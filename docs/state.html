<!DOCTYPE html>  <html> <head>   <title>state.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               state.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Copyright (C) 2011-2012
Nick Fargo, Z Vector Inc.</p>

<p>License MIT; see file <a href="https://github.com/nickfargo/state/blob/master/LICENSE"><code>LICENSE</code></a>
for details.</p>

<p><a href="http://statejs.org/">statejs.org</a>
<a href="http://github.com/nickfargo/state/">github</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

<span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">global</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>

    <span class="nx">meta</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">VERSION</span><span class="o">:</span> <span class="s1">&#39;0.0.3&#39;</span><span class="p">,</span>

        <span class="nx">noConflict</span><span class="o">:</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">original</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">global</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">original</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">})()</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The lone dependency of the <strong>State</strong> module is
<a href="http://github.com/zvector/zcore"><strong>Zcore</strong></a>, a library that assists with tasks such as
object manipulation, differential operations, facilitating prototypal inheritance, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Z</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">require</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;zcore&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Z</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>state( ... ) <a name="module" href="#module">&#x1f517;</a></h2>

<p>The <code>state</code> module is exported as a function. This is used either: (1) to generate a formal
<code>StateExpression</code>; or (2) to bestow an arbitrary <code>owner</code> object with a new implementation of
state based on the supplied <code>expression</code>, returning the owner’s initial <code>State</code>.</p>

<p>All arguments are optional: if both an <code>owner</code> and <code>expression</code> are provided, <code>state</code> acts in
the second capacity, causing <code>owner</code> to become stateful; otherwise, <code>state</code> simply returns a
<code>StateExpression</code>. The <code>attributes</code> parameter may include any of the words defined in
<code>STATE_ATTRIBUTE_MODIFIERS</code>; these are applied to the provided <code>expression</code>, and will be used
to further specify the expressed state’s functionality, or to impose constraints on how that
state may be used by its owner. (See <code>STATE_ATTRIBUTES</code> object below.)</p>

<p><em>See also:</em> <a href="#state"><code>State</code></a>, <a href="#state-expression"><code>StateExpression</code></a>,
<a href="#state-controller"><code>StateController</code></a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">state</span> <span class="p">(</span>
                      <span class="cm">/*Object*/</span> <span class="nx">owner</span><span class="p">,</span>      <span class="c1">// optional</span>
                      <span class="cm">/*String*/</span> <span class="nx">attributes</span><span class="p">,</span> <span class="c1">// optional</span>
    <span class="cm">/*StateExpression | Object*/</span> <span class="nx">expression</span><span class="p">,</span> <span class="c1">// optional</span>
             <span class="cm">/*Object | String*/</span> <span class="nx">options</span>     <span class="c1">// optional</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">typeof</span> <span class="nx">owner</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">owner</span> <span class="p">)</span> <span class="o">:</span> <span class="p">(</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">owner</span> <span class="p">);</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">typeof</span> <span class="nx">owner</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">,</span>
                <span class="nx">owner</span> <span class="o">=</span> <span class="kc">undefined</span> <span class="p">);</span>
        <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span>
            <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="kc">undefined</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">expression</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
    <span class="k">return</span> <span class="nx">owner</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">StateController</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">options</span> <span class="p">).</span><span class="nx">current</span><span class="p">()</span> <span class="o">:</span> <span class="nx">expression</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">meta</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>Module-level constants</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h4>State attributes</h4>

<p>These values are stored as a bit field in a <code>State</code> instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">STATE_ATTRIBUTES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">NORMAL</span>      <span class="o">:</span> <span class="mh">0x0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>A <strong>virtual state</strong> is a lightweight inheritor of a <strong>protostate</strong> located higher in the
owner object’s prototype chain.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">VIRTUAL</span>     <span class="o">:</span> <span class="mh">0x1</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Marking a state <code>initial</code> specifies which state a newly instantiated <code>StateController</code>
should assume.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">INITIAL</span>     <span class="o">:</span> <span class="mh">0x2</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Once a state marked <code>conclusive</code> is entered, it cannot be exited, although transitions
may still freely traverse within its substates.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">CONCLUSIVE</span>  <span class="o">:</span> <span class="mh">0x4</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Once a state marked <code>final</code> is entered, no further outbound transitions within its local
region are allowed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">FINAL</span>       <span class="o">:</span> <span class="mh">0x8</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>An <strong>abstract state</strong> cannot itself be current. Consequently a transition target that
points to a state marked <code>abstract</code> is redirected to one of its substates.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">ABSTRACT</span>    <span class="o">:</span> <span class="mh">0x10</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Marking a state <code>default</code> designates it as the actual target for any transition that
targets its abstract superstate.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">DEFAULT</span>     <span class="o">:</span> <span class="mh">0x20</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>A state marked <code>sealed</code> cannot have substates.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">SEALED</span>      <span class="o">:</span> <span class="mh">0x40</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>A <code>retained</code> state is one that preserves its own internal state, such that, after the
state has become no longer active, a subsequent transition targeting that particular
state will automatically be redirected to whichever of its descendant states was most
recently current.
<em>(Reserved; not presently implemented.)</em></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">RETAINED</span>    <span class="o">:</span> <span class="mh">0x80</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Marking a state with the <code>history</code> attribute causes its internal state to be recorded
in a sequential <strong>history</strong>. Whereas a <code>retained</code> state is concerned only with the most
recent internal state, a state’s history can be traversed and altered, resulting in
transitions back or forward to previously or subsequently held internal states.
<em>(Reserved; not presently implemented.)</em></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">HISTORY</span>     <span class="o">:</span> <span class="mh">0x100</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Normally, states that are <code>retained</code> or that keep a <code>history</code> persist their internal
state <em>deeply</em>, i.e., with a scope extending over all of the state’s descendant states.
Marking a state <code>shallow</code> limits the scope of its persistence to its immediate
substates only.
<em>(Reserved; not presently implemented.)</em></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">SHALLOW</span>     <span class="o">:</span> <span class="mh">0x200</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Causes alterations to a state to result in a reflexive transition, with a delta object
distinguishing the prior version of the state from its new version. Should also add a
history entry wherever appropriate, representing the prior version and the delta.
<em>(Reserved; not presently implemented.)</em></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">VERSIONED</span>   <span class="o">:</span> <span class="mh">0x400</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>In a state marked <code>concurrent</code>, the substates are considered <strong>concurrent orthogonal
regions</strong>. Upon entering a concurrent state, the controller creates a new set of
subcontrollers, one for each region, which will exist as long as the concurrent state
remains active. Method calls are forwarded to at most one of the regions, or if a
reduction function is associated with the given method, the call is repeated for each
region and the results reduced accordingly on their way back to the owner.
<em>(Reserved; not presently implemented.)</em></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">CONCURRENT</span>  <span class="o">:</span> <span class="mh">0x800</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The subset of attributes that are valid keywords for the <code>attributes</code> argument in a call to
the exported <code>state</code> function.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">STATE_ATTRIBUTE_MODIFIERS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;initial conclusive final&#39;</span><span class="p">,</span>
        <span class="s1">&#39;abstract default sealed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;retained history shallow versioned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;concurrent&#39;</span>
    <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span>
    </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">STATE_EXPRESSION_CATEGORIES</span> <span class="o">=</span>
        <span class="s1">&#39;data methods events guards states transitions&#39;</span><span class="p">,</span>
    </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">STATE_EVENT_TYPES</span> <span class="o">=</span>
        <span class="s1">&#39;construct depart exit enter arrive destroy mutate&#39;</span><span class="p">,</span>
    </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">GUARD_ACTIONS</span> <span class="o">=</span>
        <span class="s1">&#39;admit release&#39;</span><span class="p">,</span>
    </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">TRANSITION_PROPERTIES</span> <span class="o">=</span>
        <span class="s1">&#39;origin source target action conjugate&#39;</span><span class="p">,</span>
    </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">TRANSITION_EXPRESSION_CATEGORIES</span> <span class="o">=</span>
        <span class="s1">&#39;methods events guards&#39;</span><span class="p">,</span>
    </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">TRANSITION_EVENT_TYPES</span> <span class="o">=</span>
        <span class="s1">&#39;construct destroy enter exit start end abort&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">server</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">exports</span> <span class="o">=</span> <span class="nx">state</span> <span class="p">);</span>
<span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">client</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">global</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>State <a name="state" href="#state">&#x1f517;</a></h2>

<p>A <strong>state</strong> models a set of behaviors for an owner object. The owner may undergo <strong>transitions</strong>
that change its <strong>current</strong> state from one to another, and in so doing adopt a different set of
behaviors.</p>

<p>Distinct behaviors are modeled in each state by defining a set of method overrides, to which
calls made on the owner will be redirected so long as a state remains current.</p>

<p>States are nested hierarchically in a tree structure, with <strong>substates</strong> that inherit from their 
<strong>superstate</strong>. While a substate is current, it and all of its ancestor superstates are
considered to be <strong>active</strong>.</p>

<p>In addition, a state also recognizes the owner object’s prototypal inheritance, identifying an
identically named and positioned state in the prototype as its <strong>protostate</strong>. Behavior is
always inherited <em>from protostates first</em>, then from superstates.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">State</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">SA</span> <span class="o">=</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">;</span>

    <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">,</span> <span class="nx">SA</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">State</span> <span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
        <span class="p">}</span>
        
        <span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">expression</span> <span class="o">&amp;&amp;</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h4>attributes</h4>

<p>Returns the bit field of this state’s attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">attributes</span><span class="p">;</span> <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h4>name</h4>

<p>Returns the local name of this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">stringFunction</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="p">}</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Do the minimal setup required for a virtual state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">VIRTUAL</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(</span> <span class="nx">superstate</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h4>realize</h4>

<p>Virtual states are weakly bound to a state hierarchy by their reference held at
<code>superstate</code>; they are not proper members of the superstate’s set of substates. The
<code>realize</code> method allows a virtual state to transform itself at some later time into
a “real” state, with its own set of closed properties and methods, existing
thereafter as an abiding member of its superstate’s set of substates.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">realize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">;</span>
                <span class="nx">attributes</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">SA</span><span class="p">.</span><span class="nx">VIRTUAL</span><span class="p">;</span>

                <span class="nx">superstate</span><span class="p">.</span><span class="nx">addSubstate</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="k">this</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">realize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
                
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Do the full setup required for a real state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">realize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h3>Class-private functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h4>realize</h4>

<p>Much of the initialization for <code>State</code> is offloaded from the constructor, allowing for
creation of lightweight virtual <code>State</code> instances that inherit all of their functionality
from protostates, but can also be converted later to a real <code>State</code> if necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">realize</span> <span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">methods</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">events</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">guards</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">substates</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">transitions</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">history</span> <span class="o">=</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">HISTORY</span> <span class="o">||</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">RETAINED</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>(Exposed for debugging.)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">__private__</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{</span>
            <span class="nx">attributes</span><span class="o">:</span> <span class="nx">attributes</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
            <span class="nx">methods</span><span class="o">:</span> <span class="nx">methods</span><span class="p">,</span>
            <span class="nx">events</span><span class="o">:</span> <span class="nx">events</span><span class="p">,</span>
            <span class="nx">guards</span><span class="o">:</span> <span class="nx">guards</span><span class="p">,</span>
            <span class="nx">substates</span><span class="o">:</span> <span class="nx">substates</span><span class="p">,</span>
            <span class="nx">transitions</span><span class="o">:</span> <span class="nx">transitions</span>
        <span class="p">});</span>
        
        <span class="kd">function</span> <span class="nx">setSuperstate</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}</span>
        </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Method names are mapped to specific local variables. The named methods are created on
<code>this</code>, each of which is a partial application of its corresponding method factory at
<code>State.privileged</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Z</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;init&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">StateExpression</span> <span class="p">],</span>
            <span class="s1">&#39;superstate&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">superstate</span> <span class="p">],</span>
            <span class="s1">&#39;data&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">data</span> <span class="p">],</span>
            <span class="s1">&#39;method methodNames addMethod removeMethod&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">methods</span> <span class="p">],</span>
            <span class="s1">&#39;event addEvent removeEvent emit&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">events</span> <span class="p">],</span>
            <span class="s1">&#39;guard addGuard removeGuard&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">guards</span> <span class="p">],</span>
            <span class="s1">&#39;substate substates addSubstate removeSubstate&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">substates</span> <span class="p">],</span>
            <span class="s1">&#39;transition transitions addTransition&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">transitions</span> <span class="p">],</span>
            <span class="s1">&#39;destroy&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">setSuperstate</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">]</span>
        <span class="p">});</span>
        <span class="nx">history</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;history push replace&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">history</span> <span class="p">]</span>
        <span class="p">});</span>
        <span class="nx">Z</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span> <span class="nx">addEvent</span><span class="o">:</span> <span class="s1">&#39;on bind&#39;</span><span class="p">,</span> <span class="nx">removeEvent</span><span class="o">:</span> <span class="s1">&#39;off unbind&#39;</span><span class="p">,</span> <span class="nx">emit</span><span class="o">:</span> <span class="s1">&#39;trigger&#39;</span> <span class="p">}</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>If no superstate is given, e.g. for a root state being created by a <code>StateController</code>,
then <code>init()</code> must be called later by the implementor.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">superstate</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">);</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <h4>createRealizer</h4>

<p>Creates a method that will first realize the state and then, under the assumption that
realization has produced a new method of the same name on the instance, invoke the method.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">createRealizer</span> <span class="p">(</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">names</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span> <span class="nx">names</span> <span class="p">).</span><span class="nx">split</span><span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">regexp</span><span class="p">.</span><span class="nx">whitespace</span> <span class="p">),</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">obj</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">()[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span> <span class="p">};</span>
        <span class="p">});</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <h4>createDelegator</h4>

<p>Creates a function that will serve as a <strong>delegator</strong> method on an owner object. For each
method defined in any of the owner’s states, a delegator must be created and assigned on
the owner itself, at the <code>methodName</code> key. This delegator then forwards any calls to
<code>methodName</code> to the owner’s current state, which will locate the appropriate implementation
for the method, apply it, and return the result.</p>

<p>If an owner already has an implementation for a delegated method, it is copied into the
owner’s root state, such that it remains accessible as the owner’s “default behavior” if
none of its active states contains an implementation for that method.</p>

<p>Stateful methods are applied in the context of the <code>State</code> to which they belong, or, if a
method is inherited from a protostate, the context will be the corresponding virtual state
within the local <code>StateController</code>. However, for any a priori methods relocated to the root
state, the context appropriately remains bound to the owner object.</p>

<p><em>See also:</em> <code>State.privileged.addMethod</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">createDelegator</span> <span class="p">(</span> <span class="nx">accessorKey</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">original</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">delegator</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">[</span> <span class="nx">accessorKey</span> <span class="p">]().</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
        <span class="p">}</span>
        
        <span class="nx">delegator</span><span class="p">.</span><span class="nx">isDelegator</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">original</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">delegator</span><span class="p">.</span><span class="nx">original</span> <span class="o">=</span> <span class="nx">original</span> <span class="p">);</span>

        <span class="k">return</span> <span class="nx">delegator</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h3>Privileged methods</h3>

<p>Methods defined here are partially applied from within a constructor.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <h4>init</h4>

<p>Builds out the state’s members based on the expression provided.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Function*/</span> <span class="nx">expressionConstructor</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*&lt;expressionConstructor&gt; | Object*/</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span>
                    <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
                
                <span class="nx">expression</span> <span class="k">instanceof</span> <span class="nx">expressionConstructor</span> <span class="o">||</span>
                    <span class="p">(</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">expressionConstructor</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">);</span>
                
                <span class="nx">map</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">methods</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">fn</span> <span class="p">);</span>
                    <span class="p">},</span>
                    <span class="nx">events</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">;</span>
                        <span class="nx">Z</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">fn</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">fn</span> <span class="p">]</span> <span class="p">);</span>
                        <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">self</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">fn</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                    <span class="nx">guards</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">guardType</span><span class="p">,</span> <span class="nx">guard</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">addGuard</span><span class="p">(</span> <span class="nx">guardType</span><span class="p">,</span> <span class="nx">guard</span> <span class="p">);</span>
                    <span class="p">},</span>
                    <span class="nx">states</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">stateName</span><span class="p">,</span> <span class="nx">stateExpression</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">addSubstate</span><span class="p">(</span> <span class="nx">stateName</span><span class="p">,</span> <span class="nx">stateExpression</span> <span class="p">);</span>
                    <span class="p">},</span>
                    <span class="nx">transitions</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">transitionName</span><span class="p">,</span> <span class="nx">transitionExpression</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">addTransition</span><span class="p">(</span> <span class="nx">transitionName</span><span class="p">,</span> <span class="nx">transitionExpression</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">};</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">atomic</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="nx">expression</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">data</span> <span class="p">);</span>
                <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">map</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">category</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">expression</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">expression</span><span class="p">[</span> <span class="nx">category</span> <span class="p">],</span> <span class="nx">fn</span> <span class="p">);</span>
                <span class="p">});</span>
        
                <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">atomic</span><span class="p">;</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;construct&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">expression</span><span class="o">:</span> <span class="nx">expression</span> <span class="p">},</span> <span class="kc">false</span> <span class="p">);</span>
        
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <h4>superstate</h4>

<p>Returns the immediate superstate, or the nearest state in the superstate chain with
the provided <code>stateName</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">superstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State*/</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                <span class="cm">/*String*/</span> <span class="nx">stateName</span> <span class="c1">// optional</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">stateName</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span>
                    <span class="nx">superstate</span>
                    <span class="o">:</span>
                    <span class="nx">superstate</span> <span class="o">?</span>
                        <span class="nx">stateName</span> <span class="o">?</span>
                            <span class="nx">superstate</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="o">===</span> <span class="nx">stateName</span> <span class="o">?</span>
                                <span class="nx">superstate</span> <span class="o">:</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(</span> <span class="nx">stateName</span> <span class="p">)</span>
                            <span class="o">:</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">().</span><span class="nx">root</span><span class="p">()</span>
                        <span class="o">:</span>
                        <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <h4>data</h4>

<p>Either retrieves or edits a block of data associated with this state.</p>

<p><code>data( [Boolean viaSuper], [Boolean viaProto] )</code></p>

<p>Retrieves data attached to this state, including all data from inherited states, unless
specified otherwise by the inheritance flags <code>viaSuper</code> and <code>viaProto</code>.</p>

<p><code>data( Object edit )</code></p>

<p>Edits data on this state. For keys in <code>edit</code> whose values are set to the <code>NIL</code>
directive, the matching keys in <code>data</code> are deleted. If the operation results in a change
to <code>data</code>, a <code>mutate</code> event is emitted for this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Object*/</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Boolean*/</span> <span class="nx">viaSuper</span><span class="p">,</span> <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">viaSuper</span> <span class="o">!==</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">edit</span> <span class="o">=</span> <span class="nx">viaSuper</span><span class="p">,</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
                    <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">edit</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">edit</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">().</span><span class="nx">data</span><span class="p">(</span> <span class="nx">edit</span> <span class="p">);</span>

                    <span class="nx">delta</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">delta</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">edit</span> <span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">atomic</span> <span class="o">&amp;&amp;</span> <span class="nx">delta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">delta</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="s1">&#39;delta&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">);</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;mutate&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">],</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span>
                        <span class="nx">viaSuper</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                            <span class="nx">superstate</span><span class="p">.</span><span class="nx">data</span><span class="p">(),</span>
                        <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                            <span class="nx">protostate</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="kc">false</span> <span class="p">),</span>
                        <span class="nx">data</span>
                    <span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h4>method</h4>

<p>Retrieves the named method held on this state. If no method is found, step through
this state’s protostate chain to find one. If no method is found there, step up the
superstate hierarchy and repeat the search.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">method</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                 <span class="cm">/*String*/</span> <span class="nx">methodName</span><span class="p">,</span>
                <span class="cm">/*Boolean*/</span> <span class="nx">viaSuper</span><span class="p">,</span>    <span class="c1">// = true</span>
                <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span><span class="p">,</span>    <span class="c1">// = true</span>
                 <span class="cm">/*Object*/</span> <span class="nx">out</span>          <span class="c1">// optional</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">method</span><span class="p">;</span>

                <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
                
                <span class="nx">methods</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="p">);</span>
                
                <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">!==</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">out</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">out</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">out</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">method</span> <span class="p">);</span>
                    <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">method</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">out</span> <span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">out</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">out</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span> <span class="p">);</span>
                            <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">method</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">viaProto</span><span class="p">,</span> <span class="nx">out</span> <span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="nx">out</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">out</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">out</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">method</span> <span class="p">);</span>
                <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <h4>methodNames</h4>

<p>Returns an <code>Array</code> of names of methods defined for this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">methodNames</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">methods</span> <span class="p">);</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <h4>addMethod</h4>

<p>Adds a method to this state, which will be callable directly from the owner, but with
its context bound to the state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">addMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span><span class="p">,</span> <span class="cm">/*Function*/</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">(),</span>
                    <span class="nx">controllerName</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">name</span><span class="p">(),</span>
                    <span class="nx">root</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">(),</span>
                    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">(),</span>
                    <span class="nx">ownerMethod</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>If there is not already a method called <code>methodName</code> in the state hierarchy,
then the owner and controller need to be set up properly to accommodate calls
to this method.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span> <span class="o">!==</span> <span class="nx">root</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">root</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">ownerMethod</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">ownerMethod</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">ownerMethod</span><span class="p">.</span><span class="nx">isDelegator</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">ownerMethod</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nx">root</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">ownerMethod</span> <span class="p">);</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>A delegator function is instated on the owner, which will direct subsequent
calls to <code>owner[ methodName ]</code> to the controller, and then on to the
appropriate state’s implementation.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span>
                        <span class="nx">createDelegator</span><span class="p">(</span> <span class="nx">controllerName</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">ownerMethod</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <h4>removeMethod</h4>

<p>Dissociates the named method from this state object and returns its function.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">removeMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                <span class="k">delete</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <h4>event</h4>

<p>Gets a registered event handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">event</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span> <span class="cm">/*String*/</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">].</span><span class="nx">get</span><span class="p">(</span> <span class="nx">id</span> <span class="p">);</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h4>addEvent</h4>

<p>Binds an event handler to the specified <code>eventType</code> and returns a unique identifier
for the handler. Built-in event types are listed at <code>StateEvent.types</code>.</p>

<p><em>Aliases:</em> <strong>on</strong>, <strong>bind</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">addEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                  <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span>
                <span class="cm">/*Function*/</span> <span class="nx">fn</span><span class="p">,</span>
                  <span class="cm">/*Object*/</span> <span class="nx">context</span>    <span class="c1">// = this</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">eventType</span> <span class="p">)</span> <span class="o">||</span>
                    <span class="p">(</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateEventCollection</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">eventType</span> <span class="p">)</span> <span class="p">);</span>
                
                <span class="k">return</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">].</span><span class="nx">add</span><span class="p">(</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span> <span class="p">);</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <h4>removeEvent</h4>

<p>Unbinds the event handler with the specified <code>id</code> that was supplied by <code>addEvent</code>.</p>

<p><em>Aliases:</em> <strong>off</strong>, <strong>unbind</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">removeEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span> <span class="cm">/*String*/</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">].</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">id</span> <span class="p">);</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <h4>emit</h4>

<p>Invokes all callbacks bound to the given event type.</p>

<p>Arguments for the callbacks can be passed as an array to the <code>args</code> parameter.</p>

<p>Callbacks are invoked in the context of <code>this</code>, or as specified by <code>context</code>.</p>

<p>Callbacks bound to superstates and protostates are also invoked, unless otherwise
directed by setting <code>viaSuper</code> or <code>viaProto</code> to <code>false</code>.</p>

<p><em>Alias:</em> <strong>trigger</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">emit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                 <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span>
                  <span class="cm">/*Array*/</span> <span class="nx">args</span><span class="p">,</span>      <span class="c1">// = []</span>
                  <span class="cm">/*State*/</span> <span class="nx">context</span><span class="p">,</span>   <span class="c1">// = this</span>
                <span class="cm">/*Boolean*/</span> <span class="nx">viaSuper</span><span class="p">,</span>  <span class="c1">// = true</span>
                <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span>   <span class="c1">// = true</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">eventType</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

                <span class="k">typeof</span> <span class="nx">args</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="nx">viaSuper</span><span class="p">,</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="kc">undefined</span> <span class="p">);</span>
                <span class="k">typeof</span> <span class="nx">context</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="nx">viaSuper</span><span class="p">,</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">context</span> <span class="o">=</span> <span class="kc">undefined</span> <span class="p">);</span>

                <span class="o">!</span><span class="nx">args</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">args</span> <span class="p">]</span> <span class="p">);</span>
                <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>

                <span class="p">(</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="k">this</span> <span class="p">);</span>

                <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">protostate</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="k">this</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

                <span class="nx">viaSuper</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">superstate</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="nx">superstate</span> <span class="p">);</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h4>guard</h4>

<p>Gets a <strong>guard</strong> entity for this state. A guard is a value or function that will be
evaluated, as either a boolean or predicate, respectively, to provide a determination
of whether a controller will be admitted into or released from the state to which the
guard is applied. Guards are inherited from protostates, but not from superstates.</p>

<p><em>See also:</em> <code>StateController::evaluateGuard</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">guard</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">guards</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">guardType</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

                <span class="k">return</span> <span class="p">(</span>
                    <span class="p">(</span> <span class="nx">guard</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">guard</span> <span class="p">)</span>
                        <span class="o">||</span>
                    <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">guard</span><span class="p">(</span> <span class="nx">guardType</span> <span class="p">)</span>
                        <span class="o">||</span>
                    <span class="kc">undefined</span>
                <span class="p">);</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <h4>addGuard</h4>

<p>Adds a guard to this state, or augments an existing guard with additional entries.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">addGuard</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">guards</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">guardType</span><span class="p">,</span> <span class="nx">guard</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">),</span> <span class="nx">guard</span> <span class="p">);</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <h4>removeGuard</h4>

<p>Removes a guard from this state, or removes specific entries from an existing guard.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">removeGuard</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">guards</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                        <span class="cm">/*String*/</span> <span class="nx">guardType</span>
                <span class="cm">/*Array | String*/</span> <span class="cm">/* keys... */</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">entry</span><span class="p">;</span>

                <span class="nx">guard</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">guard</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                
                <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="k">return</span> <span class="k">delete</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="o">?</span> <span class="nx">guard</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>

                <span class="nx">keys</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">delete</span><span class="p">(</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">guard</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">entry</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <h4>substate</h4>

<p>Retrieves the named substate of <code>this</code> state. If no such substate exists in the local
state, any identically named substate held on a protostate will be returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">substate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">stateName</span><span class="p">,</span> <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
                    <span class="nx">ss</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>
                
                <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>First scan for any virtual substates that are current on the local controller.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="nx">s</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">ss</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">);</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">ss</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">ss</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="o">===</span> <span class="nx">stateName</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">s</span><span class="p">;</span> 
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Otherwise retrieve a real substate, either locally or from a protostate.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">return</span> <span class="p">(</span>
                    <span class="nx">substates</span> <span class="o">&amp;&amp;</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span>
                        <span class="o">||</span>
                    <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                            <span class="nx">protostate</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="nx">stateName</span> <span class="p">)</span>
                        <span class="o">||</span>
                    <span class="kc">undefined</span>
                <span class="p">);</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <h4>substates</h4>

<p>Returns an <code>Array</code> of this state’s substates. If the boolean <code>deep</code> argument is <code>true</code>,
returns a depth-first flattened array containing all of this state’s descendant states.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">substates</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Boolean*/</span> <span class="nx">deep</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span>
                    <span class="nx">key</span><span class="p">;</span>
                
                <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">substates</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">);</span>
                    <span class="nx">deep</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">key</span> <span class="p">].</span><span class="nx">substates</span><span class="p">(</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h4>addSubstate</h4>

<p>Creates a state from the supplied <code>stateExpression</code> and adds it as a substate of
this state. If a substate with the same <code>stateName</code> already exists, it is first
destroyed and then replaced. If the new substate is being added to the controller’s
root state, a reference is added directly on the controller itself as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">addSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                <span class="cm">/*String*/</span> <span class="nx">stateName</span><span class="p">,</span>
                <span class="cm">/*StateExpression | Object | State*/</span> <span class="nx">stateExpression</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">substate</span><span class="p">,</span> <span class="nx">controller</span><span class="p">;</span>
                
                <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">().</span><span class="nx">addSubstate</span><span class="p">(</span> <span class="nx">stateName</span><span class="p">,</span> <span class="nx">stateExpression</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSealed</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

                <span class="p">(</span> <span class="nx">substate</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">substate</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                
                <span class="nx">substate</span> <span class="o">=</span> <span class="nx">stateExpression</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">?</span>
                    <span class="nx">stateExpression</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="nx">stateExpression</span><span class="p">.</span><span class="nx">realize</span><span class="p">()</span> <span class="o">:</span>
                    <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">stateName</span><span class="p">,</span> <span class="nx">stateExpression</span> <span class="p">);</span>
                
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">substate</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
                
                <span class="k">this</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substate</span><span class="p">;</span>
                
                <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">controller</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substate</span> <span class="p">);</span>
                
                <span class="k">return</span> <span class="nx">substate</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <h4>removeSubstate</h4>

<p>Removes the named substate from the local state, if possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">removeSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">stateName</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">controller</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span>
                    <span class="nx">substate</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">substate</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

                <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
                <span class="nx">current</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>If a transition is underway involving <code>substate</code>, the removal will fail.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span>
                    <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">transition</span><span class="p">()</span> <span class="p">)</span>
                        <span class="o">&amp;&amp;</span>
                    <span class="p">(</span>
                        <span class="nx">substate</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="o">||</span>
                        <span class="nx">substate</span> <span class="o">===</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span><span class="p">()</span> <span class="o">||</span>
                        <span class="nx">substate</span> <span class="o">===</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">target</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>The controller must be forced to evacuate the state before it is removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">current</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="nx">substate</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span> <span class="nx">forced</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>

                <span class="k">delete</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>
                <span class="k">delete</span> <span class="k">this</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="k">delete</span> <span class="nx">controller</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>

                <span class="k">return</span> <span class="nx">substate</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <h4>transition</h4>

<p>Returns the named transition expression held on this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">transition</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">transitionName</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">transitionName</span> <span class="p">];</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <h4>transitions</h4>

<p>Returns an object containing all of the transition expressions defined on this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">transitions</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">transitions</span> <span class="p">);</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <h4>addTransition</h4>

<p>Registers a transition expression to this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">addTransition</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                <span class="cm">/*String*/</span> <span class="nx">transitionName</span><span class="p">,</span>
                <span class="cm">/*TransitionExpression | Object*/</span> <span class="nx">transitionExpression</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="nx">transitionExpression</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="o">||</span>
                    <span class="p">(</span> <span class="nx">transitionExpression</span> <span class="o">=</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">transitionExpression</span> <span class="p">)</span> <span class="p">);</span>
                
                <span class="k">return</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">transitionName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">transitionExpression</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h4>history</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">history</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">history</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">indexDelta</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">indexDelta</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">history</span> <span class="p">);</span>
                <span class="k">return</span> <span class="nx">history</span><span class="p">[</span> <span class="nx">history</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">indexDelta</span> <span class="p">];</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <h4>push</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">push</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">history</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">previous</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>

                <span class="k">typeof</span> <span class="nx">flags</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span>
                    <span class="p">(</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">transition</span> <span class="o">=</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">flags</span> <span class="o">=</span> <span class="kc">undefined</span> <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

                <span class="nx">flags</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">flags</span> <span class="p">);</span>

                <span class="nx">i</span> <span class="o">=</span> <span class="nx">history</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
                <span class="nx">previous</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

                <span class="nx">i</span> <span class="o">=</span> <span class="nx">history</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nx">current</span> <span class="o">=</span> <span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">state</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
                    <span class="nx">transition</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
                    <span class="nx">data</span><span class="o">:</span> <span class="kc">undefined</span>
                <span class="p">};</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">relative</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">previous</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">current</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">previous</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
                        <span class="nx">previous</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">delta</span><span class="p">(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">current</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">current</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>
                    <span class="nx">previous</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">previous</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">diff</span><span class="p">(</span> <span class="nx">previous</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">history</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span> <span class="o">++</span><span class="nx">i</span><span class="p">,</span> <span class="nx">history</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">i</span> <span class="p">);</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">isActive</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">historian</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">superstate</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>

                <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">goTo</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>

                <span class="k">return</span> <span class="nx">history</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <h4>replace</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">replace</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">history</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">previous</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span>
                    <span class="nx">i</span> <span class="o">=</span> <span class="nx">history</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span>
                    <span class="nx">l</span> <span class="o">=</span> <span class="nx">history</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">typeof</span> <span class="nx">flags</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">flags</span> <span class="o">=</span> <span class="kc">undefined</span> <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

                <span class="nx">flags</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">flags</span> <span class="p">);</span>

                <span class="nx">current</span> <span class="o">=</span> <span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">previous</span> <span class="o">=</span> <span class="nx">history</span><span class="p">[</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">);</span>
                <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">history</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">);</span>

                <span class="nx">current</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
                <span class="nx">delta</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">relative</span> <span class="o">?</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">delta</span> <span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">diff</span> <span class="p">)(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">delta</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">previous</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">previous</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">);</span>
                    <span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">next</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">current</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>

                <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">goTo</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>

                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <h4>destroy</h4>

<p>Attempts to cleanly destroy this state and all of its substates. A <code>destroy</code> event is
issued to each state after it is destroyed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">setSuperstate</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span>
                    <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">(),</span>
                    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">(),</span>
                    <span class="nx">transition</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">transition</span><span class="p">(),</span>
                    <span class="nx">origin</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">delegator</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">stateName</span><span class="p">;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>If a transition is underway that involves this state, then the state cannot be
destroyed.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">origin</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span><span class="p">(),</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">target</span><span class="p">();</span>

                    <span class="k">if</span> <span class="p">(</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">target</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Emit a <code>destroy</code> event on the local state.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">].</span><span class="nx">destroy</span><span class="p">();</span>
                    <span class="k">delete</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">superstate</span><span class="p">.</span><span class="nx">removeSubstate</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>This is the root state, so restore any original methods to the owner and
delete any delegators.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">methodName</span> <span class="k">in</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">delegator</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                        <span class="nx">method</span> <span class="o">=</span> <span class="nx">delegator</span><span class="p">.</span><span class="nx">original</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="k">delete</span> <span class="nx">delegator</span><span class="p">.</span><span class="nx">original</span><span class="p">;</span>
                            <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="k">delete</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">stateName</span> <span class="k">in</span> <span class="nx">substates</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">stateName</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">].</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="nx">setSuperstate</span><span class="p">(</span> <span class="kc">undefined</span> <span class="p">);</span>

                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <h3>Prototype methods</h3>

<p>The instance methods defined above are also defined here, either as no-ops or defaults, so
as to provide virtual states with a conformant <code>State</code> interface despite not (or not yet)
having been realized.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">createRealizer</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;addMethod addEvent addGuard addSubstate addTransition&#39;</span> <span class="p">);</span>
    <span class="nx">Z</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;data method substate&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="kc">null</span> <span class="p">]</span> <span class="p">}</span> <span class="p">);</span>
    <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">attributes</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">NORMAL</span> <span class="p">),</span>
        <span class="nx">isVirtual</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">VIRTUAL</span> <span class="p">);</span> <span class="p">},</span>
        <span class="nx">isInitial</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">INITIAL</span> <span class="p">);</span> <span class="p">},</span>
        <span class="nx">isDefault</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">DEFAULT</span> <span class="p">);</span> <span class="p">},</span>
        <span class="nx">isFinal</span><span class="o">:</span>      <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">FINAL</span> <span class="p">);</span> <span class="p">},</span>
        <span class="nx">isAbstract</span><span class="o">:</span>   <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">ABSTRACT</span> <span class="p">);</span> <span class="p">},</span>
        <span class="nx">isSealed</span><span class="o">:</span>     <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">SEALED</span> <span class="p">);</span> <span class="p">},</span>
        <span class="nx">isRetained</span><span class="o">:</span>   <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">RETAINED</span> <span class="p">);</span> <span class="p">},</span>
        <span class="nx">hasHistory</span><span class="o">:</span>   <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">HISTORY</span> <span class="p">);</span> <span class="p">},</span>
        <span class="nx">isShallow</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">SHALLOW</span> <span class="p">);</span> <span class="p">},</span>
        <span class="nx">isVersioned</span><span class="o">:</span>  <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">VERSIONED</span> <span class="p">);</span> <span class="p">},</span>
        <span class="nx">isConcurrent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">CONCURRENT</span> <span class="p">);</span> <span class="p">},</span>

        <span class="s1">&#39;name \</span>
<span class="s1">         superstate \</span>
<span class="s1">         removeMethod \</span>
<span class="s1">         event removeEvent emit trigger \</span>
<span class="s1">         guard removeGuard \</span>
<span class="s1">         removeSubstate \</span>
<span class="s1">         transition removeTransition&#39;</span> <span class="o">:</span>
            <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span>
        
        <span class="nx">realize</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">getThis</span><span class="p">,</span>

        <span class="s1">&#39;methodNames substates&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">[];</span> <span class="p">},</span>
        <span class="nx">transitions</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{};</span> <span class="p">},</span>
        <span class="nx">destroy</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="kc">false</span> <span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <h4>toString</h4>

<p>Returns this state’s fully qualified name.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <h4>controller</h4>

<p>Gets the <code>StateController</code> to which this state belongs.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">controller</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <h4>owner</h4>

<p>Gets the owner object to which this state’s controller belongs.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">owner</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <h4>root</h4>

<p>Gets the root state, i.e. the top-level superstate of this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">root</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <h4>current</h4>

<p>Gets the local controller’s current state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">current</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">().</span><span class="nx">current</span><span class="p">();</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <h4>defaultSubstate</h4>

<p>Returns the first substate marked <code>default</code>, or simply the first substate.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">defaultSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">substates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">substates</span><span class="p">(),</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">substates</span> <span class="o">&amp;&amp;</span> <span class="nx">substates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">l</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isDefault</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">return</span> <span class="nx">substates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <h4>initialSubstate</h4>

<p>Performs a “depth-within-breadth-first” recursive search to locate the most deeply
nested <code>initial</code> state by way of the greatest <code>initial</code> descendant state. Recursion
continues into the protostate only if no local descendant states are marked <code>initial</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">initialSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span> <span class="c1">// = true</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="p">[</span> <span class="k">this</span> <span class="p">],</span>
                <span class="nx">subject</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>
            
            <span class="k">while</span> <span class="p">(</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">substates</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">.</span><span class="nx">substates</span><span class="p">();</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">state</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isInitial</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">initialSubstate</span><span class="p">(</span> <span class="kc">false</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">state</span><span class="p">;</span>
                    <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">||</span> <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">initialSubstate</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <h4>protostate</h4>

<p>Returns the <strong>protostate</strong>, the state analogous to <code>this</code> found in the next object in
the owner’s prototype chain that has one. A state inherits from both its protostate and
superstate, <em>in that order</em>.</p>

<p>If the owner does not share an analogous <code>StateController</code> with its prototype, or if no
protostate can be found in the hierarchy of the prototype’s state controller, then the
search is iterated up the prototype chain.</p>

<p>A state and its protostate will always share an identical name and identical derivation
pattern, as will the respective superstates of both, relative to one another.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">protostate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">derivation</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">),</span>
                <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">(),</span>
                <span class="nx">controllerName</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">prototype</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">stateName</span><span class="p">;</span>
            
            <span class="kd">function</span> <span class="nx">iterate</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">c</span><span class="p">;</span>
                <span class="nx">prototype</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span> <span class="nx">prototype</span> <span class="p">);</span>
                <span class="nx">protostate</span> <span class="o">=</span> <span class="nx">prototype</span> <span class="o">&amp;&amp;</span>
                    <span class="k">typeof</span> <span class="nx">prototype</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">prototype</span><span class="p">[</span> <span class="nx">controllerName</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">prototype</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">c</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">?</span>
                        <span class="nx">c</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">:</span>
                        <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="nx">controllerName</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">name</span><span class="p">();</span>
            <span class="nx">prototype</span> <span class="o">=</span> <span class="nx">owner</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
        
            <span class="k">for</span> <span class="p">(</span> <span class="nx">iterate</span><span class="p">();</span> <span class="nx">protostate</span><span class="p">;</span> <span class="nx">iterate</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">derivation</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">protostate</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="nx">derivation</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">protostate</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">protostate</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <h4>derivation</h4>

<p>Returns an object array of this state’s superstate chain, starting after the root
state and ending at <code>this</code>. If <code>byName</code> is set to <code>true</code>, a string array of the
states’ names is returned instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">derivation</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Boolean*/</span> <span class="nx">byName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
                    <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">);</span>
                    <span class="nx">result</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="nx">byName</span> <span class="o">?</span> <span class="nx">state</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <h4>depth</h4>

<p>Returns the number of superstates this state has. The root state returns <code>0</code>, its
immediate substates return <code>1</code>, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">depth</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">ss</span><span class="p">;</span> <span class="nx">ss</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">ss</span><span class="p">,</span> <span class="nx">n</span><span class="o">++</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <h4>common</h4>

<p>Returns the least common ancestor of <code>this</code> and <code>other</code>. If <code>this</code> is itself an ancestor
of <code>other</code>, or vice versa, that ancestor is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">common</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">other</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">state</span><span class="p">;</span>
            <span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">other</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">other</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">depth</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">depth</span><span class="p">()</span> <span class="o">?</span>
                    <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">other</span><span class="p">,</span> <span class="nx">other</span> <span class="o">=</span> <span class="k">this</span> <span class="p">)</span> <span class="o">:</span>
                    <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span> <span class="p">);</span>
                <span class="nx">state</span><span class="p">;</span>
                <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> 
            <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="nx">other</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">other</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <h4>is</h4>

<p>Determines whether <code>this</code> is <code>state</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">is</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">state</span> <span class="o">===</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <h4>isIn</h4>

<p>Determines whether <code>this</code> is or is a substate of <code>state</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">isIn</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">state</span> <span class="o">===</span> <span class="k">this</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <h4>has</h4>

<p>Determines whether <code>this</code> is or is a superstate of <code>state</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">has</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String */</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span> <span class="o">===</span> <span class="nx">state</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <h4>isSuperstateOf</h4>

<p>Determines whether <code>this</code> is a superstate of <code>state</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">isSuperstateOf</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">superstate</span><span class="p">;</span>
            <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
            
            <span class="k">return</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">?</span>
                <span class="k">this</span> <span class="o">===</span> <span class="nx">superstate</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="o">:</span>
                <span class="kc">false</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <h4>isProtostateOf</h4>

<p>Determines whether <code>this</code> is a state analogous to <code>state</code> on any object in the prototype
chain of <code>state</code>’s owner.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">isProtostateOf</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">protostate</span><span class="p">;</span>
            <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>

            <span class="k">return</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">?</span>
                <span class="k">this</span> <span class="o">===</span> <span class="nx">protostate</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isProtostateOf</span><span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="o">:</span>
                <span class="kc">false</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <h4>apply</h4>

<p>Finds a state method and applies it in the appropriate context. If the method was
originally defined in the owner, the context will be the owner. Otherwise, the context
will either be the state in which the method is defined, or if the implementation
resides in a protostate, the corresponding inheriting state in the local controller.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">apply</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span><span class="p">,</span> <span class="cm">/*Array*/</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">ownerMethod</span><span class="p">;</span>

            <span class="nx">out</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">context</span><span class="o">:</span> <span class="kc">undefined</span> <span class="p">};</span>
            <span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">out</span> <span class="p">);</span>
            
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">method</span> <span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span> <span class="s2">&quot;State &#39;&quot;</span> <span class="o">+</span> <span class="k">this</span> <span class="o">+</span> <span class="s2">&quot;&#39; has no method &#39;&quot;</span> <span class="o">+</span>
                <span class="nx">methodName</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="p">);</span>

            <span class="nx">context</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
            <span class="nx">owner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
            <span class="nx">ownerMethod</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">ownerMethod</span> <span class="o">&amp;&amp;</span> <span class="nx">ownerMethod</span><span class="p">.</span><span class="nx">original</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">context</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <h4>call</h4>

<p>Variadic <code>apply</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">call</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <h4>hasMethod</h4>

<p>Determines whether <code>this</code> possesses or inherits a method named <code>methodName</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">hasMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">!==</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <h4>hasOwnMethod</h4>

<p>Determines whether <code>this</code> directly possesses a method named <code>methodName</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">hasOwnMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <h4>change</h4>

<p>Forwards a <code>change</code> command to the state’s controller and returns its result.</p>

<p><em>Aliases:</em> <strong>be</strong>, <strong>become</strong>, <strong>go</strong>, <strong>goTo</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="s1">&#39;change be become go goTo&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">change</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">controller</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <h4>isCurrent</h4>

<p>Returns a <code>Boolean</code> indicating whether <code>this</code> is the controller’s current state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">isCurrent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <h4>isActive</h4>

<p>Returns a <code>Boolean</code> indicating whether <code>this</code> or one of its substates is the
controller’s current state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">isActive</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">current</span> <span class="o">===</span> <span class="k">this</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">current</span> <span class="p">);</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <h4>history</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">history</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">historian</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">h</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">history</span><span class="p">();</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <h4>historian</h4>

<p>Returns the nearest history-keeping state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">historian</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="nx">s</span><span class="p">;</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">hasHistory</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">push</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">typeof</span> <span class="nx">flags</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span>
                <span class="p">(</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">transition</span> <span class="o">=</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">flags</span> <span class="o">=</span> <span class="kc">undefined</span> <span class="p">);</span>

            <span class="kd">var</span> <span class="nx">historian</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">historian</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">historian</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Before delegating to the historian, <code>state</code> must be resolved locally.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">historian</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>

        <span class="nx">replace</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">historian</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">historian</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">historian</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Before delegating to the historian, <code>state</code> must be resolved locally.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">historian</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>

        <span class="cm">/** */</span>
        <span class="nx">pushHistory</span><span class="o">:</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span> <span class="o">&amp;&amp;</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span> <span class="o">?</span>
            <span class="kd">function</span> <span class="p">(</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">urlBase</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">title</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
                    <span class="nx">urlBase</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">);</span>
            <span class="p">}</span> <span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span>
        <span class="p">,</span>
        
        <span class="cm">/** */</span>
        <span class="nx">replaceHistory</span><span class="o">:</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span> <span class="o">&amp;&amp;</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span> <span class="o">?</span>
            <span class="kd">function</span> <span class="p">(</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">urlBase</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">title</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
                    <span class="nx">urlBase</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">);</span>
            <span class="p">}</span> <span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span>
        <span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <h4>evaluateGuard</h4>

<p>Returns the Boolean result of the guard function at <code>guardName</code> defined on this state,
as evaluated against <code>testState</code>, or <code>true</code> if no guard exists.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">evaluateGuard</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*String*/</span> <span class="nx">guardName</span><span class="p">,</span>
             <span class="cm">/*State*/</span> <span class="nx">testState</span>   <span class="c1">// optional</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
                <span class="nx">guard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">guard</span><span class="p">(</span> <span class="nx">guardName</span> <span class="p">),</span>
                <span class="nx">result</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">guard</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

            <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">guard</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">selector</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span> <span class="sr">/\s*,+\s*/</span> <span class="p">),</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">expr</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span> <span class="nx">expr</span> <span class="p">),</span> <span class="nx">testState</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">result</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
                            <span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">testState</span> <span class="p">)</span> <span class="o">:</span>
                            <span class="nx">value</span>
                        <span class="p">);</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> 
                    <span class="p">}</span>
                <span class="p">});</span>
                <span class="k">return</span> <span class="nx">result</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">});</span>

            <span class="k">return</span> <span class="nx">result</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <h4>query</h4>

<p>Matches a string expression <code>expr</code> with the state or states it represents, evaluated
first in the context of <code>this</code>, then its substates, and then its superstates, until
all locations in the state tree have been searched for a match of <code>expr</code>.</p>

<p>Returns the matched <code>State</code>, or an <code>Array</code> containing the set of matched states. If a
state to be tested <code>against</code> is provided, a <code>Boolean</code> is returned, indicating whether
<code>against</code> is the matched state or is included in the matching set.</p>

<p>Setting <code>descend</code> to <code>false</code> disables recursion through the substates of <code>this</code>, and
likewise setting <code>ascend</code> to <code>false</code> disables the subsequent recursion through its
superstates.</p>

<p><em>Aliases:</em> <strong>$</strong>, <strong>match</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="s1">&#39;query $ match&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
             <span class="cm">/*String*/</span> <span class="nx">expr</span><span class="p">,</span>
              <span class="cm">/*State*/</span> <span class="nx">against</span><span class="p">,</span> <span class="c1">// optional</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">descend</span><span class="p">,</span> <span class="c1">// = true</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">ascend</span> <span class="c1">// = true</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">parts</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span>
                <span class="nx">queue</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>
            </pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>A few exceptional cases may be resolved early.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">expr</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">expr</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">against</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">ascend</span> <span class="o">=</span> <span class="nx">descend</span><span class="p">,</span> <span class="nx">descend</span> <span class="o">=</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">against</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">descend</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">descend</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="nx">ascend</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">ascend</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Absolute wildcard expressions compared against the root state pass immediately.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">against</span> <span class="o">&amp;&amp;</span> <span class="nx">against</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/^\*+$/</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Wildcard-only expressions should not be recursed.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">expr</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/^\.?\*+$/</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">descend</span> <span class="o">=</span> <span class="nx">ascend</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>If <code>expr</code> is an absolute path, evaluate it from the root state as a relative path.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;.&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">().</span><span class="nx">query</span><span class="p">(</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">descend</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Split <code>expr</code> into tokens, parse, and match to the expressed state or set of states.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">(</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">).</span><span class="nx">shift</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">l</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">against</span> <span class="o">?</span> <span class="nx">against</span> <span class="o">===</span> <span class="nx">cursor</span> <span class="o">:</span> <span class="nx">cursor</span><span class="p">;</span>
                
                <span class="nx">name</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                
                <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">against</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substates</span><span class="p">();</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">cursor</span> <span class="o">===</span> <span class="nx">against</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;**&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">against</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substates</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">against</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>If no match is found yet, then recursively descend with a breadth-first search.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">descend</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">queue</span> <span class="o">=</span> <span class="p">[</span> <span class="k">this</span> <span class="p">];</span>
                <span class="k">while</span> <span class="p">(</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">substates</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">.</span><span class="nx">substates</span><span class="p">();</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">state</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>The <code>ascend</code> block uses <code>descend</code> to indicate a substate that has
already been searched.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="nx">descend</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

                        <span class="nx">result</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>

                        <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>If a match still hasn’t been found, then recursively ascend, passing <code>this</code> as a
domain to be skipped during the superstate’s subsequent descent.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">ascend</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>No matches here.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="nx">against</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">Z</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span> <span class="nx">addEvent</span><span class="o">:</span> <span class="s1">&#39;on bind&#39;</span><span class="p">,</span> <span class="nx">removeEvent</span><span class="o">:</span> <span class="s1">&#39;off unbind&#39;</span> <span class="p">}</span> <span class="p">);</span>

    <span class="k">return</span> <span class="nx">State</span><span class="p">;</span>
<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <h2>StateExpression <a name="state-expression" href="#state-expression">&#x1f517;</a></h2>

<p>A <strong>state expression</strong> formalizes a definition of a state’s contents. States are declared by
calling the module’s exported <code>state()</code> function and passing it an object map containing the
definition. This input may be expressed in a shorthand format, which the <code>StateExpression</code>
constructor rewrites into unambiguous long form, which can be used later to create <code>State</code>
instances.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">StateExpression</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">attributeMap</span>   <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_ATTRIBUTE_MODIFIERS</span> <span class="p">),</span>
            <span class="kd">function</span> <span class="p">(</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span> <span class="p">}),</span>
        <span class="nx">categoryMap</span>    <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_EXPRESSION_CATEGORIES</span> <span class="p">),</span>
        <span class="nx">eventTypes</span>     <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_EVENT_TYPES</span> <span class="p">),</span>
        <span class="nx">guardActions</span>   <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">GUARD_ACTIONS</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">StateExpression</span> <span class="p">(</span>
        <span class="cm">/*String | Object*/</span> <span class="nx">attributes</span><span class="p">,</span> <span class="c1">// optional</span>
                 <span class="cm">/*Object*/</span> <span class="nx">map</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">map</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span>
            <span class="nx">map</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">map</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="o">:</span>
            <span class="nx">map</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="kc">undefined</span> <span class="p">);</span>
        
        <span class="nx">Z</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">map</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="o">?</span> <span class="nx">map</span> <span class="o">:</span> <span class="nx">interpret</span><span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">attributes</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
            <span class="nx">map</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="o">:</span>
            <span class="nx">Z</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">encodeAttributes</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="nx">attributes</span> <span class="o">||</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <h3>Class-private functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <h4>encodeAttributes</h4>

<p>Transforms the provided set of attributes into a bit field integer.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">encodeAttributes</span> <span class="p">(</span> <span class="cm">/*Object | String*/</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>

        <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">attributeMap</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span> <span class="o">|=</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">[</span> <span class="nx">attributeMap</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <h4>interpret</h4>

<p>Transforms a plain object map into a well-formed <code>StateExpression</code>, making the appropriate
inferences for any shorthand notation encountered.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">interpret</span> <span class="p">(</span> <span class="cm">/*Object*/</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_EXPRESSION_CATEGORIES</span><span class="p">,</span> <span class="kc">null</span> <span class="p">);</span>
        
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">map</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            </pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p><strong>Priority 1:</strong> Do a nominative type match for explicit expression instances.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">category</span> <span class="o">=</span>
                <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;states&#39;</span> <span class="o">||</span>
                <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;transitions&#39;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">category</span> <span class="p">)</span> <span class="p">{</span>
                <span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">)[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
            </pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p><strong>Priority 2:</strong> Recognize an explicitly named category object.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">result</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">],</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
            </pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p><strong>Priority 3:</strong> Use keys and value types to infer implicit categorization.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">category</span> <span class="o">=</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">eventTypes</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span> <span class="s1">&#39;events&#39;</span> <span class="o">:</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">guardActions</span> <span class="o">?</span> <span class="s1">&#39;guards&#39;</span> <span class="o">:</span>
                    <span class="nx">Z</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;states&#39;</span> <span class="o">:</span>
                    <span class="s1">&#39;methods&#39;</span><span class="p">;</span>
                <span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">)[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">events</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">value</span> <span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">guards</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="nx">value</span> <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">transitions</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="o">||</span>
                <span class="p">(</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span>
        
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">states</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="o">||</span>
                <span class="p">(</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">StateExpression</span><span class="p">;</span>
<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <h2>StateController <a name="state-controller" href="#state-controller">&#x1f517;</a></h2>

<p>A state <strong>controller</strong> is the mediator between an owner object and its implementation of state.
The controller maintains the identity of the owner’s active state, and facilitates transitions
from one state to another. It provides the behavior-modeling aspect of the owner’s state by
forwarding method calls made on the owner to any associated stateful implementations of those
methods that are valid given the current state.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">StateController</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">StateController</span> <span class="p">(</span>
                          <span class="cm">/*Object*/</span> <span class="nx">owner</span><span class="p">,</span>      <span class="c1">// = {}</span>
        <span class="cm">/*StateExpression | Object*/</span> <span class="nx">expression</span><span class="p">,</span> <span class="c1">// optional</span>
                          <span class="cm">/*Object*/</span> <span class="nx">options</span>     <span class="c1">// optional</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">StateController</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">StateController</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">}</span>
        
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">name</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span>
            <span class="nx">defaultSubstate</span><span class="p">;</span>
        
        <span class="kd">function</span> <span class="nx">setCurrent</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}</span>
        <span class="kd">function</span> <span class="nx">setTransition</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">transition</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}</span>
        </pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>Validate arguments.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">owner</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">owner</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
        <span class="nx">expression</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="o">||</span>
            <span class="p">(</span> <span class="nx">expression</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">);</span>
        <span class="nx">options</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="o">||</span>
            <span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">initialState</span><span class="o">:</span> <span class="nx">options</span> <span class="p">}</span> <span class="p">);</span>
        </pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>Assign a function to the owner that will serve as its interface into its state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;state&#39;</span><span class="p">;</span>
        <span class="nx">owner</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">createAccessor</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
        </pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <h3>Internal privileged methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <h4>owner</h4>

<p>Returns the owner object on whose behalf this controller acts.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">owner</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">owner</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <h4>name</h4>

<p>Returns the name assigned to this controller. This is also the key in <code>owner</code> that
holds the <code>accessor</code> function associated with this controller.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">name</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">stringFunction</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">name</span><span class="p">;</span> <span class="p">}</span> <span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <h4>root</h4>

<p>Returns the root state.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">root</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">root</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <h4>current</h4>

<p>Returns the controller’s current state, or currently active transition.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">current</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">current</span><span class="p">;</span> <span class="p">},</span> <span class="p">{</span>
                <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">current</span> <span class="o">?</span> <span class="nx">current</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span> <span class="p">}</span>
            <span class="p">}),</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <h4>transition</h4>

<p>Returns the currently active transition, or <code>undefined</code> if the controller is not
presently engaged in a transition.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">transition</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">transition</span><span class="p">;</span> <span class="p">},</span> <span class="p">{</span>
                <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">transition</span> <span class="o">?</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="p">}</span>
            <span class="p">}),</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <h4>destroy</h4>

<p>Destroys this controller and all of its states, and returns the owner to its original
condition.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
                <span class="nx">root</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="nx">result</span> <span class="o">=</span> <span class="k">delete</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
                <span class="nx">owner</span> <span class="o">=</span> <span class="nx">self</span> <span class="o">=</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">transition</span> <span class="o">=</span> <span class="nx">defaultSubstate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
        </pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Assign partially applied external privileged methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Z</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">StateController</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;change&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">setCurrent</span><span class="p">,</span> <span class="nx">setTransition</span> <span class="p">]</span>
        <span class="p">});</span>
        </pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>Instantiate the root state, adding a redefinition of the <code>controller</code> method that points
directly to this controller, along with all of the members and substates outlined in
<code>expression</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">root</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">controller</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">self</span><span class="p">;</span> <span class="p">};</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">);</span>
        </pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Establish which state should be the initial state and set the current state to that.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">current</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">initialSubstate</span><span class="p">()</span> <span class="o">||</span> <span class="nx">root</span><span class="p">;</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">initialState</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">initialState</span> <span class="p">)</span> <span class="p">);</span>
        <span class="nx">current</span><span class="p">.</span><span class="nx">isAbstract</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">defaultSubstate</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">defaultSubstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">defaultSubstate</span> <span class="p">);</span>
        <span class="nx">current</span><span class="p">.</span><span class="nx">controller</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">virtualize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">current</span> <span class="p">)</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>(Exposed for debugging.)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">__private__</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{</span>
            <span class="nx">root</span><span class="o">:</span> <span class="nx">root</span><span class="p">,</span>
            <span class="nx">owner</span><span class="o">:</span> <span class="nx">owner</span><span class="p">,</span>
            <span class="nx">options</span><span class="o">:</span> <span class="nx">options</span>
        <span class="p">});</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <h3>Class-private functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <h4>createAccessor</h4>

<p>Returns an <code>accessor</code> function, which will serve as an owner object’s interface to the
implementation of its state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">createAccessor</span> <span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">self</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">accessor</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">controller</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">method</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="k">this</span> <span class="o">===</span> <span class="nx">owner</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">);</span>
                <span class="nx">current</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
                <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">current</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">current</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Calling the accessor of a prototype means that <code>this</code> requires its own accessor
and <code>StateController</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
                <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isPrototypeOf</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="k">this</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateController</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
                    <span class="nx">initialState</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span>
                <span class="p">});</span>
                <span class="nx">root</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>Any methods of <code>this</code> that have stateful implementations located higher in the
prototype chain must be copied into the root state to be used as defaults.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="k">this</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">root</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">root</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">method</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="k">this</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">accessor</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <h4>virtualize</h4>

<p>Creates a transient virtual state within the local state hierarchy to represent
<code>protostate</code>, along with as many virtual superstates as are necessary to reach a real
<code>State</code> in the local hierarchy.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">virtualize</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">derivation</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">name</span><span class="p">;</span>
        <span class="kd">function</span> <span class="nx">iterate</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">derivation</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">),</span> <span class="kc">false</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">&amp;&amp;</span>
            <span class="nx">protostate</span><span class="p">.</span><span class="nx">owner</span><span class="p">().</span><span class="nx">isPrototypeOf</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span> <span class="nx">derivation</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">).</span><span class="nx">length</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">(),</span> <span class="nx">iterate</span><span class="p">();</span> <span class="nx">next</span><span class="p">;</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">iterate</span><span class="p">()</span> <span class="p">);</span>
            <span class="k">while</span> <span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">state</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">attributes</span><span class="o">:</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">.</span><span class="nx">VIRTUAL</span> <span class="p">}</span> <span class="p">);</span>
                <span class="nx">name</span> <span class="o">=</span> <span class="nx">derivation</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <h4>annihilate</h4>

<p>Destroys the given <code>virtualState</code> and all of its virtual superstates.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">annihilate</span> <span class="p">(</span> <span class="nx">virtualState</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">superstate</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span> <span class="nx">virtualState</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">virtualState</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
            <span class="nx">virtualState</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="nx">virtualState</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <h4>evaluateGuard</h4>

<p>Returns the Boolean result of the guard function at <code>guardName</code> defined on this state,
as evaluated against <code>testState</code>, or <code>true</code> if no guard exists.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">evaluateGuard</span> <span class="p">(</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">against</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">valueIsFn</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">selectors</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">typeof</span> <span class="nx">guard</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">guard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">guard</span><span class="p">(</span> <span class="nx">guard</span> <span class="p">)</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">guard</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">guard</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">guard</span><span class="p">[</span> <span class="nx">key</span> <span class="p">],</span> <span class="nx">valueIsFn</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">;</span>
            <span class="nx">valueIsFn</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
            <span class="nx">selectors</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span> <span class="nx">key</span> <span class="p">).</span><span class="nx">split</span><span class="p">(</span> <span class="sr">/\s*,+\s*/</span> <span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">selectors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selectors</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">against</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">result</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">valueIsFn</span> <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">value</span> <span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">result</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <h3>External privileged methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">StateController</span><span class="p">.</span><span class="nx">privileged</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <h4>change</h4>

<p>Attempts to execute a state transition. Handles asynchronous transitions, generation of
appropriate events, and construction of any necessary temporary virtual states. Respects
guards supplied in both the origin and <code>target</code> states. Fails by returning <code>false</code> if
the transition is disallowed.</p>

<p>The <code>target</code> parameter may be either a <code>State</code> object that is part of this controller’s
state hierarchy, or a string that resolves to a likewise targetable <code>State</code> when
evaluated from the context of the most recently current state.</p>

<p>The <code>options</code> parameter is an optional map that may include:</p>

<ul>
<li><code>forced</code> : <code>Boolean</code> — overrides any guards defined, ensuring the change will
complete, assuming a valid target.</li>
<li><code>success</code> : <code>Function</code> — callback to be executed upon successful completion of the
transition.</li>
<li><code>failure</code> : <code>Function</code> — callback to be executed if the transition attempt is blocked
by a guard.</li>
<li><code>arguments</code> : <code>Array</code> — arguments to be passed to a transition’s <code>action</code> function.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">change</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">setCurrent</span><span class="p">,</span> <span class="nx">setTransition</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">reentrant</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="kd">function</span> <span class="nx">push</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">reentrant</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                <span class="nx">reentrant</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                <span class="cm">/*State | String*/</span> <span class="nx">target</span><span class="p">,</span>
                        <span class="cm">/*Object*/</span> <span class="nx">options</span> <span class="c1">// optional</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">reentrant</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

                <span class="kd">var</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">targetOwner</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">domain</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span>
                    <span class="nx">transitionExpression</span><span class="p">,</span>
                    <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

                <span class="nx">owner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
                <span class="nx">transition</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transition</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>The <code>origin</code> is defined as the controller’s most recently current state that is
not a <code>Transition</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">origin</span> <span class="o">=</span> <span class="nx">transition</span> <span class="o">?</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span><span class="p">()</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p>Departures are not allowed from a state that is <code>final</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">isFinal</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>Resolve <code>target</code> argument to a proper <code>State</code> object if necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">target</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span>
                    <span class="p">(</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span> <span class="o">?</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">);</span>
            
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">target</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="p">)</span> <span class="o">||</span>
                        <span class="p">(</span> <span class="nx">targetOwner</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span> <span class="p">)</span> <span class="o">!==</span> <span class="nx">owner</span> <span class="o">&amp;&amp;</span>
                        <span class="o">!</span><span class="nx">targetOwner</span><span class="p">.</span><span class="nx">isPrototypeOf</span><span class="p">(</span> <span class="nx">owner</span> <span class="p">)</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>An ingressing transition that targets a retained state must be redirected to
whichever of that state’s internal states was most recently current.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">target</span><span class="p">.</span><span class="nx">isRetained</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">target</span><span class="p">.</span><span class="nx">isActive</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">record</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
                    <span class="nx">target</span> <span class="o">=</span> <span class="nx">record</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">state</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">target</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>A transition cannot target an abstract state directly, so <code>target</code> must be
reassigned to the appropriate concrete substate.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">while</span> <span class="p">(</span> <span class="nx">target</span><span class="p">.</span><span class="nx">isAbstract</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">defaultSubstate</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">target</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span>
                
                <span class="o">!</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="o">||</span>
                    <span class="nx">Z</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">arguments</span><span class="o">:</span> <span class="nx">options</span> <span class="p">}</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p>If any guards are in place for the given <code>origin</code> and <code>target</code> states, they must
consent to the transition, unless we specify that it be <code>forced</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">forced</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
                        <span class="o">!</span><span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">origin</span><span class="p">,</span> <span class="s1">&#39;release&#39;</span><span class="p">,</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">||</span>
                        <span class="o">!</span><span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;admit&#39;</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span>
                <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">failure</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">failure</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p>If <code>target</code> is a state from a prototype of <code>owner</code>, it must be represented
here as a transient virtual state.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">.</span><span class="nx">controller</span><span class="p">()</span> <span class="o">!==</span> <span class="k">this</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">virtualize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">target</span> <span class="p">)</span> <span class="p">);</span>
                </pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>If a previously initiated transition is still underway, it needs to be
notified that it won’t finish.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
                </pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>The <code>source</code> variable will reference the previously current state (or abortive
transition).</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">source</span> <span class="o">=</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p>The upcoming transition will start from its <code>source</code> and proceed within the
<code>domain</code> of the least common ancestor between that state and the specified
target.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">domain</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">common</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span>
                </pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>Retrieve the appropriate transition expression for this origin/target pairing;
if none is defined, then an actionless default transition will be created and
applied, causing the callback to return immediately.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">transitionExpression</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTransitionExpressionFor</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">);</span>
                <span class="nx">transition</span> <span class="o">=</span> <span class="nx">setTransition</span><span class="p">(</span> <span class="k">new</span> <span class="nx">Transition</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span>
                    <span class="nx">transitionExpression</span> <span class="p">));</span>
                <span class="nx">info</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">transition</span><span class="o">:</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">forced</span><span class="o">:</span> <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">forced</span> <span class="p">};</span>
                </pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>Preparation for the transition begins by emitting a <code>depart</code> event on the
<code>source</code> state.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">source</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;depart&#39;</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>Enter into the transition state.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">setCurrent</span><span class="p">(</span> <span class="nx">transition</span> <span class="p">);</span>
                <span class="nx">transition</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;enter&#39;</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                </pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>Walk up to the top of the domain, emitting <code>exit</code> events for each state
along the way.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">while</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">!==</span> <span class="nx">domain</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">state</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">attachTo</span><span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">);</span>
                <span class="p">}</span>
                </pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>Provide an enclosed callback that will be called from <code>transition.end()</code> to
conclude the transition.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">transition</span><span class="p">.</span><span class="nx">setCallback</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">pathToState</span> <span class="o">=</span> <span class="p">[],</span>
                        <span class="nx">state</span><span class="p">,</span> <span class="nx">substate</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>
                    </pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>Trace a path from <code>target</code> up to <code>domain</code>, then walk down it, emitting
<code>enter</code> events for each state along the way.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span> <span class="nx">state</span> <span class="o">!==</span> <span class="nx">domain</span><span class="p">;</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">pathToState</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">;</span> <span class="nx">substate</span> <span class="o">=</span> <span class="nx">pathToState</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">substate</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isShallow</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">state</span><span class="p">.</span><span class="nx">hasHistory</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">push</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">substate</span> <span class="p">);</span>
                        <span class="p">}</span>
                        <span class="nx">transition</span><span class="p">.</span><span class="nx">attachTo</span><span class="p">(</span> <span class="nx">substate</span> <span class="p">);</span>
                        <span class="nx">substate</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;enter&#39;</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>Exit from the transition state.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">transition</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="nx">setCurrent</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p>Terminate the transition with an <code>arrive</code> event on the targeted state.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">target</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;arrive&#39;</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    </pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p>For each state from <code>target</code> to <code>root</code> that records a deep history, push a
new element that points to <code>target</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span> <span class="nx">state</span><span class="p">;</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">isShallow</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">state</span><span class="p">.</span><span class="nx">hasHistory</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">push</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">target</span> <span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p>Any virtual states that were previously active are no longer needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">annihilate</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">);</span>
                        <span class="nx">origin</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>Now complete, the <code>Transition</code> instance can be discarded.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">transition</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                    <span class="nx">transition</span> <span class="o">=</span> <span class="nx">setTransition</span><span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>
                    
                    <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

                    <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
                <span class="p">});</span>
                </pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <p>At this point the transition is attached to the <code>domain</code> state and is ready
to proceed.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">return</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">arguments</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">target</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>
    </pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <h3>Prototype methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">StateController</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <h4>toString</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <h4>getTransitionExpressionFor</h4>

<p>Finds the appropriate transition expression for the given origin and target states. If
no matching transitions are defined in any of the states, returns a generic actionless
transition expression for the origin/target pair.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">getTransitionExpressionFor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">origin</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">origin</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">()</span> <span class="p">);</span>
            
            <span class="kd">function</span> <span class="nx">search</span> <span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">until</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">transitions</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">admit</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span> <span class="o">!==</span> <span class="nx">until</span><span class="p">;</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">until</span> <span class="o">?</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">transitions</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">transitions</span><span class="p">();</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">transitions</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">expr</span> <span class="o">=</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">guards</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">guards</span> <span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span> <span class="nx">admit</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">.</span><span class="nx">admit</span> <span class="p">)</span> <span class="o">||</span>
                                    <span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">admit</span> <span class="p">)</span> <span class="o">||</span>
                                    <span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">admit</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span> <span class="p">)</span>
                                <span class="o">&amp;&amp;</span>
                            <span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">target</span> <span class="o">?</span> <span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">state</span> <span class="o">===</span> <span class="nx">target</span> <span class="p">)</span>
                                <span class="o">&amp;&amp;</span>
                            <span class="p">(</span> <span class="o">!</span><span class="nx">expr</span><span class="p">.</span><span class="nx">origin</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">origin</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">expr</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            </pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <p>Search order:
1. <code>target</code>,
2. <code>origin</code>,
3. superstates of <code>target</code>,
4. superstates of <code>origin</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="p">(</span>
                <span class="nx">search</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">||</span>
                <span class="nx">origin</span> <span class="o">!==</span> <span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="nx">search</span><span class="p">(</span> <span class="nx">origin</span> <span class="p">)</span> <span class="o">||</span>
                <span class="nx">search</span><span class="p">(</span> <span class="nx">target</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">search</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">)</span> <span class="o">||</span>
                <span class="o">!</span><span class="nx">target</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="nx">origin</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">search</span><span class="p">(</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">common</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="p">)</span> <span class="o">||</span>
                <span class="k">new</span> <span class="nx">TransitionExpression</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">StateController</span><span class="p">;</span>
<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <h2>StateEvent <a name="state-event" href="#state-event">&#x1f517;</a></h2>

<p>When an event is emitted from a state, it passes a <code>StateEvent</code> object to any bound listeners,
containing the <code>type</code> string and a reference to the contextual <code>state</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">StateEvent</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">StateEvent</span> <span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">target</span><span class="o">:</span> <span class="nx">state</span><span class="p">,</span>
            <span class="nx">name</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">StateEvent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;StateEvent (&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;) &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="k">return</span> <span class="nx">StateEvent</span><span class="p">;</span>
<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <h2>StateEventCollection <a name="state-event-collection" href="#state-event-collection">&#x1f517;</a></h2>

<p>A state holds event listeners for each of its various event types in a <code>StateEventCollection</code>
instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">StateEventCollection</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">guid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">StateEventCollection</span> <span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">StateEventCollection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-176">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-176">&#182;</a>               </div>               <h4>guid</h4>

<p>Produces a unique numeric string, to be used as a key for bound event listeners.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">guid</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span> <span class="o">++</span><span class="nx">guid</span> <span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-177">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-177">&#182;</a>               </div>               <h4>get</h4>

<p>Retrieves a bound listener associated with the provided <code>id</code> string as returned by
the prior call to <code>add</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-178">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-178">&#182;</a>               </div>               <h4>key</h4>

<p>Retrieves the <code>id</code> string associated with the provided listener.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">key</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">listener</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">listener</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-179">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-179">&#182;</a>               </div>               <h4>keys</h4>

<p>Returns the set of <code>id</code> strings associated with all bound listeners.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">keys</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="nx">result</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">join</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-180">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-180">&#182;</a>               </div>               <h4>add</h4>

<p>Binds a listener, along with an optional context object, to be called when the
the collection <code>emit</code>s an event. Returns a unique key that can be used later to
<code>remove</code> the listener.</p>

<p><em>Aliases:</em> <strong>on bind</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*Function*/</span> <span class="nx">fn</span><span class="p">,</span>
              <span class="cm">/*Object*/</span> <span class="nx">context</span>  <span class="c1">// optional</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">guid</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">context</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">?</span> <span class="p">[</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span> <span class="p">]</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="o">++</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-181">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-181">&#182;</a>               </div>               <h4>remove</h4>

<p>Unbinds a listener. Accepts either the numeric string returned by <code>add</code> or a reference
to the function itself.</p>

<p><em>Aliases:</em> <strong>off unbind</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Function | String*/</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span>
                <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
            
            <span class="nx">fn</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span> <span class="k">typeof</span> <span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span> <span class="nx">id</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">id</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">fn</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">delete</span> <span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="o">--</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-182">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-182">&#182;</a>               </div>               <h4>empty</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">empty</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="k">delete</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-183">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-183">&#182;</a>               </div>               <h4>emit</h4>

<p>Emits a <code>StateEvent</code> to all bound listeners.</p>

<p><em>Alias:</em> <strong>trigger</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">emit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">itemType</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span>
                <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
            
            <span class="nx">state</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">item</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">itemType</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span> <span class="nx">item</span> <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">itemType</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">fn</span> <span class="o">=</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">itemType</span> <span class="o">===</span> <span class="s1">&#39;array&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">fn</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-184">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-184">&#182;</a>               </div>               <p>If <code>item</code> is a String or State, interpret this as an implied transition to be
instigated after all of the callbacks have been invoked.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">itemType</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="nx">item</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">target</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">context</span><span class="p">,</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">StateEvent</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">].</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">);</span>
                <span class="nx">fn</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-185">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-185">&#182;</a>               </div>               <h4>destroy</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">Z</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span> <span class="nx">StateEventCollection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">add</span><span class="o">:</span> <span class="s1">&#39;on bind&#39;</span><span class="p">,</span>
        <span class="nx">remove</span><span class="o">:</span> <span class="s1">&#39;off unbind&#39;</span><span class="p">,</span>
        <span class="nx">emit</span><span class="o">:</span> <span class="s1">&#39;trigger&#39;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">StateEventCollection</span><span class="p">;</span>
<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-186">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-186">&#182;</a>               </div>               <h2>Transition <a name="transition" href="#transition">&#x1f517;</a></h2>

<p>A <strong>transition</strong> is a transient <code>State</code> adopted by a controller as it changes from one of its
proper <code>State</code>s to another.</p>

<p>A transition acts within the <strong>domain</strong> of the <em>least common ancestor</em> between its <strong>origin</strong>
and <strong>target</strong> states. During this time it behaves as if it were a substate of that domain
state, inheriting method calls and propagating events in the familiar fashion.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Transition</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">Z</span><span class="p">.</span><span class="nx">inherit</span><span class="p">(</span> <span class="nx">Transition</span><span class="p">,</span> <span class="nx">State</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-187">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-187">&#182;</a>               </div>               <h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">Transition</span> <span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">TransitionExpression</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
        <span class="p">}</span>
        
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">methods</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">events</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">guards</span> <span class="o">=</span> <span class="p">{},</span></pre></div>             </td>           </tr>                               <tr id="section-188">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-188">&#182;</a>               </div>               <p>The <strong>action</strong> of a transition is a function that will be called after the
transition has been <code>start</code>ed. This function, if provided, is responsible for
calling <code>end()</code> on the transition at some point in the future.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">action</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">action</span><span class="p">,</span>

            <span class="nx">attachment</span> <span class="o">=</span> <span class="nx">source</span><span class="p">,</span>
            <span class="nx">controller</span><span class="p">,</span> <span class="nx">aborted</span><span class="p">;</span>
        
        <span class="nx">controller</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="o">!==</span> <span class="nx">target</span><span class="p">.</span><span class="nx">controller</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">controller</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-189">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-189">&#182;</a>               </div>               <p>(Exposed for debugging.)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">__private__</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{</span>
            <span class="nx">methods</span><span class="o">:</span> <span class="nx">methods</span><span class="p">,</span>
            <span class="nx">events</span><span class="o">:</span> <span class="nx">events</span><span class="p">,</span>
            <span class="nx">action</span><span class="o">:</span> <span class="nx">action</span>
        <span class="p">});</span>

        <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-190">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-190">&#182;</a>               </div>               <h4>superstate</h4>

<p>In a transition, <code>superstate</code> is used to track its position as it traverses the
<code>State</code> subtree that defines its domain.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">superstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">attachment</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-191">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-191">&#182;</a>               </div>               <h4>attachTo</h4>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">attachTo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">attachment</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-192">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-192">&#182;</a>               </div>               <h4>controller</h4>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">controller</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-193">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-193">&#182;</a>               </div>               <h4>origin</h4>

<p>A transition's <strong>origin</strong> is the controller’s most recently active <code>State</code> that is
not itself a <code>Transition</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">origin</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">source</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="o">?</span> <span class="nx">source</span><span class="p">.</span><span class="nx">origin</span><span class="p">()</span> <span class="o">:</span> <span class="nx">source</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-194">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-194">&#182;</a>               </div>               <h4>source</h4>

<p>A transition’s <strong>source</strong> is the <code>State</code> or <code>Transition</code> that immediately preceded
<code>this</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">source</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">source</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-195">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-195">&#182;</a>               </div>               <h4>target</h4>

<p>The intended destination <code>State</code> for this transition. If a target is invalidated by
a controller that <code>change</code>s state again before this transition completes, then this
transition is aborted and the <code>change</code> call will create a new transition that is
<code>source</code>d from <code>this</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">target</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">target</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-196">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-196">&#182;</a>               </div>               <h4>setCallback</h4>

<p>Allows the callback function to be set or changed prior to the transition’s
completion.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">setCallback</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-197">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-197">&#182;</a>               </div>               <h4>aborted</h4>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">aborted</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">aborted</span><span class="p">;</span> <span class="p">},</span>
            </pre></div>             </td>           </tr>                               <tr id="section-198">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-198">&#182;</a>               </div>               <h4>start</h4>

<p>Starts the transition; if an <code>action</code> is defined, that function is responsible
for declaring an end to the transition by calling <code>end()</code>. Otherwise, the
transition is necessarily synchronous and is concluded immediately.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">aborted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">action</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">action</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">action</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>
            </pre></div>             </td>           </tr>                               <tr id="section-199">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-199">&#182;</a>               </div>               <h4>abort</h4>

<p>Indicates that a transition won’t directly reach its target state; for example, if a
new transition is initiated while an asynchronous transition is already underway,
that previous transition is aborted. The previous transition is retained as the
<code>source</code> for the new transition.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">abort</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">aborted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">callback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;abort&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">},</span>
            </pre></div>             </td>           </tr>                               <tr id="section-200">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-200">&#182;</a>               </div>               <h4>end</h4>

<p>Indicates that a transition has completed and has reached its intended target. The
transition is subsequently retired, along with any preceding aborted transitions.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">end</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">aborted</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">controller</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
            <span class="p">},</span>
            </pre></div>             </td>           </tr>                               <tr id="section-201">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-201">&#182;</a>               </div>               <h4>destroy</h4>

<p>Destroys this transition and clears its held references, and does the same for any
aborted <code>source</code> transitions that preceded it.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">source</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="o">&amp;&amp;</span> <span class="nx">source</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="nx">target</span> <span class="o">=</span> <span class="nx">attachment</span> <span class="o">=</span> <span class="nx">controller</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="nx">Z</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;init&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">TransitionExpression</span> <span class="p">],</span>
            <span class="s1">&#39;method methodNames addMethod removeMethod&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">methods</span> <span class="p">],</span>
            <span class="s1">&#39;event addEvent removeEvent emit&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">events</span> <span class="p">],</span>
            <span class="s1">&#39;guard addGuard removeGuard&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">guards</span> <span class="p">]</span>
        <span class="p">});</span>
        <span class="nx">Z</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span> <span class="nx">addEvent</span><span class="o">:</span> <span class="s1">&#39;on bind&#39;</span><span class="p">,</span> <span class="nx">removeEvent</span><span class="o">:</span> <span class="s1">&#39;off unbind&#39;</span><span class="p">,</span> <span class="nx">emit</span><span class="o">:</span> <span class="s1">&#39;trigger&#39;</span> <span class="p">}</span> <span class="p">);</span>
        
        <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">);</span>
        <span class="nx">expression</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">Transition</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">transition</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">source</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">source</span><span class="p">()</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">transition</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span>
            <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">count</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="k">return</span> <span class="nx">Transition</span><span class="p">;</span>
<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-202">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-202">&#182;</a>               </div>               <h2>TransitionExpression <a name="transition-expression" href="#transition-expression">&#x1f517;</a></h2>

<p>A state may hold <strong>transition expressions</strong> that describe the transition that will take place
between any two given <strong>origin</strong> and <strong>target</strong> states.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">TransitionExpression</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">properties</span>   <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">TRANSITION_PROPERTIES</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span>
        <span class="nx">categories</span>   <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">TRANSITION_EXPRESSION_CATEGORIES</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span>
        <span class="nx">eventTypes</span>   <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">TRANSITION_EVENT_TYPES</span> <span class="p">),</span>
        <span class="nx">guardActions</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">GUARD_ACTIONS</span> <span class="p">);</span>
    </pre></div>             </td>           </tr>                               <tr id="section-203">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-203">&#182;</a>               </div>               <h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">TransitionExpression</span> <span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">map</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">Z</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">map</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="o">?</span> <span class="nx">map</span> <span class="o">:</span> <span class="nx">interpret</span><span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-204">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-204">&#182;</a>               </div>               <h3>Class-private functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-205">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-205">&#182;</a>               </div>               <h4>interpret</h4>

<p>Rewrites a plain object map as a well-formed <code>TransitionExpression</code>, making the appropriate
inferences for any shorthand notation encountered.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">interpret</span> <span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="p">{},</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">categories</span> <span class="p">),</span>
            <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">events</span><span class="p">;</span>
        
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">map</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">properties</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">categories</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">],</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">category</span> <span class="o">=</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">eventTypes</span> <span class="o">?</span> <span class="s1">&#39;events&#39;</span> <span class="o">:</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">guardActions</span> <span class="o">?</span> <span class="s1">&#39;guards&#39;</span> <span class="o">:</span>
                    <span class="s1">&#39;methods&#39;</span><span class="p">;</span>
                <span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">)[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="p">(</span> <span class="nx">events</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">events</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">value</span> <span class="p">]</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">TransitionExpression</span><span class="p">;</span>
<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-206">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-206">&#182;</a>               </div>               <p>Make the set of defined classes available as members of the exported module.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">State</span><span class="o">:</span> <span class="nx">State</span><span class="p">,</span>
    <span class="nx">StateExpression</span><span class="o">:</span> <span class="nx">StateExpression</span><span class="p">,</span>
    <span class="nx">StateController</span><span class="o">:</span> <span class="nx">StateController</span><span class="p">,</span>
    <span class="nx">StateEvent</span><span class="o">:</span> <span class="nx">StateEvent</span><span class="p">,</span>
    <span class="nx">StateEventCollection</span><span class="o">:</span> <span class="nx">StateEventCollection</span><span class="p">,</span>
    <span class="nx">Transition</span><span class="o">:</span> <span class="nx">Transition</span><span class="p">,</span>
    <span class="nx">TransitionExpression</span><span class="o">:</span> <span class="nx">TransitionExpression</span>
<span class="p">});</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 