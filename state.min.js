(function(a,b){var c=a.extend(!0,function c(d,e,f){if(!(this instanceof c))return c.Definition.apply(this,arguments);f instanceof c.Definition||(f=c.Definition(f));var g=this,h={},i={},j={},k=[],l;a.extend(this,{methods:h,events:i,rules:j,substates:k}),a.extend(this,{name:(l=function(){return e||""}).toString=l,superstate:function(){return d},method:function(a){return h[a]||d instanceof c&&d.method(a)||b},hasMethod:function(a,b){return a in h||b&&d instanceof c&&d.hasMethod(a,b)},addMethod:function(a,b){return h[a]=b},removeMethod:function(a){var b=h[a];delete h[a];return b},addEventListener:function(a,b){var d=i[a];if(!d)throw new c.EventError("Invalid event type");return d.add(b)},removeEventListener:function(a,b){return i[a].remove(b)},getEventListener:function(a,b){return i[a].get(b)},getEventListeners:function(a){return i[a]},triggerEvents:function(a){if(i[a])return i[a].trigger();throw new c.EventError("Invalid event type")},rule:function(a){return f.rules?f.rules[a]:b},addState:function(a,b){var d=this[a]=new c(this,a,b);k.push(d);return d},removeState:function(){throw new c.Error("Not implemented")},substates:function(a){if(a){var b=[];for(var c in k)b=b.concat(k[c],k[c].substates(!0));return b}return k.slice(0)}}),a.each(["enter","leave","enterSubstate","leaveSubstate"],function(a,b){i[b]=new c.Event.Collection(g,b)}),a.each({methods:function(a,b){g.addMethod(a,b)},events:function(b,c){c instanceof Array?a.each(c,function(a,c){g.addEventListener(b,c)}):g.addEventListener(b,c)},rules:function(a,b){j[a]=b},states:function(a,b){g.addState(a,b)}},function(b,c){f[b]&&a.each(f[b],c)})},{prototype:{controller:function(){var a=this.superstate();return a instanceof c?a.controller():a},toString:function(){return(this.superstate()instanceof c?this.superstate().toString()+".":"")+this.name()},select:function(){return this.controller().changeState(this)?this:!1},isSelected:function(){return this.controller().currentState()===this},isSuperstateOf:function(a){var b=a.superstate();return b instanceof c?this===b||this.isSuperstateOf(b):!1},allowLeavingTo:function(a){return!0},allowEnteringFrom:function(a){return!0},evaluateRule:function(c,d){var e=this,f=this.rule(c),g;f&&a.each(f,function(c,f){a.each(c.split(","),function(b,c){if(e.match(a.trim(c),d)){g=typeof f=="function"?!!f.apply(e,[d]):!!f;return!1}});return g===b});return g===b||g},match:function(d,e){var f=d.split("."),g=f.length&&f[0]===""?(f.shift(),this):this.controller().defaultState(),h;if(f.length){a.each(f,function(a,b){if(b==="")g=g.superstate();else if(g[b]instanceof c)g=g[b];else{if(b=="*"){h=e?g===e.superstate():g.substates();return!1}if(b=="**"){h=e?g.isSuperstateOf(e):g.substates(!0);return!1}return h=!1}});return h!==b?h:!e||g===e?g:!1}return g}},object:function(){var a=c.Controller.apply(this,arguments);a.owner().state=a;return a.owner()},define:function(a){console.warn("State.define : marked for deprecation, use State.Definition() instead");return new c.Definition(a)}});c.Definition=a.extend(!0,function(b){if(!(this instanceof c.Definition))return new c.Definition(b);a.extend(!0,this,b instanceof c.Definition?b:c.Definition.expand(b))},{members:["methods","events","rules","states"],blankMap:function(){var b={};a.each(this.members,function(a,c){b[c]=null});return b},isComplex:function(b){var c;a.each(this.members,function(d,e){return!(c=e in b&&!a.isFunction(b[e]))});return c},expand:function(b){var d=this.blankMap();a.isArray(b)?a.each(this.members,function(a,c){return a<b.length&&(d[c]=b[a])}):a.isPlainObject(b)&&a.extend(this.isComplex(b)?d:d.methods={},b),d.events&&a.each(d.events,function(b,e){typeof e=="function"&&(d.events[b]=e=[e]);if(!a.isArray(e))throw new c.DefinitionError}),d.states&&a.each(d.states,function(a,b){d.states[a]=b instanceof c.Definition?b:c.Definition(b)});return d},create:function(b){var d=this.blankMap();if(a.isPlainObject(b))d.methods=b;else if(a.isArray(b))a.each(this.members,function(a,c){return a<b.length&&(d[c]=b[a])});else throw new c.DefinitionError;return d},Set:function(b){a.each(b,function(a,d){d instanceof c.Definition||(b[a]=c.Definition(d))}),a.extend(!0,this,b)}}),c.Controller=a.extend(!0,function(d,e,f){if(!(this instanceof c.Controller))return new c.Controller(d,e,f);if(arguments.length<2||typeof e=="string")f=e,e=d,d=this;var g=this,h=new c(this),i=h;a.extend(this,{owner:function(){return d},defaultState:function(){return h},currentState:function(){return i},addState:function(e,f){f instanceof c.Definition||(f=new c.Definition(f));var i=g[e]=h.addState(e,f);f.methods&&a.each(f.methods,function(a,e){h.hasMethod(a)||(d[a]!==b&&h.addMethod(a,d[a]),d[a]=function(){var b=g.getMethod(a);if(b)return b.apply(d,arguments);if(h[a])return h[a];throw new c.Error("Invalid method call for current state")})});return i},removeState:function(a){throw new Error("State.Controller.removeState not implemented yet")},changeState:function(a){a instanceof c||(a=a?this.getState(a):h);if(!a||a.controller()!==this)throw new Error("Invalid state");if(i.evaluateRule("allowLeavingTo",a)){if(a.evaluateRule("allowEnteringFrom",i)){i.triggerEvents("leave"),i=a,i.triggerEvents("enter");return g}console.warn(a+".allowEnteringFrom("+i+") denied");return!1}console.warn(i+".allowLeavingTo("+a+") denied");return!1}}),d!==this&&a.extend(this,{current:this.currentState,add:this.addState,remove:this.removeState,change:this.changeState,is:this.isInState,get:this.getState,method:this.getMethod});if(e){var j=e instanceof c.Definition.Set?e:new c.Definition.Set(e);a.each(j,function(a,b){g.addState(a,b)})}i=this.getState(f)||this.defaultState()},{prototype:{toString:function(){return this.currentState().toString()},match:function(a,b){return this.currentState().match(a,b)},getState:function(a,c){if(a===b)return this.currentState();return c?c.match(a):this.match(a)},isInState:function(a,b){var c=this.getState(a,b),d=this.currentState();return c===d||c.isSuperstateOf(d)?c:!1},getMethod:function(a){return this.currentState().method(a)},superstate:function(a){var b=this.currentState().superstate();return a?b.method(a):b}}}),c.Event=a.extend(!0,function(b,c){a.extend(this,{target:b,name:b.name,type:c})},{prototype:{toString:function(){return"StateEvent"},log:function(a){console.log(this+" "+this.name+"."+this.type+(a?" "+a:""))}},Collection:a.extend(!0,function(d,e){var f={},g=0,h=(h=function(){return g}).toString=h;a.extend(this,{length:h,get:function(a){return f[a]},key:function(c){var d;a.each(f,function(a,e){d=e===c?a:b;return d===b});return d},keys:function(){var b=[];b.toString=function(){return"["+b.join()+"]"},a.each(f,function(a){b.push(a)});return b},add:function(a){var b=this.guid();f[b]=a,g++;return b},remove:function(a){var b=f[a];if(b){delete f[a],g--;return b}return!1},empty:function(){if(g){for(var a in f)delete f[a];g=0;return!0}return!1},trigger:function(){a.each(f,function(a,b){b.apply(d,[new c.Event(d,e)])})}})},{__guid__:0,prototype:{guid:function(){return(++this.constructor.__guid__).toString()}}})}),c.Transition=a.extend(!0,function(a,b){},{prototype:a.extend(!0,new c,{start:function(){},abort:function(){},finish:function(){}}),Definition:a.extend(!0,function(a){},{})}),c.Error=a.extend(!0,function(a){this.name="StateError",this.message=a},{prototype:{"__proto__":Error.prototype}}),c.EventError=a.extend(!0,function(a){this.name="StateEventError",this.message=a},{prototype:{"__proto__":c.Error.prototype}}),c.DefinitionError=a.extend(!0,function(a){this.name="StateDefinitionError",this.message=a},{prototype:{"__proto__":c.Error.prototype}}),a.State=window.State=c})(jQuery)