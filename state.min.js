(function(a,b){var c={slice:function(a,b,c){return Array.prototype.slice.call(a,b,c)},extend:function(a){return a},each:function(a,b){return a},isArray:function(a){return!1},isFunction:function(a){return!1},resolveOverloads:function(a,c){var d,e=[],f,g={};a=this.slice(a);for(d in a){if(a[d]===b)break;e.push(typeof a[d])}if(e.length&&(e=e.join())in c){f=c[e].split(",");for(d in f)g[f[d]]=a[d]}return g}};a||(a=c);var d=a.extend(!0,function d(c,e,f){if(!(this instanceof d))return(arguments.length<2?d.Definition:d.Controller.forObject).apply(this,arguments);var g=this,h=!1,i={},j={},k={},l={},m;a.extend(this,{methods:i,events:j,rules:k,substates:l}),a.extend(this,{superstate:function(){return c},derivation:function(a){for(var b=[],c,d=this;(c=d)&&(d=c.superstate());d&&b.unshift(a?c.name()||"":c));return b},protostate:function(){function j(){g=g.__proto__||g.constructor.prototype,i=g&&g.hasOwnProperty(e)&&g[e]instanceof d.Controller?g[e].defaultState():b}var a=this.derivation(!0),c=this.controller(),e=c.name(),f=c.owner(),g=f,h,i;e||debugger;for(j();i;j()){for(h in a)if(!(i=i[a[h]]))break;if(i)return i}},name:(m=function(){return e||""}).toString=m,definition:function(){return f},build:function(b){b&&(f=b),f instanceof d.Definition||(f=d.Definition(f)),a.each({methods:function(a,b){g.addMethod(a,b)},events:function(b,c){a.isArray(c)?a.each(c,function(a,c){g.addEvent(b,c)}):g.addEvent(b,c)},rules:function(a,b){g.addRule(a,b)},states:function(a,b){g.addState(a,b)}},function(b,c){f[b]&&a.each(f[b],c)});return this},method:function(a,d,e){var f;d===b&&(d=!0),e===b&&(e=!0);return i[a]||e&&(f=this.protostate())&&f.method(a,!1,!0)||d&&c&&c.method(a,!0,e)||b},addMethod:function(a,e){var f=this.controller(),g=f.defaultState(),h=f.owner();this.method(a,!0,!1)||(c&&h[a]!==b&&g.addMethod(a,h[a]),h[a]=d.delegate(h,a,f));return i[a]=e},removeMethod:function(a){var b=i[a];delete i[a];return b},addEvent:function(a,b){var c=j[a];if(!c)throw new Error("Invalid event type");return c.add(b)},removeEvent:function(a,b){return j[a].remove(b)},getEvent:function(a,b){return j[a].get(b)},getEvents:function(a){return j[a]},triggerEvents:function(a,b){var c=j[a];if(!c)throw new Error("Invalid event type");return c.trigger(b)},rule:function(a){var c;return f&&f.rules&&f.rules[a]||(c=this.protostate())&&c.rule(a)||b},addRule:function(a,b){k[a]=b},removeRule:function(a,b){throw new Error("Not implemented")},addState:function(a,b){var c,e=this.controller();(c=l[a])&&c.destroy(),c=this[a]=l[a]=new d(this,a,b),e&&e.defaultState()===this&&(e[a]=c);return c},removeState:function(a){var b=l[a],c,d;if(b){c=this.controller(),d=c.currentState(),c.isInState(b)&&c.changeState(this,{forced:!0}),delete l[a];return b}},substate:function(a,c){var d;c===b&&(c=!0);return l[a]||c&&((d=this.protostate())?d.substate(a):b)},substateCollection:function(a){var b=[],c;for(c in l)b.push(l[c]),a&&(b=b.concat(l[c].substateCollection(!0)));return b},destroy:function(){var a=this.controller(),b=a.transition(),c,d;if(b){c=b.origin(),d=b.destination();if(this===c||this.isSuperstateOf(c)||this===d||this.isSuperstateOf(d))return!1}for(var e in l)l[e].destroy();h=!0}}),a.each(["enter","exit","arrive","depart"],function(a,b){j[b]=new d.Event.Collection(g,b)}),c&&this.build()},{prototype:{toString:function(){return this.derivation(!0).join(".")},controller:function(){return this.superstate().controller()},depth:function(){for(var a=0,b=this;b.superstate();a++,b=b.superstate());return a},common:function(a){var b;for(this.depth()>a.depth()?(b=a,a=this):b=this;b;b=b.superstate())if(b===a||b.isSuperstateOf(a))return b},isIn:function(a){a instanceof d||(a=this.match(a));return a===this||a.isSuperstateOf(this)},isSuperstateOf:function(a){var b;a instanceof d||(a=this.match(a));return(b=a.superstate())?this===b||this.isSuperstateOf(b):!1},isProtostateOf:function(a){var b;a instanceof d||(a=this.match(a));return(b=a.protostate())?this===b||this.isProtostateOf(b):!1},hasOwnMethod:function(a){return!!this.method(a,!1,!1)},select:function(){return this.controller().changeState(this)?this:!1},isSelected:function(){return this.controller().currentState()===this},evaluateRule:function(c,d){var e=this,f=this.rule(c),g;f&&a.each(f,function(c,f){a.each(c.split(","),function(b,c){if(e.match(a.trim(c),d)){g=typeof f=="function"?!!f.apply(e,[d]):!!f;return!1}});return g===b});return g===b||g},match:function(c,d){var e=c.split("."),f=e.length&&e[0]===""?(e.shift(),this):this.controller().defaultState(),g,h;if(e.length){a.each(e,function(a,b){if(b==="")f=f.superstate();else if(g=f.substate(b))f=g;else{if(b=="*"){h=d?f===d.superstate():f.substateCollection();return!1}if(b=="**"){h=d?f.isSuperstateOf(d):f.substateCollection(!0);return!1}return h=!1}});return h!==b?h:!d||f===d?f:!1}return f}},delegate:function(a,c,d){return function(){var e=d.getMethod(c);return e?e.apply(a,arguments):b}}});d.Definition=a.extend(!0,function(b){if(!(this instanceof d.Definition))return new d.Definition(b);a.extend(!0,this,b instanceof d.Definition?b:d.Definition.expand(b))},{members:["methods","events","rules","states"],blankMap:function(){var b={};a.each(this.members,function(a,c){b[c]=null});return b},isComplex:function(b){var c;a.each(this.members,function(d,e){return!(c=e in b&&!a.isFunction(b[e]))});return c},expand:function(b){var c=this.blankMap();if(a.isArray(b))a.each(this.members,function(a,d){return a<b.length&&(c[d]=b[a])});else if(a.isPlainObject(b))if(this.isComplex(b))a.extend(c,b);else for(var e in b){var f=/^_*[A-Z]/.test(e)?"states":"methods";(c[f]||(c[f]={}))[e]=b[e]}c.events&&a.each(c.events,function(b,d){typeof d=="function"&&(c.events[b]=d=[d]);if(!a.isArray(d))throw new Error}),c.states&&a.each(c.states,function(a,b){c.states[a]=b instanceof d.Definition?b:d.Definition(b)});return c},create:function(b){var c=this.blankMap();if(a.isPlainObject(b))c.methods=b;else if(a.isArray(b))a.each(this.members,function(a,d){return a<b.length&&(c[d]=b[a])});else throw new Error;return c},Set:function(b){a.each(b,function(a,c){c instanceof d.Definition||(b[a]=d.Definition(c))}),a.extend(!0,this,b)}}),d.Controller=a.extend(!0,function(b,e,f,g){if(!(this instanceof d.Controller))return new d.Controller(b,e,f,g);var h,i,j,k,l=this,m=c.resolveOverloads(arguments,this.constructor.overloads);b=m.owner,e=m.name||"state",f=m.definition instanceof d.Definition?m.definition:d.Definition(m.definition),g=m.initialState,a.extend(this,{owner:function(){return b},name:(k=function(){return e}).toString=k,defaultState:function(){return h},currentState:function(){return i||h},transition:function(){return j},addState:function(a,b){return h.addState(a,b)},removeState:function(a){throw new Error("State.Controller.removeState not implemented yet")},createProxy:function(a){function i(){return f.substate(e=c.shift(),!1)}var c,f,g;e;if(a instanceof d&&a.controller().owner().isPrototypeOf(b)&&(c=a.derivation(!0)).length){for(f=h,g=i();g;f=g,g=i());while(e)f=new d.Proxy(f,e),e=c.shift();return f}},destroyProxy:function(a){var b;while(a instanceof d.Proxy)b=a.superstate(),a.destroy(),a=b},changeState:function(a,c){var e,f,g,j,k,l,m;a instanceof d||(a=a?this.getState(a):h);if(!a||(e=a.controller().owner())!==b&&!e.isPrototypeOf(b))throw new Error("Invalid state");c||(c={}),g=j?j.origin():i;if(c.forced||g.evaluateRule("allowDepartureTo",a)&&a.evaluateRule("allowArrivalFrom",g)){a&&a.controller()!==this&&(a=this.createProxy(a)),j&&j.abort(),f=i,i=j=new d.Transition(f,a),k=f.common(a),l={transition:j,forced:!!c.forced},f.triggerEvents("depart",l);for(m=f;m!==k;m=m.superstate())j.attachTo(m.superstate()),m.triggerEvents("exit",l);j.start(function(){var b=[];for(m=a;m!==k;b.push(m),m=m.superstate());while(b.length)j.attachTo(m=b.pop()),m.triggerEvents("enter",l);g instanceof d.Proxy&&this.destroyProxy(g),i=a,i.triggerEvents("arrive",l),j.destroy(),j=null,typeof c.success=="function"&&c.success.call(this);return this});return this}typeof c.failure=="function"&&c.failure.call(this);return!1}}),b!==this&&a.extend(this,{current:this.currentState,add:function(){return this.addState.apply(this,arguments)?this:!1},remove:this.removeState,change:function(){return this.changeState.apply(this,arguments)?this.owner():!1},is:this.isInState,get:this.getState,method:this.getMethod}),(h=a.extend(new d,{controller:function(){return l}})).build(f),i=g?this.getState(g):h,i.controller()===this||(i=this.createProxy(i))},{overloads:{"object,string,object,string":"owner,name,definition,initialState","object,string,object":"owner,name,definition","object,object,string":"owner,definition,initialState","string,object,string":"name,definition,initialState","object,object":"owner,definition","string,object":"name,definition","object,string":"definition,initialState",object:"definition",string:"name"},prototype:{toString:function(){return this.currentState().toString()},match:function(a,b){return this.currentState().match(a,b)},getState:function(a,c){return a===b?this.currentState():(c||this).match(a)},isInState:function(a,b){var c=this.getState(a,b),d=this.currentState();return c===d||c.isSuperstateOf(d)},getMethod:function(a){return this.currentState().method(a)},superstate:function(a){var c=this.currentState().superstate();return a===b?c:c.method(a)}},forObject:function(){var a=d.Controller.apply(null,arguments);a.owner()[a.name()]=a;return a.owner()}}),d.Event=a.extend(!0,function(b,c){a.extend(this,{target:b,name:b.name,type:c})},{prototype:{toString:function(){return"StateEvent ("+this.type+") "+this.name},log:function(a){console&&console.log(this+" "+this.name+"."+this.type+(a?" "+a:""))}},Collection:a.extend(!0,function(b,c){var e={},f=0,g=(g=function(){return f}).toString=g;a.extend(this,{length:g,get:function(a){return e[a]},key:function(a){for(var b in e)if(e[b]===a)return b},keys:function(){var a=[];a.toString=function(){return"["+a.join()+"]"};for(var b in e)a.push(e[b]);return a},add:function(a){var b=this.guid();e[b]=a,f++;return b},remove:function(a){var b=e[a];if(b){delete e[a],f--;return b}return!1},empty:function(){if(f){for(var a in e)delete e[a];f=0;return!0}return!1},trigger:function(f){for(var g in e)e[g].apply(b,[a.extend(new d.Event(b,c),f)])}})},{__guid__:0,prototype:{guid:function(){return(++this.constructor.__guid__).toString()}}})}),d.Proxy=a.extend(!0,function(b,c){var d;a.extend(this,{superstate:function(){return b},name:(d=function(){return c||""}).toString=d,invalidate:function(){}})},{prototype:a.extend(!0,new d,{rule:function(a){this.protostate()||debugger;return this.protostate().rule(a)}})}),d.Transition=a.extend(!0,function(e,f,g){var h=this,i=e,j=(j=e.controller())===f.controller()?j:b,k,l;a.extend(this,{superstate:function(){return i},attachTo:function(a){i=a},controller:function(){return j},origin:function(){return e instanceof d.Transition?e.origin():e},source:function(){return e},destination:function(){return f},aborted:function(){return l},start:function(a){l=!1,k=a,typeof g=="function"?g.apply(this,c.slice(arguments,0,-1)):this.finish()},abort:function(){l=!0,k=null;return this},finish:function(){l||k.apply(j),this.destroy()},destroy:function(){e instanceof d.Transition&&e.destroy(),f=i=j=null}})},{prototype:a.extend(!0,new d,{depth:function(){for(var a=0,b=this;b.source()instanceof d.Transition;a++,b=b.source());return a}}),Definition:a.extend(!0,function(a){},{})}),this.State=d})(jQuery)