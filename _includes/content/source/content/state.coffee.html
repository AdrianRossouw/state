<div class="source-content">
  
    
    <div class="text">
      
    </div>
    <div class="code">
      <div class="highlight"><pre><span class="nv">O                     = </span><span class="nx">require</span> <span class="s1">&#39;omicron&#39;</span>
<span class="nv">state                 = </span><span class="nx">require</span> <span class="s1">&#39;./state-function&#39;</span>
<span class="nv">StateEventEmitter     = </span><span class="kc">null</span>
<span class="nv">StateExpression       = </span><span class="kc">null</span>
<span class="nv">TransitionExpression  = </span><span class="kc">null</span>

<span class="p">{</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">,</span> <span class="nx">TRAVERSAL_FLAGS</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">state</span>

<span class="nv">module.exports =</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h2><a href="#state">State</a></h2>
<p>A <strong>state</strong> defines a subset of behavior for its <strong>owner</strong> object. Each
<a href="/api/#state"><code>State</code></a> holds a reference to a <code>superstate</code>, from which it may
inherit more generic behavior, forming a <strong>state tree</strong> rooted by a single
<code>RootState</code>.</p>
<blockquote>
<p><a href="/docs/#concepts--states">States</a>
<a href="/docs/#concepts--object-model">Object model</a>
<a href="/docs/#concepts--object-model--superstates-and-substates">Superstates and substates</a></p>
</blockquote>
<p>The owner’s <code>RootState</code> designates exactly one of the <code>State</code>s in its tree as
its <code>current</code> state. This reference may be <strong>transitioned</strong> to a different
<code>State</code> in the tree, causing the owner’s projected behavior to change.</p>
<p>An owner and its tree of <code>State</code>s are also heritable along the owner’s
prototype chain. Inheritors of a stateful prototype effectively possess all of
the prototype’s <code>State</code>s, but each inheritor can adopt its own <code>current</code> state
and instigate transitions independently of the prototype.</p>
<blockquote>
<p><a href="/docs/#concepts--object-model--protostates-and-epistates">Protostates and epistates</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre><span class="k">class</span> <span class="nx">State</span>

  <span class="p">{</span> <span class="nx">memoizeProtostates</span><span class="p">,</span> <span class="nx">useDispatchTables</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">options</span>

  <span class="p">{</span> <span class="nx">env</span><span class="p">,</span> <span class="nx">NIL</span><span class="p">,</span> <span class="nx">isArray</span><span class="p">,</span> <span class="nx">isEmpty</span><span class="p">,</span> <span class="nx">has</span><span class="p">,</span> <span class="nx">hasOwn</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">O</span>
  <span class="p">{</span> <span class="nx">assign</span><span class="p">,</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">clone</span><span class="p">,</span> <span class="nx">lookup</span><span class="p">,</span> <span class="nx">flatten</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">O</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Bit field constants will be used extensively throughout the class’s constructor
and methods, so make them available as free variables.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="p">{</span>
    <span class="nx">INCIPIENT</span><span class="p">,</span> <span class="nx">ATOMIC</span><span class="p">,</span> <span class="nx">DESTROYED</span>
    <span class="nx">VIRTUAL</span>
    <span class="nx">PARASTATIC</span>
    <span class="nx">MUTABLE</span><span class="p">,</span> <span class="nx">FINITE</span><span class="p">,</span> <span class="nx">STATIC</span><span class="p">,</span> <span class="nx">IMMUTABLE</span>
    <span class="nx">INITIAL</span><span class="p">,</span> <span class="nx">CONCLUSIVE</span><span class="p">,</span> <span class="nx">FINAL</span>
    <span class="nx">ABSTRACT</span><span class="p">,</span> <span class="nx">CONCRETE</span><span class="p">,</span> <span class="nx">DEFAULT</span>
    <span class="nx">REFLECTIVE</span>
    <span class="nx">HISTORY</span><span class="p">,</span> <span class="nx">RETAINED</span><span class="p">,</span> <span class="nx">SHALLOW</span>
    <span class="nx">CONCURRENT</span>
    <span class="nx">NORMAL</span>
  <span class="p">}</span> <span class="o">=</span>
      <span class="nx">assign</span> <span class="k">this</span><span class="p">,</span> <span class="nx">STATE_ATTRIBUTES</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>For methods that query related states, the default behavior is to recurse
through substates, superstates, and protostates.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="p">{</span> <span class="nx">VIA_NONE</span><span class="p">,</span> <span class="nx">VIA_SUB</span><span class="p">,</span> <span class="nx">VIA_SUPER</span><span class="p">,</span> <span class="nx">VIA_PROTO</span><span class="p">,</span> <span class="nx">VIA_ALL</span> <span class="p">}</span> <span class="o">=</span>
      <span class="nx">assign</span> <span class="k">this</span><span class="p">,</span> <span class="nx">TRAVERSAL_FLAGS</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Precompute certain useful attribute combinations.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">MUTABLE_OR_FINITE     = </span><span class="nx">MUTABLE</span> <span class="o">|</span> <span class="nx">FINITE</span>
  <span class="nv">ABSTRACT_OR_CONCRETE  = </span><span class="nx">ABSTRACT</span> <span class="o">|</span> <span class="nx">CONCRETE</span>
  <span class="nv">INCIPIENT_OR_VIRTUAL  = </span><span class="nx">INCIPIENT</span> <span class="o">|</span> <span class="nx">VIRTUAL</span>
  <span class="nv">INCIPIENT_OR_MUTABLE  = </span><span class="nx">INCIPIENT</span> <span class="o">|</span> <span class="nx">MUTABLE</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>A bit mask indicates the attributes that can be inherited via protostates.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">PROTO_HERITABLE_ATTRIBUTES =</span>
    <span class="nx">PARASTATIC</span>  <span class="o">|</span>
    <span class="nx">MUTABLE</span>     <span class="o">|</span>  <span class="nx">FINITE</span>      <span class="o">|</span>  <span class="nx">STATIC</span>     <span class="o">|</span>  <span class="nx">IMMUTABLE</span>  <span class="o">|</span>
    <span class="nx">INITIAL</span>     <span class="o">|</span>  <span class="nx">CONCLUSIVE</span>  <span class="o">|</span>  <span class="nx">FINAL</span>      <span class="o">|</span>
    <span class="nx">ABSTRACT</span>    <span class="o">|</span>  <span class="nx">CONCRETE</span>    <span class="o">|</span>  <span class="nx">DEFAULT</span>    <span class="o">|</span>
    <span class="nx">REFLECTIVE</span>  <span class="o">|</span>
    <span class="nx">HISTORY</span>     <span class="o">|</span>  <span class="nx">RETAINED</span>    <span class="o">|</span>  <span class="nx">SHALLOW</span>    <span class="o">|</span>
    <span class="nx">CONCURRENT</span>  <span class="o">|</span>
    <span class="nx">NORMAL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--supporting-classes">Supporting classes</a></h3>
<p>These are keyed here as a placeholder, and will be valued with a forward import
at the end of this class definition.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">Metaobject: </span><span class="kc">null</span>
  <span class="nv">Expression: </span><span class="kc">null</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--constructor">Constructor</a></h3>
<p>The constructor is limited to setting the references that define <code>this</code>
<code>State</code>’s relations, and then computing its <code>attributes</code> bit mask based on
those relations and the intrinsic heritability of each attribute.</p>
<p>Only afterward is the <code>State</code>’s <code>Metaobject</code>, as defined in a provided
<code>expression</code>, then <code>initialize</code>d into the instance, if necessary.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">( base, @name, expression ) -&gt;</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Relation definitions</h6>
<p>The <code>base</code> argument can specify either a <code>superstate</code> from which to inherit,
or an <code>owner</code> for which to act as a new <code>root</code> state.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">base</span> <span class="k">instanceof</span> <span class="nx">State</span>
    <span class="k">then</span> <span class="nv">superstate = </span><span class="nx">base</span><span class="p">;</span> <span class="nv">root = </span><span class="nx">superstate</span><span class="p">.</span><span class="nx">root</span><span class="p">;</span> <span class="nv">owner = </span><span class="nx">root</span><span class="p">.</span><span class="nx">owner</span>
    <span class="k">else</span> <span class="nv">superstate = </span><span class="kc">null</span><span class="p">;</span> <span class="nv">root = </span><span class="k">this</span><span class="p">;</span> <span class="nv">owner = </span><span class="nx">base</span>

    <span class="vi">@owner = </span><span class="nx">owner</span>
    <span class="vi">@root = </span><span class="nx">root</span>
    <span class="vi">@superstate = </span><span class="nx">superstate</span>
    <span class="vi">@protostate = </span><span class="nv">protostate = </span><span class="nx">@getProtostate</span><span class="p">()</span> <span class="o">or</span> <span class="kc">null</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>The linearized resolution <code>order</code> for <code>this</code> will be set later, either when the
instance is <code>realize</code>d, or on demand if a lookup is performed and the <code>order</code>
is not set.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="vi">@order = </span><span class="kc">null</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Attribute inheritance masking</h6>
<p>Explicitly defined <em>literal</em> attributes for <code>this</code> state are encoded as a bit
field integer within <code>expression</code>, and then superimposed atop the <em>inherited</em>
attribute values acquired from <code>this</code> state’s superstate and protostate.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">attributes = </span><span class="nx">expression</span><span class="o">?</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">or</span> <span class="nx">NORMAL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>The <code>mutable</code> and <code>finite</code> attributes can be inherited from the superstate
straight away.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">superstate</span><span class="o">?</span>
      <span class="nv">superAttr = </span><span class="nx">superstate</span><span class="p">.</span><span class="nx">attributes</span>
      <span class="nx">attributes</span> <span class="o">|=</span> <span class="nx">superAttr</span> <span class="o">&amp;</span> <span class="nx">MUTABLE_OR_FINITE</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>A subset of the attributes may be inherited from protostates.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">protostate</span><span class="o">?</span>
      <span class="nv">protoAttr = </span><span class="nx">protostate</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">PROTO_HERITABLE_ATTRIBUTES</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Literal <code>concrete</code> forcibly contradicts literal <code>abstract</code>; if a bad production
includes both attributes, negate <code>abstract</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nx">attributes</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">ABSTRACT</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">CONCRETE</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Literal <code>abstract</code> may override inherited <code>concrete</code>, and vice versa, so filter
those attributes out of the protostate before inheriting.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">ABSTRACT_OR_CONCRETE</span>
        <span class="nx">protoAttr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">ABSTRACT_OR_CONCRETE</span>
      <span class="nx">attributes</span> <span class="o">|=</span> <span class="nx">protoAttr</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If at this point the state is not <code>abstract</code>, then it is definitely <code>concrete</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">attributes</span> <span class="o">|=</span> <span class="nx">CONCRETE</span> <span class="k">if</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">ABSTRACT</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Literal or inherited <code>immutable</code> contradicts <code>mutable</code> absolutely, and implies
<code>finite</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">attributes</span> <span class="o">|=</span> <span class="p">(</span> <span class="nx">superAttr</span> <span class="o">|</span> <span class="nx">protoAttr</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="nx">IMMUTABLE</span>
    <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">IMMUTABLE</span>
      <span class="nv">attributes = </span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="o">~</span><span class="nx">MUTABLE</span> <span class="o">|</span> <span class="nx">FINITE</span>

    <span class="vi">@attributes = </span><span class="nx">attributes</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Offloaded initialization</h6>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">@initialize</span> <span class="nx">expression</span> <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Debug properties</h6>
<p>For easy viewing in the inspector.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">env</span><span class="p">.</span><span class="nx">debug</span>
      <span class="err">@</span><span class="p">[</span><span class="s1">&#39; &lt;path&gt;&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="nx">@path</span><span class="p">()</span>
      <span class="err">@</span><span class="p">[</span><span class="s1">&#39;&lt;attributes&gt;&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="nx">StateExpression</span><span class="p">.</span><span class="nx">decodeAttributes</span> <span class="nx">attributes</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--private">Private entities</a></h3>
<h4><a href="#state--private--create-dispatcher">createDispatcher</a></h4>
<p>For each method defined in any of the owner’s states, a <strong>dispatcher</strong> must be
created and assigned on the owner itself at the <code>methodName</code> key. Calls to
<code>owner.methodName</code> are then delegated by the dispatcher to the owner’s current
state, from which the appropriate implementation for the method will be located
and applied, and its result returned to the call site.</p>
<blockquote>
<p><a href="#state--prototype--add-method"><code>addMethod</code></a>
<a href="/docs/#concepts--methods--dispatchers">Dispatchers</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">createDispatcher = </span><span class="nx">do</span> <span class="o">-&gt;</span>
    <span class="nv">toString = </span><span class="o">-&gt;</span> <span class="s2">&quot;[dispatcher]&quot;</span>
    <span class="nf">( accessorName, methodName, original ) -&gt;</span>
      <span class="nv">dispatcher = </span><span class="o">-&gt;</span> <span class="err">@</span><span class="p">[</span> <span class="nx">accessorName</span> <span class="p">]().</span><span class="nx">apply</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">arguments</span>
      <span class="nv">dispatcher.isDispatcher = </span><span class="kc">yes</span>
      <span class="nv">dispatcher.toString = </span><span class="nx">toString</span> <span class="k">if</span> <span class="nx">env</span><span class="p">.</span><span class="nx">debug</span>
      <span class="nv">dispatcher.original = </span><span class="nx">original</span> <span class="k">if</span> <span class="nx">original</span>
      <span class="nx">dispatcher</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--essential-methods">Essential methods</a></h3>
<h4><a href="#state--prototype--initialize">initialize</a></h4>
<p>Builds out the state’s members based on the expression provided.</p>
<blockquote>
<p><a href="#state--constructor">Constructor</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">initialize: </span><span class="nf">( expression ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>

    <span class="nx">@attributes</span> <span class="o">|=</span> <span class="nx">INCIPIENT</span>
    <span class="nx">@realize</span> <span class="nx">expression</span>
    <span class="nx">@attributes</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">INCIPIENT</span>

    <span class="nx">@emit</span> <span class="s1">&#39;construct&#39;</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">VIA_PROTO</span>
    <span class="k">this</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--realize">realize</a></h4>
<p>Transforms an incipient or <strong>virtual</strong> <code>State</code> into a <strong>real</strong> state.</p>
<p>Initialization of a <code>State</code>’s contents is offloaded from the
<a href="#state--constructor">constructor</a> via
<a href="#state--prototype--initialize"><code>initialize</code></a> to here.</p>
<blockquote>
<p><a href="#state--prototype--virtualize"><code>virtualize</code></a>
<a href="/api/#state--methods--realize">realize</a>
<a href="/docs/#concepts--object-model--virtual-epistates">Virtual epistates</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">realize: </span><span class="nf">( expression ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">name</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">return</span> <span class="k">this</span> <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">INCIPIENT_OR_VIRTUAL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Begin realization higher in the superstate chain if necessary, adding each
newly realized state to the <code>substates</code> collection of its real superstate.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>
      <span class="k">if</span> <span class="nv">ss = </span><span class="nx">@superstate</span>
        <span class="nx">do</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">realize</span> <span class="k">if</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>
        <span class="nv">substates = </span><span class="nx">ss</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">substates</span> <span class="o">?=</span> <span class="p">{}</span>
        <span class="nx">do</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">destroy</span> <span class="k">if</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span><span class="o">?</span>
        <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="k">this</span>
      <span class="nx">@attributes</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">VIRTUAL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>A <code>State</code>’s <code>Metaobject</code> is stored in an underscore <code>_</code> property; the
existence of <code>_</code> in <code>this</code> implies that <code>this</code> must be a realized state.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">@_</span> <span class="o">?=</span> <span class="k">new</span> <span class="nx">@Metaobject</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Normalize any declarations of <code>parastates</code>. These will be used later in the
outer <code>realize</code> function to recursively compute a <code>linearization</code> for <code>this</code>
state and for its descendant substates.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">parastates = </span><span class="nx">expression</span><span class="o">?</span><span class="p">.</span><span class="nx">parastates</span>
      <span class="k">if</span> <span class="nx">isArray</span> <span class="nx">parastates</span> <span class="k">then</span> <span class="nv">parastates = </span><span class="nx">parastates</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;,&#39;</span>
      <span class="k">throw</span> <span class="nx">TypeError</span> <span class="nx">unless</span> <span class="k">typeof</span> <span class="nx">parastates</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
      <span class="nv">parastates = </span><span class="nx">parastates</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\s*,\s*/</span>
      <span class="k">if</span> <span class="nx">parastates</span><span class="p">.</span><span class="nx">length</span>
        <span class="vi">@_.parastates = </span><span class="nx">parastates</span>
        <span class="nx">@attributes</span> <span class="o">|=</span> <span class="nx">PARASTATIC</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Populate the rest of the empty metaobject by “mutating” against <code>expression</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">@mutate</span> <span class="nx">expression</span> <span class="k">if</span> <span class="nx">expression</span><span class="o">?</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Realizing a root state requires that, for each of the owner’s own methods, if
there exists at least one stateful implementation of that method located higher
in the owner’s prototype chain, then the owner’s implementation of that method
must be copied into the root, where it defines the owner’s default behavior.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="k">this</span> <span class="o">is</span> <span class="nx">@root</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">method</span> <span class="k">of</span> <span class="nx">@owner</span>
      <span class="nx">@addMethod</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">method</span> <span class="k">if</span> <span class="nx">key</span> <span class="o">isnt</span> <span class="s1">&#39;constructor&#39;</span> <span class="o">and</span>
        <span class="k">typeof</span> <span class="nx">method</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">method</span><span class="p">.</span><span class="nx">isDispatcher</span> <span class="o">and</span>
        <span class="nx">@method</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">VIA_PROTO</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>The superstate and parastates of <code>this</code> <code>State</code> are <code>linearize</code>d into a defined
<code>order</code>. Because the <code>State</code>s of a state tree are constructed bottom-up, in the
case of an <strong>incipient</strong> state, the linearization step must be deferred to the
<strong>root</strong>, which will then recursively <code>linearize</code> its descendants from the top
down, <em>after</em> each one has been instantiated and situated in the tree.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">@linearize</span> <span class="nx">VIA_SUB</span> <span class="k">if</span> <span class="k">this</span> <span class="o">is</span> <span class="nx">@root</span> <span class="o">or</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">INCIPIENT</span>

    <span class="k">this</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--virtualize">virtualize</a></h4>
<p>Creates, if necessary, a virtualized <strong>epistate</strong> of <code>this</code> protostate within
the state tree to which <code>inheritor</code> belongs, and also creates as many virtual
ancestor superstates as necessary to reach a real <code>State</code> within that tree.</p>
<p>Returns the state on <code>inheritor</code>’s state tree for which <code>this</code> is a protostate.
This will be the newly created virtual state, unless virtualization was
unnecessary, in which case it will be the extant real epistate of <code>this</code>.</p>
<blockquote>
<p><a href="/docs/#concepts--object-model--virtual-epistates">Virtual epistates</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">virtualize: </span><span class="nf">( inheritor ) -&gt;</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Verify relation between respective <code>owner</code>s of <code>inheritor</code> and <code>this</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nx">inheritor</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">and</span>
      <span class="nx">@owner</span><span class="p">.</span><span class="nx">isPrototypeOf</span> <span class="nx">inheritor</span><span class="p">.</span><span class="nx">owner</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Get the <code>derivation</code> list for <code>this</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="p">(</span> <span class="nv">derivation = </span><span class="nx">@derivation</span> <span class="kc">yes</span> <span class="p">).</span><span class="nx">length</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Traverse the real states of the inheriting state tree to their furthest depth.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">i = </span><span class="mi">0</span><span class="p">;</span> <span class="nv">s = </span><span class="nx">inheritor</span><span class="p">.</span><span class="nx">root</span>
    <span class="k">while</span> <span class="nv">name = </span><span class="nx">derivation</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span>
      <span class="k">break</span> <span class="nx">unless</span> <span class="nv">real = </span><span class="nx">s</span><span class="p">.</span><span class="nx">substate</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">VIA_NONE</span>
      <span class="nv">s = </span><span class="nx">real</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If <code>derivation</code> extends beyond the inheriting state tree’s real states, then
add virtual states to it until the whole superstate chain is represented.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">expr = attributes: </span><span class="nx">VIRTUAL</span>
    <span class="k">while</span> <span class="nx">name</span>
      <span class="nv">s = </span><span class="k">new</span> <span class="nx">State</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">expr</span>
      <span class="nv">name = </span><span class="nx">derivation</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span>
    <span class="nx">s</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--linearize">linearize</a></h4>
<p>Computes, records, and returns the array of <code>State</code>s that define the <code>order</code> of
resolution, or <strong>linearization</strong>, for inheritance of <code>this</code> amongst itself and
ancestors that share a common <code>owner</code> (and thus inhabit a common state tree).</p>
<p>This method adapts the <strong>C3 linearization algorithm</strong> to the <code>State</code> model,
where the returned list consists of <code>this</code> followed by a monotonic ordering of
its <strong>parastate</strong> and <strong>superstate</strong> ancestors.</p>
<p>By definition a <code>State</code>’s <strong>protostates</strong> are excluded from <code>order</code>. Traversal
<code>VIA_ALL</code> proceeds over the concatenation of the protostate chains for each
<code>State</code> in <code>order</code>; this set inherently preserves the monotonicity of <code>order</code>.</p>
<p>Parastates are specified by the selector paths contained in the <code>parastates</code>
array of the metaobject <code>this._</code>. <strong>Epistates</strong> inherit any parastate paths
defined by their protostates, and may override their ordering.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">linearize: </span><span class="nx">do</span> <span class="o">-&gt;</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h5>getParastateDeclarations</h5>
<p>Returns the concatenation of <code>this</code> <code>State</code>’s own and <code>protostate</code>-derived
declarations of <code>parastates</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">getParastateDeclarations = </span><span class="o">-&gt;</span>
      <span class="nv">head = </span><span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">parastates</span>
      <span class="nv">tail = </span><span class="nx">getParastateDeclarations</span><span class="p">.</span><span class="nx">call</span> <span class="nx">ps</span> <span class="k">if</span> <span class="nv">ps = </span><span class="nx">@protostate</span>
      <span class="k">if</span> <span class="nx">tail</span><span class="o">?</span> <span class="k">then</span> <span class="p">(</span> <span class="nx">head</span><span class="o">?</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">tail</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">tail</span> <span class="k">else</span> <span class="nx">head</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h5>merge</h5>
<p>Creates and returns a monotonic ordered set of <code>State</code>s from the provided
<code>lists</code>, where <code>lists</code> is an array of arrays, consisting of an array of
“parent” states, preceded by arrays that represent, in order, the linearization
of each “parent” state.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">merge = </span><span class="nf">( out, lists ) -&gt;</span>
      <span class="k">return</span> <span class="nx">out</span> <span class="nx">unless</span> <span class="nx">lists</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="nx">headList</span><span class="p">,</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">lists</span> <span class="k">when</span> <span class="nx">headList</span><span class="o">?</span>
        <span class="nv">head = </span><span class="nx">headList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="nv">bad = </span><span class="kc">no</span>
        <span class="k">for</span> <span class="nx">otherList</span> <span class="k">in</span> <span class="nx">lists</span> <span class="k">when</span> <span class="nx">otherList</span> <span class="o">isnt</span> <span class="nx">headList</span>
          <span class="nv">i = </span><span class="mi">1</span><span class="p">;</span> <span class="k">while</span> <span class="nv">item = </span><span class="nx">otherList</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span>
            <span class="k">if</span> <span class="nx">item</span> <span class="o">is</span> <span class="nx">head</span> <span class="k">then</span> <span class="nv">bad = </span><span class="kc">yes</span><span class="p">;</span> <span class="k">break</span>
          <span class="k">break</span> <span class="k">if</span> <span class="nx">bad</span>
        <span class="k">continue</span> <span class="k">if</span> <span class="nx">bad</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="nx">head</span>
        <span class="nv">remainingLists = </span><span class="p">[];</span> <span class="k">for</span> <span class="nx">list</span> <span class="k">in</span> <span class="nx">lists</span>
          <span class="nx">do</span> <span class="nx">list</span><span class="p">.</span><span class="nx">shift</span> <span class="k">if</span> <span class="nx">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="nx">head</span>
          <span class="nx">remainingLists</span><span class="p">.</span><span class="nx">push</span> <span class="nx">list</span> <span class="k">if</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
        <span class="k">return</span> <span class="nx">merge</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">remainingLists</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s2">&quot;Ambiguous resolution order for &#39;#{ out.pop() }&#39;&quot;</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h5>linearize</h5>
<p>Computes the linearization of <code>this</code> from its named parastates and referenced
superstate, and saves this array as <code>this.order</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">linearize = </span><span class="nf">( via = VIA_NONE ) -&gt;</span>
      <span class="k">if</span> <span class="k">this</span> <span class="o">is</span> <span class="nx">@root</span> <span class="k">then</span> <span class="nv">order = </span><span class="p">[</span><span class="k">this</span><span class="p">]</span> <span class="k">else</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Determine the ordered set of <code>State</code>s from which <code>this</code> inherits. By rule any
parastates precede the superstate. Declarations of parastates include those
inherited from protostates; all parastates are resolved to unique <code>own</code>
<code>State</code>s of the prevailing <code>owner</code>’s state tree.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>        <span class="nv">parents = </span><span class="p">[]</span>
        <span class="k">if</span> <span class="nv">paths = </span><span class="nx">getParastateDeclarations</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span>
          <span class="p">{</span> <span class="nx">owner</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
          <span class="k">for</span> <span class="nx">path</span> <span class="k">in</span> <span class="nx">paths</span>
            <span class="nx">unless</span> <span class="nv">parastate = </span><span class="nx">state</span><span class="p">.</span><span class="nx">own</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">path</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nx">ReferenceError</span> <span class="s2">&quot;Unresolvable parastate &#39;#{ path }&#39;&quot;</span>
            <span class="nx">parents</span><span class="p">.</span><span class="nx">push</span> <span class="nx">parastate</span> <span class="nx">unless</span> <span class="nx">parastate</span> <span class="k">in</span> <span class="nx">parents</span>
        <span class="nx">parents</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@superstate</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Create an array of the linearizations for each <code>parent</code>, followed by a list of
the <code>parents</code> themselves, then <code>merge</code> each of these <code>lists</code> to create a single
ordered set that defines the monotonic linearization of <code>this</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>        <span class="nv">lists = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">parent</span> <span class="k">in</span> <span class="nx">parents</span>
          <span class="nx">lists</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">order</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">linearize</span><span class="p">()</span> <span class="p">)[..]</span>
        <span class="nx">lists</span><span class="p">.</span><span class="nx">push</span> <span class="nx">parents</span>
        <span class="nv">order = </span><span class="nx">merge</span> <span class="p">[</span><span class="k">this</span><span class="p">],</span> <span class="nx">lists</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Set the determined <code>order</code>, then recurse downward if so directed (e.g., this is
instigated from the root state as the last step of realization, after all of
its substates and descendants are in place).</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="vi">@order = </span><span class="nx">order</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">linearize</span> <span class="nx">via</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">s</span> <span class="k">of</span> <span class="nx">@_</span><span class="p">.</span><span class="nx">substates</span> <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_SUB</span>
      <span class="nx">order</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--express">express</a></h4>
<p>Returns an <strong>expression</strong> of <code>this</code> state — a data structure that contains an
exported snapshot of the state’s own contents.</p>
<p>By default the returned expression is returned as a plain object; if <code>typed</code>
is truthy, the expression is a formally typed <code>StateExpression</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">express: </span><span class="nx">do</span> <span class="o">-&gt;</span>
    <span class="nv">cloneCategory = </span><span class="nf">( object ) -&gt;</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">object</span><span class="o">?</span>
      <span class="p">(</span> <span class="nv">out = </span><span class="p">{};</span> <span class="k">break</span> <span class="p">)</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">object</span>
      <span class="k">if</span> <span class="nx">out</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">object</span>
        <span class="nx">out</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">value</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
        <span class="k">then</span> <span class="nx">clone</span> <span class="nx">value</span>
        <span class="k">else</span> <span class="nx">value</span>
      <span class="nx">out</span>

    <span class="nv">cloneEvents = </span><span class="nf">( events ) -&gt;</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">events</span><span class="o">?</span>
      <span class="p">(</span> <span class="nv">out = </span><span class="p">{};</span> <span class="k">break</span> <span class="p">)</span> <span class="k">for</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">emitter</span> <span class="k">of</span> <span class="nx">events</span> <span class="k">when</span> <span class="nx">emitter</span>
      <span class="k">for</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">emitter</span> <span class="k">of</span> <span class="nx">events</span> <span class="k">when</span> <span class="nx">emitter</span>
        <span class="nx">out</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">clone</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">items</span>
      <span class="nx">out</span>

    <span class="nv">cloneSubstates = </span><span class="nf">( substates, typed ) -&gt;</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">substates</span><span class="o">?</span>
      <span class="p">(</span> <span class="nv">out = </span><span class="p">{};</span> <span class="k">break</span> <span class="p">)</span> <span class="k">for</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">substates</span>
      <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">substate</span> <span class="k">of</span> <span class="nx">substates</span>
        <span class="nx">out</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substate</span><span class="p">.</span><span class="nx">express</span> <span class="nx">typed</span>
      <span class="nx">out</span>

    <span class="k">return</span> <span class="nv">express = </span><span class="nf">( typed ) -&gt;</span>
      <span class="k">if</span> <span class="nv">_ = </span><span class="nx">@_</span> <span class="k">then</span> <span class="nv">expression = </span><span class="nx">edit</span> <span class="p">{},</span> <span class="p">{</span>  <span class="c1"># Why `edit`???</span>
        <span class="nx">@attributes</span>
        <span class="nv">data        : </span><span class="nx">cloneCategory</span>   <span class="nx">_</span><span class="p">.</span><span class="nx">data</span>
        <span class="nv">methods     : </span><span class="nx">cloneCategory</span>   <span class="nx">_</span><span class="p">.</span><span class="nx">methods</span>
        <span class="nv">events      : </span><span class="nx">cloneEvents</span>     <span class="nx">_</span><span class="p">.</span><span class="nx">events</span>
        <span class="nv">guards      : </span><span class="nx">cloneCategory</span>   <span class="nx">_</span><span class="p">.</span><span class="nx">guards</span>
        <span class="nv">states      : </span><span class="nx">cloneSubstates</span>  <span class="nx">_</span><span class="p">.</span><span class="nx">substates</span><span class="p">,</span> <span class="nx">typed</span>
        <span class="nv">transitions : </span><span class="nx">cloneCategory</span>   <span class="nx">_</span><span class="p">.</span><span class="nx">transitions</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="nx">typed</span> <span class="k">then</span> <span class="k">new</span> <span class="nx">@Expression</span> <span class="nx">expression</span> <span class="k">else</span> <span class="nx">expression</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--mutate">mutate</a></h4>
<p>Transactionally mutates <code>this</code> state by adding, updating, or removing items as
specified by the expression provided in <code>expr</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">mutate: </span><span class="nx">do</span> <span class="o">-&gt;</span>
    <span class="p">{</span> <span class="nx">NIL</span><span class="p">,</span> <span class="nx">isArray</span><span class="p">,</span> <span class="nx">isEmpty</span><span class="p">,</span> <span class="nx">isPlainObject</span><span class="p">,</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">diff</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">O</span>

    <span class="nv">editEvent = </span><span class="nf">( object, emitter ) -&gt;</span>
      <span class="p">{</span> <span class="nx">items</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">emitter</span>
      <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">object</span>
        <span class="k">if</span> <span class="nx">value</span> <span class="o">is</span> <span class="nx">NIL</span> <span class="k">then</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">key</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">value</span> <span class="o">and</span> <span class="nx">value</span> <span class="o">isnt</span> <span class="nx">items</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span>
          <span class="nx">emitter</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>

    <span class="k">return</span> <span class="nv">mutate = </span><span class="nf">( expr ) -&gt;</span>
      <span class="p">{</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">Expression</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Preparation steps</h6>
<p>Booleans to determine whether mutation of particular categories is permissible;
all content is mutable for the special case of a state being initialized.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nv">incipient = </span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">INCIPIENT</span>
      <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">incipient</span> <span class="o">and</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">IMMUTABLE</span>
      <span class="nv">mutable = </span><span class="nx">incipient</span> <span class="o">or</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Realize <code>this</code> state if necessary, then load the category collections.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nx">do</span> <span class="nx">@realize</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>
      <span class="p">{</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">transitions</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">@_</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Validate the provided state expression.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nv">expr = </span><span class="k">new</span> <span class="nx">Expression</span> <span class="nx">expr</span> <span class="nx">unless</span> <span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">Expression</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Hold onto an expression of a state’s contents <code>before</code> the mutation, to be used
for comparison later on the <code>mutate</code> event. This step does not pertain to an
<code>incipient</code> state, which will be “mutating” against nothing, and so will
suppress the emission of a <code>mutate</code> event.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nv">before = </span><span class="nx">@express</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">incipient</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Since <code>mutate</code> is transactional, the <code>ATOMIC</code> flag must be used to signal the
methods utilized here that add or remove content to temporarily suppress their
usual emission of a <code>mutate</code> event.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nx">@attributes</span> <span class="o">|=</span> <span class="nx">ATOMIC</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Data mutations</h6>
<p>Data is already set up to handle differentials that contain <code>NIL</code> values.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nx">@data</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">data</span> <span class="k">if</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">data</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Method mutations</h6>
<p>Methods are stored as a simple key mapping, and <code>addMethod</code> can be used both to
create an entry and to update an existing entry, without any additional
side-effects, so method expressions can simply be compared against the <code>NIL</code>
value.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">mutable</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">method</span> <span class="k">of</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">methods</span>
        <span class="k">if</span> <span class="nx">method</span> <span class="o">isnt</span> <span class="nx">NIL</span>
        <span class="k">then</span> <span class="nx">@addMethod</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">method</span>
        <span class="k">else</span> <span class="nx">@removeMethod</span> <span class="nx">name</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Event mutations</h6>
<p>Event listeners for a given event type might be expressed as either:</p>
<ul>
<li>a simple <code>Array</code> of items to be added;</li>
<li>a plain <code>Object</code> that maps items to specific event <code>id</code>s in the internal
emitter that should be added, updated, or deleted; or</li>
<li>an <code>Array</code> that also includes one or more such <code>Object</code>s.</li>
</ul>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">mutable</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">event</span> <span class="k">of</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">events</span>
        <span class="nx">events</span> <span class="o">or</span> <span class="o">=</span> <span class="nx">@_</span><span class="p">.</span><span class="nx">events</span> <span class="o">or</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nv">emitter = </span><span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span>
        <span class="k">if</span> <span class="nx">event</span> <span class="o">is</span> <span class="nx">NIL</span> <span class="k">then</span> <span class="nx">do</span> <span class="nx">emitter</span><span class="o">?</span><span class="p">.</span><span class="nx">empty</span><span class="p">;</span> <span class="k">continue</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If <code>event</code> contains items to be added, and an emitter does not already exist
for this event type, then one must be created.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>        <span class="k">if</span> <span class="o">not</span> <span class="nx">emitter</span> <span class="o">and</span> <span class="nx">event</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">isEmpty</span> <span class="nx">event</span>
          <span class="nv">emitter = </span><span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateEventEmitter</span> <span class="k">this</span><span class="p">,</span> <span class="nx">type</span>

        <span class="k">if</span> <span class="nx">isArray</span> <span class="nx">event</span>
        <span class="k">then</span> <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">event</span> <span class="k">when</span> <span class="nx">element</span><span class="o">?</span> <span class="o">and</span> <span class="nx">element</span> <span class="o">isnt</span> <span class="nx">NIL</span>
          <span class="k">if</span> <span class="nx">isPlainObject</span> <span class="nx">element</span>
          <span class="k">then</span> <span class="nx">editEvent</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">emitter</span>
          <span class="k">else</span> <span class="nx">@addEvent</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">element</span>
        <span class="k">else</span> <span class="nx">editEvent</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">emitter</span> <span class="k">if</span> <span class="nx">isPlainObject</span> <span class="nx">event</span>

        <span class="nx">unless</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">length</span>
          <span class="nx">do</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">destroy</span>
          <span class="k">delete</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Guard mutations</h6>
<p>Guards are stored as simple objects, and altering them causes no side-effects,
so a deep <code>edit</code> is sufficient.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">mutable</span> <span class="o">and</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">guards</span>
        <span class="nx">guards</span> <span class="o">or</span> <span class="o">=</span> <span class="nx">@_</span><span class="p">.</span><span class="nx">guards</span> <span class="o">or</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nx">edit</span> <span class="s1">&#39;deep&#39;</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">guards</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Substate mutations</h6>
<p>Substates are instances of <code>State</code>, which are either created, destroyed, or
recursively updated in place, as specified by <code>expr.states</code>.</p>
<p>By default, a state is <strong>weakly immutable</strong>, in which case its <em>direct</em>
contents cannot be altered, although any of its substates may yet be mutable,
so any submutations must therefore still be applied recursively to their
corresponding substates.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">stateExpr</span> <span class="k">of</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">substates</span>
        <span class="k">if</span> <span class="nx">substates</span> <span class="o">and</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">substates</span>
          <span class="k">if</span> <span class="nx">stateExpr</span> <span class="o">is</span> <span class="nx">NIL</span>
          <span class="k">then</span> <span class="nx">@removeSubstate</span> <span class="nx">name</span>
          <span class="k">else</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">mutate</span> <span class="nx">stateExpr</span>
        <span class="k">else</span> <span class="nx">@addSubstate</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">stateExpr</span> <span class="k">if</span> <span class="nx">stateExpr</span> <span class="o">isnt</span> <span class="nx">NIL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Transition mutations</h6>
<p>Transitions, as held by a <code>State</code>, are instances of <code>TransitionExpression</code>,
which are either created, deleted, or replaced, as specified by
<code>expr.transitions</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">mutable</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">transitionExpr</span> <span class="k">of</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">transitions</span>
        <span class="k">if</span> <span class="nx">transitions</span> <span class="o">and</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">transitions</span>
          <span class="k">if</span> <span class="nx">transitionExpr</span> <span class="o">is</span> <span class="nx">NIL</span>
          <span class="k">then</span> <span class="k">delete</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span>
          <span class="k">else</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nx">TransitionExpression</span> <span class="nx">transitionExpr</span>
        <span class="k">else</span> <span class="nx">@addTransition</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">transitionExpr</span> <span class="k">if</span> <span class="nx">transitionExpr</span> <span class="o">isnt</span> <span class="nx">NIL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h6>Cleanup and export</h6>
<p>The transaction is complete, so clear <code>ATOMIC</code> to signal the <code>add...</code> methods
to emit individual <code>mutate</code> events as usual.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nx">@attributes</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">ATOMIC</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Finally the <code>before</code> snapshot is used to acquire the <code>residue</code> of the mutation,
which is emitted as part of a <code>mutate</code> event.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nx">unless</span> <span class="nx">incipient</span>
        <span class="nv">after = </span><span class="nx">@express</span><span class="p">()</span>
        <span class="nv">residue = </span><span class="nx">diff</span> <span class="nx">before</span><span class="p">,</span> <span class="nx">after</span>
        <span class="nx">unless</span> <span class="nx">isEmpty</span> <span class="nx">residue</span>
          <span class="nx">@emit</span> <span class="s1">&#39;mutate&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">residue</span><span class="p">,</span> <span class="nx">before</span><span class="p">,</span> <span class="nx">after</span> <span class="p">],</span> <span class="nx">VIA_PROTO</span>

      <span class="k">this</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--destroy">destroy</a></h4>
<p>Attempts to cleanly destroy this state and all of its substates. A <code>destroy</code>
event is issued to each state after it has been destroyed.</p>
<blockquote>
<p><a href="/api/#state--methods--destroy">destroy (method)</a>
<a href="/api/#state--events--destroy">destroy (event)</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">destroy: </span><span class="o">-&gt;</span>
    <span class="p">{</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">_</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="p">{</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">_</span> <span class="k">if</span> <span class="nx">_</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If a transition is underway that involves any state other than the root, then
the state cannot be destroyed.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">transition = </span><span class="nx">root</span><span class="p">.</span><span class="nx">_transition</span>
      <span class="k">if</span> <span class="k">this</span> <span class="o">is</span> <span class="nx">root</span> <span class="k">then</span> <span class="nx">do</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">abort</span>
      <span class="k">else</span> <span class="k">return</span> <span class="kc">no</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">isIn</span> <span class="k">this</span> <span class="p">)</span> <span class="o">or</span>
        <span class="p">(</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">isIn</span> <span class="k">this</span> <span class="p">)</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Descendant states are destroyed bottom-up.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">do</span> <span class="nx">substate</span><span class="p">.</span><span class="nx">destroy</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">substate</span> <span class="k">of</span> <span class="nx">substates</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>The final event emitted is <code>destroy</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">@emit</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">VIA_PROTO</span>
    <span class="k">if</span> <span class="nx">events</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">event</span> <span class="k">of</span> <span class="nx">events</span>
      <span class="nx">do</span> <span class="nx">event</span><span class="p">.</span><span class="nx">destroy</span>
      <span class="k">delete</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>When the root state is destroyed, the owner gets back its original methods, and
the corresponding dispatcher for each such method is destroyed, along with the
owner’s accessor method.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="k">this</span> <span class="o">is</span> <span class="nx">root</span>
      <span class="k">for</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">methods</span> <span class="k">when</span> <span class="nv">dispatcher = </span><span class="nx">owner</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span>
        <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">dispatcher</span><span class="p">.</span><span class="nx">isDispatcher</span>
        <span class="k">if</span> <span class="nv">ownerMethod = </span><span class="nx">dispatcher</span><span class="p">.</span><span class="nx">original</span>
        <span class="k">then</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">ownerMethod</span>
        <span class="k">else</span> <span class="k">delete</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span>
      <span class="k">delete</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">@accessorName</span> <span class="p">]</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>The metaobject should be cleared explicitly, as it may contain a cyclical
reference to <code>this</code> at the head of its <code>linearization</code> array. This should be
sufficient to allow garbage-collection since only <code>this</code> should ever hold a
reference to the metaobject.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="vi">@_ = </span><span class="kc">null</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>A flag is set that can be observed later by anything retaining a reference to
this state (e.g. a memoization) which would be withholding it from being
garbage-collected.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">@attributes</span> <span class="o">|=</span> <span class="nx">DESTROYED</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>A non-root state must remove itself from its superstate.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">superstate</span><span class="o">?</span><span class="p">.</span><span class="nx">removeSubstate</span> <span class="nx">@name</span>

    <span class="kc">yes</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--attribute-methods">Attribute methods</a></h3>
<p>Methods that inspect a state’s attributes.</p>
<blockquote>
<p><a href="/docs/#concepts--attributes">Attributes</a>
<a href="/api/#state--attributes">Attributes</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">isVirtual: </span>    <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="p">)</span>
  <span class="nv">isMutable: </span>    <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="p">)</span>
  <span class="nb">isFinite</span><span class="o">:</span>      <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">FINITE</span> <span class="p">)</span>
  <span class="nv">isStatic: </span>     <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">STATIC</span> <span class="p">)</span>
  <span class="nv">isImmutable: </span>  <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">IMMUTABLE</span> <span class="p">)</span>
  <span class="nv">isInitial: </span>    <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">INITIAL</span> <span class="p">)</span>
  <span class="nv">isConclusive: </span> <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">CONCLUSIVE</span> <span class="p">)</span>
  <span class="nv">isFinal: </span>      <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">FINAL</span> <span class="p">)</span>
  <span class="nv">isAbstract: </span>   <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">ABSTRACT</span> <span class="p">)</span>
  <span class="nv">isConcrete: </span>   <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">CONCRETE</span> <span class="p">)</span>
  <span class="nv">isDefault: </span>    <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">DEFAULT</span> <span class="p">)</span>
  <span class="nv">isReflective: </span> <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">REFLECTIVE</span> <span class="p">)</span>
  <span class="nv">hasHistory: </span>   <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">HISTORY</span> <span class="p">)</span>
  <span class="nv">isRetained: </span>   <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">RETAINED</span> <span class="p">)</span>
  <span class="nv">isShallow: </span>    <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">SHALLOW</span> <span class="p">)</span>
  <span class="nv">isConcurrent: </span> <span class="o">-&gt;</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">CONCURRENT</span> <span class="p">)</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--relational-methods">Relational methods</a></h3>
<h4><a href="#state--prototype--substate">substate</a></h4>
<p>Retrieves the named substate of <code>this</code> state. If no such substate exists in the
local state, any identically named substate held on a protostate will be
returned.</p>
<blockquote>
<p><a href="/api/#state--methods--substate">substate</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">substate: </span><span class="nf">( name, via = VIA_PROTO ) -&gt;</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>First scan for any virtual active substates in the local state tree.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">s = </span><span class="nx">@root</span><span class="p">.</span><span class="nx">_current</span>
    <span class="k">while</span> <span class="nx">s</span><span class="o">?</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="o">and</span> <span class="nv">ss = </span><span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span>
      <span class="k">return</span> <span class="nx">s</span> <span class="k">if</span> <span class="nx">ss</span> <span class="o">is</span> <span class="k">this</span> <span class="o">and</span> <span class="nx">s</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="nx">name</span>
      <span class="nv">s = </span><span class="nx">ss</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Otherwise retrieve a real substate, either locally or from a protostate.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">substates</span><span class="o">?</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">or</span>
    <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_PROTO</span> <span class="o">and</span> <span class="nx">@protostate</span><span class="o">?</span><span class="p">.</span><span class="nx">substate</span> <span class="nx">name</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--substates">substates</a></h4>
<p>Returns an array of this state’s immediate substates. If the boolean <code>virtual</code>
is <code>true</code>, any active virtual epistates will be included as well.</p>
<blockquote>
<p><a href="/api/#state--methods--substates">substates</a>
<a href="/docs/#concepts--object-model--virtual-epistates">Virtual epistates</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">substates: </span><span class="nf">( virtual, deep ) -&gt;</span>
    <span class="nv">result = </span><span class="p">[]</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Include virtual substates in the returned set, if any are present.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">virtual</span> <span class="o">and</span> <span class="p">(</span> <span class="nv">s = </span><span class="nx">@root</span><span class="p">.</span><span class="nx">_current</span> <span class="p">)</span> <span class="o">and</span> <span class="nx">s</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="o">and</span>
        <span class="nx">@isSuperstateOf</span> <span class="nx">s</span>
      <span class="k">while</span> <span class="nx">s</span> <span class="o">and</span> <span class="nx">s</span> <span class="o">isnt</span> <span class="k">this</span> <span class="o">and</span> <span class="nx">s</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="o">and</span>
          <span class="nv">ss = </span><span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">s</span> <span class="k">if</span> <span class="nx">deep</span> <span class="o">or</span> <span class="nx">ss</span> <span class="o">is</span> <span class="k">this</span>
        <span class="nv">s = </span><span class="nx">ss</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Include real substates.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">substate</span> <span class="k">of</span> <span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">substates</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span> <span class="nx">substate</span>
      <span class="nv">result = </span><span class="nx">result</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">substate</span><span class="p">.</span><span class="nx">substates</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">deep</span>

    <span class="nx">result</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--descendants">descendants</a></h4>
<p>Returns a depth-first flattened array containing all of this state’s descendant
substates.</p>
<blockquote>
<p><a href="/api/#state--methods--descendants">descendants</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">descendants: </span><span class="nf">( virtual ) -&gt;</span> <span class="nx">@substates</span> <span class="nx">virtual</span><span class="p">,</span> <span class="kc">yes</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--add-substate">addSubstate</a></h4>
<p>Creates a state from the supplied <code>expression</code> and adds it as a substate of
this state. If a substate with the same <code>name</code> already exists, that state is
first destroyed and then displaced.</p>
<blockquote>
<p><a href="/api/#state--methods--add-substate">addSubstate</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">addSubstate: </span><span class="nf">( name, expression ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">INCIPIENT</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">FINITE</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span>
    <span class="nx">do</span> <span class="nx">@realize</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>

    <span class="nv">substates = </span><span class="nx">@_</span><span class="p">.</span><span class="nx">substates</span> <span class="o">or</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">do</span> <span class="nx">substate</span><span class="p">.</span><span class="nx">destroy</span> <span class="k">if</span> <span class="nv">substate = </span><span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span>

    <span class="nv">substate = </span><span class="k">if</span> <span class="nx">expression</span> <span class="k">instanceof</span> <span class="nx">State</span>
    <span class="k">then</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">realize</span><span class="p">()</span> <span class="k">if</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">superstate</span> <span class="o">is</span> <span class="k">this</span>
    <span class="k">else</span> <span class="k">new</span> <span class="nx">State</span> <span class="k">this</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">expression</span>

    <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nx">substate</span>

    <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substate</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--remove-substate">removeSubstate</a></h4>
<p>Removes the named substate from the local state, if possible.</p>
<blockquote>
<p><a href="/api/#state--methods--remove-substate">removeSubstate</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">removeSubstate: </span><span class="nf">( name ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>

    <span class="nv">substates = </span><span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">substates</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nv">substate = </span><span class="nx">substates</span><span class="o">?</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">or</span> <span class="nx">substate</span><span class="o">?</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">DESTROYED</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If a transition is underway involving <code>substate</code>, the removal must fail.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">no</span> <span class="k">if</span> <span class="p">(</span> <span class="nv">transition = </span><span class="nx">@root</span><span class="p">.</span><span class="nx">_transition</span> <span class="p">)</span> <span class="o">and</span> <span class="p">(</span>
      <span class="nx">substate</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="o">or</span>
      <span class="nx">substate</span> <span class="o">is</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span> <span class="o">or</span> <span class="nx">substate</span> <span class="o">is</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">target</span>
    <span class="p">)</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Currency must be evacuated before the state can be removed.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">@change</span> <span class="k">this</span><span class="p">,</span> <span class="nv">forced: </span><span class="kc">yes</span> <span class="k">if</span> <span class="nx">@root</span><span class="p">.</span><span class="nx">_current</span><span class="p">.</span><span class="nx">isIn</span> <span class="nx">substate</span>

    <span class="k">delete</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span>

    <span class="nx">substate</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--derivation">derivation</a></h4>
<p>Returns a <code>State</code> array of this state’s superstate chain, starting after the
root state and ending at <code>this</code>. If <code>byName</code> is set to <code>true</code>, a string array
of the states’ names is returned instead.</p>
<blockquote>
<p><a href="/api/#state--methods--derivation">derivation</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">derivation: </span><span class="nf">( byName ) -&gt;</span>
    <span class="nv">results = </span><span class="p">[];</span> <span class="nv">ss = </span><span class="k">this</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span> <span class="nv">s = </span><span class="nx">ss</span> <span class="p">)</span> <span class="o">and</span> <span class="nv">ss = </span><span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">push</span> <span class="k">if</span> <span class="nx">byName</span> <span class="k">then</span> <span class="nx">s</span><span class="p">.</span><span class="nx">name</span> <span class="o">or</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nx">s</span>
    <span class="nx">results</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--path">path</a></h4>
<p>Returns this state’s fully qualified name.</p>
<p><em>Alias:</em> <strong>toString</strong></p>
<blockquote>
<p><a href="/api/#state--methods--path">path</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">path: </span><span class="o">-&gt;</span> <span class="nx">@derivation</span><span class="p">(</span> <span class="kc">yes</span> <span class="p">).</span><span class="nx">join</span> <span class="s1">&#39;.&#39;</span>
  <span class="nv">toString: </span><span class="err">@</span><span class="o">::</span><span class="nx">path</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--depth">depth</a></h4>
<p>Returns the number of superstates this state has. The root state returns <code>0</code>,
its immediate substates return <code>1</code>, etc.</p>
<blockquote>
<p><a href="/api/#state--methods--depth">depth</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">depth: </span><span class="o">-&gt;</span>
    <span class="nv">n = </span><span class="mi">0</span><span class="p">;</span> <span class="nv">s = </span><span class="k">this</span>
    <span class="nx">n</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">while</span> <span class="nv">s = </span><span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span>
    <span class="nx">n</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--common">common</a></h4>
<p>Returns the least common ancestor of <code>this</code> and <code>other</code>. If <code>this</code> is itself an
ancestor of <code>other</code>, or vice versa, then that ancestor is returned.</p>
<blockquote>
<p><a href="/api/#state--methods--common">common</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">common: </span><span class="nf">( other ) -&gt;</span>
    <span class="nv">other = </span><span class="nx">@query</span> <span class="nx">other</span> <span class="nx">unless</span> <span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">State</span>
    <span class="k">if</span> <span class="nx">@depth</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">depth</span><span class="p">()</span> <span class="k">then</span> <span class="nv">s = </span><span class="nx">other</span><span class="p">;</span> <span class="nv">other = </span><span class="k">this</span> <span class="k">else</span> <span class="nv">s = </span><span class="k">this</span>
    <span class="k">while</span> <span class="nx">s</span>
      <span class="k">return</span> <span class="nx">s</span> <span class="k">if</span> <span class="nx">s</span> <span class="o">is</span> <span class="nx">other</span> <span class="o">or</span> <span class="nx">s</span><span class="p">.</span><span class="nx">isSuperstateOf</span> <span class="nx">other</span>
      <span class="nv">s = </span><span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span>
    <span class="kc">null</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--is">is</a></h4>
<p>Determines whether <code>this</code> is <code>other</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="o">is:</span> <span class="nf">( other ) -&gt;</span>
    <span class="nv">other = </span><span class="nx">@query</span> <span class="nx">other</span> <span class="nx">unless</span> <span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">State</span>
    <span class="nx">other</span> <span class="o">is</span> <span class="k">this</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--is-in">isIn</a></h4>
<p>Determines whether <code>this</code> is or is a substate of <code>other</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">isIn: </span><span class="nf">( other ) -&gt;</span>
    <span class="nv">other = </span><span class="nx">@query</span> <span class="nx">other</span> <span class="nx">unless</span> <span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">State</span>
    <span class="nx">other</span> <span class="o">is</span> <span class="k">this</span> <span class="o">or</span> <span class="nx">other</span><span class="p">.</span><span class="nx">isSuperstateOf</span> <span class="k">this</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--has-substate">hasSubstate</a></h4>
<p>Determines whether <code>this</code> is or is a superstate of <code>other</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">hasSubstate: </span><span class="nf">( other ) -&gt;</span>
    <span class="nv">other = </span><span class="nx">@query</span> <span class="nx">other</span> <span class="nx">unless</span> <span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">State</span>
    <span class="nx">other</span> <span class="o">is</span> <span class="k">this</span> <span class="o">or</span> <span class="nx">@isSuperstateOf</span> <span class="nx">other</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--is-superstate-of">isSuperstateOf</a></h4>
<p>Determines whether <code>this</code> is a superstate of <code>other</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">isSuperstateOf: </span><span class="nf">( other ) -&gt;</span>
    <span class="nv">other = </span><span class="nx">@query</span> <span class="nx">other</span> <span class="nx">unless</span> <span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">State</span>
    <span class="k">if</span> <span class="nv">superstate = </span><span class="nx">other</span><span class="p">.</span><span class="nx">superstate</span>
      <span class="k">this</span> <span class="o">is</span> <span class="nx">superstate</span> <span class="o">or</span> <span class="nx">@isSuperstateOf</span> <span class="nx">superstate</span>
    <span class="k">else</span> <span class="kc">no</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--default-substate">defaultSubstate</a></h4>
<p>Returns the first substate marked <code>default</code>, or simply the first substate.
Recursion continues into the protostate only if no local substates are marked
<code>default</code>.</p>
<blockquote>
<p><a href="/api/#state--methods--default-substate">defaultSubstate</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">defaultSubstate: </span><span class="nf">( via = VIA_PROTO, first ) -&gt;</span>
    <span class="k">for</span> <span class="nx">s</span> <span class="k">in</span> <span class="nv">substates = </span><span class="nx">@substates</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">s</span> <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">DEFAULT</span>
    <span class="nx">first</span> <span class="o">or</span> <span class="nx">substates</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nv">first = </span><span class="nx">substates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_PROTO</span> <span class="o">and</span> <span class="nv">protostate = </span><span class="nx">@protostate</span>
      <span class="k">return</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">defaultSubstate</span> <span class="nx">VIA_PROTO</span>
    <span class="nx">first</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--initial-substate">initialSubstate</a></h4>
<p>Performs a “depth-within-breadth-first” recursive search to locate the most
deeply nested <code>initial</code> state by way of the greatest <code>initial</code> descendant
state. Recursion continues into the protostate only if no local descendant
states are marked <code>initial</code>.</p>
<blockquote>
<p><a href="/api/#state--methods--initial-substate">initialSubstate</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">initialSubstate: </span><span class="nf">( via = VIA_PROTO ) -&gt;</span>
    <span class="nv">i = </span><span class="mi">0</span><span class="p">;</span> <span class="nv">queue = </span><span class="p">[</span> <span class="k">this</span> <span class="p">]</span>
    <span class="k">while</span> <span class="nv">subject = </span><span class="nx">queue</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span>
      <span class="k">for</span> <span class="nx">s</span> <span class="k">in</span> <span class="nv">substates = </span><span class="nx">subject</span><span class="p">.</span><span class="nx">substates</span> <span class="kc">undefined</span><span class="p">,</span> <span class="o">!!</span><span class="nx">VIA_PROTO</span>
        <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">initialSubstate</span><span class="p">(</span> <span class="nx">VIA_NONE</span> <span class="p">)</span> <span class="o">or</span> <span class="nx">s</span> <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">INITIAL</span>
        <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span> <span class="nx">s</span>
    <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_PROTO</span> <span class="o">and</span> <span class="nv">protostate = </span><span class="nx">@protostate</span>
      <span class="k">return</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">initialSubstate</span> <span class="nx">VIA_PROTO</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--get-protostate">getProtostate</a></h4>
<blockquote>
<p><a href="/api/#state--methods--get-protostate">getProtostate</a></p>
</blockquote>
<p>Returns <code>this</code> state’s <strong>protostate</strong>, the <code>State</code> that both:</p>
<ol>
<li>belongs to the nearest possible prototype of <code>@owner</code>; and</li>
<li>is taxonomically analogous to <code>this</code>, the inheriting <strong>epistate</strong>.</li>
</ol>
<p>If the owner does not share an analogous state tree with its immediate
prototype, or if that prototype’s tree does not contain a <code>State</code> analogous to
<code>this</code>, then the search is iterated up the owner’s prototype chain.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">getProtostate: </span><span class="o">-&gt;</span>
    <span class="p">{</span> <span class="nx">getPrototypeOf</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">O</span>
    <span class="p">{</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">root</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="p">{</span> <span class="nx">accessorName</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">root</span>
    <span class="nv">path = </span><span class="nx">@path</span><span class="p">()</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Walk up the prototype chain, and, starting at each prototype’s root state, use
<code>this</code> state’s <code>path</code> to locate the nearest analogous <code>protostate</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">prototype = </span><span class="nx">getPrototypeOf</span> <span class="nx">owner</span>
    <span class="k">while</span> <span class="nx">prototype</span>
      <span class="k">if</span> <span class="nv">protostate = </span><span class="nx">prototype</span><span class="p">[</span> <span class="nx">accessorName</span> <span class="p">]</span><span class="o">?</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">VIA_NONE</span>
        <span class="k">return</span> <span class="nx">protostate</span>
      <span class="nv">prototype = </span><span class="nx">getPrototypeOf</span> <span class="nx">prototype</span>
    <span class="kc">null</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--is-protostate-of">isProtostateOf</a></h4>
<p>Determines whether <code>this</code> is a state analogous to <code>state</code> on any object in the
prototype chain of <code>state</code>’s owner.</p>
<blockquote>
<p><a href="/api/#state--methods--is-protostate-of">isProtostateOf</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">isProtostateOf: </span><span class="nf">( other ) -&gt;</span>
    <span class="nv">other = </span><span class="nx">@query</span> <span class="nx">other</span> <span class="nx">unless</span> <span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">State</span>
    <span class="k">if</span> <span class="nv">protostate = </span><span class="nx">other</span><span class="p">.</span><span class="nx">protostate</span>
      <span class="k">this</span> <span class="o">is</span> <span class="nx">protostate</span> <span class="o">or</span> <span class="nx">@isProtostateOf</span> <span class="nx">protostate</span>
    <span class="k">else</span> <span class="kc">no</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--query">query</a></h4>
<p>Matches a <code>selector</code> string with the state or states it represents, evaluated
first in the context of <code>this</code>, then its substates, and then its superstates,
until all locations in the state tree have been searched for a match of
<code>selector</code>.</p>
<p>Returns the matched <code>State</code>, or an <code>Array</code> containing the set of matched
states. If a state to be tested <code>against</code> is provided, a <code>Boolean</code> is returned,
indicating whether <code>against</code> is the matched state or is included in the
matching set.</p>
<p>If no matching state is found relative to the context of <code>this</code> state, then the
query is recursed <code>via</code> the substates, superstates, and protostates of <code>this</code>,
unless otherwise directed, such that a uniquely named state can be located by
name alone from anywhere in the state tree.</p>
<blockquote>
<p><a href="/docs/#concepts--selectors">Selectors</a>
<a href="/api/#state--methods--query">query</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">query: </span><span class="nf">( selector, against, via, toBeSkipped ) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">against</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span>
      <span class="nv">toBeSkipped = </span><span class="nx">via</span><span class="p">;</span> <span class="nv">via = </span><span class="nx">against</span><span class="p">;</span> <span class="nv">against = </span><span class="kc">undefined</span>
    <span class="nv">via = </span><span class="nx">VIA_ALL</span> <span class="nx">unless</span> <span class="nx">via</span><span class="o">?</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>A few exceptional cases may be resolved early.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">selector</span><span class="o">?</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">against</span> <span class="o">is</span> <span class="kc">undefined</span> <span class="k">then</span> <span class="kc">null</span> <span class="k">else</span> <span class="kc">no</span>
    <span class="k">if</span> <span class="nx">selector</span> <span class="o">is</span> <span class="s1">&#39;.&#39;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">against</span> <span class="o">is</span> <span class="kc">undefined</span> <span class="k">then</span> <span class="k">this</span> <span class="k">else</span> <span class="nx">against</span> <span class="o">is</span> <span class="k">this</span>
    <span class="k">if</span> <span class="nx">selector</span> <span class="o">is</span> <span class="s1">&#39;&#39;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">against</span> <span class="o">is</span> <span class="kc">undefined</span> <span class="k">then</span> <span class="nx">@root</span> <span class="k">else</span> <span class="nx">against</span> <span class="o">is</span> <span class="nx">@root</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Absolute wildcard expressions compared against the root state pass immediately.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">against</span> <span class="o">and</span> <span class="nx">against</span> <span class="o">is</span> <span class="nx">@root</span> <span class="o">and</span> <span class="sr">/^\*+$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">selector</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Pure <code>.</code>/<code>*</code> expressions should not be recursed.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">via</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span> <span class="nx">VIA_SUB</span> <span class="o">|</span> <span class="nx">VIA_SUPER</span> <span class="p">)</span> <span class="k">if</span> <span class="sr">/^\.*\**$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">selector</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If <code>selector</code> is an absolute path, evaluate it from the root state as a
relative path.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">isnt</span> <span class="s1">&#39;.&#39;</span>
      <span class="k">return</span> <span class="nx">@root</span><span class="p">.</span><span class="nx">query</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">VIA_SUB</span> <span class="o">|</span> <span class="nx">VIA_PROTO</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>An all-<code>.</code> <code>selector</code> must have one <code>.</code> trimmed to parse correctly.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">selector = </span><span class="nx">selector</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/^(\.+)\.$/</span><span class="p">,</span> <span class="s1">&#39;$1&#39;</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Split <code>selector</code> into tokens, consume the leading empty-string straight away,
then parse the remaining tokens. A <code>cursor</code> reference to a matching <code>State</code> in
the tree is kept, beginning with the context state (<code>this</code>), and updated as
each token is consumed.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">parts = </span><span class="nx">selector</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;.&#39;</span>
    <span class="nv">i = </span><span class="mi">0</span><span class="p">;</span> <span class="nv">l = </span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nv">cursor = </span><span class="k">this</span>
    <span class="k">while</span> <span class="nx">cursor</span>
      <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Upon reaching the end of token stream, return the <code>State</code> currently referenced
by <code>cursor</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">return</span> <span class="p">(</span> <span class="k">if</span> <span class="nx">against</span> <span class="k">then</span> <span class="nx">against</span> <span class="o">is</span> <span class="nx">cursor</span> <span class="k">else</span> <span class="nx">cursor</span> <span class="p">)</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">l</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Consume a token.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nv">name = </span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Interpret a <strong>single wildcard</strong> as any <em>immediate</em> substate of the <code>cursor</code>
state parsed thus far.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">return</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substates</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">against</span>
        <span class="k">return</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">cursor</span> <span class="o">is</span> <span class="nx">against</span><span class="p">.</span><span class="nx">superstate</span>
        <span class="k">break</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Interpret a <strong>double wildcard</strong> as any descendant state of the <code>cursor</code> state
parsed thus far.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;**&#39;</span>
        <span class="k">return</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substates</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">yes</span> <span class="nx">unless</span> <span class="nx">against</span>
        <span class="k">return</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">isSuperstateOf</span> <span class="nx">against</span>
        <span class="k">break</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Empty string, the product of leading/consecutive <code>.</code>s, implies <code>cursor</code>’s
superstate.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;&#39;</span> <span class="k">then</span> <span class="nv">cursor = </span><span class="nx">cursor</span><span class="p">.</span><span class="nx">superstate</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Interpret any other token as an identifier that names a specific substate of
<code>cursor</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span> <span class="nv">next = </span><span class="nx">cursor</span><span class="p">.</span><span class="nx">substate</span> <span class="nx">name</span> <span class="k">then</span> <span class="nv">cursor = </span><span class="nx">next</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If no matching substate exists, the query fails for this context.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">else</span> <span class="k">break</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Recursively descend the tree, breadth-first, and retry the query with a
different context.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_SUB</span>
      <span class="nv">i = </span><span class="mi">0</span><span class="p">;</span> <span class="nv">queue = </span><span class="p">[</span> <span class="k">this</span> <span class="p">]</span>
      <span class="k">while</span> <span class="nv">subject = </span><span class="nx">queue</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span>
        <span class="k">for</span> <span class="nx">substate</span> <span class="k">in</span> <span class="nx">subject</span><span class="p">.</span><span class="nx">substates</span> <span class="kc">yes</span>
          <span class="k">continue</span> <span class="k">if</span> <span class="nx">substate</span> <span class="o">is</span> <span class="nx">toBeSkipped</span>
          <span class="nv">result = </span><span class="nx">substate</span><span class="p">.</span><span class="nx">query</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">VIA_NONE</span>
          <span class="k">return</span> <span class="nx">result</span> <span class="k">if</span> <span class="nx">result</span>
          <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span> <span class="nx">substate</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Recursively ascend the tree and retry the query, but skip <code>this</code> subtree during
the subsequent descent, since it’s already been searched.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_SUPER</span>
      <span class="k">return</span> <span class="nx">result</span> <span class="k">if</span> <span class="nv">result = </span><span class="nx">@superstate</span><span class="o">?</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span>
        <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_SUB</span> <span class="o">|</span> <span class="nx">VIA_SUPER</span><span class="p">,</span> <span class="k">this</span> <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_SUB</span> <span class="p">)</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Retry the query on the protostate.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_PROTO</span>
      <span class="k">return</span> <span class="nx">result</span> <span class="k">if</span> <span class="nv">result = </span><span class="nx">@protostate</span><span class="o">?</span><span class="p">.</span><span class="nx">query</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">via</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>All possibilities exhausted; no matches exist.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">return</span> <span class="k">if</span> <span class="nx">against</span> <span class="k">then</span> <span class="kc">no</span> <span class="k">else</span> <span class="kc">null</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--dollarsign">$</a></h4>
<p>Convenience method that either aliases to <code>change</code> if passed a function for the
first argument, or aliases to <code>query</code> if passed a string — thereby mimicking
the behavior of the object’s accessor method.</p>
<blockquote>
<p><a href="/source/root-state.html#root-state--private--create-accessor"><code>createAccessor</code></a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">$: </span><span class="nf">( expr, args... ) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">expr</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="k">return</span> <span class="nx">@change</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="p">[</span> <span class="nx">expr</span> <span class="p">].</span><span class="nx">concat</span> <span class="nx">args</span> <span class="k">if</span> <span class="nv">expr = </span><span class="nx">expr</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">expr</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span> <span class="o">and</span>
        <span class="p">(</span> <span class="nv">match = </span><span class="nx">expr</span><span class="p">.</span><span class="nx">match</span> <span class="nx">rxTransitionArrow</span> <span class="p">)</span> <span class="o">and</span>
          <span class="nv">method = </span><span class="nx">transitionArrowMethods</span><span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">then</span> <span class="err">@</span><span class="p">[</span> <span class="nx">method</span> <span class="p">].</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">].</span><span class="nx">concat</span> <span class="nx">args</span>
      <span class="k">else</span> <span class="err">@</span><span class="p">[</span> <span class="nx">method</span> <span class="p">]</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--currency-methods">Currency methods</a></h3>
<p>Methods that inspect or affect the owner’s current state.</p>
<h4><a href="#state--prototype--current">current</a></h4>
<p>Gets the local state tree’s current state, which is authoritatively determined
by the root state.</p>
<blockquote>
<p><a href="/api/#state--methods--current">current</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">current: </span><span class="o">-&gt;</span> <span class="nx">@root</span><span class="p">.</span><span class="nx">_current</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--is-current">isCurrent</a></h4>
<p>Returns a <code>Boolean</code> indicating whether <code>this</code> is the owner’s current state.</p>
<blockquote>
<p><a href="/api/#state--methods--is-current">isCurrent</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">isCurrent: </span><span class="o">-&gt;</span> <span class="k">this</span> <span class="o">is</span> <span class="nx">@current</span><span class="p">()</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--is-active">isActive</a></h4>
<p>Returns a <code>Boolean</code> indicating whether <code>this</code> or one of its substates is the
owner’s current state.</p>
<blockquote>
<p><a href="/api/#state--methods--is-active">isActive</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">isActive: </span><span class="o">-&gt;</span> <span class="k">this</span> <span class="o">is</span> <span class="p">(</span> <span class="nv">current = </span><span class="nx">@current</span><span class="p">()</span> <span class="p">)</span> <span class="o">or</span> <span class="nx">@isSuperstateOf</span> <span class="nx">current</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--change">change</a></h4>
<p>Forwards a <code>change</code> command to <code>root</code> and returns its result. Calling with no
arguments implicitly directs the root to change to <code>this</code> state.</p>
<p><em>Aliases:</em> <strong>go</strong>, <strong>be</strong></p>
<blockquote>
<p><a href="/api/#state--methods--change">change</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">change: </span><span class="nf">( target, options ) -&gt;</span>
    <span class="p">(</span> <span class="nv">root = </span><span class="nx">@root</span> <span class="p">).</span><span class="nx">change</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">arguments</span>

  <span class="nv">go: </span><span class="err">@</span><span class="o">::</span><span class="nx">change</span>
  <span class="nv">be: </span><span class="err">@</span><span class="o">::</span><span class="nx">change</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--data-methods">Data methods</a></h3>
<h4><a href="#state--prototype--data">data</a></h4>
<p>Either retrieves or edits a block of data associated with this state.</p>
<p>If provided no argument, or an integer bit field, then <code>data</code> returns a copy
of the data attached to this state, including all data from inherited states,
unless specified otherwise by the <code>via</code> query flags.</p>
<p>If called with an object-typed argument, <code>data</code> edits the data held on this
state. For keys in <code>mutation</code> whose values are set to the <code>NIL</code> directive, the
matching keys in the state’s data are deleted. If the operation results in a
change to the state’s data, a <code>mutate</code> event is emitted for this state.</p>
<blockquote>
<p><a href="/docs/#concepts--data">Data</a>
<a href="/api/#state--methods--data--read">data (read)</a>
<a href="/api/#state--methods--data--write">data (write)</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">data: </span><span class="nf">( via = VIA_ALL, out ) -&gt;</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If the provided <code>via</code> argument is not a flags integer mask, and presumably an
object instead, then interpret this call as a <em>write</em> operation, and refer to
the parameter as <code>mutation</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">mutation = </span><span class="nx">via</span> <span class="k">if</span> <span class="nx">via</span> <span class="o">isnt</span> <span class="nx">via</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nx">mutation</span>
      <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
      <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">INCIPIENT_OR_MUTABLE</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">isEmpty</span> <span class="nx">mutation</span>
        <span class="k">return</span> <span class="nx">@realize</span><span class="p">().</span><span class="nx">data</span> <span class="nx">mutation</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>
        <span class="nv">residue = </span><span class="nx">delta</span> <span class="nx">@_</span><span class="p">.</span><span class="nx">data</span> <span class="o">?=</span> <span class="p">{},</span> <span class="nx">mutation</span>
        <span class="k">if</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">ATOMIC</span> <span class="o">and</span> <span class="nx">residue</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">isEmpty</span> <span class="nx">residue</span>
          <span class="nx">@emit</span> <span class="s1">&#39;mutate&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">mutation</span><span class="p">,</span> <span class="nx">residue</span> <span class="p">],</span> <span class="nx">VIA_PROTO</span>
      <span class="k">this</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Otherwise <em>read</em> and return a copy of <code>this</code> state’s <code>data</code>, including data
inherited <code>via</code> superstates and protostates, unless directed otherwise.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nx">out</span> <span class="o">?=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="nx">relative</span> <span class="k">in</span> <span class="nx">@order</span> <span class="o">?</span> <span class="nx">@linearize</span><span class="p">()</span> <span class="k">by</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_SUPER</span> <span class="o">or</span> <span class="nx">relative</span> <span class="o">is</span> <span class="k">this</span>
        <span class="nx">edit</span> <span class="s1">&#39;deep all&#39;</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span>
          <span class="p">(</span> <span class="nx">relative</span><span class="p">.</span><span class="nx">protostate</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span> <span class="nx">VIA_PROTO</span><span class="p">,</span> <span class="nx">out</span> <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_PROTO</span> <span class="p">),</span>
          <span class="nx">relative</span><span class="p">.</span><span class="nx">_</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span>
      <span class="nx">out</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--has">has</a></h4>
<p>Determines whether a property with the given <code>key</code> is contained within <code>this</code>
state’s <code>data</code> storage, or that of an ancestral protostate, parastate, or
superstate, unless directed otherwise by <code>via</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">has: </span><span class="nf">( key, via = VIA_ALL ) -&gt;</span>
    <span class="nv">viaSuper = </span><span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_SUPER</span>
    <span class="nv">viaProto = </span><span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_PROTO</span>
    <span class="k">for</span> <span class="nx">relative</span> <span class="k">in</span> <span class="nx">@order</span> <span class="o">?</span> <span class="nx">@linearize</span><span class="p">()</span>
      <span class="nv">s = </span><span class="nx">relative</span><span class="p">;</span> <span class="k">while</span> <span class="nx">s</span><span class="o">?</span>
        <span class="k">return</span> <span class="kc">yes</span> <span class="k">if</span> <span class="p">(</span> <span class="nv">data = </span><span class="nx">s</span><span class="p">.</span><span class="nx">_</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span> <span class="p">)</span><span class="o">?</span> <span class="o">and</span> <span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span>
        <span class="k">if</span> <span class="nx">viaProto</span> <span class="k">then</span> <span class="nv">s = </span><span class="nx">s</span><span class="p">.</span><span class="nx">protostate</span> <span class="k">else</span> <span class="k">break</span>
        <span class="k">continue</span> <span class="k">if</span> <span class="nx">viaSuper</span>
    <span class="kc">no</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--get">get</a></h4>
<p>Retrieves the value of a <code>key</code> within <code>this</code> state’s <code>data</code> storage, or from
that of an ancestral protostate, parastate, or superstate, unless directed
otherwise by <code>via</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">get: </span><span class="nf">( key, via = VIA_ALL ) -&gt;</span>
    <span class="nv">viaSuper = </span><span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_SUPER</span>
    <span class="nv">viaProto = </span><span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_PROTO</span>
    <span class="k">for</span> <span class="nx">relative</span> <span class="k">in</span> <span class="nx">@order</span> <span class="o">?</span> <span class="nx">@linearize</span><span class="p">()</span>
      <span class="nv">s = </span><span class="nx">relative</span><span class="p">;</span> <span class="k">while</span> <span class="nx">s</span><span class="o">?</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">data = </span><span class="nx">s</span><span class="p">.</span><span class="nx">_</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span> <span class="p">)</span><span class="o">?</span> <span class="o">and</span> <span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span>
          <span class="k">return</span> <span class="nx">data</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span>
        <span class="k">if</span> <span class="nx">viaProto</span> <span class="k">then</span> <span class="nv">s = </span><span class="nx">s</span><span class="p">.</span><span class="nx">protostate</span> <span class="k">else</span> <span class="k">break</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">viaSuper</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--let">let</a></h4>
<p>Assigns a <code>value</code> to a <code>key</code> within <code>this</code> state’s <code>data</code> storage. If no such
key already exists, it is added.</p>
<blockquote>
<p><a href="#state--prototype--set"><code>set</code></a>
<a href="/api/#state--methods--let">let</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">let: </span><span class="nf">( key, value ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">INCIPIENT_OR_MUTABLE</span>  <span class="c1"># should warn</span>
    <span class="nx">do</span> <span class="nx">@realize</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Assignment proceeds only if the <code>value</code> being written is not the same as the
<code>displaced</code> data that is being overwritten.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nv">data = </span><span class="nx">@_</span><span class="p">.</span><span class="nx">data</span> <span class="o">or</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nx">value</span> <span class="o">isnt</span> <span class="nv">displaced = </span><span class="nx">lookup</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span>
      <span class="nx">assign</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>
      <span class="nx">assign</span> <span class="p">(</span> <span class="nv">mutation = </span><span class="p">{}</span> <span class="p">).</span><span class="nv">data = </span><span class="p">{},</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>
      <span class="nx">assign</span> <span class="p">(</span> <span class="nv">residue = </span><span class="p">{}</span> <span class="p">).</span><span class="nv">data = </span><span class="p">{},</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">displaced</span>
      <span class="nx">@emit</span> <span class="s1">&#39;mutate&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">mutation</span><span class="p">,</span> <span class="nx">residue</span> <span class="p">],</span> <span class="nx">VIA_PROTO</span>

    <span class="nx">value</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--set">set</a></h4>
<p>Assigns a <code>value</code> to an existing <code>key</code> within the <code>data</code> storage of the nearest
mutable ancestral parastate or superstate of <code>this</code>. Returns the equivalent of
a <code>let</code> operation on <code>this</code> if no such ancestor can be affected.</p>
<p>Only <code>State</code>s that belong to <code>this.owner</code> can be affected by <code>set</code>; their
protostates cannot.</p>
<blockquote>
<p><a href="/api/#state--methods--let">let</a>
<a href="/api/#state--methods--set">set</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">set: </span><span class="nf">( key, value ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">INCIPIENT_OR_MUTABLE</span>
    <span class="nx">do</span> <span class="nx">@realize</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Find the nearest <code>State</code> along the linearization path of <code>this</code> whose <code>data</code>
storage contains a property with the given <code>key</code>, and mutate that property with
the given <code>value</code> if allowed to do so. If these steps do not complete, delegate
to <code>let</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">relative</span> <span class="k">in</span> <span class="nx">@order</span> <span class="o">?</span> <span class="nx">@linearize</span><span class="p">()</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nv">data = </span><span class="nx">relative</span><span class="p">.</span><span class="nx">_</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span> <span class="p">)</span><span class="o">?</span> <span class="o">and</span> <span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span>
        <span class="k">return</span> <span class="nx">relative</span><span class="p">.</span><span class="nx">let</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">if</span> <span class="nx">relative</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span>
        <span class="k">break</span>
    <span class="nx">@let</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--delete">delete</a></h4>
<p>Removes a property from <code>this</code> state’s <code>data</code> storage, provided that <code>this</code> is
mutable.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="k">delete</span><span class="o">:</span> <span class="nf">( key ) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span>
    <span class="nx">NIL</span> <span class="o">is</span> <span class="nx">@let</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">NIL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--method-methods">Method methods</a></h3>
<h4><a href="#state--prototype--method">method</a></h4>
<p>Retrieves the named method for this state. Providing an optional <code>out</code> object
allows the appropriate <code>context</code> for a state-bound method to be delivered as a
property of <code>out</code>; if included, <code>context</code> is confined to the local state tree.</p>
<blockquote>
<p><a href="/api/#state--methods--method">method</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">method: </span><span class="nf">( methodName, via = VIA_ALL, out, returnBoxed ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="nv">realized = </span><span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span></pre></div>
    </div>
  
    
    <div class="text">
      
<blockquote>
<p>During the pseudo-loop block, the <code>context</code> reference should be considered
  provisional, because its potential value is in part a product of the manner
  in which its accompanying <code>method</code> was retrieved. After <code>break</code>ing out of the
  block, if <code>method</code> is a state-bound function, then <code>context</code> will be either
  kept and exported via <code>out</code>, or discarded otherwise.</p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">loop</span> <span class="c1"># once</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>First seek a local or memoized inherited implementation of the named method.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">realized</span>
        <span class="k">if</span> <span class="nv">method = </span><span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">methods</span><span class="o">?</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span>
          <span class="nv">context = </span><span class="k">this</span>
          <span class="k">break</span>
        <span class="k">if</span> <span class="nv">record = </span><span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">__dispatch_table__</span><span class="o">?</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span>
          <span class="p">[</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">context</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">record</span>
          <span class="k">break</span> <span class="k">if</span> <span class="nx">method</span><span class="o">?</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If an implementation is not available locally, seek an inherited method along
the protostate chain. If this succeeds, the provisional <code>context</code> will be the
<em>epistate</em> that inherits the method.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nv">viaProto = </span><span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_PROTO</span>
        <span class="k">if</span> <span class="nv">method = </span><span class="nx">@protostate</span><span class="o">?</span><span class="p">.</span><span class="nx">method</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">VIA_PROTO</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">yes</span>
          <span class="nv">context = </span><span class="k">this</span>
          <span class="nv">inherited = </span><span class="kc">yes</span>
          <span class="k">break</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If no local or protostatic method exists, seek an inherited method along the
linearization path. If this succeeds, the provisional <code>context</code> will be the
<em>superstate or parastate</em> from which the method is inherited.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_SUPER</span>
        <span class="k">for</span> <span class="nx">relative</span> <span class="k">in</span> <span class="nx">@order</span> <span class="o">?</span> <span class="nx">@linearize</span><span class="p">()</span> <span class="k">when</span> <span class="nx">relative</span> <span class="o">isnt</span> <span class="k">this</span>
          <span class="k">if</span> <span class="nv">method = </span><span class="nx">relative</span><span class="p">.</span><span class="nx">method</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">viaProto</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">yes</span>
            <span class="nv">context = </span><span class="nx">out</span><span class="o">?</span><span class="p">.</span><span class="nx">context</span> <span class="o">?</span> <span class="kc">null</span>
            <span class="nv">inherited = </span><span class="kc">yes</span>
            <span class="k">break</span>
        <span class="k">break</span> <span class="k">if</span> <span class="nx">method</span><span class="o">?</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>The method does not exist.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nv">context = </span><span class="kc">null</span>
      <span class="k">break</span> <span class="c1"># always</span>

    <span class="k">if</span> <span class="nx">method</span><span class="o">?</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If <code>method</code> is a function, it is not state-bound, so <code>context</code> is unnecessary.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">method</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
        <span class="nv">context = </span><span class="kc">null</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Iff <code>this</code> is a realized <code>State</code>, inherited lookup results can be memoized in
the local dispatch table.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">realized</span> <span class="o">and</span> <span class="nx">inherited</span> <span class="o">and</span> <span class="nx">useDispatchTables</span>
        <span class="nv">table = </span><span class="nx">@_</span><span class="p">.</span><span class="nx">__dispatch_table__</span> <span class="o">?=</span> <span class="p">{}</span>
        <span class="nx">table</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">context</span> <span class="p">]</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Unbox a state-bound function unless directed otherwise.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nx">unless</span> <span class="nx">returnBoxed</span>
        <span class="nv">method = </span><span class="nx">method</span><span class="p">.</span><span class="nx">fn</span> <span class="k">if</span> <span class="nx">method</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;state-bound-function&#39;</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Export <code>method</code> and <code>context</code> together if the <code>out</code> reference was provided.</p>
<blockquote>
<p>Callers who know that <code>method</code> will be unbound need not provide an <code>out</code>.</p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">out</span><span class="o">?</span>
      <span class="nv">out.method = </span><span class="nx">method</span>
      <span class="nv">out.context = </span><span class="nx">context</span>

    <span class="nx">method</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--method-names">methodNames</a></h4>
<p>Returns an <code>Array</code> of names of methods defined for this state.</p>
<blockquote>
<p><a href="/api/#state--methods--method-names">methodNames</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">methodNames: </span><span class="o">-&gt;</span>
    <span class="nx">keys</span> <span class="nx">methods</span> <span class="k">if</span> <span class="nv">methods = </span><span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">methods</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--add-method">addMethod</a></h4>
<p>Adds a method to this state. The provided <code>fn</code> may be any of:</p>
<ol>
<li>A proper function, which will be called in the context of <code>@owner</code>;</li>
<li>A boxing of a <em>bound</em> function as prepared by <code>state.bind</code>, which will
cause the boxed function to be called in the context of either <code>this</code>
<code>State</code> or the <em>epistate</em> inheriting the method;</li>
<li>A boxing of a <em>fixed</em> function as prepared by <code>state.fix</code>, whose boxed
function will be closed over hard references to <code>this</code> as <code>autostate</code>,
and to the <em>protostate</em> of <code>this</code>, as <code>protostate</code>.</li>
</ol>
<p>If a method called <code>methodName</code> does not already exist in the state tree, then
the owner is provided a <em>dispatcher</em> to accommodate calls to the appropriate
state’s implementation of this method.</p>
<blockquote>
<p><a href="/source/export-static.html#utility-functions--bind"><code>state.bind</code></a>
<a href="/source/export-static.html#utility-functions--fix"><code>state.fix</code></a>
<a href="/api/#state--methods--add-method">addMethod</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">addMethod: </span><span class="nf">( methodName, fn ) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">INCIPIENT_OR_MUTABLE</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If <code>fn</code> boxes a <em>state-fixed</em> function, then partially apply that function to
extract the actual method, closed over references to the locality of <code>this</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">fn</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span> <span class="o">and</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;state-fixed-function&#39;</span>
      <span class="nv">fn = </span><span class="nx">fn</span><span class="p">.</span><span class="nx">fn</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@protostate</span>

    <span class="nx">unless</span> <span class="k">typeof</span> <span class="nx">fn</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="o">or</span> <span class="nx">fn</span><span class="o">?</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;state-bound-function&#39;</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s2">&quot;Must supply a plain, bound, or fixed function&quot;</span>

    <span class="p">{</span> <span class="nx">owner</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Skip ahead if the owner is already set up with a dispatcher for this method.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">unless</span> <span class="p">(</span> <span class="nv">ownerMethod = </span><span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">isDispatcher</span>
      <span class="p">{</span> <span class="nx">root</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Create a new dispatcher method for <code>owner</code>. Its original method, if it has one,
will be retained by the dispatcher, so that if the state tree is <code>destroy</code>ed
later, the method can be reinstated on <code>owner</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span>
        <span class="nx">createDispatcher</span> <span class="nx">root</span><span class="p">.</span><span class="nx">accessorName</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">ownerMethod</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Unless we’re adding directly to <code>root</code>, copy <code>ownerMethod</code> to <code>root</code> — which
will not have an implementation for this method. (If it did, then <code>ownerMethod</code>
would already be a dispatcher.) From the root state it can still serve as
<code>owner</code>’s default implementation, available to any of its <code>State</code>s that do not
override that method.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">ownerMethod</span><span class="o">?</span> <span class="o">and</span> <span class="k">this</span> <span class="o">isnt</span> <span class="nx">root</span>
        <span class="nv">methods = </span><span class="nx">root</span><span class="p">.</span><span class="nx">_</span><span class="o">?</span><span class="p">.</span><span class="nx">methods</span> <span class="o">or</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">ownerMethod</span>

    <span class="nv">methods = </span><span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">methods</span> <span class="o">or</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--remove-method">removeMethod</a></h4>
<p>Dissociates the named method from this state object and returns its function.</p>
<blockquote>
<p><a href="/api/#state--methods--remove-method">removeMethod</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">removeMethod: </span><span class="nf">( methodName ) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">and</span> <span class="p">(</span> <span class="nv">methods = </span><span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">methods</span> <span class="p">)</span> <span class="o">and</span>
      <span class="nv">fn = </span><span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span>
    <span class="k">delete</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span>
    <span class="nx">fn</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--has-method">hasMethod</a></h4>
<p>Determines whether <code>this</code> possesses or inherits a method named <code>methodName</code>.</p>
<blockquote>
<p><a href="/api/#state--methods--has-method">hasMethod</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">hasMethod: </span><span class="nf">( methodName ) -&gt;</span>
    <span class="nv">method = </span><span class="nx">@method</span> <span class="nx">methodName</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--has-own-method">hasOwnMethod</a></h4>
<p>Determines whether <code>this</code> directly possesses a method named <code>methodName</code>.</p>
<blockquote>
<p><a href="/api/#state--methods--has-own-method">hasOwnMethod</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">hasOwnMethod: </span><span class="nf">( methodName ) -&gt;</span>
    <span class="o">!!</span> <span class="nx">@method</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">VIA_NONE</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--apply">apply</a></h4>
<p>Finds a state method and applies it in the appropriate context.</p>
<p>If the named method does not exist locally and cannot be inherited, then
<code>noSuchMethod</code> events are emitted, and the call returns <code>undefined</code>.</p>
<blockquote>
<p><a href="/api/#state--methods--apply">apply</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">apply: </span><span class="nf">( methodName, args ) -&gt;</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>First try to resolve the method quickly from the local dispatch table.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">record = </span><span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">__dispatch_table__</span><span class="o">?</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span>
      <span class="p">[</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">context</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">record</span>
      <span class="nv">method = </span><span class="nx">method</span><span class="p">.</span><span class="nx">fn</span> <span class="k">if</span> <span class="nx">method</span><span class="o">?</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;state-bound-function&#39;</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Resort to a proper lookup if the fast way turns up nothing.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">method</span><span class="o">?</span>
      <span class="k">if</span> <span class="nv">method = </span><span class="nx">@method</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">VIA_ALL</span><span class="p">,</span> <span class="nv">out = </span><span class="p">{}</span>
        <span class="p">{</span> <span class="nx">context</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">out</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Bail out gracefully if the method definitively cannot be resolved.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>      <span class="k">else</span>
        <span class="nx">@emit</span> <span class="s1">&#39;noSuchMethod&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span> <span class="p">]</span>
        <span class="nx">@emit</span> <span class="s1">&#39;noSuchMethod:&#39;</span> <span class="o">+</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span>
        <span class="k">return</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>If at this point a <code>context</code> is provided, this means that <code>method</code> is a
state-bound function, and <code>context</code> will be the appropriately bound <code>State</code>. If
no <code>context</code> exists, this means that <code>method</code> is a typical non-state-bound
function, which is meant to be invoked in the usual fashion, just as if it were
called directly as a method of <code>this</code> state’s <code>owner</code>.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">context</span> <span class="o">or</span> <span class="nx">@owner</span><span class="p">,</span> <span class="nx">args</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--call">call</a></h4>
<p>Variadic <code>apply</code>.</p>
<blockquote>
<p><a href="/api/#state--methods--call">call</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">call: </span><span class="nf">( methodName, args... ) -&gt;</span>
    <span class="nx">@apply</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--event-methods">Event methods</a></h3>
<h4><a href="#state--prototype--event">event</a></h4>
<p>Returns a registered event listener, or the number of listeners registered, for
a given event <code>type</code>.</p>
<p>If an <code>id</code> as returned by <code>addEvent</code> is provided, the event listener associated
with that <code>id</code> is returned. If no <code>id</code> is provided, the number of event
listeners registered to <code>type</code> is returned.</p>
<blockquote>
<p><a href="/api/#state--methods--event">event</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">event: </span><span class="nf">( eventType, id ) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nv">emitter = </span><span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">events</span><span class="o">?</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">]</span>
    <span class="k">return</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">length</span> <span class="k">if</span> <span class="nx">id</span> <span class="o">is</span> <span class="kc">undefined</span>
    <span class="nv">id = </span><span class="nx">emitter</span><span class="p">.</span><span class="nx">key</span> <span class="nx">id</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">id</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nx">emitter</span><span class="p">.</span><span class="nx">get</span> <span class="nx">id</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--add-event">addEvent</a></h4>
<p>Binds an event listener to the specified <code>eventType</code> and returns a unique
identifier for the listener.</p>
<p><em>Alias:</em> <strong>on</strong></p>
<blockquote>
<p><a href="/api/#state--methods--add-event">addEvent</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">addEvent: </span><span class="nf">( eventType, fn, context ) -&gt;</span>
    <span class="nx">do</span> <span class="nx">@realize</span> <span class="k">if</span> <span class="nx">@attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>

    <span class="nv">events = </span><span class="nx">@_</span><span class="p">.</span><span class="nx">events</span> <span class="o">or</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">unless</span> <span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">eventType</span>
      <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateEventEmitter</span> <span class="k">this</span>

    <span class="k">if</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;state-fixed-function&#39;</span>
      <span class="nv">fn = </span><span class="nx">fn</span><span class="p">.</span><span class="nx">fn</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@protostate</span>

    <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">].</span><span class="nx">add</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span>

  <span class="kc">on</span><span class="o">:</span> <span class="err">@</span><span class="o">::</span><span class="nx">addEvent</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--remove-event">removeEvent</a></h4>
<p>Unbinds the event listener with the specified <code>id</code> that was supplied by
<code>addEvent</code>.</p>
<p><em>Alias:</em> <strong>off</strong></p>
<blockquote>
<p><a href="/api/#state--methods--remove-event">removeEvent</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">removeEvent: </span><span class="nf">( eventType, id ) -&gt;</span>
    <span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">events</span><span class="o">?</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">].</span><span class="nx">remove</span> <span class="nx">id</span>

  <span class="kc">off</span><span class="o">:</span> <span class="err">@</span><span class="o">::</span><span class="nx">removeEvent</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--emit">emit</a></h4>
<p>Invokes all listeners bound to the given event type. Callbacks inherited from
protostates, parastates, and superstates are also invoked, unless otherwise
directed by the traversal flags of <code>via</code>.</p>
<p>Arguments to be supplied to callbacks can be passed as an array to <code>args</code>.</p>
<p>Unless <code>context</code> is provided explicitly, a provisional <code>State</code> <code>context</code> is
determined for event callbacks that are state-bound functions. This <code>context</code>
will be either <code>this</code> or an <em>epistate</em> that inherits events from <code>this</code>.</p>
<p>Normal, unbound callbacks are invoked in the context of <code>this.owner</code> as usual.</p>
<p><em>Alias:</em> <strong>trigger</strong></p>
<blockquote>
<p><a href="/api/#state--methods--emit">emit</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">emit: </span><span class="nf">( eventType, args, context, via = VIA_ALL ) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">eventType</span> <span class="o">isnt</span> <span class="s1">&#39;string&#39;</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">args</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span>
      <span class="nv">via = </span><span class="nx">context</span><span class="p">;</span> <span class="nv">context = </span><span class="nx">args</span><span class="p">;</span> <span class="nv">args = </span><span class="kc">undefined</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">context</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span>
      <span class="nv">via = </span><span class="nx">context</span><span class="p">;</span> <span class="nv">context = </span><span class="kc">undefined</span>

    <span class="nv">args = </span><span class="p">[</span><span class="nx">args</span><span class="p">]</span> <span class="k">if</span> <span class="nx">args</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">isArray</span> <span class="nx">args</span></pre></div>
    </div>
  
    
    <div class="text">
      
<p>Provisional <code>context</code> is flattened onto <code>this.owner</code>’s state tree.</p>

    </div>
    <div class="code">
      <div class="highlight"><pre>    <span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">events</span><span class="o">?</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emit</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">?</span> <span class="k">this</span>
    <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_PROTO</span>
      <span class="nx">@protostate</span><span class="o">?</span><span class="p">.</span><span class="nx">emit</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">?</span> <span class="k">this</span><span class="p">,</span> <span class="nx">VIA_PROTO</span>
    <span class="k">if</span> <span class="nx">via</span> <span class="o">&amp;</span> <span class="nx">VIA_SUPER</span>
      <span class="k">for</span> <span class="nx">relative</span> <span class="k">in</span> <span class="nx">@order</span> <span class="o">?</span> <span class="nx">@linearize</span><span class="p">()</span> <span class="k">when</span> <span class="nx">relative</span> <span class="o">isnt</span> <span class="k">this</span>
        <span class="nx">relative</span><span class="p">.</span><span class="nx">emit</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">?</span> <span class="nx">relative</span>

    <span class="k">return</span>

  <span class="nv">trigger: </span><span class="err">@</span><span class="o">::</span><span class="nx">emit</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--guard-methods">Guard methods</a></h3>
<h4><a href="#state--prototype--guard">guard</a></h4>
<p>Gets a <strong>guard</strong> entity for this state. A guard is a value or function that
will be evaluated during a transition to determine whether an owner’s currency
will be <em>admitted</em> into or <em>released</em> from the <code>State</code> to which the guard is
applied.</p>
<p>Guards are inherited from protostates, but not from parastates or superstates.</p>
<blockquote>
<p><a href="#state--private--evaluate-guard"><code>evaluateGuard</code></a>
<a href="/api/#state--methods--guard">guard</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">guard: </span><span class="nf">( guardType ) -&gt;</span>
    <span class="k">if</span> <span class="nv">guard = </span><span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">guards</span><span class="o">?</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="k">then</span> <span class="nx">clone</span> <span class="nx">guard</span>
    <span class="k">else</span> <span class="nx">@protostate</span><span class="o">?</span><span class="p">.</span><span class="nx">guard</span><span class="p">(</span> <span class="nx">guardType</span> <span class="p">)</span> <span class="o">or</span> <span class="kc">undefined</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--add-guard">addGuard</a></h4>
<p>Adds a guard to this state, or augments an existing guard with additional
entries.</p>
<blockquote>
<p><a href="/api/#state--methods--add-guard">addGuard</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">addGuard: </span><span class="nf">( guardType, guard ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">INCIPIENT_OR_MUTABLE</span>
    <span class="nx">do</span> <span class="nx">@realize</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>
    <span class="nv">guards = </span><span class="nx">@_</span><span class="p">.</span><span class="nx">guards</span> <span class="o">or</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">edit</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="o">or</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">guard</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--remove-guard">removeGuard</a></h4>
<p>Removes a guard from this state, or removes specific entries from an existing
guard.</p>
<blockquote>
<p><a href="/api/#state--methods--remove-guard">removeGuard</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">removeGuard: </span><span class="nf">( guardType, args... ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">and</span> <span class="nv">guards = </span><span class="nx">@_</span><span class="p">.</span><span class="nx">guards</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nv">guard = </span><span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span> <span class="nx">guard</span> <span class="k">if</span> <span class="k">delete</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="p">)</span> <span class="nx">unless</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span>

    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">flatten</span> <span class="nx">args</span> <span class="k">when</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
      <span class="nv">entry = </span><span class="nx">guard</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span>
      <span class="k">return</span> <span class="nx">entry</span> <span class="k">if</span> <span class="k">delete</span> <span class="nx">guard</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--transition-methods">Transition methods</a></h3>
<p>A <code>State</code> may hold <strong>transition expressions</strong> that describe a <code>Transition</code>
involving itself or any descendant <code>State</code>.</p>
<h4><a href="#state--prototype--transition">transition</a></h4>
<p>Returns the named transition expression held on this state.</p>
<blockquote>
<p><a href="/api/#state--methods--transition">transition</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">transition: </span><span class="nf">( name ) -&gt;</span> <span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">transitions</span><span class="o">?</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--transitions">transitions</a></h4>
<p>Returns an object containing all of the transition expressions defined
on this state.</p>
<blockquote>
<p><a href="/api/#state--methods--transitions">transitions</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">transitions: </span><span class="o">-&gt;</span> <span class="nx">clone</span> <span class="nx">@_</span><span class="o">?</span><span class="p">.</span><span class="nx">transitions</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--add-transition">addTransition</a></h4>
<p>Registers a transition expression to this state.</p>
<blockquote>
<p><a href="/api/#state--methods--add-transition">addTransition</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">addTransition: </span><span class="nf">( name, expression ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">INCIPIENT_OR_MUTABLE</span>
    <span class="nx">do</span> <span class="nx">@realize</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>
    <span class="nx">unless</span> <span class="nx">expression</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span>
      <span class="nv">expression = </span><span class="k">new</span> <span class="nx">TransitionExpression</span> <span class="nx">expression</span>
    <span class="nv">transitions = </span><span class="nx">@_</span><span class="p">.</span><span class="nx">transitions</span> <span class="o">or</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">expression</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h4><a href="#state--prototype--remove-transition">removeTransition</a></h4>
<p>Removes a transition expression from this state.</p>
<blockquote>
<p><a href="/api/#state--methods--remove-transition">removeTransition</a></p>
</blockquote>

    </div>
    <div class="code">
      <div class="highlight"><pre>  <span class="nv">removeTransition: </span><span class="nf">( name ) -&gt;</span>
    <span class="p">{</span> <span class="nx">attributes</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">and</span> <span class="nv">transitions = </span><span class="nx">@_</span><span class="p">.</span><span class="nx">transitions</span>
    <span class="nv">transition = </span><span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span>
    <span class="k">delete</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="k">if</span> <span class="nx">transition</span>
    <span class="nx">transition</span></pre></div>
    </div>
  
    
    <div class="text">
      
<h3><a href="#state--forward-imports">Forward imports</a></h3>

    </div>
    <div class="code">
      <div class="highlight"><pre><span class="nv">State::Metaobject     = </span><span class="nx">require</span> <span class="s1">&#39;./state-metaobject&#39;</span>
<span class="nv">State::Expression =</span>
<span class="nv">StateExpression       = </span><span class="nx">require</span> <span class="s1">&#39;./state-expression&#39;</span>
<span class="nv">StateEventEmitter     = </span><span class="nx">require</span> <span class="s1">&#39;./state-event-emitter&#39;</span>
<span class="nv">TransitionExpression  = </span><span class="nx">require</span> <span class="s1">&#39;./transition-expression&#39;</span>

</pre></div>
    </div>
  
</div>