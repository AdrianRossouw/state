         <div class="row">         <div class="text span5"><p>Copyright (C) 2011-2012 Nick Fargo, Z Vector Inc.</p>

<p><a href="https://github.com/nickfargo/state/blob/master/LICENSE"><code>LICENSE</code></a> MIT.</p>

<p><strong>State</strong> implements state-driven behavior directly into any JavaScript
object.</p>

<blockquote>
  <p><a href="/">statejs.org</a>
  <a href="/blog/">blog</a>
  <a href="/docs/">docs</a>
  <a href="/api/">api</a>
  <a href="/tests/">tests</a>
  <a class="icon-invertocat" href="http://github.com/nickfargo/state"></a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre><span class="p">;(</span> <span class="kd">function</span> <span class="p">(</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

<span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">global</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>

    <span class="nx">meta</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">VERSION</span><span class="o">:</span> <span class="s1">&#39;0.0.8&#39;</span><span class="p">,</span>

        <span class="nx">noConflict</span><span class="o">:</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">original</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">global</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">original</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">}()</span> <span class="p">),</span>

        <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">memoizeProtostates</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The lone dependency of <strong>State</strong> is <a href="http://github.com/nickfargo/omicron">Omicron</a>,
a library that assists with tasks such as object manipulation,
differential operations, and facilitation of prototypal inheritance.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">O</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">require</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;omicron&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">global</span><span class="p">.</span><span class="nx">O</span><span class="p">,</span>

    <span class="nx">NIL</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">NIL</span><span class="p">;</span>


<span class="kd">var</span> <span class="nx">rxTransitionArrow</span>       <span class="o">=</span> <span class="sr">/^\s*([\-|=]&gt;)\s*(.*)/</span><span class="p">,</span>
    <span class="nx">transitionArrowMethods</span>  <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;-&gt;&#39;</span><span class="o">:</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="s1">&#39;=&gt;&#39;</span><span class="o">:</span> <span class="s1">&#39;changeTo&#39;</span> <span class="p">};</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h2><a href="#module">state()</a></h2>

<p>The <code>state</code> module is exported as a function. This is used either: (1) to
generate a formal <a href="#state-expression"><code>StateExpression</code></a>; or (2) to bestow
an arbitrary <code>owner</code> object with a new implementation of state based on the
supplied <code>expression</code>, returning the owner’s initial
<a href="#state"><code>State</code></a>.</p>

<p>All arguments are optional. If only one <code>object</code>-typed argument is provided,
it is assigned to the <code>expression</code> parameter. If no <code>owner</code> is present,
<code>state</code> returns a <code>StateExpression</code> based on the contents of <code>expression</code>
(and <code>attributes</code>). If both an <code>owner</code> and <code>expression</code> are present, <code>state</code>
acts in the second capacity, causing <code>owner</code> to become stateful. The
<code>attributes</code> argument may include any of the words defined in
<a href="#module--constants--state-attribute-modifiers"><code>STATE_ATTRIBUTE_MODIFIERS</code></a>,
which are encoded into the provided <code>expression</code>.</p>

<blockquote>
  <p>See also:
  <a href="#state"><code>State</code></a>, <a href="#module--constants--state-attributes"><code>STATE_ATTRIBUTES</code></a>,
  <a href="#state-expression"><code>StateExpression</code></a>, <a href="#state-controller"><code>StateController</code></a></p>
  
  <p><a href="/docs/#getting-started--the-state-function">The <code>state</code> function</a>
  <a href="/api/#module"><code>state()</code></a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">state</span> <span class="p">(</span>
                      <span class="cm">/*Object*/</span> <span class="nx">owner</span><span class="p">,</span>      <span class="c1">// optional</span>
                      <span class="cm">/*String*/</span> <span class="nx">attributes</span><span class="p">,</span> <span class="c1">// optional</span>
    <span class="cm">/*StateExpression | Object*/</span> <span class="nx">expression</span><span class="p">,</span> <span class="c1">// optional</span>
             <span class="cm">/*Object | String*/</span> <span class="nx">options</span>     <span class="c1">// optional</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">owner</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">expression</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">owner</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">;</span>
            <span class="nx">expression</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">;</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">;</span>
            <span class="nx">owner</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">;</span>
            <span class="nx">expression</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">;</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">expression</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>

    <span class="k">return</span> <span class="nx">owner</span> <span class="o">?</span>
        <span class="k">new</span> <span class="nx">StateController</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">options</span> <span class="p">).</span><span class="nx">current</span><span class="p">()</span> <span class="o">:</span>
        <span class="nx">expression</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">meta</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#module--constants">Module-level constants</a></h3></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#module--constants--state-attributes">State attributes</a></h4>

<p>Attribute values are stored as a bit field in a <a href="#state"><code>State</code></a> instance.
Most attributes enumerated here also correspond with a
<a href="#module--constants--state-attribute-modifiers">modifier</a>
keyword that can be included in a call to <a href="#module"><code>state()</code></a>.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">STATE_ATTRIBUTES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">NORMAL</span>      <span class="o">:</span> <span class="mh">0x0</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--virtual">virtual</a></h5>

<p>A <strong>virtual state</strong> is a lightweight inheritor of a <strong>protostate</strong>
located higher in the owner object’s prototype chain. Notably, as
virtual states are created automatically, no modifier keyword exists
for the <code>virtual</code> attribute.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">VIRTUAL</span>     <span class="o">:</span> <span class="mh">0x1</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--mutable">mutable</a></h5>

<p>By default, states are <strong>weakly immutable</strong>; i.e., once a <code>State</code> has
been constructed, its declared data, methods, guards, substates, and
transitions cannot be altered. By including the <code>mutable</code> attribute in
the state’s expression, this restriction is lifted. Mutability is also
inherited from any of a state’s superstates or protostates.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">MUTABLE</span>     <span class="o">:</span> <span class="mh">0x2</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--finite">finite</a></h5>

<p>If a state is declared <code>finite</code>, no substates or descendant states may
be added, nor may any be removed without also destroying the state
itself.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">FINITE</span>      <span class="o">:</span> <span class="mh">0x4</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--static">static</a></h5>

<p>If a state is declared <code>static</code>, none of its contents may be changed
except for its substates.
<em>(Reserved; not presently implemented.)</em></p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">STATIC</span>      <span class="o">:</span> <span class="mh">0x8</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--immutable">immutable</a></h5>

<p>Adding the <code>immutable</code> attribute causes a state to become <strong>strongly
immutable</strong>, wherein it guarantees immutability absolutely, throughout
all inheriting states, overriding and negating any included or inherited
<code>mutable</code> attributes.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">IMMUTABLE</span>   <span class="o">:</span> <span class="mh">0x10</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--initial">initial</a></h5>

<p>Marking a state <code>initial</code> specifies which state a newly stateful object
should assume.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">INITIAL</span>     <span class="o">:</span> <span class="mh">0x20</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--conclusive">conclusive</a></h5>

<p>Once a state marked <code>conclusive</code> is entered, it cannot be exited,
although transitions may still freely traverse within its substates.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">CONCLUSIVE</span>  <span class="o">:</span> <span class="mh">0x40</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--final">final</a></h5>

<p>Once a state marked <code>final</code> is entered, no further outbound transitions
within its local region are allowed.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">FINAL</span>       <span class="o">:</span> <span class="mh">0x80</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--abstract">abstract</a></h5>

<p>An <code>abstract</code> state is used only as a source of inheritance, and cannot
itself be current. Consequently a transition that targets an abstract
state will be automatically redirected to one of its substates.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">ABSTRACT</span>    <span class="o">:</span> <span class="mh">0x100</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--concrete">concrete</a></h5>

<p>Marking a state <code>concrete</code> overrides an <code>abstract</code> attribute that would
otherwise be inherited from a protostate.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">CONCRETE</span>    <span class="o">:</span> <span class="mh">0x200</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--default">default</a></h5>

<p>Marking a state <code>default</code> designates it as the actual target for any
transition that targets its abstract superstate.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">DEFAULT</span>     <span class="o">:</span> <span class="mh">0x400</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--reflective">reflective</a></h5>

<p>A state marked <code>reflective</code> copies or “reflects” its properties onto
the owner whenever it becomes active. If the state is <code>mutable</code>, then
before it becomes inactive again it will “soak” into itself any new
properties that were added or changed on the owner while the state was
active.
<em>(Reserved; not presently implemented.)</em></p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">REFLECTIVE</span>  <span class="o">:</span> <span class="mh">0x800</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--history">history</a></h5>

<p>Marking a state with the <code>history</code> attribute causes its internal state
to be recorded in a sequential <strong>history</strong>. Whereas a <code>retained</code> state
is concerned only with the most recent internal state, a state’s history
can be traversed and altered, resulting in transitions back or forward
to previously or subsequently held internal states.
<em>(Reserved; not presently implemented.)</em></p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">HISTORY</span>     <span class="o">:</span> <span class="mh">0x1000</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--retained">retained</a></h5>

<p>A <code>retained</code> state is one that preserves its own internal state, such
that, after the state has become no longer active, a subsequent
transition targeting that particular state will automatically be
redirected to whichever of its descendant states was most recently
current.
<em>(Reserved; not presently implemented.)</em></p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">RETAINED</span>    <span class="o">:</span> <span class="mh">0x2000</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--shallow">shallow</a></h5>

<p>Normally, states that are <code>retained</code> or that keep a <code>history</code> persist
their internal state <em>deeply</em>, i.e., with a scope extending over all of
the state’s descendant states. Marking a state <code>shallow</code> limits the
scope of its persistence to its immediate substates only.
<em>(Reserved; not presently implemented.)</em></p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">SHALLOW</span>     <span class="o">:</span> <span class="mh">0x4000</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--versioned">versioned</a></h5>

<p>Would cause alterations to a state to result in a reflexive transition,
with a delta object distinguishing the prior version of the state from
its new version. Should also add a history entry wherever appropriate,
representing the prior version and the delta.
<em>(Reserved; not presently implemented.)</em></p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">VERSIONED</span>   <span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--state-attributes--concurrent">concurrent</a></h5>

<p>In a state marked <code>concurrent</code>, the substates are considered
<strong>concurrent orthogonal regions</strong>. Upon entering a concurrent state,
the controller creates a new set of subcontrollers, one for each region,
which will exist as long as the concurrent state remains active. Method
calls are forwarded to at most one of the regions, or if a reduction
function is associated with the given method, the call is repeated for
each region and the results reduced accordingly on their way back to the
owner.
<em>(Reserved; not presently implemented.)</em></p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">CONCURRENT</span>  <span class="o">:</span> <span class="mh">0x8000</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"></div>         <div class="code span11"><div class="highlight"><pre><span class="p">};</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#module--constants--name-sets">Name sets</a></h4></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--name-sets--state-attribute-modifiers">State attribute modifiers</a></h5>

<p>The subset of attributes that are valid or reserved keywords for the
<code>attributes</code> argument in a call to the exported <a href="#module"><code>state</code></a>
function.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">STATE_ATTRIBUTE_MODIFIERS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;mutable finite static immutable&#39;</span><span class="p">,</span>
        <span class="s1">&#39;initial conclusive final&#39;</span><span class="p">,</span>
        <span class="s1">&#39;abstract concrete default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;reflective&#39;</span><span class="p">,</span>
        <span class="s1">&#39;history retained shallow versioned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;concurrent&#39;</span>
    <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--name-sets--state-expression-categories">State expression categories</a></h5></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">STATE_EXPRESSION_CATEGORIES</span> <span class="o">=</span>
        <span class="s1">&#39;data methods events guards states transitions&#39;</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--name-sets--state-event-types">State event types</a></h5></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">STATE_EVENT_TYPES</span> <span class="o">=</span>
        <span class="s1">&#39;construct depart exit enter arrive destroy mutate noSuchMethod&#39;</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--name-sets--guard-actions">Guard actions</a></h5></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">GUARD_ACTIONS</span> <span class="o">=</span>
        <span class="s1">&#39;admit release&#39;</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--name-sets--transition-properties">Transition properties</a></h5></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">TRANSITION_PROPERTIES</span> <span class="o">=</span>
        <span class="s1">&#39;origin source target action conjugate&#39;</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--name-sets--transition-expression-categories">Transition expression categories</a></h5></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">TRANSITION_EXPRESSION_CATEGORIES</span> <span class="o">=</span>
        <span class="s1">&#39;methods events guards&#39;</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5><a href="#module--constants--name-sets--transition-event-types">Transition event types</a></h5></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">TRANSITION_EVENT_TYPES</span> <span class="o">=</span>
        <span class="s1">&#39;construct destroy enter exit start end abort&#39;</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The <a href="#module"><code>state</code></a> module is exported via CommonJS on the server, and
globally in the browser.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">server</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">exports</span> <span class="o">=</span> <span class="nx">state</span> <span class="p">);</span>
<span class="nx">O</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">client</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">global</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#module--constants--module">module</a></h4>

<p>References or creates a unique object visible only within the lexical scope
of this module.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">__MODULE__</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">server</span> <span class="o">?</span> <span class="nx">module</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">exports</span><span class="o">:</span> <span class="nx">state</span> <span class="p">};</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#module--method">state.method</a></h3>

<p>Returns a <code>factory</code> to be called internally, which will flatten the scope
of the provided <code>fn</code>, reclose it both over any provided <code>bindings</code> and over
a static set of <code>lexicals</code> based on <code>autostate</code>, which is provided to
<code>factory</code> as the <code>State</code> instance that will contain the <strong>lexical state
method</strong> that <code>factory</code> produces.</p>

<blockquote>
  <p><a href="/api/#module--method"><code>state.method</code></a></p>
  
  <p><a href="/blog/lexical-binding-in-state-methods/">Lexical binding in state methods</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">state</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lexicals</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;__State__&#39;</span><span class="p">,</span> <span class="s1">&#39;autostate&#39;</span><span class="p">,</span> <span class="s1">&#39;protostate&#39;</span> <span class="p">];</span>

    <span class="kd">var</span> <span class="nx">rx</span> <span class="o">=</span> <span class="sr">/^(function\b\s*(?:[$_A-Za-z][$\w]*)?\s*\((?:[\s\S]*?)\)\s*\{)([\s\S]*)/</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="s2">&quot;return $1\n&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;  var superstate, owner;\n&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;  if ( this instanceof __State__ ) {\n&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;    superstate = this.superstate();\n&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;    owner = this.owner();\n&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;  }\n&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;$2;&quot;</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">method</span> <span class="p">(</span> <span class="nx">bindings</span><span class="p">,</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>

        <span class="kd">function</span> <span class="nx">factory</span> <span class="p">(</span> <span class="nx">autostate</span> <span class="p">)</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Invocation from outside the module is forbidden, as this could
expose <code>bindings</code>, which must remain private.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="k">this</span> <span class="o">!==</span> <span class="nx">__MODULE__</span> <span class="p">)</span> <span class="k">throw</span> <span class="nx">ReferenceError</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>With proper <code>bindings</code> and <code>fn</code> arguments, forward the
invocation to <code>createMethod</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">bindings</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">fn</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">createMethod</span><span class="p">(</span> <span class="nx">factory</span><span class="p">,</span> <span class="nx">autostate</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">,</span> <span class="nx">fn</span> <span class="p">);</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If passed <code>bindings</code> only, return a partially applied function
that accepts <code>fn</code> later.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">bindings</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">fn</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">createMethod</span><span class="p">(</span> <span class="nx">factory</span><span class="p">,</span> <span class="nx">autostate</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">,</span> <span class="nx">fn</span> <span class="p">);</span>
                <span class="p">};</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If passed only <code>fn</code> as the first argument, assume no <code>bindings</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">bindings</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">fn</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">createMethod</span><span class="p">(</span> <span class="nx">factory</span><span class="p">,</span> <span class="nx">autostate</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">bindings</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">factory</span><span class="p">.</span><span class="nx">isLexicalStateMethodFactory</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">factory</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">createMethod</span> <span class="p">(</span> <span class="nx">factory</span><span class="p">,</span> <span class="nx">autostate</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">,</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">identifiers</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">result</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Gather all the identifiers that the transformed <code>fn</code> will be closed
over and arrange them into an array of named <code>params</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">identifiers</span> <span class="o">=</span> <span class="nx">bindings</span> <span class="k">instanceof</span> <span class="nb">Object</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">bindings</span> <span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">identifiers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bindings</span><span class="p">[</span> <span class="nx">identifiers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">];</span>
        <span class="nx">params</span> <span class="o">=</span> <span class="nx">identifiers</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">lexicals</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Gather all the values that will be mapped to the <code>params</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">State</span><span class="p">,</span> <span class="nx">autostate</span><span class="p">,</span> <span class="nx">autostate</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">];</span>
        <span class="nx">values</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Write the body of the function that wraps <code>fn</code>, and inject <code>fn</code> with
references to the superstate and owner of the context <code>State</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">body</span> <span class="o">=</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">fn</span> <span class="p">).</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">rx</span><span class="p">,</span> <span class="nx">s</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Generate the wrapper function and immediately apply it with all of
the closed binding values.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">result</span> <span class="o">=</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">body</span> <span class="p">)</span> <span class="p">)</span>
                         <span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Save the <code>factory</code> from which the method was created, so that the
method can be cloned or exported, e.g., with
<a href="/api/#state--methods--express"><code>express()</code></a>, to a separate
<code>State</code>, where the method will need to be re-transformed with
bindings to the new state’s lexical environment.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">result</span><span class="p">.</span><span class="nx">factory</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">;</span>

        <span class="nx">result</span><span class="p">.</span><span class="nx">isLexicalStateMethod</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h2><a href="#state">State</a></h2>

<blockquote>
  <p><a href="/api/#state">State</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--__pre.js"><code>state/__pre.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">State</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

<span class="kd">var</span> <span class="nx">SA</span> <span class="o">=</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">,</span>
    </pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Attribute bitfield constants will be used extensively in the <code>State</code>
<a href="#state--constructor.js">constructor</a> and the
<a href="#state--attributes.js">attribute methods</a>, so make them accessible
as free variables.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">NORMAL</span>      <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">,</span>
    <span class="nx">VIRTUAL</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">VIRTUAL</span><span class="p">,</span>
    <span class="nx">MUTABLE</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">MUTABLE</span><span class="p">,</span>
    <span class="nx">FINITE</span>      <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">FINITE</span><span class="p">,</span>
    <span class="nx">STATIC</span>      <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">STATIC</span><span class="p">,</span>
    <span class="nx">IMMUTABLE</span>   <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">IMMUTABLE</span><span class="p">,</span>
    <span class="nx">INITIAL</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">INITIAL</span><span class="p">,</span>
    <span class="nx">CONCLUSIVE</span>  <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">CONCLUSIVE</span><span class="p">,</span>
    <span class="nx">FINAL</span>       <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">FINAL</span><span class="p">,</span>
    <span class="nx">ABSTRACT</span>    <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">ABSTRACT</span><span class="p">,</span>
    <span class="nx">CONCRETE</span>    <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">CONCRETE</span><span class="p">,</span>
    <span class="nx">DEFAULT</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">,</span>
    <span class="nx">REFLECTIVE</span>  <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">REFLECTIVE</span><span class="p">,</span>
    <span class="nx">HISTORY</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">HISTORY</span><span class="p">,</span>
    <span class="nx">RETAINED</span>    <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">RETAINED</span><span class="p">,</span>
    <span class="nx">SHALLOW</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">SHALLOW</span><span class="p">,</span>
    <span class="nx">CONCURRENT</span>  <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">CONCURRENT</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>All attributes except <code>virtual</code> are inherited via protostates.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">PROTOSTATE_HERITABLE_ATTRIBUTES</span> <span class="o">=</span>
        <span class="nx">MUTABLE</span>     <span class="o">|</span>  <span class="nx">FINITE</span>      <span class="o">|</span>  <span class="nx">STATIC</span>     <span class="o">|</span>  <span class="nx">IMMUTABLE</span>  <span class="o">|</span>
        <span class="nx">INITIAL</span>     <span class="o">|</span>  <span class="nx">CONCLUSIVE</span>  <span class="o">|</span>  <span class="nx">FINAL</span>      <span class="o">|</span>
        <span class="nx">ABSTRACT</span>    <span class="o">|</span>  <span class="nx">CONCRETE</span>    <span class="o">|</span>  <span class="nx">DEFAULT</span>    <span class="o">|</span>
        <span class="nx">REFLECTIVE</span>  <span class="o">|</span>
        <span class="nx">HISTORY</span>     <span class="o">|</span>  <span class="nx">RETAINED</span>    <span class="o">|</span>  <span class="nx">SHALLOW</span>    <span class="o">|</span>
        <span class="nx">CONCURRENT</span>
    <span class="p">;</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">,</span> <span class="nx">SA</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--constructor.js"><code>state/constructor.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--constructor">Constructor</a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">State</span> <span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">controller</span><span class="p">,</span> <span class="nx">superAttributes</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">protoAttributes</span><span class="p">;</span>

    <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">expression</span> <span class="o">&amp;&amp;</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||</span> <span class="nx">NORMAL</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--constructor--name">name</a></h4>

<p>Returns the local name of this state.</p>

<blockquote>
  <p><a href="/api/#state--methods--name">name</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">stringFunction</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="p">}</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>A root state is created by a <a href="#state-controller"><code>StateController</code></a>,
which passes a reference to itself into the <code>superstate</code> parameter,
signaling that a <code>controller</code> method closing over the reference needs to
be created for this instance.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="k">instanceof</span> <span class="nx">StateController</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">controller</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">;</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">controller</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="nx">controller</span> <span class="p">);</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Otherwise this state is an inheritor of an existing superstate.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span> <span class="o">=</span> <span class="nx">privileged</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(</span> <span class="nx">superstate</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The <code>mutable</code> and <code>finite</code> attributes are inherited from the
superstate.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">superAttributes</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">attributes</span><span class="p">();</span>
        <span class="nx">attributes</span> <span class="o">|=</span> <span class="nx">superAttributes</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="nx">MUTABLE</span> <span class="o">|</span> <span class="nx">FINITE</span> <span class="p">);</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The set of “protostate-heritable” attributes are inherited from the
protostate.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">protoAttributes</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">attributes</span><span class="p">();</span>
        <span class="nx">protoAttributes</span> <span class="o">&amp;=</span> <span class="nx">PROTOSTATE_HERITABLE_ATTRIBUTES</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Literal <code>concrete</code> forcibly contradicts literal <code>abstract</code>; if a
bad production includes both attributes, negate <code>abstract</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">CONCRETE</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">attributes</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">ABSTRACT</span><span class="p">;</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Literal <code>abstract</code> may override inherited <code>concrete</code>, and vice
versa, so filter those attributes out of the protostate before
inheriting.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="nx">ABSTRACT</span> <span class="o">|</span> <span class="nx">CONCRETE</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">protoAttributes</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span> <span class="nx">ABSTRACT</span> <span class="o">|</span> <span class="nx">CONCRETE</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">attributes</span> <span class="o">|=</span> <span class="nx">protoAttributes</span><span class="p">;</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If at this point the state is not <code>abstract</code>, then <code>concrete</code> must be
imposed.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">ABSTRACT</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">attributes</span> <span class="o">|=</span> <span class="nx">CONCRETE</span><span class="p">;</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Literal or inherited <code>immutable</code> is an absolute contradiction of
<code>mutable</code> and implication of <code>finite</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">attributes</span> <span class="o">|=</span> <span class="p">(</span> <span class="nx">superAttributes</span> <span class="o">|</span> <span class="nx">protoAttributes</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="nx">IMMUTABLE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">IMMUTABLE</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">attributes</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">MUTABLE</span><span class="p">;</span>
        <span class="nx">attributes</span> <span class="o">|=</span> <span class="nx">FINITE</span><span class="p">;</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Only a few instance methods are required for a virtual state,
including one (<a href="#state--privileged--realize"><code>realize</code></a>) method which
if called later will convert the virtual state into a real state.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="nx">privileged</span><span class="p">.</span><span class="nx">attributes</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">realize</span> <span class="o">=</span> <span class="nx">privileged</span><span class="p">.</span><span class="nx">realize</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">);</span>
        <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">mutableVirtualMethods</span> <span class="p">);</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>For a real state, the remainder of construction is delegated to the
class-private <a href="#state--private--realize"><code>realize</code></a> function.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">realize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Additional property assignments for easy viewing in the inspector.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">[</span><span class="s1">&#39; &lt;owner&gt;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
        <span class="k">this</span><span class="p">[</span><span class="s1">&#39; &lt;path&gt;&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">[</span><span class="s1">&#39;&lt;attr&gt;&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="nx">StateExpression</span><span class="p">.</span><span class="nx">decodeAttributes</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">privileged</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span> <span class="o">=</span> <span class="p">{};</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--core.js"><code>state/core.js</code></a></h3>

<p>Methods for initializing and properly destroying a <code>State</code> instance.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--init">init</a></h4>

<p>Builds out the state’s members based on the expression provided.</p>

<blockquote>
  <p><a href="#state--methods--init">init</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Function*/</span> <span class="nx">expressionConstructor</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*&lt;expressionConstructor&gt; | Object*/</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">__initializing__</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">mutate</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">);</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">__initializing__</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;construct&#39;</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--destroy">destroy</a></h4>

<p>Attempts to cleanly destroy this state and all of its substates.
A <code>destroy</code> event is issued to each state after it is destroyed.</p>

<blockquote>
  <p><a href="#state--methods--destroy">destroy</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">setSuperstate</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span>
                <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">(),</span>
                <span class="nx">owner</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">(),</span>
                <span class="nx">transition</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">transition</span><span class="p">(),</span>
                <span class="nx">origin</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">delegator</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">stateName</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If a transition is underway that involves this state, then the
state cannot be destroyed.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">origin</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span><span class="p">();</span>
                <span class="nx">target</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">target</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">target</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Descendant states are destroyed bottom-up.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span> <span class="nx">stateName</span> <span class="k">in</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">stateName</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">].</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p><code>destroy</code> is the final event emitted.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">].</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="k">delete</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The state must remove itself from its superstate.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>A mutable superstate has a <code>removeSubstate</code> method already
available.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">isMutable</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">superstate</span><span class="p">.</span><span class="nx">removeSubstate</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="p">);</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>An immutable superstate must be peeked to acquire a
<code>removeSubstate</code> method.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">privileged</span><span class="p">.</span><span class="nx">removeSubstate</span><span class="p">(</span>
                        <span class="nx">superstate</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span> <span class="nx">__MODULE__</span><span class="p">,</span> <span class="s1">&#39;attributes&#39;</span> <span class="p">),</span>
                        <span class="nx">superstate</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span> <span class="nx">__MODULE__</span><span class="p">,</span> <span class="s1">&#39;substates&#39;</span> <span class="p">)</span>
                    <span class="p">).</span><span class="nx">call</span><span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>When the root state is destroyed, the owner gets back its
original methods, and the corresponding delegator for each such
method is destroyed.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">else</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">methodName</span> <span class="k">in</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">delegator</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">delegator</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">method</span> <span class="o">=</span> <span class="nx">delegator</span><span class="p">.</span><span class="nx">original</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="k">delete</span> <span class="nx">delegator</span><span class="p">.</span><span class="nx">original</span><span class="p">;</span>
                            <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="k">delete</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The <code>destroy</code> call is propagated to the root’s controller,
unless the controller itself instigated the call, in which
case its own <code>destroy</code> method will already have been removed.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">controller</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">&amp;&amp;</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="nx">setSuperstate</span><span class="p">(</span> <span class="kc">undefined</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>A flag is set that can be observed later by anything retaining
a reference to this state (e.g. a memoization) which would be
withholding it from being garbage-collected. A well-behaved
retaining entity should check this flag as necessary to
reassert the validity of its reference, and discard the
reference after it observes <code>destroyed</code> to have been set to
<code>true</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">destroyed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="kc">false</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--internal.js"><code>state/internal.js</code></a></h3>

<p>For internal use only. Code here is not documented in the public API.</p></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--peek">peek</a></h4>

<p>Exposes private entities to code within the same module-level lexical
scope. Callers must authenticate themselves as internal by providing a
<code>referenceToModule</code> that matches the closed unique module-scoped object
<a href="#module--constants--module"><code>__MODULE__</code></a> (which in a CommonJS environment
is equivalent to the standard <code>module</code>).</p></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">peek</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*Function*/</span> <span class="nx">expressionConstructor</span><span class="p">,</span>
          <span class="cm">/*Number*/</span> <span class="nx">attributes</span><span class="p">,</span>
          <span class="cm">/*Object*/</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">transitions</span><span class="p">,</span>
    <span class="cm">/*StateHistory*/</span> <span class="nx">history</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">members</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">expressionConstructor</span><span class="o">:</span> <span class="nx">expressionConstructor</span><span class="p">,</span>
            <span class="nx">attributes</span><span class="o">:</span> <span class="nx">attributes</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
            <span class="nx">methods</span><span class="o">:</span> <span class="nx">methods</span><span class="p">,</span>
            <span class="nx">events</span><span class="o">:</span> <span class="nx">events</span><span class="p">,</span>
            <span class="nx">guards</span><span class="o">:</span> <span class="nx">guards</span><span class="p">,</span>
            <span class="nx">substates</span><span class="o">:</span> <span class="nx">substates</span><span class="p">,</span>
            <span class="nx">transitions</span><span class="o">:</span> <span class="nx">transitions</span><span class="p">,</span>
            <span class="nx">history</span><span class="o">:</span> <span class="nx">history</span>
        <span class="p">};</span>

    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*&lt;module&gt;*/</span> <span class="nx">referenceToModule</span><span class="p">,</span>
          <span class="cm">/*String*/</span> <span class="nx">name</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">referenceToModule</span> <span class="o">!==</span> <span class="nx">__MODULE__</span> <span class="p">)</span> <span class="k">throw</span> <span class="nx">ReferenceError</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">name</span> <span class="o">?</span> <span class="nx">members</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">members</span> <span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peek</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--realization.js"><code>state/realization.js</code></a></h3>

<p>Methods for realizing an incipient or virtual <code>State</code> instance.</p></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--private--realize">realize</a></h4>

<p>Continues construction of an incipient <a href="#state"><code>State</code></a>, or equivalently,
converts a virtual state into a <em>real</em> state.</p>

<p>Much of the initialization for <code>State</code> is offloaded from the
<a href="#state--constructor">constructor</a>, allowing for creation of lightweight
virtual <code>State</code> instances that inherit all of their functionality from
protostates, but can also be converted at some later time to a real <code>State</code>
if necessary.</p>

<blockquote>
  <p>See also:
  <a href="#state--constructor"><code>State constructor</code></a>,
  <a href="#state-controller--private--virtualize"><code>StateController virtualize</code></a>,
  <a href="#state--privileged--realize"><code>State.privileged.realize</code></a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">realize</span> <span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">addMethod</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span>
        <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The real state’s private variables and collections.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">data</span>        <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">methods</span>     <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">events</span>      <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">guards</span>      <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">substates</span>   <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">transitions</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">history</span>     <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Method names are mapped to specific local variables. The named
methods are created on <code>this</code>, each of which is a partial application
of its corresponding method factory at
<a href="#state--privileged"><code>State.privileged</code></a>.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">O</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;peek express mutate&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="nx">StateExpression</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span>
                <span class="nx">substates</span><span class="p">,</span> <span class="nx">transitions</span><span class="p">,</span> <span class="nx">history</span> <span class="p">],</span>
        <span class="s1">&#39;superstate&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="nx">superstate</span> <span class="p">],</span>
        <span class="s1">&#39;attributes&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="nx">attributes</span> <span class="p">],</span>
        <span class="s1">&#39;data has get let&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="nx">attributes</span> <span class="o">|</span> <span class="nx">MUTABLE</span><span class="p">,</span> <span class="nx">data</span> <span class="p">],</span>
        <span class="s1">&#39;method methodNames addMethod removeMethod&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="nx">methods</span> <span class="p">],</span>
        <span class="s1">&#39;event addEvent removeEvent emit&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="nx">events</span> <span class="p">],</span>
        <span class="s1">&#39;guard addGuard removeGuard&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="nx">guards</span> <span class="p">],</span>
        <span class="s1">&#39;substate substates addSubstate removeSubstate&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">],</span>
        <span class="s1">&#39;transition transitions addTransition removeTransition&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="nx">transitions</span> <span class="p">],</span>
        <span class="s1">&#39;destroy&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">s</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">s</span><span class="p">;</span> <span class="p">},</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span>
                <span class="nx">substates</span> <span class="p">]</span>
    <span class="p">});</span>

    <span class="nx">O</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">addEvent</span><span class="o">:</span> <span class="s1">&#39;on bind&#39;</span><span class="p">,</span>
        <span class="nx">removeEvent</span><span class="o">:</span> <span class="s1">&#39;off unbind&#39;</span><span class="p">,</span>
        <span class="nx">emit</span><span class="o">:</span> <span class="s1">&#39;trigger&#39;</span>
    <span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>With the instance methods in place, <code>this</code> is now ready to apply
<code>expression</code> to itself.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">privileged</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span> <span class="nx">StateExpression</span> <span class="p">).</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Realizing a root state requires that, for any of the owner’s own
methods for which exist at least one stateful implementation located
higher in its prototype chain, that method must be copied into the
root to define the object’s default behavior.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">superstate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">owner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">addMethod</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">addMethod</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">addMethod</span> <span class="o">=</span> <span class="nx">privileged</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span> <span class="nx">methods</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">owner</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">method</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="nx">O</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">method</span><span class="p">.</span><span class="nx">isDelegator</span> <span class="o">&amp;&amp;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="nx">addMethod</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">method</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If the state is <code>finite</code> or non-<code>mutable</code>, then the appropriate
mutation methods used during construction/realization can no longer
be used, and must be removed.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">O</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="s1">&#39;mutate let addMethod removeMethod addGuard removeGuard \</span>
<span class="s1">            addTransition removeTransition&#39;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">),</span>
            <span class="kd">function</span> <span class="p">(</span> <span class="nx">m</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">delete</span> <span class="nx">self</span><span class="p">[</span> <span class="nx">m</span> <span class="p">];</span>
            <span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>An exception is <code>data</code>, which must be rewritten rather than removed.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">||</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">FINITE</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">addSubstate</span><span class="p">;</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">removeSubstate</span><span class="p">;</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Non-<code>mutable</code> and <code>finite</code> requires a special implementation of
<code>mutate</code> that disallows mutations to substates.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">FINITE</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mutate</span> <span class="o">=</span> <span class="nx">privileged</span><span class="p">.</span><span class="nx">mutate</span><span class="p">(</span> <span class="nx">StateExpression</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span>
            <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">transitions</span> <span class="p">);</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>(Exposed for debugging.)</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">O</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;&lt;attr&gt;&#39;</span><span class="o">:</span> <span class="nx">StateExpression</span><span class="p">.</span><span class="nx">decodeAttributes</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">),</span>
        <span class="nx">__private__</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span> <span class="nx">__MODULE__</span> <span class="p">)</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--private--mutable-virtual-methods">mutableVirtualMethods</a></h4>

<p>A set of methods that will be mixed into mutable virtual states. When
called, these first <a href="#state--private--realize"><code>realize</code></a> the state and
then, provided that realization has successfully produced a new method
of the same name on the instance, invoke that method.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mutableVirtualMethods</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">names</span> <span class="o">=</span> <span class="s1">&#39;addMethod addEvent addGuard addSubstate addTransition&#39;</span><span class="p">;</span>

    <span class="nx">O</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">names</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">realizer</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">()[</span> <span class="nx">name</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="o">!==</span> <span class="nx">realizer</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">obj</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">realizer</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--realize">realize</a></h4>

<p>Transforms a virtual state into a “real” state.</p>

<p>A virtual state is a lightweight <a href="#state"><code>State</code></a> instance whose
purpose is simply to inherit from its protostate. As such virtual states
are weakly bound to a state hierarchy by their reference held at
<code>superstate</code>, and are not proper members of the superstate’s set of
substates. Transforming the state from virtual to real causes it to
exist thereafter as an abiding member of its superstate’s set of
substates.</p>

<blockquote>
  <p>See also: <a href="#state--private--realize"><code>State realize</code></a></p>
  
  <p><a href="/api/#state--methods--realize">realize</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">realize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span>
            <span class="nx">addSubstate</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="s1">&#39;addSubstate&#39;</span> <span class="p">)</span> <span class="o">?</span>
                <span class="nx">superstate</span><span class="p">.</span><span class="nx">addSubstate</span> <span class="o">:</span>
                <span class="nx">privileged</span><span class="p">.</span><span class="nx">addSubstate</span><span class="p">(</span>
                    <span class="nx">superstate</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span> <span class="nx">__MODULE__</span><span class="p">,</span> <span class="s1">&#39;attributes&#39;</span> <span class="p">),</span>
                    <span class="nx">superstate</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span> <span class="nx">__MODULE__</span><span class="p">,</span> <span class="s1">&#39;substates&#39;</span> <span class="p">)</span>
                <span class="p">);</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">addSubstate</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">(),</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">realize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="o">~</span><span class="nx">VIRTUAL</span><span class="p">,</span>
                <span class="nx">expression</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--virtualize">virtualize</a></h4>

<p>Creates, if necessary, a virtual state within the state hierarchy of
<code>inheritor</code> to represent <code>this</code> protostate, along with as many virtual
superstates as are necessary to reach a real <a href="#state"><code>State</code></a> in the
hierarchy of <code>inheritor</code>.</p>

<p>Returns the state on <code>inheritor</code>’s state tree for which <code>this</code> is a
protostate. This will be the newly created virtual state, unless
virtualization was unnecessary, in which case it will be the already
existent real <strong>epistate</strong> of <code>this</code>.</p>

<blockquote>
  <p><a href="/docs/#concepts--inheritance--protostates">Protostates</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">virtualize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">inheritor</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">derivation</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">real</span><span class="p">,</span> <span class="nx">name</span><span class="p">;</span>
        </pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Verify that <code>inheritor</code>’s owner does indeed inherit from the owner
of <code>this</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">inheritor</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">().</span><span class="nx">isPrototypeOf</span><span class="p">(</span>
            <span class="nx">inheritor</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Get the <a href="/api/#state--methods--derivation">derivation</a> list for
<code>this</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">derivation</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">derivation</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Traverse the real states of the inheriting state tree to their
furthest depth.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">inheritor</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">derivation</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span> <span class="nx">real</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">s</span> <span class="o">=</span> <span class="nx">real</span><span class="p">;</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If <code>derivation</code> extends beyond the inheriting state tree’s real
states, then add virtual states to it until the whole superstate
chain is represented.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">while</span> <span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">attributes</span><span class="o">:</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">.</span><span class="nx">VIRTUAL</span>
            <span class="p">});</span>
            <span class="nx">name</span> <span class="o">=</span> <span class="nx">derivation</span><span class="p">[</span> <span class="nx">i</span><span class="o">++</span> <span class="p">];</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">realize</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">getThis</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--expression.js"><code>state/expression.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--express">express</a></h4>

<p>Returns an expression of the state of <code>this</code> state — a snapshot of the
state’s current contents.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">express</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">clone</span> <span class="p">(</span> <span class="nx">obj</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">obj</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="nx">out</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
            <span class="nx">out</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">?</span>
                <span class="nx">O</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">obj</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">)</span> <span class="o">:</span>
                <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">cloneMethods</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">methods</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">method</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">method</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
            <span class="nx">out</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
            <span class="nx">out</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">isLexicalStateMethod</span> <span class="o">?</span>
                <span class="nx">method</span><span class="p">.</span><span class="nx">factory</span> <span class="o">:</span>
                <span class="nx">method</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">cloneEvents</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">events</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">out</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
            <span class="nx">out</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">items</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">cloneSubstates</span> <span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">typed</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">substates</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">O</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">substate</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span> <span class="nx">out</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">)[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substate</span><span class="p">.</span><span class="nx">express</span><span class="p">(</span> <span class="nx">typed</span> <span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>By default the returned expression is returned as a plain <code>Object</code>; if
<code>typed</code> is truthy, the expression is a formally typed
<a href="#state-expression"><code>StateExpression</code></a>.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*Function*/</span> <span class="nx">ExpressionConstructor</span><span class="p">,</span>
          <span class="cm">/*Number*/</span> <span class="nx">attributes</span><span class="p">,</span>
          <span class="cm">/*Object*/</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">transitions</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Boolean*/</span> <span class="nx">typed</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="nx">O</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="nx">expression</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">attributes</span><span class="o">:</span>  <span class="nx">attributes</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span>        <span class="nx">clone</span><span class="p">(</span> <span class="nx">data</span> <span class="p">),</span>
                <span class="nx">methods</span><span class="o">:</span>     <span class="nx">cloneMethods</span><span class="p">(</span> <span class="nx">methods</span> <span class="p">),</span>
                <span class="nx">events</span><span class="o">:</span>      <span class="nx">cloneEvents</span><span class="p">(</span> <span class="nx">events</span> <span class="p">),</span>
                <span class="nx">guards</span><span class="o">:</span>      <span class="nx">clone</span><span class="p">(</span> <span class="nx">guards</span> <span class="p">),</span>
                <span class="nx">states</span><span class="o">:</span>      <span class="nx">cloneSubstates</span><span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">typed</span> <span class="p">),</span>
                <span class="nx">transitions</span><span class="o">:</span> <span class="nx">clone</span><span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span>
            <span class="p">});</span>

            <span class="k">return</span> <span class="nx">typed</span> <span class="o">?</span>
                <span class="k">new</span> <span class="nx">ExpressionConstructor</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="o">:</span>
                <span class="nx">expression</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}()</span> <span class="p">);</span>

<span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">express</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--mutation.js"><code>state/mutation.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--mutate">mutate</a></h4>

<p>Transactionally mutates the state by adding, updating, or removing items
as specified by the expression provided in <code>expr</code>. </p></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">mutate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span>
    <span class="cm">/*Function*/</span> <span class="nx">ExpressionConstructor</span><span class="p">,</span>
      <span class="cm">/*Number*/</span> <span class="nx">attributes</span><span class="p">,</span>
      <span class="cm">/*Object*/</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">transitions</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*&lt;expressionConstructor&gt; | Object*/</span> <span class="nx">expr</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">ExpressionConstructor</span> <span class="o">||</span>
            <span class="p">(</span> <span class="nx">expr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressionConstructor</span><span class="p">(</span> <span class="nx">expr</span> <span class="p">)</span> <span class="p">);</span>

        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">NIL</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">NIL</span><span class="p">,</span>
            <span class="nx">before</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">after</span><span class="p">,</span> <span class="nx">delta</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">addMethod</span><span class="p">,</span> <span class="nx">removeMethod</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The privileged <code>init</code> method uses <code>mutate</code> for the state’s
initial build, but with the resultant <code>mutate</code> event suppressed.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__initializing__</span> <span class="p">)</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>A snapshot of the <code>before</code> condition of this state is taken,
to be compared later with an <code>after</code> snapshot.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">before</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">express</span><span class="p">();</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>This invocation of <code>mutate</code> utilizes the set of privileged <code>add*</code>
methods, however, since they are being called as part of a single
operation, each must suppress its usual emission of its own
<code>mutate</code> event.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">__atomic__</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Data is already set up to handle differentials that contain <code>NIL</code>
values.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">data</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Methods are stored as a simple key mapping, and
<a href="#state--privileged--add-method"><code>addMethod</code></a> can be used both to
create an entry and to update an existing entry, without any
additional side-effects, so method expressions can simply be
compared against the <code>NIL</code> value.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">methods</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">methods</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">emitter</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">value</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
                <span class="nx">value</span> <span class="o">!==</span> <span class="nx">NIL</span> <span class="o">?</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">:</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">removeMethod</span><span class="p">(</span> <span class="nx">name</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Event listeners for a given event type might be expressed as a
simple <code>Array</code> of items to be added, as a plain <code>Object</code> that
maps items to specific keys in the internal event emitter that
should be updated or deleted, or as an <code>Array</code> that also includes
one or more such <code>Object</code>s.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">O</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">events</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span>
                    <span class="nx">eventCollection</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">eventCollection</span> <span class="o">&amp;&amp;</span> <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If an event emitter object does not already exist for
this event type, then one will be created, so long as
<code>object</code> is expected to contain items to be added.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">eventCollection</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">O</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">eventCollection</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="o">=</span>
                        <span class="k">new</span> <span class="nx">StateEventEmitter</span><span class="p">(</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">type</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">items</span> <span class="o">=</span> <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>

                <span class="nx">edit</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
                            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="p">)</span> <span class="p">{</span>
                                <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">key</span> <span class="p">);</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="o">!==</span> <span class="nx">items</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
                                <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">};</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>
                    <span class="p">};</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                        <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">edit</span> <span class="o">:</span> <span class="nx">add</span> <span class="p">)(</span> <span class="nx">value</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">edit</span><span class="p">(</span> <span class="nx">object</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span>
                    <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">delete</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">];</span>
            <span class="p">});</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Guards are stored as simple objects, and altering them causes no
side-effects, so a deep <code>edit</code> is sufficient.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">guards</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">guards</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="s1">&#39;deep&#39;</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">guards</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Substates are instances of <a href="#State"><code>State</code></a>, which are either
created, destroyed, or recursively updated in place, as specified
by <code>expr.states</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">substates</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">states</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">emitter</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">value</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="o">?</span>
                    <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">destroy</span><span class="p">()</span> <span class="o">:</span>
                    <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">mutate</span><span class="p">(</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">addSubstate</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Transitions are instances of
<a href="#transition-expression"><code>TransitionExpression</code></a>, which are
either created, deleted, or replaced, as specified by
<code>expr.transitions</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">transitions</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">transitions</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">emitter</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">delete</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">value</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">addTransition</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Allow <code>add*</code> methods to emit individual <code>mutate</code> events normally.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">__atomic__</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Finally the <code>before</code> snapshot is used to acquire the <code>delta</code> of the
mutation, which is emitted as part of a <code>mutate</code> event.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">before</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">after</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">express</span><span class="p">();</span>
            <span class="nx">delta</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">diff</span><span class="p">(</span> <span class="nx">before</span><span class="p">,</span> <span class="nx">after</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">O</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">delta</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;mutate&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">before</span><span class="p">,</span> <span class="nx">after</span> <span class="p">],</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--mutate">mutate</a></h4>

<p>By default states are weakly immutable and their contents cannot be
changed, so they will not possess a <code>mutate</code> instance method unless they
bear the <code>mutable</code> attribute. However, because a weak-immutable superstate
may contain mutable substates, any parts of a mutation operation that
correspond to mutable states must be recursed.</p>

<blockquote>
  <p>See also: <a href="#state--privileged--mutate">mutate (instance)</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mutate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">expr</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span>
        <span class="nx">NIL</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">NIL</span><span class="p">,</span>
        <span class="nx">ss</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">states</span><span class="p">,</span>
        <span class="nx">substates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">substates</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">ss</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">ss</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">ss</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">!==</span> <span class="nx">NIL</span> <span class="o">&amp;&amp;</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">mutate</span><span class="p">(</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">addSubstate</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--attributes.js"><code>state/attributes.js</code></a></h3>

<p>Methods that inspect a state’s attributes.</p>

<blockquote>
  <p><a href="/docs/#concepts--attributes">Attributes</a>
  <a href="/api/#state--attributes">Attributes</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--attributes">attributes</a></h4>

<p>Returns the bit-field representing the state’s attribute flags.</p>

<blockquote>
  <p><a href="/api/#state--methods--attributes">attributes</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Number*/</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">attributes</span><span class="p">;</span> <span class="p">};</span>
<span class="p">};</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">attributes</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="nx">NORMAL</span> <span class="p">),</span>
    <span class="nx">isVirtual</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isMutable</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nb">isFinite</span><span class="o">:</span>     <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">FINITE</span>     <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isStatic</span><span class="o">:</span>     <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">STATIC</span>     <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isImmutable</span><span class="o">:</span>  <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">IMMUTABLE</span>  <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isInitial</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">INITIAL</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isConclusive</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">CONCLUSIVE</span> <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isFinal</span><span class="o">:</span>      <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">FINAL</span>      <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isAbstract</span><span class="o">:</span>   <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">ABSTRACT</span>   <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isConcrete</span><span class="o">:</span>   <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">CONCRETE</span>   <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isDefault</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">DEFAULT</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isReflective</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">REFLECTIVE</span> <span class="p">);</span> <span class="p">},</span>
    <span class="nx">hasHistory</span><span class="o">:</span>   <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">HISTORY</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isRetained</span><span class="o">:</span>   <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">RETAINED</span>   <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isShallow</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SHALLOW</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isConcurrent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">CONCURRENT</span> <span class="p">);</span> <span class="p">}</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--model.js"><code>state/model.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--superstate">superstate</a></h4>

<p>Returns the immediate superstate, or the nearest state in the superstate
chain with the provided <code>stateName</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--superstate">superstate</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">superstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State*/</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*String*/</span> <span class="nx">stateName</span> <span class="c1">// optional</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">stateName</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span>
                <span class="nx">superstate</span>
                <span class="o">:</span>
                <span class="nx">superstate</span> <span class="o">?</span>
                    <span class="nx">stateName</span> <span class="o">?</span>
                        <span class="nx">superstate</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="o">===</span> <span class="nx">stateName</span> <span class="o">?</span>
                            <span class="nx">superstate</span> <span class="o">:</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(</span> <span class="nx">stateName</span> <span class="p">)</span>
                        <span class="o">:</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">().</span><span class="nx">root</span><span class="p">()</span>
                    <span class="o">:</span>
                    <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--owner">owner</a></h4>

<p>Gets the owner object to which this state’s controller belongs.</p>

<blockquote>
  <p><a href="/api/#state--methods--owner">owner</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">owner</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--controller">controller</a></h4>

<p>Gets the <a href="#state-controller"><code>StateController</code></a> to which this state
belongs.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">controller</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--root">root</a></h4>

<p>Gets the root state, i.e. the top-level superstate of this state.</p>

<blockquote>
  <p><a href="/api/#state--methods--root">root</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">root</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--superstate">superstate</a></h4>

<p>The <code>superstate</code> method is overridden for non-root <code>State</code> instances
using <a href="#state--privileged--superstate"><code>State.privileged.superstate</code></a>.</p>

<blockquote>
  <p><a href="/api/#state--methods--superstate">superstate</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">superstate</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--derivation">derivation</a></h4>

<p>Returns an object array of this state’s superstate chain, starting after
the root state and ending at <code>this</code>. If <code>byName</code> is set to <code>true</code>, a
string array of the states’ names is returned instead.</p>

<blockquote>
  <p><a href="/api/#state--methods--derivation">derivation</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">derivation</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Boolean*/</span> <span class="nx">byName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">ss</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">ss</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">ss</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="nx">byName</span> <span class="o">?</span> <span class="nx">s</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">s</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--path">path</a></h4>

<p>Returns this state’s fully qualified name.</p>

<p><em>Alias:</em> <strong>toString</strong></p>

<blockquote>
  <p><a href="/api/#state--methods--path">path</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="s1">&#39;path toString&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--depth">depth</a></h4>

<p>Returns the number of superstates this state has. The root state returns
<code>0</code>, its immediate substates return <code>1</code>, etc.</p>

<blockquote>
  <p><a href="/api/#state--methods--depth">depth</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">depth</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="nx">n</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--common">common</a></h4>

<p>Returns the least common ancestor of <code>this</code> and <code>other</code>. If <code>this</code> is
itself an ancestor of <code>other</code>, or vice versa, that ancestor is returned.</p>

<blockquote>
  <p><a href="/api/#state--methods--common">common</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">common</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">other</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">state</span><span class="p">;</span>

        <span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">other</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">other</span> <span class="p">)</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">depth</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">depth</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">state</span> <span class="o">=</span> <span class="nx">other</span><span class="p">;</span> <span class="nx">other</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="nx">other</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">other</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--is">is</a></h4>

<p>Determines whether <code>this</code> is <code>state</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--is">is</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">is</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nx">state</span> <span class="o">===</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--is-in">isIn</a></h4>

<p>Determines whether <code>this</code> is or is a substate of <code>state</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--is-in">isIn</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">isIn</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nx">state</span> <span class="o">===</span> <span class="k">this</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--has-substate">hasSubstate</a></h4>

<p>Determines whether <code>this</code> is or is a superstate of <code>state</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--has-substate">hasSubstate</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">hasSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String */</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span> <span class="o">===</span> <span class="nx">state</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--is-superstate-of">isSuperstateOf</a></h4>

<p>Determines whether <code>this</code> is a superstate of <code>state</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--is-superstate-of">isSuperstateOf</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">isSuperstateOf</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">superstate</span><span class="p">;</span>
        <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">?</span>
            <span class="k">this</span> <span class="o">===</span> <span class="nx">superstate</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="o">:</span>
            <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--protostate">protostate</a></h4>

<p>Returns the <strong>protostate</strong>, the state analogous to <code>this</code> found in the
next object in the owner’s prototype chain that has one. A state
inherits first from its protostates, then from its superstates.</p>

<p>If the owner does not share an analogous
<a href="#state-controller"><code>StateController</code></a> with its prototype, or if no
protostate can be found in the hierarchy of the prototype’s state
controller, then the search is iterated up the prototype chain.</p>

<p>A state and its protostate will always share an identical name and
identical derivation pattern, as will the respective superstates of
both, relative to one another.</p>

<blockquote>
  <p><a href="/api/#state--methods--protostate">protostate</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">protostate</span><span class="o">:</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">memoize</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">memoizeProtostates</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">memoize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If <code>destroyed</code> has been set, it means we’re hanging onto
an invalid reference. Removing this method from the
instance will clear the reference for GC. This
invocation can then be relayed back up to
<a href="#state--prototype--protostate"><code>State.prototype.protostate</code></a>.</p></div>         <div class="code span11"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">destroyed</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">;</span>
                        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="k">return</span> <span class="nx">protostate</span><span class="p">;</span>
                <span class="p">};</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">derivation</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">),</span>
                <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">(),</span>
                <span class="nx">controllerName</span><span class="p">,</span> <span class="nx">prototype</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="nx">controllerName</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">name</span><span class="p">();</span>
            <span class="nx">prototype</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Returns the root state of the next <code>prototype</code> in the chain.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">s</span><span class="p">;</span>
                <span class="k">return</span> <span class="p">(</span> <span class="nx">prototype</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span> <span class="nx">prototype</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">O</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">prototype</span><span class="p">[</span> <span class="nx">controllerName</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">prototype</span> <span class="p">)</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">s</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>
            <span class="p">};</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Walk up the prototype chain; starting at each prototype’s root
state, locate the protostate that corresponds to <code>this</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">while</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="nx">next</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">derivation</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">protostate</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="nx">derivation</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">protostate</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Before returning the located protostate, memoize
subsequent lookups with an instance method that closes
over it.</p></div>         <div class="code span11"><div class="highlight"><pre>                    <span class="nx">memoize</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span> <span class="o">=</span> <span class="nx">memoize</span><span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">);</span>

                    <span class="k">return</span> <span class="nx">protostate</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}()</span> <span class="p">),</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--is-protostate-of">isProtostateOf</a></h4>

<p>Determines whether <code>this</code> is a state analogous to <code>state</code> on any object
in the prototype chain of <code>state</code>’s owner.</p>

<blockquote>
  <p><a href="/api/#state--methods--is-protostate-of">isProtostateOf</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">isProtostateOf</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">protostate</span><span class="p">;</span>
        <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">?</span>
            <span class="k">this</span> <span class="o">===</span> <span class="nx">protostate</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isProtostateOf</span><span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="o">:</span>
            <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--substates--default-substate">defaultSubstate</a></h4>

<p>Returns the first substate marked <code>default</code>, or simply the first
substate. Recursion continues into the protostate only if no local
substates are marked <code>default</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--default-substate">defaultSubstate</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">defaultSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span><span class="p">,</span> <span class="c1">// = true</span>
                       <span class="nx">first</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">substates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">substates</span><span class="p">(),</span>
            <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">substates</span> <span class="o">&amp;&amp;</span> <span class="nx">substates</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
            <span class="nx">protostate</span><span class="p">;</span>

        <span class="nx">first</span> <span class="o">||</span> <span class="nx">l</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isDefault</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">||</span> <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">defaultSubstate</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">first</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">first</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--substates--favor">favor</a></h4>

<p>An abstract state may <code>favor</code> a particular substate by overriding the
attribute-based implementation of <code>defaultSubstate</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--favor">favor</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">favor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">substate</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">path</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">isConcrete</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        </pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Calling with no arguments clears any overriding favoritism,
reverting back to the attribute-based method on the prototype.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">substate</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;defaultSubstate&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultSubstate</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultSubstate</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">();</span>

        <span class="nx">substate</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">substate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">substate</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">substate</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">substate</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        
        <span class="nx">path</span> <span class="o">=</span> <span class="nx">substate</span><span class="p">.</span><span class="nx">path</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">defaultSubstate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">path</span> <span class="p">);</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">substate</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--substates--appoint">appoint</a></h4>

<p>An abstract state may <code>appoint</code> a substate, which first <code>favor</code>s the
substate and then, iff the abstract state is active, transitions into
the favored substate.</p>

<blockquote>
  <p><a href="/api/#state--methods--appoint">appoint</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">appoint</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">substate</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">favored</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">favor</span><span class="p">(</span> <span class="nx">substate</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">favored</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">isActive</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="nx">favored</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nx">favored</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--substates--initial-substate">initialSubstate</a></h4>

<p>Performs a “depth-within-breadth-first” recursive search to locate the
most deeply nested <code>initial</code> state by way of the greatest <code>initial</code>
descendant state. Recursion continues into the protostate only if no
local descendant states are marked <code>initial</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--initial-substate">initialSubstate</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">initialSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span> <span class="c1">// = true</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="p">[</span> <span class="k">this</span> <span class="p">],</span>
            <span class="nx">subject</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">substates</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">.</span><span class="nx">substates</span><span class="p">(</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">state</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isInitial</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">initialSubstate</span><span class="p">(</span> <span class="kc">false</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">state</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">||</span> <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">initialSubstate</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--currency.js"><code>state/currency.js</code></a></h3>

<p>Methods that inspect or change the owner’s current state.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--current">current</a></h4>

<p>Gets the local controller’s current state.</p>

<blockquote>
  <p><a href="/api/#state--methods--current">current</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">current</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">().</span><span class="nx">current</span><span class="p">();</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--is-current">isCurrent</a></h4>

<p>Returns a <code>Boolean</code> indicating whether <code>this</code> is the owner’s current
state.</p>

<blockquote>
  <p><a href="/api/#state--methods--is-current">isCurrent</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">isCurrent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--is-active">isActive</a></h4>

<p>Returns a <code>Boolean</code> indicating whether <code>this</code> or one of its substates is
the owner’s current state.</p>

<blockquote>
  <p><a href="/api/#state--methods--is-active">isActive</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">isActive</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">current</span> <span class="o">===</span> <span class="k">this</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">current</span> <span class="p">);</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--change">change</a></h4>

<p>Forwards a <code>change</code> command to the state’s controller and returns its
result. Calling with no arguments directs the controller to change to
<code>this</code> state.</p>

<p><em>Aliases:</em> <strong>go</strong>, <strong>be</strong></p>

<blockquote>
  <p>See also: <a href="#state-controller--privileged--change"><code>StateController.privileged.change</code></a></p>
  
  <p><a href="/api/#state--methods--change">change</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="s1">&#39;change go be&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*State | String*/</span> <span class="nx">target</span><span class="p">,</span>  <span class="c1">// optional</span>
                <span class="cm">/*Object*/</span> <span class="nx">options</span>  <span class="c1">// optional</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

        <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">change</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">controller</span><span class="p">,</span>
            <span class="nx">target</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span>
                <span class="nx">arguments</span> <span class="o">:</span>
                <span class="p">[</span> <span class="k">this</span> <span class="p">].</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">arguments</span> <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--change-to">changeTo</a></h4>

<p>Calls <code>change</code> without regard to a <code>target</code>’s retained internal state.</p>

<p><em>Alias:</em> <strong>goTo</strong></p>

<blockquote>
  <p>See also: <a href="#state--prototype--change"><code>State::change</code></a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="s1">&#39;changeTo goTo&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*State | String*/</span> <span class="nx">target</span><span class="p">,</span>
                <span class="cm">/*Object*/</span> <span class="nx">options</span>  <span class="c1">// optional</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nx">target</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">this</span> <span class="p">);</span>
        <span class="nx">options</span> <span class="o">?</span> <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">direct</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">)</span> <span class="o">:</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">direct</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--query.js"><code>state/query.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--query">query</a></h4>

<p>Matches a <code>selector</code> string with the state or states it represents,
evaluated first in the context of <code>this</code>, then its substates, and then
its superstates, until all locations in the state tree have been
searched for a match of <code>selector</code>.</p>

<p>Returns the matched <a href="#state"><code>State</code></a>, or an <code>Array</code> containing the set
of matched states. If a state to be tested <code>against</code> is provided, a
<code>Boolean</code> is returned, indicating whether <code>against</code> is the matched state
or is included in the matching set.</p>

<p>Setting <code>descend</code> to <code>false</code> disables recursion through the substates of
<code>this</code>, and likewise setting <code>ascend</code> to <code>false</code> disables the subsequent
recursion through its superstates.</p>

<p><em>Alias:</em> <strong>match</strong></p>

<blockquote>
  <p><a href="/docs/#concepts--selectors">Selectors</a>
  <a href="/api/#state--methods--query">query</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="s1">&#39;query match&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
         <span class="cm">/*String*/</span> <span class="nx">selector</span><span class="p">,</span>
          <span class="cm">/*State*/</span> <span class="nx">against</span><span class="p">,</span> <span class="c1">// optional</span>
        <span class="cm">/*Boolean*/</span> <span class="nx">descend</span><span class="p">,</span> <span class="c1">// = true</span>
        <span class="cm">/*Boolean*/</span> <span class="nx">ascend</span><span class="p">,</span>  <span class="c1">// = true</span>
        <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span> <span class="c1">// = true</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parts</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span>
            <span class="nx">queue</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">against</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">ascend</span> <span class="o">=</span> <span class="nx">descend</span><span class="p">;</span> <span class="nx">descend</span> <span class="o">=</span> <span class="nx">against</span><span class="p">;</span> <span class="nx">against</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">descend</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">descend</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
        <span class="nx">ascend</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">ascend</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
        <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>A few exceptional cases may be resolved early.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">selector</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">against</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">selector</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">against</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">against</span> <span class="o">===</span> <span class="k">this</span> <span class="o">:</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">selector</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">against</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span>
                <span class="nx">against</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">:</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Absolute wildcard expressions compared against the root state pass
immediately.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">against</span> <span class="o">&amp;&amp;</span> <span class="nx">against</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                <span class="nx">selector</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/^\*+$/</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Pure <code>.</code>/<code>*</code> expressions should not be recursed.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">selector</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/^\.*\**$/</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">descend</span> <span class="o">=</span> <span class="nx">ascend</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If <code>selector</code> is an absolute path, evaluate it from the root state
as a relative path.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;.&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">().</span><span class="nx">query</span><span class="p">(</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">descend</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>An all-<code>.</code> <code>selector</code> must have one <code>.</code> trimmed to parse correctly.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">selector</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="sr">/^(\.+)\.$/</span><span class="p">,</span> <span class="s1">&#39;$1&#39;</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Split <code>selector</code> into tokens, consume the leading empty-string
straight away, then parse the remaining tokens. A <code>cursor</code> reference
to a matching <a href="#state"><code>State</code></a> in the tree is kept, beginning with
the context state (<code>this</code>), and updated as each token is consumed.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">parts</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="nx">cursor</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Upon reaching the end of the token stream, return the
<a href="#state"><code>State</code></a> currently referenced by <code>cursor</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">l</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">against</span> <span class="o">?</span> <span class="nx">against</span> <span class="o">===</span> <span class="nx">cursor</span> <span class="o">:</span> <span class="nx">cursor</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Consume a token.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">name</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Interpret a <strong>single wildcard</strong> as any <em>immediate</em> substate of
the <code>cursor</code> state parsed thus far.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">against</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substates</span><span class="p">();</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">cursor</span> <span class="o">===</span> <span class="nx">against</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Interpret a <strong>double wildcard</strong> as any descendant state of the
<code>cursor</code> state parsed thus far.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;**&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">against</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substates</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">against</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Empty string, the product of leading/consecutive dots, implies
<code>cursor</code>’s superstate.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Interpret any other token as an identifier that names a specific
substate of <code>cursor</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If no matching substate exists, the query fails for this
context.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If the query has failed, then recursively descend the tree,
breadth-first, and retry the query with a different context.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">descend</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">queue</span> <span class="o">=</span> <span class="p">[</span> <span class="k">this</span> <span class="p">];</span>
            <span class="k">while</span> <span class="p">(</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">substates</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">.</span><span class="nx">substates</span><span class="p">(</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">state</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The <code>ascend</code> block uses <code>descend</code> to indicate a substate
that has already been searched.</p></div>         <div class="code span11"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="nx">descend</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

                    <span class="nx">result</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="kc">false</span> <span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>

                    <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If the query still hasn’t succeeded, then recursively ascend the
tree and retry, but also passing <code>this</code> as a domain to be skipped
during the superstate’s subsequent descent.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">ascend</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">descend</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">,</span>
                <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If the query still hasn’t succeeded, then retry the query on the
protostate.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">descend</span><span class="p">,</span> <span class="nx">ascend</span><span class="p">,</span>
                <span class="kc">true</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>All possibilities exhausted; no matches exist.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">return</span> <span class="nx">against</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--dollarsign">$</a></h4>

<p>Convenience method that either aliases to
<a href="#state--prototype--change"><code>change</code></a> if passed a function for the first
argument, or aliases to <a href="#state--prototype--query"><code>query</code></a> if passed a
string — thereby mimicking the behavior of the object’s accessor method.</p>

<blockquote>
  <p>See also:
  <a href="#state-controller--private--create-accessor"><code>StateController createAccessor</code></a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">$</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">expr</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">method</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">expr</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">args</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">expr</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">expr</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">change</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">expr</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="nx">rxTransitionArrow</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">transitionArrowMethods</span><span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">[</span> <span class="nx">method</span> <span class="p">].</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">]</span>
                    <span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">return</span> <span class="k">this</span><span class="p">[</span> <span class="nx">method</span> <span class="p">](</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--data.js"><code>state/data.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--data">data</a></h4>

<p>Either retrieves or edits a block of data associated with this state.</p>

<p>If called with no arguments, or with boolean arguments, <code>data</code> returns
a copy of the data attached to this state, including all data from
inherited states, unless specified otherwise by the inheritance flags
<code>viaSuper</code> and <code>viaProto</code>.</p>

<p>If called with an object-typed argument, <code>data</code> edits the data held on
this state. For keys in <code>edit</code> whose values are set to the <code>NIL</code>
directive, the matching keys in the state’s data are deleted. If the
operation results in a change to the state’s data, a
<a href="/api/#state--attributes--mutate"><code>mutate</code></a> event is emitted for this
state.</p>

<blockquote>
  <p><a href="/docs/#concepts--data">Data</a>
  <a href="/api/#state--methods--data">data</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Boolean*/</span> <span class="nx">viaSuper</span><span class="p">,</span> <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">viaSuper</span> <span class="o">!==</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">edit</span> <span class="o">=</span> <span class="nx">viaSuper</span><span class="p">;</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">edit</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">O</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">edit</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">().</span><span class="nx">data</span><span class="p">(</span> <span class="nx">edit</span> <span class="p">);</span>
                <span class="p">}</span>
                
                <span class="nx">delta</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">delta</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">edit</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__atomic__</span> <span class="o">&amp;&amp;</span> <span class="nx">delta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">O</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">delta</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;mutate&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">],</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">O</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span>
                    <span class="nx">viaSuper</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">superstate</span><span class="p">.</span><span class="nx">data</span><span class="p">(),</span>
                    <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">protostate</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="kc">false</span> <span class="p">),</span>
                    <span class="nx">data</span>
                <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--has">has</a></h4></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">has</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">viaSuper</span><span class="p">,</span> <span class="nx">viaProto</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>

            <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>

            <span class="k">return</span> <span class="o">!!</span><span class="p">(</span>
                <span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">protostate</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="nx">viaSuper</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">superstate</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">viaProto</span> <span class="p">)</span>
            <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--get">get</a></h4></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">viaSuper</span><span class="p">,</span> <span class="nx">viaProto</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>
            
            <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>

            <span class="k">return</span> <span class="p">(</span>
                <span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">protostate</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="nx">viaSuper</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">superstate</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">viaProto</span> <span class="p">)</span>
            <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--let">let</a></h4></div>         <div class="code span11"><div class="highlight"><pre>    <span class="s1">&#39;let&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">displaced</span><span class="p">,</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">delta</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span> <span class="c1">// should warn: attempted `let` on non-mutable state</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">()[</span><span class="s1">&#39;let&#39;</span><span class="p">](</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>With no bound <code>data</code> (e.g. in a virtual state), an assignment
fails and returns. An attempted deletion returns <code>NIL</code>,
suggestive of the expression <code>delete data[key] === true</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">value</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="o">?</span> <span class="nx">NIL</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">displaced</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">displaced</span> <span class="o">!==</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
                <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">edit</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
                <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">delta</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">displaced</span> <span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;mutate&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">],</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span>
    <span class="nx">has</span><span class="o">:</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span>
    <span class="nx">get</span><span class="o">:</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span>
    <span class="s1">&#39;let&#39;</span><span class="o">:</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">[</span><span class="s1">&#39;let&#39;</span><span class="p">](</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--set">set</a></h4></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isMutable</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">();</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If no mutable property already exists along the superstate chain,
then default to a <code>let</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="s1">&#39;let&#39;</span><span class="p">](</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Find the superstate that holds the inherited property and mutate it.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="nx">s</span><span class="p">;</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">isMutable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">s</span><span class="p">[</span><span class="s1">&#39;let&#39;</span><span class="p">](</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--delete">delete</a></h4></div>         <div class="code span11"><div class="highlight"><pre>    <span class="s1">&#39;delete&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="s1">&#39;let&#39;</span><span class="p">](</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">NIL</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">NIL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--methods.js"><code>state/methods.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">rootNoop</span> <span class="p">()</span> <span class="p">{}</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--method">method</a></h4>

<p>Retrieves the named method held on this state. If no method is found,
step through this state’s protostate chain to find one. If no method is
found there, step up the superstate hierarchy and repeat the search.</p>

<blockquote>
  <p><a href="/api/#state--methods--method">method</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">method</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
             <span class="cm">/*String*/</span> <span class="nx">methodName</span><span class="p">,</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaSuper</span><span class="p">,</span>    <span class="c1">// = true</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span><span class="p">,</span>    <span class="c1">// = true</span>
             <span class="cm">/*Object*/</span> <span class="nx">out</span>          <span class="c1">// optional</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">method</span><span class="p">;</span>

            <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>

            <span class="nx">methods</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">!==</span> <span class="nx">rootNoop</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">out</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">out</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="nx">out</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">method</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">out</span> <span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">out</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">out</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span> <span class="p">);</span>
                        <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">method</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">viaProto</span><span class="p">,</span>
                        <span class="nx">out</span> <span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">out</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">out</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">out</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--method-names">methodNames</a></h4>

<p>Returns an <code>Array</code> of names of methods defined for this state.</p>

<blockquote>
  <p><a href="/api/#state--methods--method-names">methodNames</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">methodNames</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">O</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">methods</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--add-method">addMethod</a></h4>

<p>Adds a method to this state, which will be callable directly from the
owner, but with its context bound to the state.</p>

<blockquote>
  <p><a href="/api/#state--methods--add-method">addMethod</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">addMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h5>createDelegator</h5>

<p>Creates a function that will serve as a <strong>delegator</strong> method on an
owner object. For each method defined in any of the owner’s states,
a delegator must be created and assigned on the owner itself, at
the <code>methodName</code> key. This delegator then forwards any calls to
<code>methodName</code> to the owner’s current state, which will locate the
appropriate implementation for the method, apply it, and return the
result.</p>

<p>If an owner already has an implementation for a delegated method,
it is copied into the owner’s root state, such that it remains
accessible as the owner’s “default behavior” if none of its active
states contains an implementation for that method.</p>

<p>Stateful methods are applied in the context of the <a href="#state"><code>State</code></a>
to which they belong, or, if a method is inherited from a
protostate, the context will be the corresponding virtual state
within the local <a href="#state-controller"><code>StateController</code></a>. However,
for any a priori methods relocated to the root state, the context
appropriately remains bound to the owner object.</p>

<blockquote>
  <p><a href="/docs/#concepts--methods--delegators">Delegator methods</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">createDelegator</span> <span class="p">(</span> <span class="nx">accessorKey</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">original</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">function</span> <span class="nx">delegator</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">[</span> <span class="nx">accessorKey</span> <span class="p">]().</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">delegator</span><span class="p">.</span><span class="nx">isDelegator</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">delegator</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;[delegator]&quot;</span><span class="p">;</span> <span class="p">};</span>
            <span class="p">}</span>

            <span class="nx">original</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">delegator</span><span class="p">.</span><span class="nx">original</span> <span class="o">=</span> <span class="nx">original</span> <span class="p">);</span>

            <span class="k">return</span> <span class="nx">delegator</span><span class="p">;</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
              <span class="cm">/*String*/</span> <span class="nx">methodName</span><span class="p">,</span>
            <span class="cm">/*Function*/</span> <span class="nx">fn</span><span class="p">,</span>
             <span class="cm">/*Boolean*/</span> <span class="nx">raw</span>  <span class="c1">// optional</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">(),</span>
                <span class="nx">controllerName</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">name</span><span class="p">(),</span>
                <span class="nx">root</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">(),</span>
                <span class="nx">owner</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">(),</span>
                <span class="nx">ownerMethod</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If <code>fn</code> holds a lexical state method then extract the method.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">raw</span> <span class="o">&amp;&amp;</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">isLexicalStateMethodFactory</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">fn</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">__MODULE__</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If there is not already a method called <code>methodName</code> in the
state hierarchy, then the owner and controller need to be set up
properly to accommodate calls to this method.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">this</span> <span class="o">!==</span> <span class="nx">root</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="nx">root</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">ownerMethod</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                    <span class="p">(</span> <span class="nx">ownerMethod</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">ownerMethod</span><span class="p">.</span><span class="nx">isDelegator</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="p">(</span> <span class="nx">ownerMethod</span> <span class="o">=</span> <span class="nx">rootNoop</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The owner method must be added to the root state in its
“raw” form, i.e., not lexically transformed by
<code>state.method</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>                    <span class="nx">root</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">ownerMethod</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>A delegator function is instated on the owner, which will
direct subsequent calls to <code>owner[ methodName ]</code> to the
controller, and then on to the appropriate state’s
implementation.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span>
                    <span class="nx">createDelegator</span><span class="p">(</span> <span class="nx">controllerName</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">ownerMethod</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--remove-method">removeMethod</a></h4>

<p>Dissociates the named method from this state object and returns its
function.</p>

<blockquote>
  <p><a href="/api/#state--methods--remove-method">removeMethod</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">removeMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
            <span class="k">delete</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
            <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">method</span><span class="o">:</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="kc">null</span> <span class="p">),</span>
    <span class="nx">methodNames</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">[];</span> <span class="p">},</span>
    <span class="s1">&#39;addMethod removeMethod&#39;</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--has-method">hasMethod</a></h4>

<p>Determines whether <code>this</code> possesses or inherits a method named
<code>methodName</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--has-method">hasMethod</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">hasMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">!==</span> <span class="nx">rootNoop</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--has-own-method">hasOwnMethod</a></h4>

<p>Determines whether <code>this</code> directly possesses a method named <code>methodName</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--has-own-method">hasOwnMethod</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">hasOwnMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--apply">apply</a></h4>

<p>Finds a state method and applies it in the appropriate context. If the
method was originally defined in the owner, the context will be the
owner. Otherwise, the context will either be the state in which the
method is defined, or if the implementation resides in a protostate, the
corresponding state belonging to the inheriting owner. If the named
method does not exist locally and cannot be inherited, a <code>noSuchMethod</code>
event is emitted and the call returns <code>undefined</code>.</p>

<blockquote>
  <p><a href="/api/#state--methods--apply">apply</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">apply</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*String*/</span> <span class="nx">methodName</span><span class="p">,</span>
         <span class="cm">/*Array*/</span> <span class="nx">args</span>         <span class="c1">// optional</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">ownerMethod</span><span class="p">;</span>

        <span class="nx">out</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">context</span><span class="o">:</span> <span class="kc">undefined</span> <span class="p">};</span>
        <span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">out</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">method</span> <span class="p">)</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Observers may listen for either a general <code>noSuchMethod</code> event,
or one that is specific to a particular method.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;noSuchMethod&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span> <span class="p">]</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;noSuchMethod:&#39;</span> <span class="o">+</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">context</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
        <span class="nx">ownerMethod</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">ownerMethod</span> <span class="o">&amp;&amp;</span> <span class="nx">ownerMethod</span><span class="p">.</span><span class="nx">original</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">context</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--prototype--call">call</a></h4>

<p>Variadic <a href="#state--prototype--apply"><code>apply</code></a>.</p>

<blockquote>
  <p><a href="/api/#state--methods--call">call</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">call</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">O</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--events.js"><code>state/events.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--event">event</a></h4>

<p>Returns a registered event listener, or the number of listeners
registered, for a given event <code>type</code>.</p>

<p>If an <code>id</code> as returned by <a href="#state--privileged--add-event"><code>addEvent</code></a> is
provided, the event listener associated with that <code>id</code> is returned. If no
<code>id</code> is provided, the number of event listeners registered to <code>type</code> is
returned.</p>

<blockquote>
  <p><a href="/api/#state--methods--event">event</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">event</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                    <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span>
         <span class="cm">/*String | Function*/</span> <span class="nx">id</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">emitter</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">id</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

            <span class="k">typeof</span> <span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">id</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--add-event">addEvent</a></h4>

<p>Binds an event listener to the specified <code>eventType</code> and returns a unique
identifier for the listener. Built-in event types are listed at
<code>STATE_EVENT_TYPES</code>.</p>

<p><em>Aliases:</em> <strong>on</strong>, <strong>bind</strong></p>

<blockquote>
  <p><a href="/api/#state--methods--add-event">addEvent</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">addEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
              <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span>
            <span class="cm">/*Function*/</span> <span class="nx">fn</span><span class="p">,</span>
              <span class="cm">/*Object*/</span> <span class="nx">context</span>    <span class="c1">// = this</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">eventType</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateEventEmitter</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">eventType</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">].</span><span class="nx">add</span><span class="p">(</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--remove-event">removeEvent</a></h4>

<p>Unbinds the event listener with the specified <code>id</code> that was supplied by
<a href="#state--privileged--add-event"><code>addEvent</code></a>.</p>

<p><em>Aliases:</em> <strong>off</strong>, <strong>unbind</strong></p>

<blockquote>
  <p><a href="/api/#state--methods--remove-event">removeEvent</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">removeEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span> <span class="cm">/*String*/</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">].</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">id</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--emit">emit</a></h4>

<p>Invokes all listeners bound to the given event type.</p>

<p>Arguments for the listeners can be passed as an array to the <code>args</code>
parameter.</p>

<p>Callbacks are invoked in the context of <code>this</code>, or as specified by
<code>context</code>.</p>

<p>Callbacks bound to superstates and protostates are also invoked, unless
otherwise directed by setting <code>viaSuper</code> or <code>viaProto</code> to <code>false</code>.</p>

<p><em>Alias:</em> <strong>trigger</strong></p>

<blockquote>
  <p><a href="/api/#state--methods--emit">emit</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">emit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
             <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span>
              <span class="cm">/*Array*/</span> <span class="nx">args</span><span class="p">,</span>      <span class="c1">// = []</span>
              <span class="cm">/*State*/</span> <span class="nx">context</span><span class="p">,</span>   <span class="c1">// = this</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaSuper</span><span class="p">,</span>  <span class="c1">// = true</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span>   <span class="c1">// = true</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">eventType</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">args</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">viaProto</span> <span class="o">=</span> <span class="nx">viaSuper</span><span class="p">;</span>
                <span class="nx">viaSuper</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
                <span class="nx">context</span> <span class="o">=</span> <span class="nx">args</span><span class="p">;</span>
                <span class="nx">args</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">context</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">viaProto</span> <span class="o">=</span> <span class="nx">viaSuper</span><span class="p">;</span>
                <span class="nx">viaSuper</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
                <span class="nx">context</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="o">!</span><span class="nx">args</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">O</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">args</span> <span class="p">]</span> <span class="p">);</span>
            <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>

            <span class="p">(</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="k">this</span> <span class="p">);</span>

            <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="nx">protostate</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="k">this</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

            <span class="nx">viaSuper</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="nx">superstate</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="nx">superstate</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;event addEvent removeEvent emit trigger&#39;</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">noop</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--guards.js"><code>state/guards.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--guard">guard</a></h4>

<p>Gets a <strong>guard</strong> entity for this state. A guard is a value or function
that will be evaluated, as either a boolean or predicate, respectively,
to provide a determination of whether a controller will be admitted into
or released from the state to which the guard is applied. Guards are
inherited from protostates, but not from superstates.</p>

<blockquote>
  <p>See also: <a href="#state-controller--private--evaluate-guard"><code>StateController evaluateGuard</code></a></p>
  
  <p><a href="/api/#state--methods--guard">guard</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">guard</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">guards</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">guardType</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

            <span class="k">return</span> <span class="p">(</span>
                <span class="p">(</span> <span class="nx">guard</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">guard</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">protostate</span><span class="p">.</span><span class="nx">guard</span><span class="p">(</span> <span class="nx">guardType</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="kc">undefined</span>
            <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--add-guard">addGuard</a></h4>

<p>Adds a guard to this state, or augments an existing guard with additional
entries.</p>

<blockquote>
  <p><a href="/api/#state--methods--add-guard">addGuard</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">addGuard</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">guards</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">guardType</span><span class="p">,</span> <span class="cm">/*Object*/</span> <span class="nx">guard</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">O</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span>
                <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">),</span>
                <span class="nx">guard</span>
            <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--remove-guard">removeGuard</a></h4>

<p>Removes a guard from this state, or removes specific entries from an
existing guard.</p>

<blockquote>
  <p><a href="/api/#state--methods--remove-guard">removeGuard</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">removeGuard</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">guards</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                    <span class="cm">/*String*/</span> <span class="nx">guardType</span>
            <span class="cm">/*Array | String*/</span> <span class="cm">/* keys... */</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">entry</span><span class="p">;</span>

            <span class="nx">guard</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">guard</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span> <span class="k">delete</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">guard</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">keys</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">entry</span> <span class="o">=</span> <span class="nx">guard</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="k">delete</span> <span class="nx">guard</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">entry</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;guard addGuard removeGuard&#39;</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">noop</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--substates.js"><code>state/substates.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--substate">substate</a></h4>

<p>Retrieves the named substate of <code>this</code> state. If no such substate
exists in the local state, any identically named substate held on a
protostate will be returned.</p>

<blockquote>
  <p><a href="/api/#state--methods--substate">substate</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">substate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
             <span class="cm">/*String*/</span> <span class="nx">stateName</span><span class="p">,</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span>    <span class="c1">// = true</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
                <span class="nx">ss</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

            <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>First scan for any virtual substates that are active on the
local controller.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="nx">s</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">ss</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">);</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">ss</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">ss</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="o">===</span> <span class="nx">stateName</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">s</span><span class="p">;</span> 
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Otherwise retrieve a real substate, either locally or from a
protostate.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">return</span> <span class="p">(</span>
                <span class="nx">substates</span> <span class="o">&amp;&amp;</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span>
                    <span class="o">||</span>
                <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">protostate</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="nx">stateName</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="kc">undefined</span>
            <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--substates">substates</a></h4>

<p>Returns an <code>Array</code> of this state’s substates. If the boolean <code>deep</code>
argument is <code>true</code>, returns a depth-first flattened array containing all
of this state’s descendant states.</p>

<blockquote>
  <p><a href="/api/#state--methods--substates">substates</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">substates</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">deep</span><span class="p">,</span>    <span class="c1">// = false</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">virtual</span>  <span class="c1">// = false</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">s</span><span class="p">,</span> <span class="nx">ss</span><span class="p">,</span> <span class="nx">key</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Include virtual substates, if present.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">virtual</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">s</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">while</span> <span class="p">(</span> <span class="nx">s</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span> <span class="o">!==</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                           <span class="p">(</span> <span class="nx">ss</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span>
                    <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">deep</span> <span class="o">?</span>
                            <span class="nx">result</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="nx">s</span> <span class="p">)</span> <span class="o">:</span>
                            <span class="nx">ss</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="nx">s</span> <span class="p">);</span>
                        <span class="nx">s</span> <span class="o">=</span> <span class="nx">ss</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Include real substates.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">substates</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">deep</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">key</span> <span class="p">].</span><span class="nx">substates</span><span class="p">(</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--add-substate">addSubstate</a></h4>

<p>Creates a state from the supplied <code>stateExpression</code> and adds it as a
substate of this state. If a substate with the same <code>stateName</code> already
exists, it is first destroyed and then replaced. If the new substate is
being added to the controller’s root state, a reference is added
directly on the controller itself as well.</p>

<blockquote>
  <p><a href="/api/#state--methods--add-substate">addSubstate</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">addSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                                      <span class="cm">/*String*/</span> <span class="nx">stateName</span><span class="p">,</span>
            <span class="cm">/*StateExpression | Object | State*/</span> <span class="nx">stateExpression</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">substate</span><span class="p">,</span> <span class="nx">controller</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">().</span><span class="nx">addSubstate</span><span class="p">(</span> <span class="nx">stateName</span><span class="p">,</span> <span class="nx">stateExpression</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="p">(</span> <span class="nx">substate</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">substate</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>

            <span class="nx">substate</span> <span class="o">=</span> <span class="nx">stateExpression</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">?</span>
                <span class="nx">stateExpression</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">stateExpression</span><span class="p">.</span><span class="nx">realize</span><span class="p">()</span>
                <span class="o">:</span>
                <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">stateName</span><span class="p">,</span> <span class="nx">stateExpression</span> <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">substate</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

            <span class="k">this</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substate</span><span class="p">;</span>

            <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">controller</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substate</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">substate</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--remove-substate">removeSubstate</a></h4>

<p>Removes the named substate from the local state, if possible.</p>

<blockquote>
  <p><a href="/api/#state--methods--remove-substate">removeSubstate</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">removeSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">stateName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">controller</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span>
                <span class="nx">substate</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">substate</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
            <span class="nx">current</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If a transition is underway involving <code>substate</code>, the removal
will fail.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">transition</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">transition</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
                    <span class="nx">substate</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="o">||</span>
                    <span class="nx">substate</span> <span class="o">===</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span><span class="p">()</span> <span class="o">||</span>
                    <span class="nx">substate</span> <span class="o">===</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">target</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The controller must be forced to evacuate the state before it is
removed.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="nx">substate</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span> <span class="nx">forced</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="k">delete</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>
            <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="k">delete</span> <span class="nx">controller</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>

            <span class="k">return</span> <span class="nx">substate</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;substate substates&#39;</span><span class="o">:</span> <span class="p">[</span> <span class="kc">null</span> <span class="p">]</span>
<span class="p">});</span>
<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;addSubstate removeSubstate&#39;</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">noop</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--transitions.js"><code>state/transitions.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--transition">transition</a></h4>

<p>Returns the named transition expression held on this state.</p>

<blockquote>
  <p><a href="/api/#state--methods--transition">transition</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">transition</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">transitionName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">transitionName</span> <span class="p">];</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--transitions">transitions</a></h4>

<p>Returns an object containing all of the transition expressions defined
on this state.</p>

<blockquote>
  <p><a href="/api/#state--methods--transitions">transitions</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">transitions</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">O</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">transitions</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--add-transition">addTransition</a></h4>

<p>Registers a transition expression to this state.</p>

<blockquote>
  <p><a href="/api/#state--methods--add-transition">addTransition</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">addTransition</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                                   <span class="cm">/*String*/</span> <span class="nx">name</span><span class="p">,</span>
            <span class="cm">/*TransitionExpression | Object*/</span> <span class="nx">expression</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="nx">expression</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="o">||</span>
                <span class="p">(</span> <span class="nx">expression</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">);</span>

            <span class="k">return</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state--privileged--remove-transition">removeTransition</a></h4>

<p>(Not implemented)</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">removeTransition</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">noop</span>
<span class="p">});</span>

<span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;transition addTransition removeTransition&#39;</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span>
    <span class="nx">transitions</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{};</span> <span class="p">}</span>
<span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state--__post.js"><code>state/__post.js</code></a></h3></div>         <div class="code span11"><div class="highlight"><pre><span class="k">return</span> <span class="nx">State</span><span class="p">;</span>

<span class="p">}()</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h2><a href="#state-expression">StateExpression</a></h2>

<p>A <strong>state expression</strong> is a data structure that formalizes a definition of
a state’s contents.</p>

<p>States are declared by calling the module’s exported <a href="#module"><code>state()</code></a>
function and passing it an object map containing the definition. This
input may be expressed in a shorthand format, which the
<a href="#state-expression"><code>StateExpression</code></a>
<a href="#state-expression--constructor">constructor</a> rewrites into unambiguous
long form, which can be used later to create <a href="#state"><code>State</code></a> instances.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">StateExpression</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">attributeMap</span> <span class="o">=</span>
            <span class="nx">O</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_ATTRIBUTE_MODIFIERS</span> <span class="p">),</span>
                <span class="kd">function</span> <span class="p">(</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
                <span class="p">}),</span>

        <span class="nx">attributeFlags</span> <span class="o">=</span>
            <span class="nx">O</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span> <span class="nx">STATE_ATTRIBUTES</span> <span class="p">),</span>
                <span class="kd">function</span> <span class="p">(</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
                <span class="p">}),</span>

        <span class="nx">categoryMap</span>    <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_EXPRESSION_CATEGORIES</span> <span class="p">),</span>
        <span class="nx">eventTypes</span>     <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_EVENT_TYPES</span> <span class="p">),</span>
        <span class="nx">guardActions</span>   <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">GUARD_ACTIONS</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state-expression--constructor">Constructor</a></h3></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">StateExpression</span> <span class="p">(</span>
        <span class="cm">/*String | Object*/</span> <span class="nx">attributes</span><span class="p">,</span> <span class="c1">// optional</span>
                 <span class="cm">/*Object*/</span> <span class="nx">map</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">map</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">map</span> <span class="p">)</span> <span class="p">{</span> <span class="nx">map</span> <span class="o">=</span> <span class="p">{};</span> <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">map</span> <span class="p">)</span> <span class="p">{</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">;</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">O</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="s1">&#39;deep all&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">map</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="o">?</span> <span class="nx">map</span> <span class="o">:</span> <span class="nx">interpret</span><span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">attributes</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
            <span class="nx">map</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="o">:</span>
            <span class="nx">O</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">encodeAttributes</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="nx">attributes</span> <span class="o">||</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state-expression--class">Class functions</a></h3></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-expression--class--encode-attributes">encodeAttributes</a></h4>

<p>Returns the bit-field integer represented by the provided set of
attributes.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">encodeAttributes</span> <span class="p">(</span> <span class="cm">/*Object | String*/</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">attributeMap</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span> <span class="o">|=</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">[</span> <span class="nx">attributeMap</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">StateExpression</span><span class="p">.</span><span class="nx">encodeAttributes</span> <span class="o">=</span> <span class="nx">encodeAttributes</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-expression--class--decode-attributes">decodeAttributes</a></h4>

<p>Returns the space-delimited set of attribute names represented by the
provided bit-field integer.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">decodeAttributes</span> <span class="p">(</span> <span class="cm">/*Number*/</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">attributeFlags</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">key</span> <span class="o">&amp;&amp;</span> <span class="nx">out</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">attributeFlags</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">out</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">StateExpression</span><span class="p">.</span><span class="nx">decodeAttributes</span> <span class="o">=</span> <span class="nx">decodeAttributes</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state-expression--private">Class-private functions</a></h3></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-expression--private--interpret">interpret</a></h4>

<p>Transforms a plain object map into a well-formed
<a href="#state-expression"><code>StateExpression</code></a>, making the appropriate
inferences for any shorthand notation encountered.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">interpret</span> <span class="p">(</span> <span class="cm">/*Object*/</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_EXPRESSION_CATEGORIES</span><span class="p">,</span> <span class="kc">null</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Interpret and categorize the elements of the provided <code>map</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">map</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If <code>value</code> is just a reference to the exported <code>state</code> function,
interpret this as an empty state.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">value</span> <span class="o">===</span> <span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p><strong>Priority 1:</strong> Do a nominative type match for explicit
expression instances.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">category</span> <span class="o">=</span>
                <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;states&#39;</span> <span class="o">||</span>
                <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;transitions&#39;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">category</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">];</span>
                <span class="nx">item</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
                <span class="nx">item</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p><strong>Priority 2:</strong> Recognize an explicitly named category object.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">],</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p><strong>Priority 3:</strong> Use keys and value types to infer implicit
categorization.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">category</span> <span class="o">=</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">eventTypes</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span>
                        <span class="s1">&#39;events&#39;</span> <span class="o">:</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">guardActions</span> <span class="o">?</span>
                        <span class="s1">&#39;guards&#39;</span> <span class="o">:</span>
                    <span class="nx">O</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">?</span>
                        <span class="s1">&#39;states&#39;</span> <span class="o">:</span>
                    <span class="nx">O</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">?</span>
                        <span class="s1">&#39;methods&#39;</span> <span class="o">:</span>
                    <span class="kc">undefined</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">category</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">];</span>
                    <span class="nx">item</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
                    <span class="nx">item</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Coerce the extracted values as necessary:</p></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Event values are coerced into an array.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">events</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">value</span> <span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Guards are represented as a hashmap keyed by selector, so non-object
values are coerced into a single-element object with the value keyed
to the wildcard selector.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">guards</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">O</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="nx">value</span> <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Transition values must be a
<a href="#transition-expression"><code>TransitionExpression</code></a>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">transitions</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>State values must be a <a href="#state-expression"><code>StateExpression</code></a>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">states</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">StateExpression</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h2><a href="#state-controller">StateController</a></h2>

<p>A <strong>state controller</strong> maintains the identity of the owner’s <strong>current
state</strong>, and facilitates transitions from one state to another. It provides
the behavior-modeling aspect of the owner’s state by forwarding method calls
made on the owner to any associated stateful implementations of those
methods that are valid given the current state.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">StateController</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state-controller--constructor">Constructor</a></h3></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">StateController</span> <span class="p">(</span>
                          <span class="cm">/*Object*/</span> <span class="nx">owner</span><span class="p">,</span>      <span class="c1">// = {}</span>
        <span class="cm">/*StateExpression | Object*/</span> <span class="nx">expression</span><span class="p">,</span> <span class="c1">// optional</span>
                          <span class="cm">/*Object*/</span> <span class="nx">options</span>     <span class="c1">// optional</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">StateController</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">StateController</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">name</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">defaultSubstate</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">setCurrent</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}</span>
        <span class="kd">function</span> <span class="nx">setTransition</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">transition</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Validate arguments.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">owner</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">owner</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
        <span class="nx">expression</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="o">||</span>
            <span class="p">(</span> <span class="nx">expression</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">);</span>
        <span class="nx">options</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="o">||</span>
            <span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">initialState</span><span class="o">:</span> <span class="nx">options</span> <span class="p">}</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Assign to <code>owner</code> an
<a href="#state-controller--private--create-accessor">accessor method</a>
that will serve as the owner’s interface into its state.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;state&#39;</span><span class="p">;</span>
        <span class="nx">owner</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">createAccessor</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>

        <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--constructor--owner">owner</a></h4>

<p>Returns the owner object on whose behalf this controller acts.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">owner</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="nx">owner</span> <span class="p">),</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--constructor--name">name</a></h4>

<p>Returns the name assigned to this controller. This is also the
key in <code>owner</code> that holds the <code>accessor</code> function associated
with this controller.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">name</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">stringFunction</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">name</span><span class="p">;</span> <span class="p">}</span> <span class="p">),</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--constructor--current">current</a></h4>

<p>Returns the controller’s current state, or currently active
transition.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">current</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">current</span><span class="p">;</span> <span class="p">},</span> <span class="p">{</span>
                <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">current</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">current</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}),</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--constructor--change">change</a></h4>

<p><em>See</em> <a href="#state-controller--privileged--change"><code>StateController.privileged.change</code></a></p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">change</span><span class="o">:</span> <span class="nx">StateController</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span>
                <span class="nx">setCurrent</span><span class="p">,</span> <span class="nx">setTransition</span> <span class="p">),</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--constructor--transition">transition</a></h4>

<p>Returns the currently active transition, or <code>undefined</code> if the
controller is not presently engaged in a transition.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">transition</span><span class="o">:</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">transition</span><span class="p">;</span> <span class="p">},</span> <span class="p">{</span>
                <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}),</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--constructor--destroy">destroy</a></h4>

<p>Destroys this controller and all of its states, and returns the
owner to its original condition.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
                <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">;</span>
                <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
                <span class="nx">root</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="nx">result</span> <span class="o">=</span> <span class="k">delete</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
                <span class="nx">owner</span> <span class="o">=</span> <span class="nx">self</span> <span class="o">=</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Instantiate the root state, adding a redefinition of the
<code>controller</code> method that points directly to this controller, along
with all of the members and substates outlined in <code>expression</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">root</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Establish which state should be the initial state and set the
current state to that.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">current</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">initialSubstate</span><span class="p">()</span> <span class="o">||</span> <span class="nx">root</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">initialState</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">current</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">initialState</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">isAbstract</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">defaultSubstate</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">defaultSubstate</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">defaultSubstate</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">current</span> <span class="o">=</span> <span class="nx">defaultSubstate</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">controller</span><span class="p">()</span> <span class="o">!==</span> <span class="k">this</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">current</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">virtualize</span><span class="p">(</span> <span class="nx">root</span> <span class="p">);</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>(Exposed for debugging.)</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">O</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">__private__</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{</span>
            <span class="nx">root</span><span class="o">:</span> <span class="nx">root</span><span class="p">,</span>
            <span class="nx">owner</span><span class="o">:</span> <span class="nx">owner</span><span class="p">,</span>
            <span class="nx">options</span><span class="o">:</span> <span class="nx">options</span>
        <span class="p">});</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3>Class-private functions</h3></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--private--create-accessor">createAccessor</a></h4>

<p>Returns an <code>accessor</code> function, which will serve as an owner object’s
interface to the implementation of its state.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">createAccessor</span> <span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">self</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">accessor</span> <span class="p">(</span> <span class="nx">input</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">method</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="k">this</span> <span class="o">===</span> <span class="nx">owner</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">current</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">current</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">input</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">current</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="nx">input</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">input</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="nx">rxTransitionArrow</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">transitionArrowMethods</span><span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">current</span><span class="p">[</span> <span class="nx">method</span> <span class="p">].</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">current</span><span class="p">,</span> <span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">]</span>
                            <span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">return</span> <span class="nx">current</span><span class="p">[</span> <span class="nx">method</span> <span class="p">](</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">current</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Calling the accessor of a prototype means that <code>this</code> requires
its own accessor and <a href="#state-controller"><code>StateController</code></a>.
Creating a new <code>StateController</code> has the desired side-effect of
also creating the object’s new accessor, to which the call is
then forwarded.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
                <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isPrototypeOf</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="k">this</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="k">new</span> <span class="nx">StateController</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
                    <span class="nx">initialState</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span>
                <span class="p">});</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">accessor</span><span class="p">.</span><span class="nx">isAccessor</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">accessor</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s2">&quot;[accessor] -&gt; &quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">accessor</span><span class="p">;</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--private--evaluate-guard">evaluateGuard</a></h4>

<p>Returns the <code>Boolean</code> result of the guard function at <code>guardName</code>
defined on this state, as evaluated against <code>testState</code>, or <code>true</code> if no
guard exists.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">evaluateGuard</span> <span class="p">(</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">against</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">valueIsFn</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">selectors</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">typeof</span> <span class="nx">guard</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">guard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">guard</span><span class="p">(</span> <span class="nx">guard</span> <span class="p">)</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">guard</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">guard</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">guard</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="nx">valueIsFn</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">;</span>

            <span class="nx">valueIsFn</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
            <span class="nx">selectors</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span> <span class="nx">key</span> <span class="p">).</span><span class="nx">split</span><span class="p">(</span> <span class="sr">/\s*,+\s*/</span> <span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">selectors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selectors</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">against</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">result</span> <span class="o">=</span> <span class="nx">valueIsFn</span> <span class="o">?</span> <span class="o">!!</span><span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="p">)</span> <span class="o">:</span> <span class="o">!!</span><span class="nx">value</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">result</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state-controller--privileged">External privileged methods</a></h3></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">StateController</span><span class="p">.</span><span class="nx">privileged</span> <span class="o">=</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--privileged--change">change</a></h4>

<p>Attempts to execute a state transition. Handles asynchronous
transitions, generation of appropriate events, and construction of
any necessary temporary virtual states. Respects guards supplied in
both the origin and <code>target</code> states.</p>

<p>The <code>target</code> parameter may be either a <a href="#state"><code>State</code></a> object
within the purview of this controller, or a string that resolves to
a likewise targetable <code>State</code> when evaluated from the context of the
most recently current state.</p>

<p>The <code>options</code> parameter is an optional map that may include:</p>

<ul>
<li><p><code>args</code> : <code>Array</code> — arguments to be passed to a transition’s
<code>action</code> function.</p></li>
<li><p><code>success</code> : <code>Function</code> — callback to be executed upon successful
completion of the transition.</p></li>
<li><p><code>failure</code> : <code>Function</code> — callback to be executed if the transition
attempt is blocked by a guard.</p></li>
</ul></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">change</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">setCurrent</span><span class="p">,</span> <span class="nx">setTransition</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">defaultOptions</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                <span class="cm">/*State | String*/</span> <span class="nx">target</span><span class="p">,</span>
                        <span class="cm">/*Object*/</span> <span class="nx">options</span> <span class="c1">// optional</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">targetOwner</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span>
                    <span class="nx">domain</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">transitionExpression</span><span class="p">,</span>
                    <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

                <span class="nx">transition</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transition</span><span class="p">();</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The <code>origin</code> is defined as the controller’s most recently
current state that is not a <code>Transition</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">origin</span> <span class="o">=</span> <span class="nx">transition</span> <span class="o">?</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span><span class="p">()</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Departures are not allowed from a state that is <code>final</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">isFinal</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

                <span class="nx">root</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>
                <span class="nx">owner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Ensure that <code>target</code> is a valid <a href="#state"><code>State</code></a>.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">target</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span>
                    <span class="p">(</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span> <span class="o">?</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">root</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">target</span> <span class="o">||</span>
                        <span class="p">(</span> <span class="nx">targetOwner</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span> <span class="p">)</span> <span class="o">!==</span> <span class="nx">owner</span> <span class="o">&amp;&amp;</span>
                        <span class="o">!</span><span class="nx">targetOwner</span><span class="p">.</span><span class="nx">isPrototypeOf</span><span class="p">(</span> <span class="nx">owner</span> <span class="p">)</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Resolve <code>options</code> to an object if necessary.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">options</span> <span class="o">=</span> <span class="nx">defaultOptions</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">args</span><span class="o">:</span> <span class="nx">options</span> <span class="p">};</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>A transition cannot target an abstract state directly, so
<code>target</code> must be reassigned to the appropriate concrete
substate.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">while</span> <span class="p">(</span> <span class="nx">target</span><span class="p">.</span><span class="nx">isAbstract</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">defaultSubstate</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">target</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If any guards are in place for the given <code>origin</code> and
<code>target</code> states, they must consent to the transition.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">forced</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
                        <span class="o">!</span><span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">origin</span><span class="p">,</span> <span class="s1">&#39;release&#39;</span><span class="p">,</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">||</span>
                        <span class="o">!</span><span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;admit&#39;</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span>
                <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">failure</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">options</span><span class="p">.</span><span class="nx">failure</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If <code>target</code> is a protostate, i.e. a state from a prototype
of <code>owner</code>, then it must be represented within <code>owner</code> as a
transient virtual state that inherits from the protostate.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">.</span><span class="nx">controller</span><span class="p">()</span> <span class="o">!==</span> <span class="k">this</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">virtualize</span><span class="p">(</span> <span class="nx">root</span> <span class="p">)</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The <code>source</code> variable will reference the previously current
state (or abortive transition).</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">source</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The upcoming transition will start from its <code>source</code> and
proceed within the <code>domain</code> of the least common ancestor
between that state and the specified target.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">domain</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">common</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Conclusivity is enforced by checking each state that will be
exited against the <code>conclusive</code> attribute.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">state</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">!==</span> <span class="nx">domain</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isConclusive</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                    <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If a previously initiated transition is still underway, it
needs to be notified that it won’t finish.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Retrieve the appropriate transition expression for this
origin/target pairing; if none is defined, then an
actionless default transition will be created and applied,
causing the callback to return immediately.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">transitionExpression</span> <span class="o">=</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">getTransitionExpressionFor</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">);</span>
                <span class="nx">transition</span> <span class="o">=</span>
                    <span class="k">new</span> <span class="nx">Transition</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">transitionExpression</span> <span class="p">);</span>
                <span class="nx">setTransition</span><span class="p">(</span> <span class="nx">transition</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Preparation for the transition begins by emitting a <code>depart</code>
event on the <code>source</code> state.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">source</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;depart&#39;</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Enter into the transition state.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">setCurrent</span><span class="p">(</span> <span class="nx">transition</span> <span class="p">);</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;enter&#39;</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Walk up to the top of the domain, emitting <code>exit</code> events for
each state along the way.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span> <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span> <span class="o">!==</span> <span class="nx">domain</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">state</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">attachTo</span><span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">);</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>A scoped callback will be called from <code>transition.end()</code> to
conclude the transition.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">setCallback</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">pathToState</span><span class="p">,</span> <span class="nx">substate</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>

                    <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Trace a path from <code>target</code> up to <code>domain</code>, then walk
down it, emitting <code>enter</code> events for each state along
the way.</p></div>         <div class="code span11"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">pathToState</span> <span class="o">=</span> <span class="p">[];</span>
                              <span class="nx">state</span> <span class="o">!==</span> <span class="nx">domain</span><span class="p">;</span>
                              <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span>
                        <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">pathToState</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">;</span>
                        <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">substate</span> <span class="o">=</span> <span class="nx">pathToState</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="p">);</span>
                        <span class="nx">state</span> <span class="o">=</span> <span class="nx">substate</span>
                    <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">transition</span><span class="p">.</span><span class="nx">attachTo</span><span class="p">(</span> <span class="nx">substate</span> <span class="p">);</span>
                        <span class="nx">substate</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;enter&#39;</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                        <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span>
                    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Exit from the transition state.</p></div>         <div class="code span11"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">transition</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                        <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span>
                    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Terminate the transition with an <code>arrive</code> event on the
targeted state.</p></div>         <div class="code span11"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">setCurrent</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span>
                        <span class="nx">target</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;arrive&#39;</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Any virtual states that were previously active are
no longer needed.</p></div>         <div class="code span11"><div class="highlight"><pre>                        <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">;</span>
                              <span class="nx">state</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">();</span>
                              <span class="nx">state</span> <span class="o">=</span> <span class="nx">superstate</span>
                        <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
                            <span class="nx">state</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Now complete, the <a href="#transition"><code>Transition</code></a>
instance can be discarded.</p></div>         <div class="code span11"><div class="highlight"><pre>                        <span class="nx">transition</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                        <span class="nx">transition</span> <span class="o">=</span> <span class="nx">setTransition</span><span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
                        <span class="p">}</span>

                        <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>At this point the transition is attached to the <code>domain</code>
state and is ready to proceed.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">return</span> <span class="nx">transition</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">args</span> <span class="p">)</span> <span class="o">||</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state-controller--prototype">Prototype methods</a></h3></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">StateController</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--prototype--to-string">toString</a></h4></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-controller--prototype--get-transition-expression-for">getTransitionExpressionFor</a></h4>

<p>Finds the appropriate transition expression for the given origin and
target states. If no matching transitions are defined in any of the
states, returns a generic actionless transition expression for the
origin/target pair.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">getTransitionExpressionFor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">origin</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">origin</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">()</span> <span class="p">);</span>

            <span class="kd">function</span> <span class="nx">search</span> <span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">until</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">transitions</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">admit</span><span class="p">,</span> <span class="nx">release</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span> <span class="p">;</span>
                     <span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span> <span class="o">!==</span> <span class="nx">until</span><span class="p">;</span>
                     <span class="nx">state</span> <span class="o">=</span> <span class="nx">until</span> <span class="o">?</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">transitions</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">transitions</span><span class="p">();</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">transitions</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">expr</span> <span class="o">=</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">guards</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">guards</span> <span class="p">)</span> <span class="o">||</span>
                                    <span class="p">(</span>
                                        <span class="o">!</span><span class="p">(</span> <span class="nx">admit</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">.</span><span class="nx">admit</span> <span class="p">)</span> <span class="o">||</span>
                                            <span class="nx">O</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">admit</span> <span class="p">)</span> <span class="o">||</span>
                                            <span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">admit</span><span class="p">,</span>
                                                <span class="nx">target</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span>
                                    <span class="p">)</span>
                                        <span class="o">&amp;&amp;</span>
                                    <span class="p">(</span>
                                        <span class="o">!</span><span class="p">(</span> <span class="nx">release</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">.</span><span class="nx">release</span> <span class="p">)</span> <span class="o">||</span>
                                            <span class="nx">O</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">release</span> <span class="p">)</span> <span class="o">||</span>
                                            <span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span>
                                                <span class="nx">release</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">target</span> <span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                                    <span class="o">&amp;&amp;</span>
                                <span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">target</span> <span class="o">?</span>
                                        <span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">:</span>
                                        <span class="nx">state</span> <span class="o">===</span> <span class="nx">target</span>
                                <span class="p">)</span>
                                    <span class="o">&amp;&amp;</span>
                                <span class="p">(</span> <span class="o">!</span><span class="nx">expr</span><span class="p">.</span><span class="nx">origin</span> <span class="o">||</span>
                                    <span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">origin</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="nx">expr</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Search order:
1. <code>target</code>,
2. <code>origin</code>,
3. superstates of <code>target</code>,
4. superstates of <code>origin</code>.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="k">return</span> <span class="p">(</span>
                <span class="nx">search</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="nx">origin</span> <span class="o">!==</span> <span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="nx">search</span><span class="p">(</span> <span class="nx">origin</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="nx">search</span><span class="p">(</span> <span class="nx">target</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">)</span> <span class="o">||</span>
                        <span class="nx">search</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="o">!</span><span class="nx">target</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="nx">origin</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">search</span><span class="p">(</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">common</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="k">new</span> <span class="nx">TransitionExpression</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">StateController</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h2><a href="#state-event-emitter">StateEventEmitter</a></h2>

<p>A state holds event listeners for a given event type in a <code>StateEventEmitter</code>
instance.</p>

<p>An event listener is usually a function, but may also be held as a string,
which, when the client state <a href="#state--privileged--emit"><code>emit</code></a>s
the event type associated with this emitter, will be interpreted as an
implicit order for the emitting state to <a href="#state--prototype--change"><code>change</code></a>
to the target state named by the string.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">StateEventEmitter</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">guid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state-event-emitter">Constructor</a></h3></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">StateEventEmitter</span> <span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#state-event-emitter--prototype">Prototype methods</a></h3></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">StateEventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--guid">guid</a></h4>

<p>Produces a unique numeric string, to be used as a key for bound
event listeners.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">guid</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span> <span class="nx">guid</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--get">get</a></h4>

<p>Retrieves a bound listener associated with the provided <code>id</code> string
as returned by the prior call to
<a href="#state-event-emitter--prototype--add"><code>add</code></a>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span> <span class="nx">id</span> <span class="p">];</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--get-all">getAll</a></h4>

<p>Returns an array of all bound listeners.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">getAll</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--set">set</a></h4>

<p>Adds or replaces a handler bound to a specific key.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
                       <span class="cm">/*String*/</span> <span class="nx">id</span><span class="p">,</span>
            <span class="cm">/*Function | String*/</span> <span class="nx">handler</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
            <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">id</span> <span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">items</span><span class="p">[</span> <span class="nx">id</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--key">key</a></h4>

<p>Retrieves the <code>id</code> string associated with the provided listener.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">key</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Function*/</span> <span class="nx">listener</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">listener</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--keys">keys</a></h4>

<p>Returns the set of <code>id</code> strings associated with all bound listeners.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">keys</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="nx">result</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">join</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--add">add</a></h4>

<p>Binds a listener, along with an optional context object, to be
called when the the emitter
<a href="#state-event-emitter--prototype--emit"><code>emit</code></a>s an event.
Returns a unique key that can be used later to
<a href="#state-event-emitter--prototype--remove"><code>remove</code></a> the listener.</p>

<p><em>Aliases:</em> <strong>on bind</strong></p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="s1">&#39;add on bind&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*Function*/</span> <span class="nx">fn</span><span class="p">,</span>
              <span class="cm">/*Object*/</span> <span class="nx">context</span>  <span class="c1">// optional</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">guid</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span> <span class="nx">id</span> <span class="p">]</span> <span class="o">=</span>
                <span class="k">typeof</span> <span class="nx">context</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">?</span> <span class="p">[</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span> <span class="p">]</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="o">++</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--remove">remove</a></h4>

<p>Unbinds a listener. Accepts either the numeric string returned by
<a href="#state-event-emitter--prototype--add"><code>add</code></a> or a reference to
the function itself.</p>

<p><em>Aliases:</em> <strong>off unbind</strong></p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="s1">&#39;remove off unbind&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Function | String*/</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span>
                <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>

            <span class="nx">fn</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span> <span class="k">typeof</span> <span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span> <span class="nx">id</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">id</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">fn</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">delete</span> <span class="nx">items</span><span class="p">[</span> <span class="nx">id</span> <span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="o">--</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--empty">empty</a></h4>

<p>Removes all listeners, and returns the number of listeners removed.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">empty</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">n</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

            <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="k">delete</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--emit">emit</a></h4>

<p>Invokes all bound listeners, with the provided array of <code>args</code>, and
in the context of the bound or provided <code>state</code>.</p>

<p><em>Alias:</em> <strong>trigger</strong></p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="s1">&#39;emit trigger&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*Array*/</span> <span class="nx">args</span><span class="p">,</span>  <span class="c1">// optional</span>
            <span class="cm">/*State*/</span> <span class="nx">state</span>  <span class="c1">// = this</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">itemType</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span>
                <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>

            <span class="nx">state</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">item</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="nx">itemType</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span> <span class="nx">item</span> <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">itemType</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">fn</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">itemType</span> <span class="o">===</span> <span class="s1">&#39;array&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">fn</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>If <code>item</code> is a string or <a href="#state"><code>State</code></a>, interpret this
as an implied transition to be instigated from the client
<code>State</code> after all the callbacks have been invoked.</p></div>         <div class="code span11"><div class="highlight"><pre>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">itemType</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="nx">item</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">target</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
                <span class="nx">fn</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span>
        <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#state-event-emitter--prototype--destroy">destroy</a></h4></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span> <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">StateEventEmitter</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h2><a href="#transition">Transition</a></h2>

<p>A <code>Transition</code> is a transient <code>State</code> adopted by a controller as it changes
from one of its proper <code>State</code>s to another.</p>

<p>A transition acts within the <strong>domain</strong> of the <em>least common ancestor</em>
between its <strong>origin</strong> and <strong>target</strong> states. During this time it behaves as
if it were a substate of that domain state, inheriting method calls and
propagating events in the familiar fashion.</p>

<blockquote>
  <p><a href="/docs/#concepts--transitions">Transitions</a>
  <a href="/api/#transition">Transition</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Transition</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">O</span><span class="p">.</span><span class="nx">inherit</span><span class="p">(</span> <span class="nx">Transition</span><span class="p">,</span> <span class="nx">State</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#transition--constructor">Constructor</a></h3></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">Transition</span> <span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">TransitionExpression</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">name</span> <span class="o">=</span> <span class="nx">expression</span> <span class="o">&amp;&amp;</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>

            <span class="nx">methods</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">events</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">guards</span> <span class="o">=</span> <span class="p">{},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>The <strong>action</strong> of a transition is a function that will be called
after the transition has been <code>start</code>ed. This function, if
provided, is responsible for calling <code>end()</code> on the transition
at some point in the future.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">action</span> <span class="o">=</span> <span class="nx">expression</span> <span class="o">&amp;&amp;</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">action</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span>

            <span class="nx">attachment</span> <span class="o">=</span> <span class="nx">source</span><span class="p">,</span>
            <span class="nx">controller</span><span class="p">,</span> <span class="nx">aborted</span><span class="p">;</span>

        <span class="nx">controller</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="o">!==</span> <span class="nx">target</span><span class="p">.</span><span class="nx">controller</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">controller</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>(Exposed for debugging.)</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">O</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">__private__</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{</span>
            <span class="nx">methods</span><span class="o">:</span> <span class="nx">methods</span><span class="p">,</span>
            <span class="nx">events</span><span class="o">:</span> <span class="nx">events</span><span class="p">,</span>
            <span class="nx">guards</span><span class="o">:</span> <span class="nx">guards</span><span class="p">,</span>
            <span class="nx">action</span><span class="o">:</span> <span class="nx">action</span>
        <span class="p">});</span>

        <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--name">name</a></h4></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">name</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--superstate">superstate</a></h4>

<p>A <a href="#transition"><code>Transition</code></a> instance uses <code>superstate</code> to
track its position as it traverses the <a href="#state"><code>State</code></a> subtree
that defines its domain.</p>

<blockquote>
  <p><a href="/api/#transition--methods--superstate">superstate</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">superstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">attachment</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--attach-to">attachTo</a></h4></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">attachTo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">attachment</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--controller">controller</a></h4></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">controller</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">controller</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--origin">origin</a></h4>

<p>A transition’s <strong>origin</strong> is the controller’s most recently
active <a href="#state"><code>State</code></a> that is not itself a
<a href="#transition"><code>Transition</code></a>.</p>

<blockquote>
  <p><a href="/api/#transition--methods--origin">origin</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">origin</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">source</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="o">?</span> <span class="nx">source</span><span class="p">.</span><span class="nx">origin</span><span class="p">()</span> <span class="o">:</span> <span class="nx">source</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--source">source</a></h4>

<p>A transition’s <strong>source</strong> is the <a href="#state"><code>State</code></a> or
<a href="#transition"><code>Transition</code></a> that immediately preceded <code>this</code>.</p>

<blockquote>
  <p><a href="/api/#transition--methods--source">source</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">source</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">source</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--target">target</a></h4>

<p>The intended destination <a href="#state"><code>State</code></a> for this transition.
If a target is invalidated by a controller that
<a href="#state-controller--privileged--change"><code>change</code></a>s state again
before this transition completes, then this transition is
aborted and the <code>change</code> call will create a new transition with
<code>this</code> as its <code>source</code>.</p>

<blockquote>
  <p><a href="/api/#transition--methods--target">target</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">target</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--set-callback">setCallback</a></h4>

<p>Allows the callback function to be set or changed prior to the
transition’s completion.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">setCallback</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--was-aborted">wasAborted</a></h4>

<blockquote>
  <p><a href="/api/#transition--methods--was-aborted">wasAborted</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">wasAborted</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">aborted</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--start">start</a></h4>

<p>Starts the transition; if an <code>action</code> is defined, that function
is responsible for declaring an end to the transition by calling
<a href="#transitions--constructor--end"><code>end()</code></a>. Otherwise, the
transition is necessarily synchronous and is concluded
immediately.</p>

<blockquote>
  <p><a href="/api/#transition--methods--start">start</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">aborted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">action</span> <span class="o">&amp;&amp;</span> <span class="nx">O</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">action</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">action</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--abort">abort</a></h4>

<p>Indicates that a transition won’t directly reach its target
state; for example, if a new transition is initiated while an
asynchronous transition is already underway, that previous
transition is aborted. The previous transition is retained as
the <code>source</code> for the new transition.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">abort</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">aborted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">callback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;abort&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--end">end</a></h4>

<p>Indicates that a transition has completed and has reached its
intended target. The transition is subsequently retired, along
with any preceding aborted transitions.</p>

<blockquote>
  <p><a href="/api/#transition--methods--end">end</a></p>
</blockquote></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">end</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">aborted</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">controller</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
            <span class="p">},</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--constructor--destroy">destroy</a></h4>

<p>Destroys this transition and clears its held references, and
does the same for any aborted <code>source</code> transitions that preceded
it.</p></div>         <div class="code span11"><div class="highlight"><pre>            <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">source</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="o">&amp;&amp;</span> <span class="nx">source</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="nx">target</span> <span class="o">=</span> <span class="nx">attachment</span> <span class="o">=</span> <span class="nx">controller</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p><a href="#transition"><code>Transition</code></a> also inherits certain privileged methods
from <a href="#state"><code>State</code></a>, which it obtains by partially applying the
corresponding members of <a href="#state--privileged"><code>State.privileged</code></a>.</p></div>         <div class="code span11"><div class="highlight"><pre>        <span class="nx">O</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;express mutate&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">TransitionExpression</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span> <span class="p">],</span>
            <span class="s1">&#39;method methodNames addMethod removeMethod&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">methods</span> <span class="p">],</span>
            <span class="s1">&#39;event addEvent removeEvent emit&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">events</span> <span class="p">],</span>
            <span class="s1">&#39;guard addGuard removeGuard&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">guards</span> <span class="p">]</span>
        <span class="p">});</span>
        <span class="nx">O</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">addEvent</span><span class="o">:</span> <span class="s1">&#39;on bind&#39;</span><span class="p">,</span>
            <span class="nx">removeEvent</span><span class="o">:</span> <span class="s1">&#39;off unbind&#39;</span><span class="p">,</span>
            <span class="nx">emit</span><span class="o">:</span> <span class="s1">&#39;trigger&#39;</span>
        <span class="p">});</span>

        <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span> <span class="nx">TransitionExpression</span> <span class="p">).</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition--prototype--depth">depth</a></h4></div>         <div class="code span11"><div class="highlight"><pre>    <span class="nx">Transition</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">source</span><span class="p">(),</span>
            <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        
        <span class="k">while</span> <span class="p">(</span> <span class="nx">s</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">source</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">count</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Transition</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h2><a href="#transition-expression">TransitionExpression</a></h2>

<p>A <a href="#state"><code>State</code></a> may hold <strong>transition expressions</strong> that describe the
transition that will take place between any two given <strong>origin</strong> and
<strong>target</strong> states.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">TransitionExpression</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">properties</span>   <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">TRANSITION_PROPERTIES</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span>
        <span class="nx">categories</span>   <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">TRANSITION_EXPRESSION_CATEGORIES</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span>
        <span class="nx">eventTypes</span>   <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">TRANSITION_EVENT_TYPES</span> <span class="p">),</span>
        <span class="nx">guardActions</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">GUARD_ACTIONS</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#transition-expression--constructor">Constructor</a></h3></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">TransitionExpression</span> <span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">map</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">O</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="s1">&#39;deep all&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">map</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="o">?</span> <span class="nx">map</span> <span class="o">:</span> <span class="nx">interpret</span><span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h3><a href="#transition-expression--private">Class-private functions</a></h3></div>         <div class="code span11"><div class="highlight"><pre></pre></div></div>     </div>          <div class="row">         <div class="text span5"><h4><a href="#transition-expression--private--interpret">interpret</a></h4>

<p>Rewrites a plain object map as a well-formed
<a href="#transition-expression"><code>TransitionExpression</code></a>, making the appropriate
inferences for any shorthand notation encountered.</p></div>         <div class="code span11"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">interpret</span> <span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="p">{},</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">categories</span> <span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">map</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">properties</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">categories</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">],</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">category</span> <span class="o">=</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">eventTypes</span> <span class="o">?</span>
                        <span class="s1">&#39;events&#39;</span> <span class="o">:</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">guardActions</span> <span class="o">?</span>
                        <span class="s1">&#39;guards&#39;</span> <span class="o">:</span>
                    <span class="nx">O</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">?</span>
                        <span class="s1">&#39;methods&#39;</span> <span class="o">:</span>
                    <span class="kc">undefined</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">category</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">];</span>
                    <span class="nx">item</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
                    <span class="nx">item</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="p">(</span> <span class="nx">events</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">events</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">O</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">value</span> <span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">TransitionExpression</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div></div>     </div>          <div class="row">         <div class="text span5"><p>Classes are made available as members of the exported module.</p></div>         <div class="code span11"><div class="highlight"><pre><span class="nx">O</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">State</span><span class="o">:</span> <span class="nx">State</span><span class="p">,</span>
    <span class="nx">StateExpression</span><span class="o">:</span> <span class="nx">StateExpression</span><span class="p">,</span>
    <span class="nx">StateController</span><span class="o">:</span> <span class="nx">StateController</span><span class="p">,</span>
    <span class="nx">StateEventEmitter</span><span class="o">:</span> <span class="nx">StateEventEmitter</span><span class="p">,</span>
    <span class="nx">Transition</span><span class="o">:</span> <span class="nx">Transition</span><span class="p">,</span>
    <span class="nx">TransitionExpression</span><span class="o">:</span> <span class="nx">TransitionExpression</span>
<span class="p">});</span>

<span class="p">}.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">);</span>

</pre></div></div>     </div> 