(function(a){function e(b,c,d,e){return arguments.length<2?(typeof b=="string"?c=b:d=b,b=a):(typeof b=="string"&&(e=d,d=c,c=b,b=a),typeof c!="string"&&(e=d,d=c,c=a)),d=new p(c,d),b?(new q(b,d,e)).current():d}"use strict";var b=this,c={VERSION:"0.0.3",noConflict:function(){var a=b.state;return function(){return b.state=a,this}}(),options:{memoizeProtostates:!0}},d=typeof require!="undefined"?require("zcore"):b.Z;d.assign(e,c);var f={NORMAL:0,VIRTUAL:1,MUTABLE:2,FINITE:4,IMMUTABLE:8,INITIAL:16,CONCLUSIVE:32,FINAL:64,ABSTRACT:128,DEFAULT:256,SEALED:512,HISTORY:1024,RETAINED:2048,SHALLOW:4096,VERSIONED:8192,CONCURRENT:16384},g=["mutable finite immutable","initial conclusive final","abstract default sealed","history retained shallow versioned","concurrent"].join(" "),h="data methods events guards states transitions",i="construct depart exit enter arrive destroy mutate",j="admit release",k="origin source target action conjugate",l="methods events guards",m="construct destroy enter exit start end abort";d.env.server&&(module.exports=exports=e),d.env.client&&(b.state=e);var n=d.env.server?module:{exports:e},o=function(){function C(b,c,e){if(!(this instanceof C))return new C(b,c,e);var f,l,m,n,o;f=e&&e.attributes||g,this.name=d.stringFunction(function(){return c||""}),b instanceof q?(l=b,b=a,l.root=d.thunk(this),this.controller=d.thunk(l)):b&&(this.superstate=D.superstate(b),m=b.attributes(),f|=m&(i|j));if(n=this.protostate())o=n.attributes(),f|=o&B;f|=(m|o)&k,f&k&&(f&=~i,f|=j),f&h?(this.attributes=D.attributes(f),this.realize=D.realize(f),f&i&&d.assign(this,F)):E.call(this,b,f,e),d.env.debug&&(this[" <owner>"]=this.owner(),this[" <path>"]=this.derivation(!0).join("."),this["<attr>"]=p.decodeAttributes(f))}function E(a,b,c){var e,f,g,h,k=this,l={},m={},o={},q={},r={},t={},u=b&x||b&y?new s(this):null;d.privilege(this,D,{"peek express mutate":[p,b,l,m,o,q,r,t,u],superstate:[a],attributes:[b],data:[b,l],"method methodNames addMethod removeMethod":[m],"event addEvent removeEvent emit":[o],"guard addGuard removeGuard":[q],"substate substates addSubstate removeSubstate":[b,r],"transition transitions addTransition removeTransition":[t],destroy:[function(b){return a=b},m,o,r]}),u&&d.privilege(this,D,{"history push replace":[u]}),d.alias(this,{addEvent:"on bind",removeEvent:"off unbind",emit:"trigger"}),D.init(p).call(this,c);if(!a&&(e=this.owner())){f=this.addMethod,f||(f=D.addMethod(m));for(g in e)d.hasOwn.call(e,g)&&(h=e[g],d.isFunction(h)&&!h.isDelegator&&this.method(g,!1)&&f.call(this,g,h))}~b&i&&d.forEach("mutate addMethod removeMethod addGuard removeGuard             addTransition removeTransition".split(/\s+/),function(a){delete k[a]});if(~b&i||b&j)delete this.addSubstate,delete this.removeSubstate;return~b&i&&b&j&&(this.mutate=D.mutate(p,b,l,m,o,q,null,t)),d.env.debug&&d.assign(this,{__private__:this.peek(n)}),this}var e=f,g=e.NORMAL,h=e.VIRTUAL,i=e.MUTABLE,j=e.FINITE,k=e.IMMUTABLE,l=e.INITIAL,m=e.CONCLUSIVE,o=e.FINAL,t=e.ABSTRACT,v=e.DEFAULT,w=e.SEALED,x=e.HISTORY,y=e.RETAINED,z=e.SHALLOW,A=e.CONCURRENT,B=i|j|k|l|m|o|t|v|w|x|y|z|A;d.assign(C,e),C.prototype.name=d.noop;var D=C.privileged={};d.assign(C.privileged,{init:function(a){return function(a){return this.__initializing__=!0,this.mutate(a),delete this.__initializing__,this.emit("construct",a,!1),this}},destroy:function(b,c,e,f){return function(){var g=this.superstate(),h=this.controller(),i=h.owner(),j=h.transition(),k,l,m,o,p,q,r;if(j){k=j.origin(),l=j.target();if(k.isIn(this)||l.isIn(this))return!1}for(r in f)d.hasOwn.call(f,r)&&f[r].destroy();this.emit("destroy",!1);for(m in e)e[m].destroy(),delete e[m];if(g)g.isMutable()?g.removeSubstate(this.name()):D.removeSubstate(g.peek(n,"attributes"),g.peek(n,"substates")).call(g,this.name());else{for(o in c)p=i[o],q=p.original,q?(delete p.original,i[o]=q):delete i[o];h.destroy&&h.destroy()}return b(a),this.destroyed=!0}}}),d.assign(C.prototype,{destroy:d.thunk(!1)}),C.privileged.peek=function(a,b,c,e,f,g,h,i,j){var k={expressionConstructor:a,attributes:b,data:c,methods:e,events:f,guards:g,substates:h,transitions:i,history:j};return function(a,b){if(a!==n)throw ReferenceError;return b?k[b]:d.clone(k)}},C.prototype.peek=d.noop;var F=function(){var a={},b="addMethod addEvent addGuard addSubstate addTransition";return d.forEach(b.split(" "),function(b){function c(){var a=this.realize()[b];if(a!==c)return a.apply(this,arguments)}a[b]=c}),a}();return C.privileged.realize=function(a){return function(b){var c=this.superstate(),e=d.hasOwn.call(c,"addSubstate")?c.addSubstate:D.addSubstate(c.peek(n,"attributes"),c.peek(n,"substates"));return delete this.realize,e.call(c,this.name(),this)&&E.call(this,c,a&~h,b),this}},C.prototype.realize=d.getThis,C.privileged.express=function(){function b(b){if(b===a)return;var c=null,e,f;for(e in b)f=b[e],(c||(c={}))[e]=f&&typeof f=="object"?d.clone(b[e]):f;return c}function c(b){if(b===a)return;var c=null,e,f;for(e in b)if(f=b[e])(c||(c={}))[e]=d.clone(f.items);return c}function e(b,c){if(b===a)return;var e=null;return d.forEach(b,function(a,b){(e||(e={}))[b]=a.express(c)}),e}return function(a,f,g,h,i,j,k,l){return function(m){var n={};return d.edit(n,{attributes:f,data:b(g),methods:b(h),events:c(i),guards:b(j),states:e(k,m),transitions:b(l)}),m?new a(n):n}}}(),C.prototype.express=d.noop,d.assign(C.privileged,{mutate:function(a,b,c,e,f,g,h,i){return function(b){b instanceof a||(b=new a(b));var j=this,k=d.NIL,l,m,n,o,p,q,s,t;this.__initializing__||(l=this.express()),this.__atomic__=!0,c&&b.data&&this.data(b.data),m=e&&b.methods;for(n in m)d.hasOwn.call(m,n)&&(o=m[n],o!==k?this.addMethod(n,o):this.removeMethod(n));f&&b.events&&d.forEach(b.events,function(a,b){var c,e,g,h,i,l=f[b];if(a===k)return l&&l.empty();!l&&a&&!d.isEmpty(a)&&(l=f[b]=new r(j,b)),c=l.items,e=function(a){var b,e;for(b in a)d.hasOwn.call(a,b)&&(e=a[b],e===k?l.remove(b):e&&e!==c[b]&&l.set(b,e))};if(d.isArray(a)){g=function(a){return j.addEvent(b,a)};for(h=0,i=a.length;h<i;h++){o=a[h];if(o==null||o===k)continue;(d.isPlainObject(o)?e:g)(o)}}else d.isPlainObject(a)&&e(a);l.length||l.destroy()&&delete f[b]}),g&&b.guards&&d.edit("deep",g,b.guards),m=h&&b.states;for(n in m)d.hasOwn.call(m,n)&&(o=m[n],n in h?o===k?h[n].destroy():h[n].mutate(o,!1):this.addSubstate(n,o));m=i&&b.transitions;for(n in m)d.hasOwn.call(m,n)&&(o=m[n],n in i?o===k?delete i[n]:i[n]=new u(o):this.addTransition(n,o));return delete this.__atomic__,l&&(p=this.express(),q=d.diff(l,p),d.isEmpty(q)||this.emit("mutate",[b,l,p,q],!1)),this}}}),d.assign(C.prototype,{mutate:function(a){var b,c,e=d.NIL,f=this.substates(),g=a.states;for(b in g)d.hasOwn.call(g,b)&&(c=g[b],b in f?c!==e&&f[b].mutate(c,!1):this.addSubstate(b,c))}}),C.privileged.attributes=function(a){return function(){return a}},d.assign(C.prototype,{attributes:d.thunk(g),isVirtual:function(){return!!(this.attributes()&h)},isMutable:function(){return!!(this.attributes()&i)},isFinite:function(){return!!(this.attributes()&j)},isImmutable:function(){return!!(this.attributes()&k)},isInitial:function(){return!!(this.attributes()&l)},isConclusive:function(){return!!(this.attributes()&m)},isFinal:function(){return!!(this.attributes()&o)},isAbstract:function(){return!!(this.attributes()&t)},isDefault:function(){return!!(this.attributes()&v)},isSealed:function(){return!!(this.attributes()&w)},isRetained:function(){return!!(this.attributes()&y)},hasHistory:function(){return!!(this.attributes()&x)},isShallow:function(){return!!(this.attributes()&z)},isVersioned:function(){return!!(this.attributes()&VERSIONED)},isConcurrent:function(){return!!(this.attributes()&A)}}),d.assign(C.privileged,{superstate:function(b){return function(c){return c===a?b:b?c?b.name()===c?b:b.superstate(c):this.controller().root():a}}}),d.assign(C.prototype,{owner:function(){var a=this.controller();if(a)return a.owner()},controller:function(){var a=this.superstate();if(a)return a.controller()},root:function(){var a=this.controller();if(a)return a.root()},superstate:d.noop,protostate:function(){var a=this.derivation(!0),b=this.controller(),e,f,g,h,i,j;if(!b)return;e=b.name(),f=b.owner(),g=function(){var a,b;return f=d.getPrototypeOf(f),f&&typeof f=="object"&&d.isFunction(a=f[e])&&(b=a.apply(f))&&b instanceof C&&b.root()};for(h=g();h;h=g()){for(i=0,j=a.length;i<j;i++){h=h.substate(a[i],!1);if(!h)break}if(h)return c.options.memoizeProtostates&&(this.protostate=function(){return h.destroyed?(h=null,delete this.protostate,this.protostate()):h}),h}},derivation:function(a){for(var b=[],c,d=this;(c=d)&&(d=c.superstate());b.unshift(a?c.name()||"":c));return b},depth:function(){for(var a=0,b=this,c;c=b.superstate();b=c,a++);return a},common:function(a){var b;a instanceof C||(a=this.query(a));for(this.depth()>a.depth()?(b=a,a=this):b=this;b;b=b.superstate())if(b===a||b.isSuperstateOf(a))return b},is:function(a){return a instanceof C||(a=this.query(a)),a===this},isIn:function(a){return a instanceof C||(a=this.query(a)),a===this||a.isSuperstateOf(this)},has:function(a){return a instanceof C||(a=this.query(a)),this===a||this.isSuperstateOf(a)},isSuperstateOf:function(a){var b;return a instanceof C||(a=this.query(a)),(b=a.superstate())?this===b||this.isSuperstateOf(b):!1},isProtostateOf:function(a){var b;return a instanceof C||(a=this.query(a)),(b=a.protostate())?this===b||this.isProtostateOf(b):!1},defaultSubstate:function(b,c){var d=this.substates(),e=0,f=d&&d.length,g;c||f&&(c=d[0]);for(;e<f;e++)if(d[e].isDefault())return d[e];if(b||b===a){g=this.protostate();if(g)return g.defaultSubstate(!0,c)}return c},initialSubstate:function(b){var c=[this],d,e,f,g,h,i;while(d=c.shift()){e=d.substates(!1,!0);for(f=0,g=e.length;f<g;f++){h=e[f];if(h.isInitial())return h.initialSubstate(!1)||h;c.push(h)}}if(b||b===a){i=this.protostate();if(i)return i.initialSubstate(!0)}},toString:function(){return this.derivation(!0).join(".")}}),d.assign(C.prototype,{current:function(){var a=this.controller();if(a)return this.controller().current()},isCurrent:function(){return this.current()===this},isActive:function(){var a=this.current();return a===this||this.isSuperstateOf(a)},"change go be":function(a,b){var c=this.controller();return arguments.length?(d.isNumber(a)&&(a=this.history(a)),c.change.apply(c,a instanceof C||typeof a=="string"?arguments:[this].concat(arguments))):c.change(this)},"changeTo goTo become":function(b,c){return b===a&&(b=this),c?c.direct=!0:c={direct:!0},this.change(b,c)}}),d.assign(C.prototype,{"query match":function(b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s;typeof c=="boolean"&&(e=d,d=c,c=a),d===a&&(d=!0),e===a&&(e=!0),f===a&&(f=!0);if(b==null)return c!==a?!1:null;if(b===".")return c!==a?c===this:this;if(b==="")return c!==a?c===this.root():this.root();if(c&&c===this.root()&&b.search(/^\*+$/)===0)return!0;b.search(/^\.*\**$/)===0&&(d=e=!1);if(b.charAt(0)!==".")return this.root().query("."+b,c,d,!1);b=b.replace(/^(\.+)\.$/,"$1"),g=b.split(".");for(k=1,l=g.length,h=this;h;k++){if(k>=l)return c?c===h:h;m=g[k];if(m==="*"){if(!c)return h.substates();if(h===c.superstate())return!0;break}if(m==="**"){if(!c)return h.substates(!0);if(h.isSuperstateOf(c))return!0;break}if(m==="")h=h.superstate();else if(i=h.substate(m))h=i;else break}if(d){n=[this];while(o=n.shift()){p=o.substates(!1,!0);for(k=0,l=p.length;k<l;k++){q=p[k];if(q===d)continue;j=q.query(b,c,!1,!1,!1);if(j)return j;n.push(q)}}}if(e&&(r=this.superstate())){j=r.query(b,c,d&&this,!0,!1);if(j)return j}if(f&&(s=this.protostate())){j=s.query(b,c,d,e,!0);if(j)return j}return c?!1:null},$:function(a){var b;if(typeof a!="function")return this.query.apply(this,arguments);b=d.slice.call(arguments),b[0]=a=a();if(a)return this.change.apply(this,b)}}),d.assign(C.privileged,{data:function(b,c){return function(e,f){var g,j,k,l,m;return e!=null&&typeof e!="boolean"?(g=e,e=f=!1):(e===a&&(e=!0),f===a&&(f=!0)),g&&b&i&&!d.isEmpty(g)?b&h?this.realize().data(g):(j=d.delta(c,g),!this.__atomic__&&j&&!d.isEmpty(j)&&(this.push("delta",this,null,j),this.emit("mutate",[g,j],!1)),this):d.clone(e&&(l=this.superstate())&&l.data(),f&&(m=this.protostate())&&m.data(!1),c)}}}),C.prototype.data=C.privileged.data(a,null),d.assign(C.privileged,{method:function(b){return function(c,e,f,g){var h,i,j;e===a&&(e=!0),f===a&&(f=!0),b&&(j=b[c]);if(j&&j!==d.noop)return g&&(g.context=this,g.method=j),j;if(f){i=this.protostate();if(i){j=i.method(c,!1,!0,g);if(j)return g&&(g.context=this),j}}if(e){h=this.superstate();if(h){j=h.method(c,!0,f,g);if(j)return j}}return g&&(g.context=null,g.method=j),j}},methodNames:function(a){return function(){return d.keys(a)}},addMethod:function(b){function c(a,b,c){function e(){return this[a]().apply(b,arguments)}return e.isDelegator=!0,d.env.debug&&(e.toString=function(){return"[delegator]"}),c&&(e.original=c),e}return function(e,f){var g=this.controller(),h=g.name(),i=g.root(),j=g.owner(),k;if(!this.method(e,!0,!1)){if(this!==i&&!i.method(e,!1,!1)){k=j[e];if(k===a||k.isDelegator)k=d.noop;i.addMethod(e,k)}j[e]=c(h,e,k)}return b[e]=f}},removeMethod:function(a){return function(b){var c=a[b];return delete a[b],c}}}),d.assign(C.prototype,{method:C.privileged.method(null),methodNames:function(){return[]},"addMethod removeMethod":d.noop,hasMethod:function(a){var b=this.method(a);return b&&b!==d.noop},hasOwnMethod:function(a){return!!this.method(a,!1,!1)},apply:function(b,c){var d,e,f,g,h;return d={method:a,context:a},e=this.method(b,!0,!0,d),e?(f=d.context,g=this.owner(),h=g[b],h&&h.original&&f===this.root()&&(f=g),e.apply(f,c)):this.emit("nonexistent",[b,c],!1)},call:function(a){return this.apply(a,d.slice.call(arguments,1))}}),d.assign(C.privileged,{event:function(b){return function(c,d){var e=b[c];if(e==null)return;return d===a?e.length:(typeof d=="function"&&(d=e.key(d)),e.get(d))}},addEvent:function(a){return function(b,c,e){return d.hasOwn.call(a,b)||(a[b]=new r(this,b)),a[b].add(c,e)}},removeEvent:function(a){return function(b,c){return a[b].remove(c)}},emit:function(b){return function(c,e,f,g,h){var i,j,k;if(typeof c!="string")return;typeof e=="boolean"&&(h=g,g=f,f=e,e=a),typeof f=="boolean"&&(h=g,g=f,f=a),!e&&(e=[])||d.isArray(e)||(e=[e]),g===a&&(g=!0),h===a&&(h=!0),(i=b[c])&&i.emit(e,f||this),h&&(j=this.protostate())&&j.emit(c,e,f||this,!1),g&&(k=this.superstate())&&k.emit(c,e,f||k)}}}),d.assign(C.prototype,{"event addEvent removeEvent emit trigger":d.noop}),d.assign(C.privileged,{guard:function(b){return function(c){var e,f;return(e=b[c])&&d.clone(e)||(f=this.protostate())&&f.guard(c)||a}},addGuard:function(a){return function(b,c){return d.edit(a[b]||(a[b]={}),c)}},removeGuard:function(b){return function(c){var e,f,g,h,i,j;e=b[c];if(!e)return null;if(arguments.length<2)return delete b[c]?e:a;f=d.flatten(d.slice.call(arguments,1));for(g=0,h=f.length;g<h;g++){i=f[g];if(typeof i=="string"){j=e[i];if(delete e[i])return j}}}}}),d.assign(C.prototype,{"guard addGuard removeGuard":d.noop}),d.assign(C.privileged,{substate:function(b,c){return function(b,d){var e=this.current(),f,g;d===a&&(d=!0);for(;e&&e.isVirtual()&&(f=e.superstate());e=f)if(f===this&&e.name()===b)return e;return c&&c[b]||d&&(g=this.protostate())&&g.substate(b)||a}},substates:function(a,b){return function(a,c){var e=[],f,g,h;if(c){f=this.current();if(f&&f.isVirtual()&&this.isSuperstateOf(f))while(f&&f!==this&&f.isVirtual()&&(g=f.superstate()))a?e.unshift(f):g===this&&e.unshift(f),f=g}for(h in b)d.hasOwn.call(b,h)&&(e.push(b[h]),a&&(e=e.concat(b[h].substates(!0))));return e}},addSubstate:function(a,b){return function(c,d){var e,f;return~a&i&&"catch!",d instanceof C&&d.isVirtual()&&d.superstate()===this&&d.protostate().superstate().isProtostateOf(this)&&"catch!",a&h?this.realize().addSubstate(c,d):a&w?null:((e=b[c])&&e.destroy(),e=d instanceof C?d.superstate()===this&&d.realize():new C(this,c,d),e?(this[c]=b[c]=e,f=this.controller(),f.root()===this&&(f[c]=e),e):null)}},removeSubstate:function(a,b){return function(a){var c,d,e,f=b[a];if(!f)return;return c=this.controller(),d=c.current(),e=c.transition(),e&&(f.isSuperstateOf(e)||f===e.origin()||f===e.target())?!1:(d.isIn(f)&&c.change(this,{forced:!0}),delete b[a],delete this[a],c.root()===this&&delete c[a],f)}}}),d.privilege(C.prototype,C.privileged,{"substate substates":[null]}),d.assign(C.prototype,{"addSubstate removeSubstate":d.noop}),d.assign(C.privileged,{transition:function(a){return function(b){return a[b]}},transitions:function(a){return function(){return d.clone(a)}},addTransition:function(a){return function(b,c){return c instanceof u||(c=u(c)),a[b]=c}},removeTransition:d.noop}),d.assign(C.prototype,{"transition addTransition removeTransition":d.noop,transitions:function(){return{}}}),d.assign(C.privileged,{history:function(b){return function(c){return c===a?b.express():b[b.index+c]}},push:function(a){return function(b){var c,e,f;b==="string"&&(b=this.query(b,!0,!1)),b instanceof C&&b.isIn(this)?a.pushState(c=b):d.isPlainObject(b)&&a.pushMutation(e=b);if(c&&this.isActive()||e)f=this.superstate(),f&&(f=f.historian()),f&&f.push(b)}},old_push:function(b){return function(c,e,f,g){var h,i,j,k;typeof c!="string"&&(g=f,f=e,e=c,c=a);if(!(e instanceof C&&this.has(e)))return;return c=d.assign(c),h=b.index,i=h===a?null:b[h],h=b.index=h===a?0:h+1,j=b[h]={state:e.toString(),transition:a,data:a},c.relative?i?(j.data=i.data,i.data=d.delta(j.data,g)):j.data=d.clone(g):(j.data=d.clone(g),i&&(i.data=d.diff(i.data,g))),b.splice(++h,b.length-h),this.isActive()&&(k=this.superstate())&&(k=k.historian())&&k.push(e,f,c,g),1,b.length}},replace:function(a){return function(){item==="string"&&(item=this.query(item));if(!item)return;if(item instanceof C)return a.replaceState(item);if(d.isPlainObject(item))return a.replaceMutation(item)}},old_replace:function(b){return function(c,e,f){var g,h,i,j,k=b.index,l=b.length;if(k===a)return this.push.apply(this,arguments),this;typeof c!="string"&&(f=e,e=c,c=a);if(!e.isIn(this))return;return c=d.assign(c),h=b[k],k>0&&(g=b[k-1]),k<l-1&&(i=b[k+1]),h.state=e.toString(),j=(c.relative?d.delta:d.diff)(h.data,f),d.isEmpty(j)||(g&&d.edit(!0,g.data,j),i&&d.edit(!0,i.data,j)),h.data=d.clone(f),0,this}}}),d.assign(C.prototype,{history:function(){var a=this.historian();if(a)return a.history()},historian:function(){if(this.hasHistory())return this;for(var a=this.superstate();a;a=a.superstate())if(a.hasHistory()&&!a.isShallow())return a},push:function(b,c,d,e){typeof b!="string"&&(e=d,d=c,c=b,b=a);var f=this.historian();if(f){c instanceof C||(c=this.query(c));if(c&&c.isIn(this))return f.push(b,c,d,e)}},replace:function(a,b,c,d){var e=this.historian();if(e){b instanceof C||(b=this.query(b));if(b&&b.isIn(this))return e.push(a,b,c,d)}},pushHistory:b.history&&b.history.pushState?function(a,c){return b.history.pushState(this.data,a||this.toString(),c+"/"+this.derivation(!0).join("/"))}:d.noop,replaceHistory:b.history&&b.history.replaceState?function(a,c){return b.history.replaceState(this.data,a||this.toString(),c+"/"+this.derivation(!0).join("/"))}:d.noop}),C}(),p=function(){function n(b,c){if(this instanceof n)typeof b=="string"?c||(c={}):c||(c=b,b=a),d.edit("deep all",this,c instanceof n?c:q(c)),b==null?c&&(b=c.attributes):d.isNumber(b)||(b=o(b)),this.attributes=b||f.NORMAL;else return new n(b,c)}function o(a){var c,e=f.NORMAL;typeof a=="string"&&(a=d.assign(a));for(c in a)d.hasOwn.call(a,c)&&c in b&&(e|=f[b[c]]);return e}function p(a){var b,d=[];for(b in c)a&b&&d.push(c[b]);return d.join(" ")}function q(b){var c,f,g,i,j,k=d.assign(h,null);for(c in b)d.hasOwn.call(b,c)&&(f=b[c],f===e&&(f=new n),i=f instanceof n&&"states"||f instanceof u&&"transitions",i?(j=k[i],j||(j=k[i]={}),j[c]=f):c in k&&f?k[c]=d.clone(k[c],f):(i=c in l||typeof f=="string"?"events":c in m?"guards":d.isPlainObject(f)?"states":d.isFunction(f)?"methods":a,i&&(j=k[i],j||(j=k[i]={}),j[c]=f)));g=k.events;for(c in g)if(d.hasOwn.call(g,c)){f=g[c];if(typeof f=="function"||typeof f=="string")g[c]=[f]}g=k.guards;for(c in g)d.hasOwn.call(g,c)&&(f=g[c],d.isPlainObject(f)||(g[c]={"*":f}));g=k.transitions;for(c in g)d.hasOwn.call(g,c)&&(f=g[c],f instanceof u||(g[c]=new u(f)));g=k.states;for(c in g)d.hasOwn.call(g,c)&&(f=g[c],f instanceof n||(g[c]=new n(f)));return k}var b=d.forEach(d.assign(g),function(a,b,c){c[b]=b.toUpperCase()}),c=d.forEach(d.invert(f),function(a,b,c){c[b]=a.toLowerCase()}),k=d.assign(h),l=d.assign(i),m=d.assign(j);return n.encodeAttributes=o,n.decodeAttributes=p,n}(),q=function(){function b(f,g,h){function q(a){return l=a}function r(a){return m=a}if(!(this instanceof b))return new b(f,g,h);var i=this,j,k,l,m,n;f||(f={}),g instanceof p||(g=new p(g)),h===a&&(h={})||typeof h=="string"&&(h={initialState:h}),j=h.name||"state",f[j]=c(f,j,this),d.assign(this,{owner:d.thunk(f),name:d.stringFunction(function(){return j}),current:d.assign(function(){return l},{toString:function(){if(l)return l.toString()}}),change:b.privileged.change(q,r),transition:d.assign(function(){return m},{toString:function(){if(m)return m.toString()}}),destroy:function(){var a;return delete this.destroy,m&&m.abort(),k.destroy(),a=delete f[j],f=i=k=l=m=null,a}}),k=new o(this,"",g),l=k.initialSubstate()||k,h.initialState!==a&&(l=k.query(h.initialState)),l.isAbstract()&&(n=l.defaultSubstate(),n&&(l=n)),l.controller()!==this&&(l=e.call(this,l)),d.env.debug&&d.assign(this.__private__={},{root:k,owner:f,options:h})}function c(a,c,e){function f(){var f,g;if(this===a)return d.isFunction(f=arguments[0])?e.change(f.call(this)):(g=e.current(),arguments.length?g.query.apply(g,arguments):g);if(Object.prototype.isPrototypeOf.call(a,this)&&!d.hasOwn.call(this,c))return new b(this,null,{name:c,initialState:e.current().toString()}),this[c].apply(this,arguments)}return d.env.debug&&(f.toString=function(){return"[accessor] -> "+e.current().toString()}),f}function e(a){function g(){return d=c.substate(e=b.shift(),!1),d}var b,c,d,e;if(a instanceof o&&a.owner().isPrototypeOf(this.owner())&&(b=a.derivation(!0)).length){c=this.root(),g();while(d)c=d,g();while(e)c=new o(c,e,{attributes:f.VIRTUAL}),e=b.shift();return c}}function g(a,b){var c,e,f,g,h,i,j,k=!0;typeof a=="string"&&(a=this.guard(a));if(!a)return!0;for(c in a)if(d.hasOwn.call(a,c)){e=a[c],f=typeof e=="function",f&&(g||(g=d.slice.call(arguments,1))),h=d.trim(c).split(/\s*,+\s*/);for(i=0,j=h.length;i<j;i++)if(this.query(h[i],b)){k=f?!!e.apply(this,g):!!e;break}if(!k)break}return k}return b.privileged={change:function(a,b){var c={};return function(f,h){var i,j,k,l,m,n,p,q,r,s,u=this;i=this.owner(),j=this.transition(),m=j?j.origin():this.current();if(m.isFinal())return null;d.isNumber(f)&&f,f instanceof o||(f=f?m.query(f):this.root());if(!f||(k=f.owner())!==i&&!k.isPrototypeOf(i))return null;h?d.isArray(h)&&(h={arguments:h}):h=c,!h.direct&&f.isRetained()&&!f.isActive()&&(q=f.history(0),f=q!=null&&f.query(q)||f);while(f.isAbstract()){f=f.defaultSubstate();if(!f)return null}if(!h.forced&&(!g.call(m,"release",f)||!g.call(f,"admit",m)))return typeof h.failure=="function"&&h.failure.call(this),null;f&&f.controller()!==this&&(f=e.call(this,f)),l=this.current(),n=l.common(f),q=l;while(q!==n){if(q.isConclusive())return null;q=q.superstate()}j&&j.abort(),s=this.getTransitionExpressionFor(f,m),j=b(new t(f,l,s)),p={transition:j,forced:!!h.forced},l.emit("depart",p,!1),a(j),j.emit("enter",!1);for(q=l;q!==n;)q.emit("exit",p,!1),j.attachTo(q=q.superstate());return j.setCallback(function(){var c=[],d,e,g;for(d=f;d!==n;d=d.superstate())c.push(d);for(d=n;e=c.pop();d=e)d.isShallow()&&d.hasHistory()&&d.push(e),j.attachTo(e),e.emit("enter",p,!1);j.emit("exit",!1),a(f),f.emit("arrive",p,!1);for(d=f;d;d=g)g=d.superstate(),!d.isShallow()&&d.hasHistory()&&d.push(f);for(d=m;d.isVirtual();d=g)g=d.superstate(),d.destroy();return j.destroy(),j=b(null),typeof h.success=="function"&&h.success.call(this),f}),j.start.apply(j,h.arguments)||f}}},d.assign(b.prototype,{toString:function(){return this.current().toString()},getTransitionExpressionFor:function(a,b){function c(c,e){var f,h,i,j,k,l;for(;c&&c!==e;c=e?c.superstate():null){f=c.transitions();for(h in f)if(d.hasOwn.call(f,h)){i=f[h];if((!(j=i.guards)||(!(k=j.admit)||d.isEmpty(k)||g.call(b,k,a,b))&&(!(l=j.release)||d.isEmpty(l)||g.call(a,l,b,a)))&&(i.target?c.query(i.target,a):c===a)&&(!i.origin||c.query(i.origin,b)))return i}}}return b||(b=this.current()),c(a)||b!==a&&c(b)||c(a.superstate(),this.root())||c(this.root())||!a.isIn(b)&&c(b.superstate(),b.common(a))||new u}}),b}(),r=function(){function b(a,b){this.state=a,this.type=b,this.items={},this.length=0}var a=0;return d.assign(b.prototype,{guid:function(){return(a+=1).toString()},get:function(a){return this.items[a]},getAll:function(){var a,b=this.items,c=[];for(a in b)d.hasOwn.call(b,a)&&c.push(b[a]);return c},set:function(a,b){var c=this.items;return d.hasOwn.call(c,a)||this.length++,c[a]=b,a},key:function(a){var b,c=this.items;for(b in c)if(d.hasOwn.call(c,b)&&c[b]===a)return b},keys:function(){var a,b=this.items,c=[];c.toString=function(){return"["+c.join()+"]"};for(a in b)d.hasOwn.call(b,a)&&c.push(b[a]);return c},"add on bind":function(a,b){var c=this.guid();return this.items[c]=typeof b=="object"?[a,b]:a,this.length++,c},"remove off unbind":function(a){var b,c,d,e=this.items;return b=e[typeof a=="function"?this.key(a):a],b?(delete e[a],this.length--,b):!1},empty:function(){var a=this.length,b,c;if(a===0)return 0;b=this.items;for(c in b)d.hasOwn.call(b,c)&&delete b[c];return this.length=0,a},"emit trigger":function(a,b){var c,e,f,g,h,i,j=this.items,k=this.type;b||(b=this.state);for(c in j)if(d.hasOwn.call(j,c)){e=j[c],f=d.type(e);if(f==="function")g=e,h=b;else if(f==="array")g=e[0],h=e[1];else if(f==="string"||e instanceof o){i=e;continue}g.apply(h,a),g=h=null}i&&b.change(i)},destroy:function(){return this.empty(),delete this.state,delete this.items,!0}}),b}(),s=function(){function c(a,b,c,d){var e,f;c||(c=0),d||(d=a.length-1);while(c<=d){e=(c+d)/2<<0,f=a[e];if(b<f)d=e-1;else if(b>f)c=e+1;else return e}}function e(b){this.state=b,this.elements={},this.indices=[],this.index=a,this.isShallow=b.isShallow(),(this.stateIsImmutable=b.isImmutable())||(this.stateIndices=[],this.stateIndex=a,this.mutationOffset=0)}var b=0;return d.assign(e.prototype,{superhistory:function(){var a=this.state.superstate();if(a)return a.historian()},root:function(){var a=this.superhistory();if(a)return a.root()||a},createElement:function(a){this.elements[b+=1]=a},indexOf:function(){return function(a){return search(this.indices,a)}},traverseToElement:function(a){var b=search(this.indices,a);if(b)return this.traverseToIndex(b)},traverseToIndex:function(a){},traverseBy:function(b,c,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;typeof b=="string",typeof c=="boolean"&&(e=c,c=0),c==null&&(c=0),f=this.elements,g=this.indices,h=this.index;if(h===a)return;i=g.length,e===a&&(e=!0);if(this.stateIsImmutable){n=h+b,n>=i?n=i-1:n<0&&(n=0),b=n-h,p=b<0?-1:1;if(e)this.index=n,this.changeState(g[n]);else while(h!==n)this.index=h+=p,this.changeState(g[h])}else{j=this.stateIndices,k=j.length,l=this.stateIndex,m=this.mutationOffset,o=l+b,o>=k?o=k-1:o<0&&(o=0),n=j[o],b=o-l,p=b<0?-1:1,q=this.state.express();while(h!==n||c){r=j[l+1]-h-1,p<0?m||(m=r):m+=1;while(0<m&&m<=r){if(h===n){if(c===0)break;c--}s=h+m,t=g[s],g[s]=d.delta(q,t),u=d.clone(u,t),m+=p}m=0,h=j[l+=p],e||(u&&(this.mutateState(u),u=null),this.index=h,this.changeState(g[h]))}e&&(u&&this.mutateState(u),this.changeState(g[n])),this.mutationOffset=0}},changeState:function(a){var b;return this.traverse=d.noop,b=this.state.change(a),delete this.traverse,b},mutateState:function(a){this.state.mutate(a)},pushState:function(a){var b=this.elements,c=this.indices,d=this.index+this.mutationOffset+1;c.splice(d,c.length-d),this.index=d,this.mutationOffset=0,a instanceof o||(a=this.state.query(a)),c[d]=a.toString()},replaceState:function(a){var b=this.indices,c=this.index},pushMutation:function(a){},replaceMutation:function(a){},previousStateIndex:function(){return this.stateIndices?this.stateIndices[this.stateIndex-1]:this.index-1},nextStateIndex:function(){return this.stateIndices?this.stateIndices[this.stateIndex+1]:this.index+1},currentState:function(){var a=this.indices[this.index];return this.state.query(a)||a},previousState:function(){var a=this.indices[this.previousStateIndex()];return this.state.query(a)||a},nextState:function(){var a=this.indices[this.nextStateIndex()];return this.state.query(a)||a},destroy:function(){this.state=this.indices=null}}),e}(),t=function(){function b(c,e,f,g){if(!(this instanceof b))return u.apply(this,arguments);var h=this,i={},j={},k={},l=f.action,m=e,n,p;n=e.controller(),n!==c.controller()&&(n=a),d.env.debug&&d.assign(this.__private__={},{methods:i,events:j,guards:k,action:l}),d.assign(this,{superstate:function(){return m},attachTo:function(a){return m=a},controller:function(){return n},origin:function(){return e instanceof b?e.origin():e},source:function(){return e},target:function(){return c},setCallback:function(a){return g=a},aborted:function(){return p},start:function(){return p=!1,this.emit("start",arguments,!1),l&&d.isFunction(l)?(l.apply(this,arguments),this):this.end.apply(this,arguments)},abort:function(){return p=!0,g=null,this.emit("abort",arguments,!1),this},end:function(){return p||(this.emit("end",arguments,!1),g&&g.apply(n,arguments)),this.destroy(),c},destroy:function(){e instanceof b&&e.destroy(),c=m=n=null}}),d.privilege(this,o.privileged,{"express mutate":[u,a,null,i,j,k],"method methodNames addMethod removeMethod":[i],"event addEvent removeEvent emit":[j],"guard addGuard removeGuard":[k]}),d.alias(this,{addEvent:"on bind",removeEvent:"off unbind",emit:"trigger"}),o.privileged.init(u).call(this,f)}return d.inherit(b,o),b.prototype.depth=function(){var a=this.source(),c=0;while(a instanceof b)c++,a=a.source();return c},b}(),u=function(){function g(a){if(this instanceof g)d.edit("deep all",this,a instanceof g?a:h(a));else return new g(a)}function h(g){var h,i,j,k,l,m=d.assign({},b,c);for(h in g)d.hasOwn.call(g,h)&&(i=g[h],h in b?m[h]=i:h in c?m[h]=d.clone(m[h],i):(j=h in e?"events":h in f?"guards":d.isFunction(i)?"methods":a,j&&(l=m[j],l||(l=m[j]={}),l[h]=i)));for(h in k=m.events)i=k[h],d.isFunction(i)&&(k[h]=[i]);return m}var b=d.assign(k,null),c=d.assign(l,null),e=d.assign(m),f=d.assign(j);return g}();d.assign(e,{State:o,StateExpression:p,StateController:q,StateEventCollection:r,Transition:t,TransitionExpression:u})}).call(this);