(function(a){function g(b,c,d,e){return arguments.length<2?(typeof b=="string"?c=b:d=b,b=a):(typeof b=="string"&&(e=d,d=c,c=b,b=a),typeof c!="string"&&(e=d,d=c,c=a)),d=new r(c,d),b?(new s(b,d,e)).current():d}"use strict";var b=this,c={VERSION:"0.0.4",noConflict:function(){var a=b.state;return function(){return b.state=a,this}}(),options:{memoizeProtostates:!0}},d=typeof require!="undefined"?require("zcore"):b.Z,e=/^\s*([\-|=]>)\s*(.*)/,f={"->":"change","=>":"changeTo"};d.assign(g,c);var h={NORMAL:0,VIRTUAL:1,MUTABLE:2,FINITE:4,STATIC:8,IMMUTABLE:16,INITIAL:32,CONCLUSIVE:64,FINAL:128,ABSTRACT:256,DEFAULT:512,REFLECTIVE:1024,HISTORY:2048,RETAINED:4096,SHALLOW:8192,VERSIONED:a,CONCURRENT:16384},i=["mutable finite static immutable","initial conclusive final","abstract default","reflective","history retained shallow versioned","concurrent"].join(" "),j="data methods events guards states transitions",k="construct depart exit enter arrive destroy mutate noSuchMethod",l="admit release",m="origin source target action conjugate",n="methods events guards",o="construct destroy enter exit start end abort";d.env.server&&(module.exports=exports=g),d.env.client&&(b.state=g);var p=d.env.server?module:{exports:g},q=function(){function F(b,c,e){if(!(this instanceof F))return new F(b,c,e);var f,g,h,m,o;f=e&&e.attributes||i,this.name=d.stringFunction(function(){return c||""}),b instanceof s?(g=b,b=a,g.root=d.thunk(this),this.controller=d.thunk(g)):b&&(this.superstate=G.superstate(b),h=b.attributes(),f|=h&(k|l));if(m=this.protostate())o=m.attributes(),f|=o&E;f|=(h|o)&n,f&n&&(f&=~k,f|=l),f&j?(this.attributes=G.attributes(f),this.realize=G.realize(f),f&k&&d.assign(this,I)):H.call(this,b,f,e),d.env.debug&&(this[" <owner>"]=this.owner(),this[" <path>"]=this.derivation(!0).join("."),this["<attr>"]=r.decodeAttributes(f))}function H(a,b,c){var e,f,g,h,i=this,j={},m={},n={},o={},q={},s={},t=b&A||b&B?new u(this):null;d.privilege(this,G,{"peek express mutate":[r,b,j,m,n,o,q,s,t],superstate:[a],attributes:[b],data:[b|k,j],"method methodNames addMethod removeMethod":[m],"event addEvent removeEvent emit":[n],"guard addGuard removeGuard":[o],"substate substates addSubstate removeSubstate":[b,q],"transition transitions addTransition removeTransition":[s],destroy:[function(b){return a=b},m,n,q]}),t&&d.privilege(this,G,{"history push replace":[t]}),d.alias(this,{addEvent:"on bind",removeEvent:"off unbind",emit:"trigger"}),G.init(r).call(this,c);if(!a&&(e=this.owner())){f=this.addMethod,f||(f=G.addMethod(m));for(g in e)d.hasOwn.call(e,g)&&(h=e[g],d.isFunction(h)&&!h.isDelegator&&this.method(g,!1)&&f.call(this,g,h))}~b&k&&(d.forEach("mutate addMethod removeMethod addGuard removeGuard             addTransition removeTransition".split(/\s+/),function(a){delete i[a]}),this.data=F.privileged.data(b,j));if(~b&k||b&l)delete this.addSubstate,delete this.removeSubstate;return~b&k&&b&l&&(this.mutate=G.mutate(r,b,j,m,n,o,null,s)),d.env.debug&&d.assign(this,{__private__:this.peek(p)}),this}function J(){}var g=h,i=g.NORMAL,j=g.VIRTUAL,k=g.MUTABLE,l=g.FINITE,m=g.STATIC,n=g.IMMUTABLE,o=g.INITIAL,q=g.CONCLUSIVE,v=g.FINAL,x=g.ABSTRACT,y=g.DEFAULT,z=g.REFLECTIVE,A=g.HISTORY,B=g.RETAINED,C=g.SHALLOW,D=g.CONCURRENT,E=k|l|m|n|o|q|v|x|y|z|A|B|C|D;d.assign(F,g),F.prototype.name=d.noop;var G=F.privileged={};d.assign(F.privileged,{init:function(a){return function(a){return this.__initializing__=!0,this.mutate(a),delete this.__initializing__,this.emit("construct",a,!1),this}},destroy:function(b,c,e,f){return function(){var g=this.superstate(),h=this.controller(),i=h.owner(),j=h.transition(),k,l,m,n,o,q,r;if(j){k=j.origin(),l=j.target();if(k.isIn(this)||l.isIn(this))return!1}for(r in f)d.hasOwn.call(f,r)&&f[r].destroy();this.emit("destroy",!1);for(m in e)e[m].destroy(),delete e[m];if(g)g.isMutable()?g.removeSubstate(this.name()):G.removeSubstate(g.peek(p,"attributes"),g.peek(p,"substates")).call(g,this.name());else{for(n in c)o=i[n],q=o.original,q?(delete o.original,i[n]=q):delete i[n];h.destroy&&h.destroy()}return b(a),this.destroyed=!0}}}),F.prototype.destroy=d.thunk(!1),F.privileged.peek=function(a,b,c,e,f,g,h,i,j){var k={expressionConstructor:a,attributes:b,data:c,methods:e,events:f,guards:g,substates:h,transitions:i,history:j};return function(a,b){if(a!==p)throw ReferenceError;return b?k[b]:d.clone(k)}},F.prototype.peek=d.noop;var I=function(){var a={},b="addMethod addEvent addGuard addSubstate addTransition";return d.forEach(b.split(" "),function(b){function c(){var a=this.realize()[b];if(a!==c)return a.apply(this,arguments)}a[b]=c}),a}();return F.privileged.realize=function(a){return function(b){var c=this.superstate(),e=d.hasOwn.call(c,"addSubstate")?c.addSubstate:G.addSubstate(c.peek(p,"attributes"),c.peek(p,"substates"));return delete this.realize,e.call(c,this.name(),this)&&H.call(this,c,a&~j,b),this}},F.prototype.realize=d.getThis,F.privileged.express=function(){function b(b){if(b===a)return;var c=null,e,f;for(e in b)f=b[e],(c||(c={}))[e]=f&&typeof f=="object"?d.clone(b[e]):f;return c}function c(b){if(b===a)return;var c=null,e,f;for(e in b)if(f=b[e])(c||(c={}))[e]=d.clone(f.items);return c}function e(b,c){if(b===a)return;var e=null;return d.forEach(b,function(a,b){(e||(e={}))[b]=a.express(c)}),e}return function(a,f,g,h,i,j,k,l){return function(m){var n={};return d.edit(n,{attributes:f,data:b(g),methods:b(h),events:c(i),guards:b(j),states:e(k,m),transitions:b(l)}),m?new a(n):n}}}(),F.prototype.express=d.noop,F.privileged.mutate=function(a,b,c,e,f,g,h,i){return function(b){b instanceof a||(b=new a(b));var j=this,k=d.NIL,l,m,n,o,p,q,r,s;this.__initializing__||(l=this.express()),this.__atomic__=!0,c&&b.data&&this.data(b.data),m=e&&b.methods;for(n in m)d.hasOwn.call(m,n)&&(o=m[n],o!==k?this.addMethod(n,o):this.removeMethod(n));f&&b.events&&d.forEach(b.events,function(a,b){var c,e,g,h,i,l=f[b];if(a===k)return l&&l.empty();!l&&a&&!d.isEmpty(a)&&(l=f[b]=new t(j,b)),c=l.items,e=function(a){var b,e;for(b in a)d.hasOwn.call(a,b)&&(e=a[b],e===k?l.remove(b):e&&e!==c[b]&&l.set(b,e))};if(d.isArray(a)){g=function(a){return j.addEvent(b,a)};for(h=0,i=a.length;h<i;h++){o=a[h];if(o==null||o===k)continue;(d.isPlainObject(o)?e:g)(o)}}else d.isPlainObject(a)&&e(a);l.length||l.destroy()&&delete f[b]}),g&&b.guards&&d.edit("deep",g,b.guards),m=h&&b.states;for(n in m)d.hasOwn.call(m,n)&&(o=m[n],n in h?o===k?h[n].destroy():h[n].mutate(o,!1):this.addSubstate(n,o));m=i&&b.transitions;for(n in m)d.hasOwn.call(m,n)&&(o=m[n],n in i?o===k?delete i[n]:i[n]=new w(o):this.addTransition(n,o));return delete this.__atomic__,l&&(p=this.express(),q=d.diff(l,p),d.isEmpty(q)||this.emit("mutate",[b,q,l,p],!1)),this}},F.prototype.mutate=function(a){var b,c,e=d.NIL,f=this.substates(),g=a.states;for(b in g)d.hasOwn.call(g,b)&&(c=g[b],b in f?c!==e&&f[b].mutate(c,!1):this.addSubstate(b,c))},F.privileged.attributes=function(a){return function(){return a}},d.assign(F.prototype,{attributes:d.thunk(i),isVirtual:function(){return!!(this.attributes()&j)},isMutable:function(){return!!(this.attributes()&k)},isFinite:function(){return!!(this.attributes()&l)},isStatic:function(){return!!(this.attributes()&m)},isImmutable:function(){return!!(this.attributes()&n)},isInitial:function(){return!!(this.attributes()&o)},isConclusive:function(){return!!(this.attributes()&q)},isFinal:function(){return!!(this.attributes()&v)},isAbstract:function(){return!!(this.attributes()&x)},isDefault:function(){return!!(this.attributes()&y)},isReflective:function(){return!!(this.attributes()&z)},hasHistory:function(){return!!(this.attributes()&A)},isRetained:function(){return!!(this.attributes()&B)},isShallow:function(){return!!(this.attributes()&C)},isConcurrent:function(){return!!(this.attributes()&D)}}),d.assign(F.privileged,{superstate:function(b){return function(c){return c===a?b:b?c?b.name()===c?b:b.superstate(c):this.controller().root():a}}}),d.assign(F.prototype,{owner:function(){var a=this.controller();if(a)return a.owner()},controller:function(){var a=this.superstate();if(a)return a.controller()},root:function(){var a=this.controller();if(a)return a.root()},superstate:d.noop,derivation:function(a){var b=[],c,d=this;while((c=d)&&(d=c.superstate()))b.unshift(a?c.name()||"":c);return b},"path toString":function(){return this.derivation(!0).join(".")},depth:function(){var a=0,b=this;while(b=b.superstate())a++;return a},common:function(a){var b;a instanceof F||(a=this.query(a)),this.depth()>a.depth()?(b=a,a=this):b=this;while(b){if(b===a||b.isSuperstateOf(a))return b;b=b.superstate()}},is:function(a){return a instanceof F||(a=this.query(a)),a===this},isIn:function(a){return a instanceof F||(a=this.query(a)),a===this||a.isSuperstateOf(this)},has:function(a){return a instanceof F||(a=this.query(a)),this===a||this.isSuperstateOf(a)},isSuperstateOf:function(a){var b;return a instanceof F||(a=this.query(a)),(b=a.superstate())?this===b||this.isSuperstateOf(b):!1},protostate:function(){var a;return c.options.memoizeProtostates&&(a=function(a){return function(){return a.destroyed?(delete this.protostate,this.protostate()):a}}),function(){var b=this.derivation(!0),c=this.controller(),e,f,g,h,i,j;if(!c)return;e=c.name(),f=c.owner(),g=function(){var a,b;return(f=d.getPrototypeOf(f))&&d.isFunction(a=f[e])&&(b=a.apply(f))instanceof F&&b.root()};while(h=g()){for(i=0,j=b.length;i<j;i++){h=h.substate(b[i],!1);if(!h)break}if(h)return a&&(this.protostate=a(h)),h}}}(),isProtostateOf:function(a){var b;return a instanceof F||(a=this.query(a)),(b=a.protostate())?this===b||this.isProtostateOf(b):!1},defaultSubstate:function(b,c){var d=this.substates(),e=0,f=d&&d.length,g;c||f&&(c=d[0]);for(;e<f;e++)if(d[e].isDefault())return d[e];if(b||b===a){g=this.protostate();if(g)return g.defaultSubstate(!0,c)}return c},initialSubstate:function(b){var c=[this],d,e,f,g,h,i;while(d=c.shift()){e=d.substates(!1,!0);for(f=0,g=e.length;f<g;f++){h=e[f];if(h.isInitial())return h.initialSubstate(!1)||h;c.push(h)}}if(b||b===a){i=this.protostate();if(i)return i.initialSubstate(!0)}}}),d.assign(F.prototype,{current:function(){var a=this.controller();if(a)return this.controller().current()},isCurrent:function(){return this.current()===this},isActive:function(){var a=this.current();return a===this||this.isSuperstateOf(a)},"change go be":function(a,b){var c=this.controller();return arguments.length?(d.isNumber(a)&&(a=this.history(a)),c.change.apply(c,a instanceof F||typeof a=="string"?arguments:[this].concat(arguments))):c.change(this)},"changeTo goTo":function(b,c){return b===a&&(b=this),c?c.direct=!0:c={direct:!0},this.change(b,c)}}),d.assign(F.prototype,{"query match":function(b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s;typeof c=="boolean"&&(e=d,d=c,c=a),d===a&&(d=!0),e===a&&(e=!0),f===a&&(f=!0);if(b==null)return c!==a?!1:null;if(b===".")return c!==a?c===this:this;if(b==="")return c!==a?c===this.root():this.root();if(c&&c===this.root()&&b.search(/^\*+$/)===0)return!0;b.search(/^\.*\**$/)===0&&(d=e=!1);if(b.charAt(0)!==".")return this.root().query("."+b,c,d,!1);b=b.replace(/^(\.+)\.$/,"$1"),g=b.split(".");for(k=1,l=g.length,h=this;h;k++){if(k>=l)return c?c===h:h;m=g[k];if(m==="*"){if(!c)return h.substates();if(h===c.superstate())return!0;break}if(m==="**"){if(!c)return h.substates(!0);if(h.isSuperstateOf(c))return!0;break}if(m==="")h=h.superstate();else if(i=h.substate(m))h=i;else break}if(d){n=[this];while(o=n.shift()){p=o.substates(!1,!0);for(k=0,l=p.length;k<l;k++){q=p[k];if(q===d)continue;j=q.query(b,c,!1,!1,!1);if(j)return j;n.push(q)}}}if(e&&(r=this.superstate())){j=r.query(b,c,d&&this,!0,!1);if(j)return j}if(f&&(s=this.protostate())){j=s.query(b,c,d,e,!0);if(j)return j}return c?!1:null},$:function(a){var b,c,g;if(typeof a!="function")return typeof a=="string"&&(c=a.match(e))&&(g=f[c[1]])?arguments.length>1?this[g].apply(this,[c[2]].concat(d.slice.call(arguments,1))):this[g](c[2]):this.query.apply(this,arguments);b=d.slice.call(arguments),b[0]=a=a();if(a)return this.change.apply(this,b)}}),d.assign(F.privileged,{data:function(b,c){return function(e,f){var g,h,i,l,m;return e!=null&&typeof e!="boolean"?(g=e,e=f=!1):(e===a&&(e=!0),f===a&&(f=!0)),g&&b&k&&!d.isEmpty(g)?b&j?this.realize().data(g):(h=d.delta(c,g),!this.__atomic__&&h&&!d.isEmpty(h)&&(this.push("delta",this,null,h),this.emit("mutate",[g,h],!1)),this):d.clone(e&&(l=this.superstate())&&l.data(),f&&(m=this.protostate())&&m.data(!1),c)}}}),d.assign(F.prototype,{data:F.privileged.data(a,null),reflect:function(){var a=this.owner(),b=this.data(),c,e;if(d.isEmpty(b))return a;for(c in a)d.hasOwn.call(a,c)&&(e=a[c],d.isFunction(e)&&(e.isDelegator||e.isAccessor)&&(b[c]=e));return d.edit("absolute delta",a,b)},soak:function(){var a,b,c,e,f;if(!this.isMutable())return;a=this.owner(),b={};for(e in a)if(d.hasOwn.call(a,e)){f=a[e];if(!d.isFunction(f)||!f.isDelegator&&!f.isAccessor)b[e]=f}return c=d.diff(b,this.data()),d.edit("deep",c,c),this.data(c),c}}),d.assign(F.privileged,{method:function(b){return function(c,d,e,f){var g,h,i;d===a&&(d=!0),e===a&&(e=!0),b&&(i=b[c]);if(i&&i!==J)return f&&(f.context=this,f.method=i),i;if(e){h=this.protostate();if(h){i=h.method(c,!1,!0,f);if(i)return f&&(f.context=this),i}}if(d){g=this.superstate();if(g){i=g.method(c,!0,e,f);if(i)return i}}return f&&(f.context=null,f.method=i),i}},methodNames:function(a){return function(){return d.keys(a)}},addMethod:function(b){function c(a,b,c){function e(){return this[a]().apply(b,arguments)}return e.isDelegator=!0,d.env.debug&&(e.toString=function(){return"[delegator]"}),c&&(e.original=c),e}return function(d,e){var f=this.controller(),g=f.name(),h=f.root(),i=f.owner(),j;if(!this.method(d,!0,!1)){if(this!==h&&!h.method(d,!1,!1)){j=i[d];if(j===a||j.isDelegator)j=J;h.addMethod(d,j)}i[d]=c(g,d,j)}return b[d]=e}},removeMethod:function(a){return function(b){var c=a[b];return delete a[b],c}}}),d.assign(F.prototype,{method:F.privileged.method(null),methodNames:function(){return[]},"addMethod removeMethod":d.noop,hasMethod:function(a){var b=this.method(a);return b&&b!==J},hasOwnMethod:function(a){return!!this.method(a,!1,!1)},apply:function(b,c){var d,e,f,g,h;d={method:a,context:a},e=this.method(b,!0,!0,d);if(!e){this.emit("noSuchMethod",[b,c]),this.emit("noSuchMethod:"+b,c);return}return f=d.context,g=this.owner(),h=g[b],h&&h.original&&f===this.root()&&(f=g),e.apply(f,c)},call:function(a){return this.apply(a,d.slice.call(arguments,1))}}),d.assign(F.privileged,{event:function(b){return function(c,d){var e=b[c];if(e==null)return;return d===a?e.length:(typeof d=="function"&&(d=e.key(d)),e.get(d))}},addEvent:function(a){return function(b,c,e){return d.hasOwn.call(a,b)||(a[b]=new t(this,b)),a[b].add(c,e)}},removeEvent:function(a){return function(b,c){return a[b].remove(c)}},emit:function(b){return function(c,e,f,g,h){var i,j,k;if(typeof c!="string")return;typeof e=="boolean"&&(h=g,g=f,f=e,e=a),typeof f=="boolean"&&(h=g,g=f,f=a),!e&&(e=[])||d.isArray(e)||(e=[e]),g===a&&(g=!0),h===a&&(h=!0),(i=b[c])&&i.emit(e,f||this),h&&(j=this.protostate())&&j.emit(c,e,f||this,!1),g&&(k=this.superstate())&&k.emit(c,e,f||k)}}}),d.assign(F.prototype,{"event addEvent removeEvent emit trigger":d.noop}),d.assign(F.privileged,{guard:function(b){return function(c){var e,f;return(e=b[c])&&d.clone(e)||(f=this.protostate())&&f.guard(c)||a}},addGuard:function(a){return function(b,c){return d.edit(a[b]||(a[b]={}),c)}},removeGuard:function(b){return function(c){var e,f,g,h,i,j;e=b[c];if(!e)return null;if(arguments.length<2)return delete b[c]?e:a;f=d.flatten(d.slice.call(arguments,1));for(g=0,h=f.length;g<h;g++){i=f[g];if(typeof i=="string"){j=e[i];if(delete e[i])return j}}}}}),d.assign(F.prototype,{"guard addGuard removeGuard":d.noop}),d.assign(F.privileged,{substate:function(b,c){return function(b,d){var e=this.current(),f,g;d===a&&(d=!0);for(;e&&e.isVirtual()&&(f=e.superstate());e=f)if(f===this&&e.name()===b)return e;return c&&c[b]||d&&(g=this.protostate())&&g.substate(b)||a}},substates:function(a,b){return function(a,c){var e=[],f,g,h;if(c){f=this.current();if(f&&f.isVirtual()&&this.isSuperstateOf(f))while(f&&f!==this&&f.isVirtual()&&(g=f.superstate()))a?e.unshift(f):g===this&&e.unshift(f),f=g}for(h in b)d.hasOwn.call(b,h)&&(e.push(b[h]),a&&(e=e.concat(b[h].substates(!0))));return e}},addSubstate:function(a,b){return function(c,d){var e,f;return~a&k&&"catch!",d instanceof F&&d.isVirtual()&&d.superstate()===this&&d.protostate().superstate().isProtostateOf(this)&&"catch!",a&j?this.realize().addSubstate(c,d):((e=b[c])&&e.destroy(),e=d instanceof F?d.superstate()===this&&d.realize():new F(this,c,d),e?(this[c]=b[c]=e,f=this.controller(),f.root()===this&&(f[c]=e),e):null)}},removeSubstate:function(a,b){return function(a){var c,d,e,f=b[a];if(!f)return;return c=this.controller(),d=c.current(),e=c.transition(),e&&(f.isSuperstateOf(e)||f===e.origin()||f===e.target())?!1:(d.isIn(f)&&c.change(this,{forced:!0}),delete b[a],delete this[a],c.root()===this&&delete c[a],f)}}}),d.privilege(F.prototype,F.privileged,{"substate substates":[null]}),d.assign(F.prototype,{"addSubstate removeSubstate":d.noop}),d.assign(F.privileged,{transition:function(a){return function(b){return a[b]}},transitions:function(a){return function(){return d.clone(a)}},addTransition:function(a){return function(b,c){return c instanceof w||(c=new w(c)),a[b]=c}},removeTransition:d.noop}),d.assign(F.prototype,{"transition addTransition removeTransition":d.noop,transitions:function(){return{}}}),d.assign(F.privileged,{history:function(b){return function(c){return c===a?b.express():b[b.index+c]}},push:function(a){return function(b){var c,e,f;b==="string"&&(b=this.query(b,!0,!1)),b instanceof F&&b.isIn(this)?a.pushState(c=b):d.isPlainObject(b)&&a.pushMutation(e=b);if(c&&this.isActive()||e)f=this.superstate(),f&&(f=f.historian()),f&&f.push(b)}},old_push:function(b){return function(c,e,f,g){var h,i,j,k;typeof c!="string"&&(g=f,f=e,e=c,c=a);if(!(e instanceof F&&this.has(e)))return;return c=d.assign(c),h=b.index,i=h===a?null:b[h],h=b.index=h===a?0:h+1,j=b[h]={state:e.toString(),transition:a,data:a},c.relative?i?(j.data=i.data,i.data=d.delta(j.data,g)):j.data=d.clone(g):(j.data=d.clone(g),i&&(i.data=d.diff(i.data,g))),b.splice(++h,b.length-h),this.isActive()&&(k=this.superstate())&&(k=k.historian())&&k.push(e,f,c,g),1,b.length}},replace:function(a){return function(b){b==="string"&&(b=this.query(b));if(!b)return;if(b instanceof F)return a.replaceState(b);if(d.isPlainObject(b))return a.replaceMutation(b)}},old_replace:function(b){return function(c,e,f){var g,h,i,j,k=b.index,l=b.length;if(k===a)return this.push.apply(this,arguments),this;typeof c!="string"&&(f=e,e=c,c=a);if(!e.isIn(this))return;return c=d.assign(c),h=b[k],k>0&&(g=b[k-1]),k<l-1&&(i=b[k+1]),h.state=e.toString(),j=(c.relative?d.delta:d.diff)(h.data,f),d.isEmpty(j)||(g&&d.edit(!0,g.data,j),i&&d.edit(!0,i.data,j)),h.data=d.clone(f),0,this}}}),d.assign(F.prototype,{history:function(){var a=this.historian();if(a)return a.history()},historian:function(){if(this.hasHistory())return this;for(var a=this.superstate();a;a=a.superstate())if(a.hasHistory()&&!a.isShallow())return a},push:function(b,c,d,e){typeof b!="string"&&(e=d,d=c,c=b,b=a);var f=this.historian();if(f){c instanceof F||(c=this.query(c));if(c&&c.isIn(this))return f.push(b,c,d,e)}},replace:function(a,b,c,d){var e=this.historian();if(e){b instanceof F||(b=this.query(b));if(b&&b.isIn(this))return e.push(a,b,c,d)}},pushHistory:b.history&&b.history.pushState?function(a,c){return b.history.pushState(this.data,a||this.toString(),c+"/"+this.derivation(!0).join("/"))}:d.noop,replaceHistory:b.history&&b.history.replaceState?function(a,c){return b.history.replaceState(this.data,a||this.toString(),c+"/"+this.derivation(!0).join("/"))}:d.noop}),F}(),r=function(){function n(b,c){if(this instanceof n)typeof b=="string"?c||(c={}):c||(c=b,b=a),d.edit("deep all",this,c instanceof n?c:q(c)),b==null?c&&(b=c.attributes):d.isNumber(b)||(b=o(b)),this.attributes=b||h.NORMAL;else return new n(b,c)}function o(a){var c,e=h.NORMAL;typeof a=="string"&&(a=d.assign(a));for(c in a)d.hasOwn.call(a,c)&&c in b&&(e|=h[b[c]]);return e}function p(a){var b,d=[];for(b in c)a&b&&d.push(c[b]);return d.join(" ")}function q(b){var c,e,h,i,k,l=d.assign(j,null);for(c in b)d.hasOwn.call(b,c)&&(e=b[c],e===g&&(e=new n),i=e instanceof n&&"states"||e instanceof w&&"transitions",i?(k=l[i],k||(k=l[i]={}),k[c]=e):c in l&&e?l[c]=d.clone(l[c],e):(i=c in f||typeof e=="string"?"events":c in m?"guards":d.isPlainObject(e)?"states":d.isFunction(e)?"methods":a,i&&(k=l[i],k||(k=l[i]={}),k[c]=e)));h=l.events;for(c in h)if(d.hasOwn.call(h,c)){e=h[c];if(typeof e=="function"||typeof e=="string")h[c]=[e]}h=l.guards;for(c in h)d.hasOwn.call(h,c)&&(e=h[c],d.isPlainObject(e)||(h[c]={"*":e}));h=l.transitions;for(c in h)d.hasOwn.call(h,c)&&(e=h[c],e instanceof w||(h[c]=new w(e)));h=l.states;for(c in h)d.hasOwn.call(h,c)&&(e=h[c],e instanceof n||(h[c]=new n(e)));return l}var b=d.forEach(d.assign(i),function(a,b,c){c[b]=b.toUpperCase()}),c=d.forEach(d.invert(h),function(a,b,c){c[b]=a.toLowerCase()}),e=d.assign(j),f=d.assign(k),m=d.assign(l);return n.encodeAttributes=o,n.decodeAttributes=p,n}(),s=function(){function b(e,f,h){function o(a){return l=a}function p(a){return m=a}if(!(this instanceof b))return new b(e,f,h);var i=this,j,k,l,m,n;e||(e={}),f instanceof r||(f=new r(f)),h===a&&(h={})||typeof h=="string"&&(h={initialState:h}),j=h.name||"state",e[j]=c(e,j,this),d.assign(this,{owner:d.thunk(e),name:d.stringFunction(function(){return j}),current:d.assign(function(){return l},{toString:function(){if(l)return l.toString()}}),change:b.privileged.change(o,p),transition:d.assign(function(){return m},{toString:function(){if(m)return m.toString()}}),destroy:function(){var a;return delete this.destroy,m&&m.abort(),k.destroy(),a=delete e[j],e=i=k=l=m=null,a}}),k=new q(this,"",f),l=k.initialSubstate()||k,h.initialState!==a&&(l=k.query(h.initialState)),l.isAbstract()&&(n=l.defaultSubstate(),n&&(l=n)),l.controller()!==this&&(l=g.call(this,l)),d.env.debug&&d.assign(this.__private__={},{root:k,owner:e,options:h})}function c(a,c,g){function h(h){var i,j,k;if(this===a)return i=g.current(),arguments.length===0?i:typeof h=="function"?i.change(h.call(this)):typeof h=="string"&&(j=h.match(e))&&(k=f[j[1]])?arguments.length>1?i[k].apply(i,[j[2]].concat(d.slice.call(arguments,1))):i[k](j[2]):i.query.apply(i,arguments);if(Object.prototype.isPrototypeOf.call(a,this)&&!d.hasOwn.call(this,c))return new b(this,null,{name:c,initialState:g.current().toString()}),this[c].apply(this,arguments)}return h.isAccessor=!0,d.env.debug&&(h.toString=function(){return"[accessor] -> "+g.current().toString()}),h}function g(a){function f(){return d=c.substate(e=b.shift(),!1),d}var b,c,d,e;if(a instanceof q&&a.owner().isPrototypeOf(this.owner())&&(b=a.derivation(!0)).length){c=this.root(),f();while(d)c=d,f();while(e)c=new q(c,e,{attributes:h.VIRTUAL}),e=b.shift();return c}}function i(a,b){var c,e,f,g,h,i,j,k=!0;typeof a=="string"&&(a=this.guard(a));if(!a)return!0;for(c in a)if(d.hasOwn.call(a,c)){e=a[c],f=typeof e=="function",f&&(g||(g=d.slice.call(arguments,1))),h=d.trim(c).split(/\s*,+\s*/);for(i=0,j=h.length;i<j;i++)if(this.query(h[i],b)){k=f?!!e.apply(this,g):!!e;break}if(!k)break}return k}return b.privileged={change:function(a,b){var c={};return function(e,f){var h,j,k,l,m,n,o,p,r,s=this;h=this.owner(),j=this.transition(),m=j?j.origin():this.current();if(m.isFinal())return null;d.isNumber(e)&&e,e instanceof q||(e=e?m.query(e):this.root());if(!e||(k=e.owner())!==h&&!k.isPrototypeOf(h))return null;f?d.isArray(f)&&(f={args:f}):f=c,!f.direct&&e.isRetained()&&!e.isActive()&&(o=e.history(0),e=o!=null&&e.query(o)||e);while(e.isAbstract()){e=e.defaultSubstate();if(!e)return null}if(!f.forced&&(!i.call(m,"release",e)||!i.call(e,"admit",m)))return typeof f.failure=="function"&&f.failure.call(this),null;e&&e.controller()!==this&&(e=g.call(this,e)),l=this.current(),n=l.common(e),o=l;while(o!==n){if(o.isConclusive())return null;o=o.superstate()}j&&j.abort(),r=this.getTransitionExpressionFor(e,m),j=new v(e,l,r),b(j),l.emit("depart",j,!1),j.wasAborted()&&(j=null),j&&(a(j),j.emit("enter",!1),j.wasAborted()&&(j=null));for(o=l;j&&o!==n;)o.emit("exit",j,!1),j.attachTo(o=o.superstate()),j.wasAborted()&&(j=null);return j&&j.setCallback(function(){var c,d,g,h;j.wasAborted()&&(j=null);if(j)for(c=e,d=[];c!==n;c=c.superstate())d.push(c);for(c=n;j&&(g=d.pop());c=g)c.isShallow()&&c.hasHistory()&&c.push(g),j.attachTo(g),g.emit("enter",j,!1),j.wasAborted()&&(j=null);j&&(j.emit("exit",!1),j.wasAborted()&&(j=null));if(j){a(e),e.emit("arrive",j,!1);for(c=e;c;c=h)h=c.superstate(),!c.isShallow()&&c.hasHistory()&&c.push(e);for(c=m;c.isVirtual();c=h)h=c.superstate(),c.destroy();return j.destroy(),j=b(null),typeof f.success=="function"&&f.success.call(this),e}return null}),j&&j.start.apply(j,f.args)||this.current()}}},d.assign(b.prototype,{toString:function(){return this.current().toString()},getTransitionExpressionFor:function(a,b){function c(c,e){var f,g,h,j,k,l;for(;c&&c!==e;c=e?c.superstate():null){f=c.transitions();for(g in f)if(d.hasOwn.call(f,g)){h=f[g];if((!(j=h.guards)||(!(k=j.admit)||d.isEmpty(k)||i.call(b,k,a,b))&&(!(l=j.release)||d.isEmpty(l)||i.call(a,l,b,a)))&&(h.target?c.query(h.target,a):c===a)&&(!h.origin||c.query(h.origin,b)))return h}}}return b||(b=this.current()),c(a)||b!==a&&c(b)||c(a.superstate(),this.root())||c(this.root())||!a.isIn(b)&&c(b.superstate(),b.common(a))||new w}}),b}(),t=function(){function b(a,b){this.state=a,this.type=b,this.items={},this.length=0}var a=0;return d.assign(b.prototype,{guid:function(){return(a+=1).toString()},get:function(a){return this.items[a]},getAll:function(){var a,b=this.items,c=[];for(a in b)d.hasOwn.call(b,a)&&c.push(b[a]);return c},set:function(a,b){var c=this.items;return d.hasOwn.call(c,a)||this.length++,c[a]=b,a},key:function(a){var b,c=this.items;for(b in c)if(d.hasOwn.call(c,b)&&c[b]===a)return b},keys:function(){var a,b=this.items,c=[];c.toString=function(){return"["+c.join()+"]"};for(a in b)d.hasOwn.call(b,a)&&c.push(b[a]);return c},"add on bind":function(a,b){var c=this.guid();return this.items[c]=typeof b=="object"?[a,b]:a,this.length++,c},"remove off unbind":function(a){var b,c,d,e=this.items;return b=e[typeof a=="function"?this.key(a):a],b?(delete e[a],this.length--,b):!1},empty:function(){var a=this.length,b,c;if(a===0)return 0;b=this.items;for(c in b)d.hasOwn.call(b,c)&&delete b[c];return this.length=0,a},"emit trigger":function(a,b){var c,e,f,g,h,i,j=this.items,k=this.type;b||(b=this.state);for(c in j)if(d.hasOwn.call(j,c)){e=j[c],f=d.type(e);if(f==="function")g=e,h=b;else if(f==="array")g=e[0],h=e[1];else if(f==="string"||e instanceof q){i=e;continue}g.apply(h,a),g=h=null}i&&b.change(i)},destroy:function(){return this.empty(),delete this.state,delete this.items,!0}}),b}(),u=function(){function c(a,b,c,d){var e,f;c||(c=0),d||(d=a.length-1);while(c<=d){e=(c+d)/2<<0,f=a[e];if(b<f)d=e-1;else if(b>f)c=e+1;else return e}}function e(b){this.state=b,this.elements={},this.indices=[],this.index=a,this.isShallow=b.isShallow(),(this.stateIsImmutable=b.isImmutable())||(this.stateIndices=[],this.stateIndex=a,this.mutationOffset=0)}var b=0;return d.assign(e.prototype,{superhistory:function(){var a=this.state.superstate();if(a)return a.historian()},root:function(){var a=this.superhistory();if(a)return a.root()||a},createElement:function(a){this.elements[b+=1]=a},indexOf:function(){return function(a){return c(this.indices,a)}},traverseToElement:function(a){var b=c(this.indices,a);if(b)return this.traverseToIndex(b)},traverseToIndex:function(a,b){var c=this.indices,e=this.index,f=a<e?-1:1,g,h,i,j,k,l,m,n,o,p;if(this.stateIsImmutable)if(b)this.index=a,this.changeState(c[a]);else while(e!==a)this.index=e+=f,this.changeState(c[e]);else{g=this.stateIndices,h=this.stateIndex,i,j=this.mutationOffset,k=this.state.express();while(e!==a){m=g[h+1]-e-1,f<0?j||(j=m):j+=1;while(0<j&&j<=m){if(e===a){if(l===0)break;l--}n=e+j,o=c[n],c[n]=d.delta(k,o),p=d.clone(p,o),j+=f}j=0,e=g[h+=f],b||(p&&(this.mutateState(p),p=null),this.index=e,this.changeState(c[e]))}b&&(p&&this.mutateState(p),this.changeState(c[a])),this.mutationOffset=0}},traverseBy:function(b,c,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;typeof b=="string",typeof c=="boolean"&&(e=c,c=0),c==null&&(c=0),f=this.elements,g=this.indices,h=this.index;if(h===a)return;i=g.length,e===a&&(e=!0);if(this.stateIsImmutable){n=h+b,n>=i?n=i-1:n<0&&(n=0),b=n-h,p=b<0?-1:1;if(e)this.index=n,this.changeState(g[n]);else while(h!==n)this.index=h+=p,this.changeState(g[h])}else{j=this.stateIndices,k=j.length,l=this.stateIndex,m=this.mutationOffset,o=l+b,o>=k?o=k-1:o<0&&(o=0),n=j[o],b=o-l,p=b<0?-1:1,q=this.state.express();while(h!==n||c){r=j[l+1]-h-1,p<0?m||(m=r):m+=1;while(0<m&&m<=r){if(h===n){if(c===0)break;c--}s=h+m,t=g[s],g[s]=d.delta(q,t),u=d.clone(u,t),m+=p}m=0,h=j[l+=p],e||(u&&(this.mutateState(u),u=null),this.index=h,this.changeState(g[h]))}e&&(u&&this.mutateState(u),this.changeState(g[n])),this.mutationOffset=0}},changeState:function(a){var b;return this.traverse=d.noop,b=this.state.change(a),delete this.traverse,b},mutateState:function(a){this.state.mutate(a)},pushState:function(a){var b=this.elements,c=this.indices,d=this.index+this.mutationOffset+1;c.splice(d,c.length-d),this.index=d,this.mutationOffset=0,a instanceof q||(a=this.state.query(a)),c[d]=a.toString()},replaceState:function(a){var b=this.indices,c=this.index},pushMutation:function(a){},replaceMutation:function(a){},previousStateIndex:function(){return this.stateIndices?this.stateIndices[this.stateIndex-1]:this.index-1},nextStateIndex:function(){return this.stateIndices?this.stateIndices[this.stateIndex+1]:this.index+1},currentState:function(){var a=this.indices[this.index];return this.state.query(a)||a},previousState:function(){var a=this.indices[this.previousStateIndex()];return this.state.query(a)||a},nextState:function(){var a=this.indices[this.nextStateIndex()];return this.state.query(a)||a},destroy:function(){this.state=this.indices=null}}),e}(),v=function(){function b(c,e,f,g){if(!(this instanceof b))return w.apply(this,arguments);var h=this,i={},j={},k={},l=f.action,m=e,n,o;n=e.controller(),n!==c.controller()&&(n=a),d.env.debug&&d.assign(this.__private__={},{methods:i,events:j,guards:k,action:l}),d.assign(this,{superstate:function(){return m},attachTo:function(a){return m=a},controller:function(){return n},origin:function(){return e instanceof b?e.origin():e},source:function(){return e},target:function(){return c},setCallback:function(a){return g=a},wasAborted:function(){return o},start:function(){return o=!1,this.emit("start",arguments,!1),l&&d.isFunction(l)?(l.apply(this,arguments),this):this.end.apply(this,arguments)},abort:function(){return o=!0,g=null,this.emit("abort",arguments,!1),this},end:function(){return o||(this.emit("end",arguments,!1),g&&g.apply(n,arguments)),this.destroy(),c},destroy:function(){e instanceof b&&e.destroy(),c=m=n=null}}),d.privilege(this,q.privileged,{"express mutate":[w,a,null,i,j,k],"method methodNames addMethod removeMethod":[i],"event addEvent removeEvent emit":[j],"guard addGuard removeGuard":[k]}),d.alias(this,{addEvent:"on bind",removeEvent:"off unbind",emit:"trigger"}),q.privileged.init(w).call(this,f)}return d.inherit(b,q),b.prototype.depth=function(){var a=this.source(),c=0;while(a instanceof b)c++,a=a.source();return c},b}(),w=function(){function g(a){if(this instanceof g)d.edit("deep all",this,a instanceof g?a:h(a));else return new g(a)}function h(g){var h,i,j,k,l,m=d.assign({},b,c);for(h in g)d.hasOwn.call(g,h)&&(i=g[h],h in b?m[h]=i:h in c?m[h]=d.clone(m[h],i):(j=h in e?"events":h in f?"guards":d.isFunction(i)?"methods":a,j&&(l=m[j],l||(l=m[j]={}),l[h]=i)));for(h in k=m.events)i=k[h],d.isFunction(i)&&(k[h]=[i]);return m}var b=d.assign(m,null),c=d.assign(n,null),e=d.assign(o),f=d.assign(l);return g}();d.assign(g,{State:q,StateExpression:r,StateController:s,StateEventEmitter:t,Transition:v,TransitionExpression:w})}).call(this);