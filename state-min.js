(function(a){function h(b,c,d,e){return arguments.length<2?(typeof b=="string"?c=b:d=b,b=a):(typeof b=="string"&&(e=d,d=c,c=b,b=a),typeof c!="string"&&(e=d,d=c,c=a)),d=new s(c,d),b?(new t(b,d,e)).current():d}"use strict";var b=this,c={VERSION:"0.0.8",noConflict:function(){var a=b.state;return function(){return b.state=a,this}}(),options:{memoizeProtostates:!0}},d=typeof require!="undefined"?require("omicron"):b.O,e=d.NIL,f=/^\s*([\-|=]>)\s*(.*)/,g={"->":"change","=>":"changeTo"};d.assign(h,c);var i={NORMAL:0,VIRTUAL:1,MUTABLE:2,FINITE:4,STATIC:8,IMMUTABLE:16,INITIAL:32,CONCLUSIVE:64,FINAL:128,ABSTRACT:256,CONCRETE:512,DEFAULT:1024,REFLECTIVE:2048,HISTORY:4096,RETAINED:8192,SHALLOW:16384,VERSIONED:a,CONCURRENT:32768},j=["mutable finite static immutable","initial conclusive final","abstract concrete default","reflective","history retained shallow versioned","concurrent"].join(" "),k="data methods events guards states transitions",l="construct depart exit enter arrive destroy mutate noSuchMethod",m="admit release",n="origin source target action conjugate",o="methods events guards",p="construct destroy enter exit start end abort";d.env.server&&(module.exports=exports=h),d.env.client&&(b.state=h);var q=d.env.server?module:{exports:h};h.method=function(){function f(b,c){function d(e){if(this!==q)throw ReferenceError;if(typeof b=="object"&&typeof c=="function")return g(d,e,b,c);if(typeof b=="object"&&c===a)return function(a){return g(d,e,b,a)};if(typeof b=="function"&&c===a)return g(d,e,null,b)}return d.isLexicalStateMethodFactory=!0,d}function g(a,f,g,h){var i,j,k,l,m,n,o,p;i=g instanceof Object&&d.keys(g)||[],k=0,l=i.length,j=new Array(l);for(;k<l;k++)j[k]=g[i[k]];return m=i.concat(b),n=[r,f,f.protostate()],j.length&&(n=j.concat(n)),o=Function.prototype.toString.call(h).replace(c,e),p=Function.apply(null,m.concat(o)).apply(null,n),p.factory=a,p.isLexicalStateMethod=!0,p}var b=["__State__","autostate","protostate"],c=/^(function\b\s*(?:[$_A-Za-z][$\w]*)?\s*\((?:[\s\S]*?)\)\s*\{)([\s\S]*)/,e="return $1\n  var superstate, owner;\n  if ( this instanceof __State__ ) {\n    superstate = this.superstate();\n    owner = this.owner();\n  }\n$2;";return f}();var r=function(){function F(b,c,e){if(!(this instanceof F))return new F(b,c,e);var f,g,i,m,o;f=e&&e.attributes||h,this.name=d.stringFunction(function(){return c||""}),b instanceof t?(g=b,b=a,g.root=d.thunk(this),this.controller=d.thunk(g)):b&&(this.superstate=G.superstate(b),i=b.attributes(),f|=i&(k|l));if(m=this.protostate())o=m.attributes(),o&=E,f&x&&(f&=~v),f&(v|x)&&(o&=~(v|x)),f|=o;~f&v&&(f|=x),f|=(i|o)&n,f&n&&(f&=~k,f|=l),f&j?(this.attributes=G.attributes(f),this.realize=G.realize(f),f&k&&d.assign(this,I)):H.call(this,b,f,e),d.env.debug&&(this[" <owner>"]=this.owner(),this[" <path>"]=this.derivation(!0).join("."),this["<attr>"]=s.decodeAttributes(f))}function H(a,b,c){var e,f,g,h,i=this,j={},m={},n={},o={},p={},r={},t=null;d.privilege(this,G,{"peek express mutate":[s,b,j,m,n,o,p,r,t],superstate:[a],attributes:[b],"data has get let":[b|k,j],"method methodNames addMethod removeMethod":[m],"event addEvent removeEvent emit":[n],"guard addGuard removeGuard":[o],"substate substates addSubstate removeSubstate":[b,p],"transition transitions addTransition removeTransition":[r],destroy:[function(b){return a=b},m,n,p]}),d.alias(this,{addEvent:"on bind",removeEvent:"off unbind",emit:"trigger"}),G.init(s).call(this,c);if(!a&&(e=this.owner())){f=this.addMethod,f||(f=G.addMethod(m));for(g in e)d.hasOwn.call(e,g)&&(h=e[g],d.isFunction(h)&&!h.isDelegator&&this.method(g,!1)&&f.call(this,g,h))}~b&k&&(d.forEach("mutate let addMethod removeMethod addGuard removeGuard             addTransition removeTransition".split(/\s+/),function(a){delete i[a]}),this.data=F.privileged.data(b,j));if(~b&k||b&l)delete this.addSubstate,delete this.removeSubstate;return~b&k&&b&l&&(this.mutate=G.mutate(s,b,j,m,n,o,null,r)),d.env.debug&&d.assign(this,{"<attr>":s.decodeAttributes(b),__private__:this.peek(q)}),this}function J(){}var b=i,h=b.NORMAL,j=b.VIRTUAL,k=b.MUTABLE,l=b.FINITE,m=b.STATIC,n=b.IMMUTABLE,o=b.INITIAL,p=b.CONCLUSIVE,r=b.FINAL,v=b.ABSTRACT,x=b.CONCRETE,y=b.DEFAULT,z=b.REFLECTIVE,A=b.HISTORY,B=b.RETAINED,C=b.SHALLOW,D=b.CONCURRENT,E=k|l|m|n|o|p|r|v|x|y|z|A|B|C|D;d.assign(F,b),F.prototype.name=d.noop;var G=F.privileged={};d.assign(F.privileged,{init:function(a){return function(a){return this.__initializing__=!0,this.mutate(a),delete this.__initializing__,this.emit("construct",a,!1),this}},destroy:function(b,c,e,f){return function(){var g=this.superstate(),h=this.controller(),i=h.owner(),j=h.transition(),k,l,m,n,o,p,r;if(j){k=j.origin(),l=j.target();if(k.isIn(this)||l.isIn(this))return!1}for(r in f)d.hasOwn.call(f,r)&&f[r].destroy();this.emit("destroy",!1);for(m in e)e[m].destroy(),delete e[m];if(g)g.isMutable()?g.removeSubstate(this.name()):G.removeSubstate(g.peek(q,"attributes"),g.peek(q,"substates")).call(g,this.name());else{for(n in c)o=i[n],o&&(p=o.original,p?(delete o.original,i[n]=p):delete i[n]);h.destroy&&h.destroy()}return b(a),this.destroyed=!0}}}),F.prototype.destroy=d.thunk(!1),F.privileged.peek=function(a,b,c,e,f,g,h,i,j){var k={expressionConstructor:a,attributes:b,data:c,methods:e,events:f,guards:g,substates:h,transitions:i,history:j};return function(a,b){if(a!==q)throw ReferenceError;return b?k[b]:d.clone(k)}},F.prototype.peek=d.noop;var I=function(){var a={},b="addMethod addEvent addGuard addSubstate addTransition";return d.forEach(b.split(" "),function(b){function c(){var a=this.realize()[b];if(a!==c)return a.apply(this,arguments)}a[b]=c}),a}();return F.privileged.realize=function(a){return function(b){var c=this.superstate(),e=d.hasOwn.call(c,"addSubstate")?c.addSubstate:G.addSubstate(c.peek(q,"attributes"),c.peek(q,"substates"));return delete this.realize,e.call(c,this.name(),this)&&H.call(this,c,a&~j,b),this}},d.assign(F.prototype,{virtualize:function(a){var b,c,d,e,f;if(!(a instanceof F&&this.owner().isPrototypeOf(a.owner())))return null;b=this.derivation(!0);if(!b.length)return null;c=0,d=a.root();while((f=b[c++])&&(e=d.substate(f,!1)))d=e;while(f)d=new F(d,f,{attributes:i.VIRTUAL}),f=b[c++];return d},realize:d.getThis}),F.privileged.express=function(){function b(b){if(b===a)return;var c=null,e,f;for(e in b)f=b[e],c||(c={}),c[e]=f&&typeof f=="object"?d.clone(b[e]):f;return c}function c(b){if(b===a)return;var c=null,d,e;for(d in b)e=b[d],c||(c={}),c[d]=e.isLexicalStateMethod?e.factory:e;return c}function e(b){if(b===a)return;var c=null,e,f;for(e in b)if(f=b[e])c||(c={}),c[e]=d.clone(f.items);return c}function f(b,c){if(b===a)return;var e=null;return d.forEach(b,function(a,b){(e||(e={}))[b]=a.express(c)}),e}return function(a,g,h,i,j,k,l,m){return function(n){var o={};return d.edit(o,{attributes:g,data:b(h),methods:c(i),events:e(j),guards:b(k),states:f(l,n),transitions:b(m)}),n?new a(o):o}}}(),F.prototype.express=d.noop,F.privileged.mutate=function(a,b,c,e,f,g,h,i){return function(b){b instanceof a||(b=new a(b));var j=this,k=d.NIL,l,m,n,o,p,q,r,s;this.__initializing__||(l=this.express()),this.__atomic__=!0,c&&b.data&&this.data(b.data),m=e&&b.methods;for(n in m)d.hasOwn.call(m,n)&&(o=m[n],o!==k?this.addMethod(n,o):this.removeMethod(n));f&&b.events&&d.forEach(b.events,function(a,b){var c,e,g,h,i,l=f[b];if(a===k)return l&&l.empty();!l&&a&&!d.isEmpty(a)&&(l=f[b]=new u(j,b)),c=l.items,e=function(a){var b,e;for(b in a)d.hasOwn.call(a,b)&&(e=a[b],e===k?l.remove(b):e&&e!==c[b]&&l.set(b,e))};if(d.isArray(a)){g=function(a){return j.addEvent(b,a)};for(h=0,i=a.length;h<i;h++){o=a[h];if(o==null||o===k)continue;(d.isPlainObject(o)?e:g)(o)}}else d.isPlainObject(a)&&e(a);l.length||l.destroy()&&delete f[b]}),g&&b.guards&&d.edit("deep",g,b.guards),m=h&&b.states;for(n in m)d.hasOwn.call(m,n)&&(o=m[n],n in h?o===k?h[n].destroy():h[n].mutate(o,!1):this.addSubstate(n,o));m=i&&b.transitions;for(n in m)d.hasOwn.call(m,n)&&(o=m[n],n in i?o===k?delete i[n]:i[n]=new w(o):this.addTransition(n,o));return delete this.__atomic__,l&&(p=this.express(),q=d.diff(l,p),d.isEmpty(q)||this.emit("mutate",[b,q,l,p],!1)),this}},F.prototype.mutate=function(a){var b,c,e=d.NIL,f=a.states,g=this.substates();for(b in f)d.hasOwn.call(f,b)&&(c=f[b],b in g?c!==e&&g[b].mutate(c,!1):this.addSubstate(b,c))},F.privileged.attributes=function(a){return function(){return a}},d.assign(F.prototype,{attributes:d.thunk(h),isVirtual:function(){return!!(this.attributes()&j)},isMutable:function(){return!!(this.attributes()&k)},isFinite:function(){return!!(this.attributes()&l)},isStatic:function(){return!!(this.attributes()&m)},isImmutable:function(){return!!(this.attributes()&n)},isInitial:function(){return!!(this.attributes()&o)},isConclusive:function(){return!!(this.attributes()&p)},isFinal:function(){return!!(this.attributes()&r)},isAbstract:function(){return!!(this.attributes()&v)},isConcrete:function(){return!!(this.attributes()&x)},isDefault:function(){return!!(this.attributes()&y)},isReflective:function(){return!!(this.attributes()&z)},hasHistory:function(){return!!(this.attributes()&A)},isRetained:function(){return!!(this.attributes()&B)},isShallow:function(){return!!(this.attributes()&C)},isConcurrent:function(){return!!(this.attributes()&D)}}),d.assign(F.privileged,{superstate:function(b){return function(c){return c===a?b:b?c?b.name()===c?b:b.superstate(c):this.controller().root():a}}}),d.assign(F.prototype,{owner:function(){var a=this.controller();if(a)return a.owner()},controller:function(){var a=this.superstate();if(a)return a.controller()},root:function(){var a=this.controller();if(a)return a.root()},superstate:d.noop,derivation:function(a){var b=[],c,d=this;while((c=d)&&(d=c.superstate()))b.unshift(a?c.name()||"":c);return b},"path toString":function(){return this.derivation(!0).join(".")},depth:function(){var a=0,b=this;while(b=b.superstate())a++;return a},common:function(a){var b;a instanceof F||(a=this.query(a)),this.depth()>a.depth()?(b=a,a=this):b=this;while(b){if(b===a||b.isSuperstateOf(a))return b;b=b.superstate()}},is:function(a){return a instanceof F||(a=this.query(a)),a===this},isIn:function(a){return a instanceof F||(a=this.query(a)),a===this||a.isSuperstateOf(this)},hasSubstate:function(a){return a instanceof F||(a=this.query(a)),this===a||this.isSuperstateOf(a)},isSuperstateOf:function(a){var b;return a instanceof F||(a=this.query(a)),(b=a.superstate())?this===b||this.isSuperstateOf(b):!1},protostate:function(){var a;return c.options.memoizeProtostates&&(a=function(a){return function(){return a.destroyed?(delete this.protostate,this.protostate()):a}}),function(){var b=this.derivation(!0),c=this.controller(),e,f,g,h,i,j;if(!c)return;e=c.name(),f=c.owner(),g=function(){var a,b;return(f=d.getPrototypeOf(f))&&d.isFunction(a=f[e])&&(b=a.apply(f))instanceof F&&b.root()};while(h=g()){for(i=0,j=b.length;i<j;i++){h=h.substate(b[i],!1);if(!h)break}if(h)return a&&(this.protostate=a(h)),h}}}(),isProtostateOf:function(a){var b;return a instanceof F||(a=this.query(a)),(b=a.protostate())?this===b||this.isProtostateOf(b):!1},defaultSubstate:function(b,c){var d=this.substates(),e=0,f=d&&d.length,g;c||f&&(c=d[0]);for(;e<f;e++)if(d[e].isDefault())return d[e];if(b||b===a){g=this.protostate();if(g)return g.defaultSubstate(!0,c)}return c},favor:function(a){var b;if(this.isConcrete())return;return a==null&&d.hasOwn.call(this,"defaultSubstate")?(delete this.defaultSubstate,this.defaultSubstate()):(this.isVirtual()&&this.realize(),a instanceof F||(a=this.query(a)),!a||!this.isSuperstateOf(a)?null:(b=a.path(),this.defaultSubstate=function(){return this.query(b)},a))},appoint:function(a){var b=this.favor(a);if(!b)return;return this.isActive()?this.change(b):b},initialSubstate:function(b){var c=[this],d,e,f,g,h,i;while(d=c.shift()){e=d.substates(!1,!0);for(f=0,g=e.length;f<g;f++){h=e[f];if(h.isInitial())return h.initialSubstate(!1)||h;c.push(h)}}if(b||b===a){i=this.protostate();if(i)return i.initialSubstate(!0)}}}),d.assign(F.prototype,{current:function(){var a=this.controller();if(a)return this.controller().current()},isCurrent:function(){return this.current()===this},isActive:function(){var a=this.current();return a===this||this.isSuperstateOf(a)},"change go be":function(a,b){var c=this.controller();return arguments.length?c.change.apply(c,a instanceof F||typeof a=="string"?arguments:[this].concat(arguments)):c.change(this)},"changeTo goTo":function(b,c){return b===a&&(b=this),c?c.direct=!0:c={direct:!0},this.change(b,c)}}),d.assign(F.prototype,{"query match":function(b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s;typeof c=="boolean"&&(e=d,d=c,c=a),d===a&&(d=!0),e===a&&(e=!0),f===a&&(f=!0);if(b==null)return c!==a?!1:null;if(b===".")return c!==a?c===this:this;if(b==="")return c!==a?c===this.root():this.root();if(c&&c===this.root()&&b.search(/^\*+$/)===0)return!0;b.search(/^\.*\**$/)===0&&(d=e=!1);if(b.charAt(0)!==".")return this.root().query("."+b,c,d,!1);b=b.replace(/^(\.+)\.$/,"$1"),g=b.split(".");for(k=1,l=g.length,h=this;h;k++){if(k>=l)return c?c===h:h;m=g[k];if(m==="*"){if(!c)return h.substates();if(h===c.superstate())return!0;break}if(m==="**"){if(!c)return h.substates(!0);if(h.isSuperstateOf(c))return!0;break}if(m==="")h=h.superstate();else if(i=h.substate(m))h=i;else break}if(d){n=[this];while(o=n.shift()){p=o.substates(!1,!0);for(k=0,l=p.length;k<l;k++){q=p[k];if(q===d)continue;j=q.query(b,c,!1,!1,!1);if(j)return j;n.push(q)}}}if(e&&(r=this.superstate())){j=r.query(b,c,d&&this,!0,!1);if(j)return j}if(f&&(s=this.protostate())){j=s.query(b,c,d,e,!0);if(j)return j}return c?!1:null},$:function(a){var b,c,e;if(typeof a!="function")return typeof a=="string"&&(c=a.match(f))&&(e=g[c[1]])?arguments.length>1?this[e].apply(this,[c[2]].concat(d.slice.call(arguments,1))):this[e](c[2]):this.query.apply(this,arguments);b=d.slice.call(arguments),b[0]=a=a();if(a)return this.change.apply(this,b)}}),d.assign(F.privileged,{data:function(b,c){return function(e,f){var g,h,i,l,m;return e!=null&&typeof e!="boolean"?(g=e,e=f=!1):(e===a&&(e=!0),f===a&&(f=!0)),g&&b&k&&!d.isEmpty(g)?b&j?this.realize().data(g):(h=d.delta(c,g),!this.__atomic__&&h&&!d.isEmpty(h)&&this.emit("mutate",[g,h],!1),this):d.clone(e&&(l=this.superstate())&&l.data(),f&&(m=this.protostate())&&m.data(!1),c)}},has:function(b,c){return function(b,e,f){var g,h;return e===a&&(e=!0),f===a&&(f=!0),!!(c&&d.has(c,b)||f&&(g=this.protostate())&&g.has(b,!1,!0)||e&&(h=this.superstate())&&h.has(b,!0,f))}},get:function(b,c){return function(b,e,f){var g,h;return e===a&&(e=!0),f===a&&(f=!0),c&&d.lookup(c,b)||f&&(g=this.protostate())&&g.get(b,!1,!0)||e&&(h=this.superstate())&&h.get(b,!0,f)}},let:function(b,c){return function(f,g){var h,i,l;if(!(b&k))return;return b&j?this.realize().let(f,g):c?(h=d.lookup(c,f),h!==g&&(d.assign(c,f,g),d.assign(i={},f,g),d.assign(l={},f,h),this.emit("mutate",[i,l],!1)),g):g===e?e:a}}}),d.assign(F.prototype,{data:F.privileged.data(a,null),has:F.privileged.has(a,null),get:F.privileged.get(a,null),let:F.privileged.let(a,null),set:function(a,b){if(!this.isMutable())return;this.isVirtual()&&this.realize();if(!this.has(a,!0,!1))return this.let(a,b);for(var c=this;c;c=c.superstate())if(c.isMutable()&&c.has(a,!1,!1))return c.let(a,b)},"delete":function(a){return this.let(a,e)===e}}),d.assign(F.privileged,{method:function(b){return function(c,d,e,f){var g,h,i;d===a&&(d=!0),e===a&&(e=!0),b&&(i=b[c]);if(i&&i!==J)return f&&(f.context=this,f.method=i),i;if(e){h=this.protostate();if(h){i=h.method(c,!1,!0,f);if(i)return f&&(f.context=this),i}}if(d){g=this.superstate();if(g){i=g.method(c,!0,e,f);if(i)return i}}return f&&(f.context=null,f.method=i),i}},methodNames:function(a){return function(){return d.keys(a)}},addMethod:function(b){function c(a,b,c){function e(){return this[a]().apply(b,arguments)}return e.isDelegator=!0,d.env.debug&&(e.toString=function(){return"[delegator]"}),c&&(e.original=c),e}return function(d,e,f){var g=this.controller(),h=g.name(),i=g.root(),j=g.owner(),k;return!f&&e.isLexicalStateMethodFactory&&(e=e.call(q,this)),this.method(d,!0,!1)||(this!==i&&!i.method(d,!1,!1)&&(k=j[d],(k===a||k.isDelegator)&&(k=J),i.addMethod(d,k,!0)),j[d]=c(h,d,k)),b[d]=e}},removeMethod:function(a){return function(b){var c=a[b];return delete a[b],c}}}),d.assign(F.prototype,{method:F.privileged.method(null),methodNames:function(){return[]},"addMethod removeMethod":d.noop,hasMethod:function(a){var b=this.method(a);return b&&b!==J},hasOwnMethod:function(a){return!!this.method(a,!1,!1)},apply:function(b,c){var d,e,f,g,h;d={method:a,context:a},e=this.method(b,!0,!0,d);if(!e){this.emit("noSuchMethod",[b,c]),this.emit("noSuchMethod:"+b,c);return}return f=d.context,g=this.owner(),h=g[b],h&&h.original&&f===this.root()&&(f=g),e.apply(f,c)},call:function(a){return this.apply(a,d.slice.call(arguments,1))}}),d.assign(F.privileged,{event:function(b){return function(c,d){var e=b[c];if(e==null)return;return d===a?e.length:(typeof d=="function"&&(d=e.key(d)),e.get(d))}},addEvent:function(a){return function(b,c,e){return d.hasOwn.call(a,b)||(a[b]=new u(this,b)),a[b].add(c,e)}},removeEvent:function(a){return function(b,c){return a[b].remove(c)}},emit:function(b){return function(c,e,f,g,h){var i,j,k;if(typeof c!="string")return;typeof e=="boolean"&&(h=g,g=f,f=e,e=a),typeof f=="boolean"&&(h=g,g=f,f=a),!e&&(e=[])||d.isArray(e)||(e=[e]),g===a&&(g=!0),h===a&&(h=!0),(i=b[c])&&i.emit(e,f||this),h&&(j=this.protostate())&&j.emit(c,e,f||this,!1),g&&(k=this.superstate())&&k.emit(c,e,f||k)}}}),d.assign(F.prototype,{"event addEvent removeEvent emit trigger":d.noop}),d.assign(F.privileged,{guard:function(b){return function(c){var e,f;return(e=b[c])&&d.clone(e)||(f=this.protostate())&&f.guard(c)||a}},addGuard:function(a){return function(b,c){return d.edit(a[b]||(a[b]={}),c)}},removeGuard:function(b){return function(c){var e,f,g,h,i,j;e=b[c];if(!e)return null;if(arguments.length<2)return delete b[c]?e:a;f=d.flatten(d.slice.call(arguments,1));for(g=0,h=f.length;g<h;g++){i=f[g];if(typeof i=="string"){j=e[i];if(delete e[i])return j}}}}}),d.assign(F.prototype,{"guard addGuard removeGuard":d.noop}),d.assign(F.privileged,{substate:function(b,c){return function(b,d){var e=this.current(),f,g;d===a&&(d=!0);for(;e&&e.isVirtual()&&(f=e.superstate());e=f)if(f===this&&e.name()===b)return e;return c&&c[b]||d&&(g=this.protostate())&&g.substate(b)||a}},substates:function(a,b){return function(a,c){var e=[],f,g,h;if(c){f=this.current();if(f&&f.isVirtual()&&this.isSuperstateOf(f))while(f&&f!==this&&f.isVirtual()&&(g=f.superstate()))a?e.unshift(f):g===this&&e.unshift(f),f=g}for(h in b)d.hasOwn.call(b,h)&&(e.push(b[h]),a&&(e=e.concat(b[h].substates(!0))));return e}},addSubstate:function(a,b){return function(c,d){var e,f;return a&j?this.realize().addSubstate(c,d):((e=b[c])&&e.destroy(),e=d instanceof F?d.superstate()===this&&d.realize():new F(this,c,d),e?(this[c]=b[c]=e,f=this.controller(),f.root()===this&&(f[c]=e),e):null)}},removeSubstate:function(a,b){return function(a){var c,d,e,f=b[a];if(!f)return;return c=this.controller(),d=c.current(),e=c.transition(),e&&(f.isSuperstateOf(e)||f===e.origin()||f===e.target())?!1:(d.isIn(f)&&c.change(this,{forced:!0}),delete b[a],delete this[a],c.root()===this&&delete c[a],f)}}}),d.privilege(F.prototype,F.privileged,{"substate substates":[null]}),d.assign(F.prototype,{"addSubstate removeSubstate":d.noop}),d.assign(F.privileged,{transition:function(a){return function(b){return a[b]}},transitions:function(a){return function(){return d.clone(a)}},addTransition:function(a){return function(b,c){return c instanceof w||(c=new w(c)),a[b]=c}},removeTransition:d.noop}),d.assign(F.prototype,{"transition addTransition removeTransition":d.noop,transitions:function(){return{}}}),F}(),s=function(){function n(b,c){if(this instanceof n)typeof b=="string"?c||(c={}):c||(c=b,b=a),d.edit("deep all",this,c instanceof n?c:q(c)),b==null?c&&(b=c.attributes):d.isNumber(b)||(b=o(b)),this.attributes=b||i.NORMAL;else return new n(b,c)}function o(a){var c,e=i.NORMAL;typeof a=="string"&&(a=d.assign(a));for(c in a)d.hasOwn.call(a,c)&&c in b&&(e|=i[b[c]]);return e}function p(a){var b,d=[];for(b in c)a&b&&d.push(c[b]);return d.join(" ")}function q(b){var c,e,i,j,l,m=d.assign(k,null);for(c in b)d.hasOwn.call(b,c)&&(e=b[c],e===h&&(e=new n),j=e instanceof n&&"states"||e instanceof w&&"transitions",j?(l=m[j],l||(l=m[j]={}),l[c]=e):c in m&&e?m[c]=d.clone(m[c],e):(j=c in f||typeof e=="string"?"events":c in g?"guards":d.isPlainObject(e)?"states":d.isFunction(e)?"methods":a,j&&(l=m[j],l||(l=m[j]={}),l[c]=e)));i=m.events;for(c in i)if(d.hasOwn.call(i,c)){e=i[c];if(typeof e=="function"||typeof e=="string")i[c]=[e]}i=m.guards;for(c in i)d.hasOwn.call(i,c)&&(e=i[c],d.isPlainObject(e)||(i[c]={"*":e}));i=m.transitions;for(c in i)d.hasOwn.call(i,c)&&(e=i[c],e instanceof w||(i[c]=new w(e)));i=m.states;for(c in i)d.hasOwn.call(i,c)&&(e=i[c],e instanceof n||(i[c]=new n(e)));return m}var b=d.forEach(d.assign(j),function(a,b,c){c[b]=b.toUpperCase()}),c=d.forEach(d.invert(i),function(a,b,c){c[b]=a.toLowerCase()}),e=d.assign(k),f=d.assign(l),g=d.assign(m);return n.encodeAttributes=o,n.decodeAttributes=p,n}(),t=function(){function b(e,f,g){function n(a){return k=a}function o(a){return l=a}if(!(this instanceof b))return new b(e,f,g);var h=this,i,j,k,l,m;e||(e={}),f instanceof s||(f=new s(f)),g===a&&(g={})||typeof g=="string"&&(g={initialState:g}),i=g.name||"state",e[i]=c(e,i,this),d.assign(this,{owner:d.thunk(e),name:d.stringFunction(function(){return i}),current:d.assign(function(){return k},{toString:function(){if(k)return k.toString()}}),change:b.privileged.change(n,o),transition:d.assign(function(){return l},{toString:function(){if(l)return l.toString()}}),destroy:function(){var a;return delete this.destroy,l&&l.abort(),j.destroy(),a=delete e[i],e=h=j=k=l=null,a}}),j=new r(this,"",f),k=j.initialSubstate()||j,g.initialState!==a&&(k=j.query(g.initialState)),k.isAbstract()&&(m=k.defaultSubstate(),m&&(k=m)),k.controller()!==this&&(k=k.virtualize(j)),d.env.debug&&d.assign(this.__private__={},{root:j,owner:e,options:g})}function c(a,c,e){function h(h){var i,j,k;if(this===a)return i=e.current(),arguments.length===0?i:typeof h=="function"?i.change(h.call(this)):typeof h=="string"&&(j=h.match(f))&&(k=g[j[1]])?arguments.length>1?i[k].apply(i,[j[2]].concat(d.slice.call(arguments,1))):i[k](j[2]):i.query.apply(i,arguments);if(Object.prototype.isPrototypeOf.call(a,this)&&!d.hasOwn.call(this,c))return new b(this,null,{name:c,initialState:e.current().toString()}),this[c].apply(this,arguments)}return h.isAccessor=!0,d.env.debug&&(h.toString=function(){return"[accessor] -> "+e.current().toString()}),h}function e(a,b){var c,e,f,g,h,i,j,k=!0;typeof a=="string"&&(a=this.guard(a));if(!a)return!0;for(c in a)if(d.hasOwn.call(a,c)){e=a[c],f=typeof e=="function",f&&(g||(g=d.slice.call(arguments,1))),h=d.trim(c).split(/\s*,+\s*/);for(i=0,j=h.length;i<j;i++)if(this.query(h[i],b)){k=f?!!e.apply(this,g):!!e;break}if(!k)break}return k}return b.privileged={change:function(a,b){var c={};return function(f,g){var h,i,j,k,l,m,n,o,p,q,s=this;j=this.transition(),m=j?j.origin():this.current();if(m.isFinal())return null;h=this.root(),i=this.owner(),f instanceof r||(f=f?m.query(f):h);if(!f||(k=f.owner())!==i&&!k.isPrototypeOf(i))return null;g?d.isArray(g)&&(g={args:g}):g=c;while(f.isAbstract()){f=f.defaultSubstate();if(!f)return null}if(!g.forced&&(!e.call(m,"release",f)||!e.call(f,"admit",m)))return typeof g.failure=="function"&&g.failure.call(this),null;f&&f.controller()!==this&&(f=f.virtualize(h)),l=this.current(),n=l.common(f),o=l;while(o!==n){if(o.isConclusive())return null;o=o.superstate()}j&&j.abort(),q=this.getTransitionExpressionFor(f,m),j=new v(f,l,q),b(j),l.emit("depart",j,!1),j.wasAborted()&&(j=null),j&&(a(j),j.emit("enter",!1),j.wasAborted()&&(j=null));for(o=l;j&&o!==n;)o.emit("exit",j,!1),j.attachTo(o=o.superstate()),j.wasAborted()&&(j=null);return j&&j.setCallback(function(){var c,d,e,h;j.wasAborted()&&(j=null);if(j)for(c=f,d=[];c!==n;c=c.superstate())d.push(c);for(c=n;j&&(e=d.pop());c=e)j.attachTo(e),e.emit("enter",j,!1),j.wasAborted()&&(j=null);j&&(j.emit("exit",!1),j.wasAborted()&&(j=null));if(j){a(f),f.emit("arrive",j,!1);for(c=m;c.isVirtual();c=h)h=c.superstate(),c.destroy();return j.destroy(),j=b(null),typeof g.success=="function"&&g.success.call(this),f}return null}),j&&j.start.apply(j,g.args)||this.current()}}},d.assign(b.prototype,{toString:function(){return this.current().toString()},getTransitionExpressionFor:function(a,b){function c(c,f){var g,h,i,j,k,l;for(;c&&c!==f;c=f?c.superstate():null){g=c.transitions();for(h in g)if(d.hasOwn.call(g,h)){i=g[h];if((!(j=i.guards)||(!(k=j.admit)||d.isEmpty(k)||e.call(b,k,a,b))&&(!(l=j.release)||d.isEmpty(l)||e.call(a,l,b,a)))&&(i.target?c.query(i.target,a):c===a)&&(!i.origin||c.query(i.origin,b)))return i}}}return b||(b=this.current()),c(a)||b!==a&&c(b)||c(a.superstate(),this.root())||c(this.root())||!a.isIn(b)&&c(b.superstate(),b.common(a))||new w}}),b}(),u=function(){function b(a,b){this.state=a,this.type=b,this.items={},this.length=0}var a=0;return d.assign(b.prototype,{guid:function(){return(a+=1).toString()},get:function(a){return this.items[a]},getAll:function(){var a,b=this.items,c=[];for(a in b)d.hasOwn.call(b,a)&&c.push(b[a]);return c},set:function(a,b){var c=this.items;return d.hasOwn.call(c,a)||this.length++,c[a]=b,a},key:function(a){var b,c=this.items;for(b in c)if(d.hasOwn.call(c,b)&&c[b]===a)return b},keys:function(){var a,b=this.items,c=[];c.toString=function(){return"["+c.join()+"]"};for(a in b)d.hasOwn.call(b,a)&&c.push(b[a]);return c},"add on bind":function(a,b){var c=this.guid();return this.items[c]=typeof b=="object"?[a,b]:a,this.length++,c},"remove off unbind":function(a){var b,c,d,e=this.items;return b=e[typeof a=="function"?this.key(a):a],b?(delete e[a],this.length--,b):!1},empty:function(){var a=this.length,b,c;if(a===0)return 0;b=this.items;for(c in b)d.hasOwn.call(b,c)&&delete b[c];return this.length=0,a},"emit trigger":function(a,b){var c,e,f,g,h,i,j=this.items,k=this.type;b||(b=this.state);for(c in j)if(d.hasOwn.call(j,c)){e=j[c],f=d.type(e);if(f==="function")g=e,h=b;else if(f==="array")g=e[0],h=e[1];else if(f==="string"||e instanceof r){i=e;continue}g.apply(h,a),g=h=null}i&&b.change(i)},destroy:function(){return this.empty(),delete this.state,delete this.items,!0}}),b}(),v=function(){function b(c,e,f,g){if(!(this instanceof b))return w.apply(this,arguments);var h=this,i=f&&f.name||"",j={},k={},l={},m=f&&f.action||null,n=e,o,p;o=e.controller(),o!==c.controller()&&(o=a),d.env.debug&&d.assign(this.__private__={},{methods:j,events:k,guards:l,action:m}),d.assign(this,{name:function(){return i},superstate:function(){return n},attachTo:function(a){return n=a},controller:function(){return o},origin:function(){return e instanceof b?e.origin():e},source:function(){return e},target:function(){return c},setCallback:function(a){return g=a},wasAborted:function(){return p},start:function(){return p=!1,this.emit("start",arguments,!1),m&&d.isFunction(m)?(m.apply(this,arguments),this):this.end.apply(this,arguments)},abort:function(){return p=!0,g=null,this.emit("abort",arguments,!1),this},end:function(){return p||(this.emit("end",arguments,!1),g&&g.apply(o,arguments)),this.destroy(),c},destroy:function(){e instanceof b&&e.destroy(),c=n=o=null}}),d.privilege(this,r.privileged,{"express mutate":[w,a,null,j,k,l],"method methodNames addMethod removeMethod":[j],"event addEvent removeEvent emit":[k],"guard addGuard removeGuard":[l]}),d.alias(this,{addEvent:"on bind",removeEvent:"off unbind",emit:"trigger"}),r.privileged.init(w).call(this,f)}return d.inherit(b,r),b.prototype.depth=function(){var a=this.source(),c=0;while(a instanceof b)c++,a=a.source();return c},b}(),w=function(){function g(a){if(this instanceof g)d.edit("deep all",this,a instanceof g?a:h(a));else return new g(a)}function h(g){var h,i,j,k,l,m=d.assign({},b,c);for(h in g)d.hasOwn.call(g,h)&&(i=g[h],h in b?m[h]=i:h in c?m[h]=d.clone(m[h],i):(j=h in e?"events":h in f?"guards":d.isFunction(i)?"methods":a,j&&(l=m[j],l||(l=m[j]={}),l[h]=i)));for(h in k=m.events)i=k[h],d.isFunction(i)&&(k[h]=[i]);return m}var b=d.assign(n,null),c=d.assign(o,null),e=d.assign(p),f=d.assign(m);return g}();d.assign(h,{State:r,StateExpression:s,StateController:t,StateEventEmitter:u,Transition:v,TransitionExpression:w})}).call(this);