<!DOCTYPE html>  <html> <head>   <title>state.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               state.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Copyright (C) 2011-2012
Nick Fargo, Z Vector Inc.</p>

<p><a href="https://github.com/nickfargo/state/blob/master/LICENSE"><code>LICENSE</code></a> MIT.</p>

<p><strong>State</strong> is a micro-framework for implementing state-driven behavior
directly into any JavaScript object.</p>

<p><a href="http://statejs.org/">statejs.org</a></p>

<p><a class="icon-large icon-octocat"
   href="http://github.com/nickfargo/state/"></a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">;(</span> <span class="kd">function</span> <span class="p">(</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

<span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">global</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>

    <span class="nx">meta</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">VERSION</span><span class="o">:</span> <span class="s1">&#39;0.0.4&#39;</span><span class="p">,</span>

        <span class="nx">noConflict</span><span class="o">:</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">original</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">global</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">original</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">}()</span> <span class="p">),</span>

        <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">memoizeProtostates</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The lone dependency of the <strong>State</strong> module is
<a href="http://github.com/zvector/zcore">Zcore</a>, a library that assists with
tasks such as object manipulation, differential operations, and
facilitation of prototypal inheritance.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Z</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">require</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;zcore&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Z</span><span class="p">;</span>


<span class="kd">var</span> <span class="nx">rxTransitionArrow</span>       <span class="o">=</span> <span class="sr">/^\s*([\-|=]&gt;)\s*(.*)/</span><span class="p">,</span>
    <span class="nx">transitionArrowMethods</span>  <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;-&gt;&#39;</span><span class="o">:</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="s1">&#39;=&gt;&#39;</span><span class="o">:</span> <span class="s1">&#39;changeTo&#39;</span> <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>state( ... ) <a class="icon-link" name="module" href="#module"></a></h2>

<p>The <code>state</code> module is exported as a function. This is used either: (1) to
generate a formal <a href="#state-expression"><code>StateExpression</code></a>; or (2) to bestow
an arbitrary <code>owner</code> object with a new implementation of state based on the
supplied <code>expression</code>, returning the owner’s initial
<a href="#state"><code>State</code></a>.</p>

<p>All arguments are optional. If only one <code>object</code>-typed argument is provided,
it is assigned to the <code>expression</code> parameter. If no <code>owner</code> is present,
<code>state</code> returns a <code>StateExpression</code> based on the contents of <code>expression</code>
(and <code>attributes</code>). If both an <code>owner</code> and <code>expression</code> are present, <code>state</code>
acts in the second capacity, causing <code>owner</code> to become stateful. The
<code>attributes</code> argument may include any of the words defined in
<a href="#module--constants--state-attribute-modifiers"><code>STATE_ATTRIBUTE_MODIFIERS</code></a>,
which are encoded into the provided <code>expression</code>.</p>

<p><em>See also:</em>
<a href="#state"><code>State</code></a>, <a href="#module--constants--state-attributes"><code>STATE_ATTRIBUTES</code></a>,
<a href="#state-expression"><code>StateExpression</code></a>, <a href="#state-controller"><code>StateController</code></a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">state</span> <span class="p">(</span>
                      <span class="cm">/*Object*/</span> <span class="nx">owner</span><span class="p">,</span>      <span class="c1">// optional</span>
                      <span class="cm">/*String*/</span> <span class="nx">attributes</span><span class="p">,</span> <span class="c1">// optional</span>
    <span class="cm">/*StateExpression | Object*/</span> <span class="nx">expression</span><span class="p">,</span> <span class="c1">// optional</span>
             <span class="cm">/*Object | String*/</span> <span class="nx">options</span>     <span class="c1">// optional</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">owner</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">expression</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">owner</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">;</span>
            <span class="nx">expression</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">;</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">;</span>
            <span class="nx">owner</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">;</span>
            <span class="nx">expression</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">;</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nx">expression</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>

    <span class="k">return</span> <span class="nx">owner</span> <span class="o">?</span>
        <span class="k">new</span> <span class="nx">StateController</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">options</span> <span class="p">).</span><span class="nx">current</span><span class="p">()</span> <span class="o">:</span>
        <span class="nx">expression</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">meta</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><a class="icon-link" name="module--constants" href="#module--constants"></a></p>

<h3>Module-level constants</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes"
   href="#module--constants--state-attributes"></a></p>

<h4>State attributes</h4>

<p>Attribute values are stored as a bit field in a <a href="#state"><code>State</code></a> instance.
Most attributes enumerated here also correspond with a
<a href="#module--constants--state-attribute-modifiers">modifier</a>
keyword that can be included in a call to <a href="#module"><code>state()</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">STATE_ATTRIBUTES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">NORMAL</span>      <span class="o">:</span> <span class="mh">0x0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--virtual"
   href="#module--constants--state-attributes--virtual"></a></p>

<h5>virtual</h5>

<p>A <strong>virtual state</strong> is a lightweight inheritor of a <strong>protostate</strong>
located higher in the owner object’s prototype chain. Notably, as
virtual states are created automatically, no modifier keyword exists
for the <code>virtual</code> attribute.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">VIRTUAL</span>     <span class="o">:</span> <span class="mh">0x1</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--mutable"
   href="#module--constants--state-attributes--mutable"></a></p>

<h5>mutable</h5>

<p>By default, states are <strong>weakly immutable</strong>; i.e., once a <code>State</code> has
been constructed, its declared data, methods, guards, substates, and
transitions cannot be altered. By including the <code>mutable</code> attribute in
the state’s expression, this restriction is lifted. Mutability is also
inherited from any of a state’s superstates or protostates.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">MUTABLE</span>     <span class="o">:</span> <span class="mh">0x2</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--finite"
   href="#module--constants--state-attributes--finite"></a></p>

<h5>finite</h5>

<p>If a state is declared <code>finite</code>, no substates or descendant states may
be added, nor may any be removed without also destroying the state
itself.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">FINITE</span>      <span class="o">:</span> <span class="mh">0x4</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--static"
   href="#module--constants--state-attributes--static"></a></p>

<h5>static</h5>

<p>If a state is declared <code>static</code>, none of its contents may be changed
except for its substates.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">STATIC</span>      <span class="o">:</span> <span class="mh">0x8</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--immutable"
   href="#module--constants--state-attributes--immutable"></a></p>

<h5>immutable</h5>

<p>Adding the <code>immutable</code> attribute causes a state to become <strong>strongly
immutable</strong>, wherein it guarantees immutability absolutely, throughout
all inheriting states, overriding and negating any included or inherited
<code>mutable</code> attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">IMMUTABLE</span>   <span class="o">:</span> <span class="mh">0x10</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--initial"
   href="#module--constants--state-attributes--initial"></a></p>

<h5>initial</h5>

<p>Marking a state <code>initial</code> specifies which state a newly stateful object
should assume.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">INITIAL</span>     <span class="o">:</span> <span class="mh">0x20</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--conclusive"
   href="#module--constants--state-attributes--conclusive"></a></p>

<h5>conclusive</h5>

<p>Once a state marked <code>conclusive</code> is entered, it cannot be exited,
although transitions may still freely traverse within its substates.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">CONCLUSIVE</span>  <span class="o">:</span> <span class="mh">0x40</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--final"
   href="#module--constants--state-attributes--final"></a></p>

<h5>final</h5>

<p>Once a state marked <code>final</code> is entered, no further outbound transitions
within its local region are allowed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">FINAL</span>       <span class="o">:</span> <span class="mh">0x80</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--abstract"
   href="#module--constants--state-attributes--abstract"></a></p>

<h5>abstract</h5>

<p>An <code>abstract</code> state is used only as a source of inheritance, and cannot
itself be current. Consequently a transition that targets an abstract
state will be automatically redirected to one of its substates.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ABSTRACT</span>    <span class="o">:</span> <span class="mh">0x100</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--default"
   href="#module--constants--state-attributes--default"></a></p>

<h5>default</h5>

<p>Marking a state <code>default</code> designates it as the actual target for any
transition that targets its abstract superstate.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">DEFAULT</span>     <span class="o">:</span> <span class="mh">0x200</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--reflective"
   href="#module--constants--state-attributes--reflective"></a></p>

<h5>reflective</h5>

<p>A state marked <code>reflective</code> copies or “reflects” its properties onto
the owner whenever it becomes active. If the state is <code>mutable</code>, then
before it becomes inactive again it will “soak” into itself any new
properties that were added or changed on the owner while the state was
active.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">REFLECTIVE</span>  <span class="o">:</span> <span class="mh">0x400</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--history"
   href="#module--constants--state-attributes--history"></a></p>

<h5>history</h5>

<p>Marking a state with the <code>history</code> attribute causes its internal state
to be recorded in a sequential <strong>history</strong>. Whereas a <code>retained</code> state
is concerned only with the most recent internal state, a state’s history
can be traversed and altered, resulting in transitions back or forward
to previously or subsequently held internal states.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">HISTORY</span>     <span class="o">:</span> <span class="mh">0x800</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--retained"
   href="#module--constants--state-attributes--retained"></a></p>

<h5>retained</h5>

<p>A <code>retained</code> state is one that preserves its own internal state, such
that, after the state has become no longer active, a subsequent
transition targeting that particular state will automatically be
redirected to whichever of its descendant states was most recently
current.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">RETAINED</span>    <span class="o">:</span> <span class="mh">0x1000</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attributes--shallow"
   href="#module--constants--state-attributes--shallow"></a></p>

<h5>shallow</h5>

<p>Normally, states that are <code>retained</code> or that keep a <code>history</code> persist
their internal state <em>deeply</em>, i.e., with a scope extending over all of
the state’s descendant states. Marking a state <code>shallow</code> limits the
scope of its persistence to its immediate substates only.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">SHALLOW</span>     <span class="o">:</span> <span class="mh">0x2000</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h5>versioned</h5>

<p>Would cause alterations to a state to result in a reflexive transition,
with a delta object distinguishing the prior version of the state from
its new version. Should also add a history entry wherever appropriate,
representing the prior version and the delta.
<em>(Reserved; not presently implemented.)</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">VERSIONED</span>   <span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h5>concurrent</h5>

<p>In a state marked <code>concurrent</code>, the substates are considered
<strong>concurrent orthogonal regions</strong>. Upon entering a concurrent state,
the controller creates a new set of subcontrollers, one for each region,
which will exist as long as the concurrent state remains active. Method
calls are forwarded to at most one of the regions, or if a reduction
function is associated with the given method, the call is repeated for
each region and the results reduced accordingly on their way back to the
owner.
<em>(Reserved; not presently implemented.)</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">CONCURRENT</span>  <span class="o">:</span> <span class="mh">0x4000</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-attribute-modifiers"
   href="#module--constants--state-attribute-modifiers"></a></p>

<h4>State attribute modifiers</h4>

<p>The subset of attributes that are valid keywords for the <code>attributes</code>
argument in a call to the exported <a href="#module"><code>state</code></a> function.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">STATE_ATTRIBUTE_MODIFIERS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;mutable finite static immutable&#39;</span><span class="p">,</span>
        <span class="s1">&#39;initial conclusive final&#39;</span><span class="p">,</span>
        <span class="s1">&#39;abstract default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;reflective&#39;</span><span class="p">,</span>
        <span class="s1">&#39;history retained shallow versioned&#39;</span><span class="p">,</span>
        <span class="s1">&#39;concurrent&#39;</span>
    <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-expression-categories"
   href="#module--constants--state-expression-categories"></a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">STATE_EXPRESSION_CATEGORIES</span> <span class="o">=</span>
        <span class="s1">&#39;data methods events guards states transitions&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--state-event-types"
   href="#module--constants--state-event-types"></a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">STATE_EVENT_TYPES</span> <span class="o">=</span>
        <span class="s1">&#39;construct depart exit enter arrive destroy mutate noSuchMethod&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--guard-actions"
   href="#module--constants--guard-actions"></a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">GUARD_ACTIONS</span> <span class="o">=</span>
        <span class="s1">&#39;admit release&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--transition-properties"
   href="#module--constants--transition-properties"></a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">TRANSITION_PROPERTIES</span> <span class="o">=</span>
        <span class="s1">&#39;origin source target action conjugate&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--transition-expression-categories"
   href="#module--constants--transition-expression-categories"></a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">TRANSITION_EXPRESSION_CATEGORIES</span> <span class="o">=</span>
        <span class="s1">&#39;methods events guards&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--transition-event-types"
   href="#module--constants--transition-event-types"></a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">TRANSITION_EVENT_TYPES</span> <span class="o">=</span>
        <span class="s1">&#39;construct destroy enter exit start end abort&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>The <a href="#module"><code>state</code></a> module is exported via CommonJS on the server, and
globally in the browser.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">server</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">exports</span> <span class="o">=</span> <span class="nx">state</span> <span class="p">);</span>
<span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">client</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">global</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p><a class="icon-link"
   name="module--constants--module"
   href="#module--constants--module"></a></p>

<h4>module</h4>

<p>References or creates a unique object visible only within the lexical scope
of this module.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">__MODULE__</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">server</span> <span class="o">?</span> <span class="nx">module</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">exports</span><span class="o">:</span> <span class="nx">state</span> <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h2>State <a class="icon-link" name="state" href="#state"></a></h2>

<p>A <strong>state</strong> models a set of behaviors on behalf of an owner object. The
owner may undergo <strong>transitions</strong> that change its <strong>current</strong> state from
one to another, and in so doing adopt a different set of behaviors.</p>

<p>Distinct behaviors are modeled in each state by defining a set of method
overrides, to which calls made on the owner will be redirected so long as a
state remains current.</p>

<p>States are structured as a rooted tree, where <strong>substates</strong> inherit from a
single <strong>superstate</strong>. While a substate is current, it and all of its
ancestor superstates are considered to be <strong>active</strong>.</p>

<p>In addition, a state also recognizes the owner object’s prototypal
inheritance, identifying an identically named and positioned state in the
prototype as its <strong>protostate</strong>. Stateful behavior is inherited <em>from
protostates first</em>, then from superstates.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--__pre.js"
   href="#state--__pre.js"></a></p>

<h3><code>state/__pre.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">State</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

<span class="kd">var</span> <span class="nx">SA</span> <span class="o">=</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">,</span>
    
    <span class="nx">NORMAL</span>      <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">,</span>
    <span class="nx">VIRTUAL</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">VIRTUAL</span><span class="p">,</span>
    <span class="nx">MUTABLE</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">MUTABLE</span><span class="p">,</span>
    <span class="nx">FINITE</span>      <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">FINITE</span><span class="p">,</span>
    <span class="nx">STATIC</span>      <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">STATIC</span><span class="p">,</span>
    <span class="nx">IMMUTABLE</span>   <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">IMMUTABLE</span><span class="p">,</span>
    <span class="nx">INITIAL</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">INITIAL</span><span class="p">,</span>
    <span class="nx">CONCLUSIVE</span>  <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">CONCLUSIVE</span><span class="p">,</span>
    <span class="nx">FINAL</span>       <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">FINAL</span><span class="p">,</span>
    <span class="nx">ABSTRACT</span>    <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">ABSTRACT</span><span class="p">,</span>
    <span class="nx">DEFAULT</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">,</span>
    <span class="nx">REFLECTIVE</span>  <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">REFLECTIVE</span><span class="p">,</span>
    <span class="nx">HISTORY</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">HISTORY</span><span class="p">,</span>
    <span class="nx">RETAINED</span>    <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">RETAINED</span><span class="p">,</span>
    <span class="nx">SHALLOW</span>     <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">SHALLOW</span><span class="p">,</span>
    <span class="nx">CONCURRENT</span>  <span class="o">=</span> <span class="nx">SA</span><span class="p">.</span><span class="nx">CONCURRENT</span><span class="p">,</span>

    <span class="nx">PROTOSTATE_HERITABLE_ATTRIBUTES</span> <span class="o">=</span>
        <span class="nx">MUTABLE</span>     <span class="o">|</span>  <span class="nx">FINITE</span>      <span class="o">|</span>  <span class="nx">STATIC</span>     <span class="o">|</span>  <span class="nx">IMMUTABLE</span>  <span class="o">|</span>
        <span class="nx">INITIAL</span>     <span class="o">|</span>  <span class="nx">CONCLUSIVE</span>  <span class="o">|</span>  <span class="nx">FINAL</span>      <span class="o">|</span>
        <span class="nx">ABSTRACT</span>    <span class="o">|</span>  <span class="nx">DEFAULT</span>     <span class="o">|</span>
        <span class="nx">REFLECTIVE</span>  <span class="o">|</span>
        <span class="nx">HISTORY</span>     <span class="o">|</span>  <span class="nx">RETAINED</span>    <span class="o">|</span>  <span class="nx">SHALLOW</span>    <span class="o">|</span>
        <span class="nx">CONCURRENT</span>
    <span class="p">;</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">,</span> <span class="nx">SA</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--constructor.js"
   href="#state--constructor.js"></a></p>

<h3><code>state/constructor.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--constructor"
   href="#state--constructor"></a></p>

<h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">State</span> <span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">controller</span><span class="p">,</span> <span class="nx">superstateAttributes</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span>
        <span class="nx">protostateAttributes</span><span class="p">;</span>

    <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">expression</span> <span class="o">&amp;&amp;</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||</span> <span class="nx">NORMAL</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h4>name</h4>

<p>Returns the local name of this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">stringFunction</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="p">}</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>A root state is created by a <a href="#state-controller"><code>StateController</code></a>,
which passes a reference to itself into the <code>superstate</code> parameter,
signaling that a <code>controller</code> method closing over the reference needs to
be created for this instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="k">instanceof</span> <span class="nx">StateController</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">controller</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">;</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">controller</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="nx">controller</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Otherwise this state is an inheritor of an existing superstate.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span> <span class="o">=</span> <span class="nx">privileged</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(</span> <span class="nx">superstate</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>The <code>mutable</code> and <code>finite</code> attributes are inherited from the
superstate.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">superstateAttributes</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">attributes</span><span class="p">();</span>
        <span class="nx">attributes</span> <span class="o">|=</span> <span class="nx">superstateAttributes</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="nx">MUTABLE</span> <span class="o">|</span> <span class="nx">FINITE</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>The set of “protostate-heritable” attributes are inherited from the
protostate.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">protostateAttributes</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">attributes</span><span class="p">();</span>
        <span class="nx">attributes</span> <span class="o">|=</span> <span class="nx">protostateAttributes</span> <span class="o">&amp;</span> <span class="nx">PROTOSTATE_HERITABLE_ATTRIBUTES</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Literal or inherited <code>immutable</code> is an absolute contradiction of
<code>mutable</code> and implication of <code>finite</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">attributes</span> <span class="o">|=</span> <span class="p">(</span> <span class="nx">superstateAttributes</span> <span class="o">|</span> <span class="nx">protostateAttributes</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="nx">IMMUTABLE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">IMMUTABLE</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">attributes</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nx">MUTABLE</span><span class="p">;</span>
        <span class="nx">attributes</span> <span class="o">|=</span> <span class="nx">FINITE</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Only a few instance methods are required for a virtual state,
including one (<a href="#state--privileged--realize"><code>realize</code></a>) method which
if called later will convert the virtual state into a real state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="nx">privileged</span><span class="p">.</span><span class="nx">attributes</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">realize</span> <span class="o">=</span> <span class="nx">privileged</span><span class="p">.</span><span class="nx">realize</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">);</span>
        <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">mutableVirtualMethods</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>For a real state, the remainder of construction is delegated to the
class-private <a href="#state--private--realize"><code>realize</code></a> function.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">realize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Additional property assignments for easy viewing in the inspector.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">[</span><span class="s1">&#39; &lt;owner&gt;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
        <span class="k">this</span><span class="p">[</span><span class="s1">&#39; &lt;path&gt;&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">[</span><span class="s1">&#39;&lt;attr&gt;&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="nx">StateExpression</span><span class="p">.</span><span class="nx">decodeAttributes</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">privileged</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--core.js"
   href="#state--core.js"></a></p>

<h3><code>state/core.js</code></h3>

<p>Methods for initializing and properly destroying a <code>State</code> instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--init"
   href="#state--privileged--init"></a></p>

<h4>init</h4>

<p>Builds out the state’s members based on the expression provided.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Function*/</span> <span class="nx">expressionConstructor</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*&lt;expressionConstructor&gt; | Object*/</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">__initializing__</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">mutate</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">);</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">__initializing__</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;construct&#39;</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--destroy"
   href="#state--privileged--destroy"></a></p>

<h4>destroy</h4>

<p>Attempts to cleanly destroy this state and all of its substates.
A <code>destroy</code> event is issued to each state after it is destroyed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">setSuperstate</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span>
                <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">(),</span>
                <span class="nx">owner</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">(),</span>
                <span class="nx">transition</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">transition</span><span class="p">(),</span>
                <span class="nx">origin</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">delegator</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">stateName</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>If a transition is underway that involves this state, then the
state cannot be destroyed.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">origin</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span><span class="p">();</span>
                <span class="nx">target</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">target</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">target</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Descendant states are destroyed bottom-up.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span> <span class="nx">stateName</span> <span class="k">in</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">stateName</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">].</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p><code>destroy</code> is the final event emitted.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">].</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="k">delete</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>The state must remove itself from its superstate.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>A mutable superstate has a <code>removeSubstate</code> method already
available.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">isMutable</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">superstate</span><span class="p">.</span><span class="nx">removeSubstate</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>An immutable superstate must be peeked to acquire a
<code>removeSubstate</code> method.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">privileged</span><span class="p">.</span><span class="nx">removeSubstate</span><span class="p">(</span>
                        <span class="nx">superstate</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span> <span class="nx">__MODULE__</span><span class="p">,</span> <span class="s1">&#39;attributes&#39;</span> <span class="p">),</span>
                        <span class="nx">superstate</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span> <span class="nx">__MODULE__</span><span class="p">,</span> <span class="s1">&#39;substates&#39;</span> <span class="p">)</span>
                    <span class="p">).</span><span class="nx">call</span><span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>When the root state is destroyed, the owner gets back its
original methods, and the corresponding delegator for each such
method is destroyed.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">methodName</span> <span class="k">in</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">delegator</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                    <span class="nx">method</span> <span class="o">=</span> <span class="nx">delegator</span><span class="p">.</span><span class="nx">original</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">delete</span> <span class="nx">delegator</span><span class="p">.</span><span class="nx">original</span><span class="p">;</span>
                        <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">delete</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>The <code>destroy</code> call is propagated to the root’s controller,
unless the controller itself instigated the call, in which
case its own <code>destroy</code> method will already have been removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">controller</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">&amp;&amp;</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="nx">setSuperstate</span><span class="p">(</span> <span class="kc">undefined</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>A flag is set that can be observed later by anything retaining a
reference to this state (e.g. a memoization) which would be
withholding it from being garbage-collected. A well-behaved
retaining entity should check this flag as necessary to reassert
the validity of its reference, and discard the reference after it
observes <code>destroyed</code> to have been set to <code>true</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">destroyed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="kc">false</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--internal.js"
   href="#state--internal.js"></a></p>

<h3><code>state/internal.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--peek"
   href="#state--privileged--peek"></a></p>

<h4>peek</h4>

<p>Exposes private entities to code within the same module-level lexical
scope. Callers must authenticate themselves as internal by providing a
<code>referenceToModule</code> that matches the closed unique module-scoped object
<a href="#module--constants--module"><code>__MODULE__</code></a> (which in a CommonJS environment
is equivalent to the standard <code>module</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">peek</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*Function*/</span> <span class="nx">expressionConstructor</span><span class="p">,</span>
          <span class="cm">/*Number*/</span> <span class="nx">attributes</span><span class="p">,</span>
          <span class="cm">/*Object*/</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">transitions</span><span class="p">,</span>
    <span class="cm">/*StateHistory*/</span> <span class="nx">history</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">members</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">expressionConstructor</span><span class="o">:</span> <span class="nx">expressionConstructor</span><span class="p">,</span>
            <span class="nx">attributes</span><span class="o">:</span> <span class="nx">attributes</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
            <span class="nx">methods</span><span class="o">:</span> <span class="nx">methods</span><span class="p">,</span>
            <span class="nx">events</span><span class="o">:</span> <span class="nx">events</span><span class="p">,</span>
            <span class="nx">guards</span><span class="o">:</span> <span class="nx">guards</span><span class="p">,</span>
            <span class="nx">substates</span><span class="o">:</span> <span class="nx">substates</span><span class="p">,</span>
            <span class="nx">transitions</span><span class="o">:</span> <span class="nx">transitions</span><span class="p">,</span>
            <span class="nx">history</span><span class="o">:</span> <span class="nx">history</span>
        <span class="p">};</span>

    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*&lt;module&gt;*/</span> <span class="nx">referenceToModule</span><span class="p">,</span>
          <span class="cm">/*String*/</span> <span class="nx">name</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">referenceToModule</span> <span class="o">!==</span> <span class="nx">__MODULE__</span> <span class="p">)</span> <span class="k">throw</span> <span class="nx">ReferenceError</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">name</span> <span class="o">?</span> <span class="nx">members</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">members</span> <span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peek</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--virtualization.js"
   href="#state--virtualization.js"></a></p>

<h3><code>state/virtualization.js</code></h3>

<p>Methods for realizing an incipient or virtual <code>State</code> instance.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--private--realize"
   href="#state--private--realize"></a></p>

<h4>realize</h4>

<p>Continues construction of an incipient <a href="#state"><code>State</code></a>, or equivalently,
converts a virtual state into a <em>real</em> state.</p>

<p>Much of the initialization for <code>State</code> is offloaded from the
<a href="#state--constructor">constructor</a>, allowing for creation of lightweight
virtual <code>State</code> instances that inherit all of their functionality from
protostates, but can also be converted at some later time to a real <code>State</code>
if necessary.</p>

<p><em>See also:</em>
<a href="#state--constructor"><code>State constructor</code></a>,
<a href="#state-controller--private--virtualize"><code>StateController virtualize</code></a>,
<a href="#state--privileged--realize"><code>State.privileged.realize</code></a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">realize</span> <span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">addMethod</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span>
        <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>The real state’s private variables and collections.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">data</span>        <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">methods</span>     <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">events</span>      <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">guards</span>      <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">substates</span>   <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">transitions</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">history</span>     <span class="o">=</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">HISTORY</span> <span class="o">||</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">RETAINED</span> <span class="o">?</span>
            <span class="k">new</span> <span class="nx">StateHistory</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="o">:</span>
            <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Method names are mapped to specific local variables. The named
methods are created on <code>this</code>, each of which is a partial application
of its corresponding method factory at
<a href="#state--privileged"><code>State.privileged</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Z</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;peek express mutate&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">StateExpression</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span>
            <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">transitions</span><span class="p">,</span> <span class="nx">history</span> <span class="p">],</span>
        <span class="s1">&#39;superstate&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">superstate</span> <span class="p">],</span>
        <span class="s1">&#39;attributes&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">attributes</span> <span class="p">],</span>
        <span class="s1">&#39;data&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">attributes</span> <span class="o">|</span> <span class="nx">MUTABLE</span><span class="p">,</span> <span class="nx">data</span> <span class="p">],</span>
        <span class="s1">&#39;method methodNames addMethod removeMethod&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">methods</span> <span class="p">],</span>
        <span class="s1">&#39;event addEvent removeEvent emit&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">events</span> <span class="p">],</span>
        <span class="s1">&#39;guard addGuard removeGuard&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">guards</span> <span class="p">],</span>
        <span class="s1">&#39;substate substates addSubstate removeSubstate&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">attributes</span><span class="p">,</span>
            <span class="nx">substates</span> <span class="p">],</span>
        <span class="s1">&#39;transition transitions addTransition removeTransition&#39;</span> <span class="o">:</span>
            <span class="p">[</span> <span class="nx">transitions</span> <span class="p">],</span>
        <span class="s1">&#39;destroy&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">s</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">s</span><span class="p">;</span> <span class="p">},</span> <span class="nx">methods</span><span class="p">,</span>
            <span class="nx">events</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">]</span>
    <span class="p">});</span>
    <span class="nx">history</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;history push replace&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">history</span> <span class="p">]</span>
    <span class="p">});</span>

    <span class="nx">Z</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">addEvent</span><span class="o">:</span> <span class="s1">&#39;on bind&#39;</span><span class="p">,</span>
        <span class="nx">removeEvent</span><span class="o">:</span> <span class="s1">&#39;off unbind&#39;</span><span class="p">,</span>
        <span class="nx">emit</span><span class="o">:</span> <span class="s1">&#39;trigger&#39;</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>With the instance methods in place, <code>this</code> is now ready to apply
<code>expression</code> to itself.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">privileged</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span> <span class="nx">StateExpression</span> <span class="p">).</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Realizing a root state requires that, for any of the owner’s own
methods for which exist at least one stateful implementation located
higher in its prototype chain, that method must be copied into the
root to define the object’s default behavior.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">superstate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">owner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">addMethod</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">addMethod</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">addMethod</span> <span class="o">=</span> <span class="nx">privileged</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span> <span class="nx">methods</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">owner</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">method</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">method</span><span class="p">.</span><span class="nx">isDelegator</span> <span class="o">&amp;&amp;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="nx">addMethod</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">method</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>If the state is <code>finite</code> or non-<code>mutable</code>, then the appropriate
mutation methods used during construction/realization can no longer
be used, and must be removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="s1">&#39;mutate addMethod removeMethod addGuard removeGuard \</span>
<span class="s1">            addTransition removeTransition&#39;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">),</span>
            <span class="kd">function</span> <span class="p">(</span> <span class="nx">m</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">delete</span> <span class="nx">self</span><span class="p">[</span> <span class="nx">m</span> <span class="p">];</span>
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>An exception is <code>data</code>, which must be rewritten rather than removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">||</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">FINITE</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">addSubstate</span><span class="p">;</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">removeSubstate</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Non-<code>mutable</code> and <code>finite</code> requires a special implementation of
<code>mutate</code> that disallows mutations to substates.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">FINITE</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mutate</span> <span class="o">=</span> <span class="nx">privileged</span><span class="p">.</span><span class="nx">mutate</span><span class="p">(</span> <span class="nx">StateExpression</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span>
            <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">transitions</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>(Exposed for debugging.)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">__private__</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span> <span class="nx">__MODULE__</span> <span class="p">)</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--private--mutable-virtual-methods"
   href="#state--private--mutable-virtual-methods"></a></p>

<h4>mutableVirtualMethods</h4>

<p>A set of methods that will be mixed into mutable virtual states. When
called, these first <a href="#state--private--realize"><code>realize</code></a> the state and
then, provided that realization has successfully produced a new method
of the same name on the instance, invoke that method.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">mutableVirtualMethods</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">names</span> <span class="o">=</span> <span class="s1">&#39;addMethod addEvent addGuard addSubstate addTransition&#39;</span><span class="p">;</span>

    <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">names</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">realizer</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">()[</span> <span class="nx">name</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="o">!==</span> <span class="nx">realizer</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">obj</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">realizer</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--realize"
   href="#state--privileged--realize"></a></p>

<h4>realize</h4>

<p>Transforms a virtual state into a “real” state.</p>

<p>A virtual state is a lightweight <a href="#state"><code>State</code></a> instance whose
purpose is simply to inherit from its protostate. As such virtual states
are weakly bound to a state hierarchy by their reference held at
<code>superstate</code>, and are not proper members of the superstate’s set of
substates. Transforming the state from virtual to real causes it to
exist thereafter as an abiding member of its superstate’s set of
substates.</p>

<p><em>See also:</em> <a href="#state--private--realize"><code>State realize</code></a> </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">realize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span>
            <span class="nx">addSubstate</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="s1">&#39;addSubstate&#39;</span> <span class="p">)</span> <span class="o">?</span>
                <span class="nx">superstate</span><span class="p">.</span><span class="nx">addSubstate</span> <span class="o">:</span>
                <span class="nx">privileged</span><span class="p">.</span><span class="nx">addSubstate</span><span class="p">(</span>
                    <span class="nx">superstate</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span> <span class="nx">__MODULE__</span><span class="p">,</span> <span class="s1">&#39;attributes&#39;</span> <span class="p">),</span>
                    <span class="nx">superstate</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span> <span class="nx">__MODULE__</span><span class="p">,</span> <span class="s1">&#39;substates&#39;</span> <span class="p">)</span>
                <span class="p">);</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">addSubstate</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">superstate</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">(),</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">realize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="o">~</span><span class="nx">VIRTUAL</span><span class="p">,</span>
                <span class="nx">expression</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">realize</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">getThis</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--expression.js"
   href="#state--expression.js"></a></p>

<h3><code>state/expression.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--express"
   href="#state--privileged--express"></a></p>

<h4>express</h4>

<p>Returns an expression of the state of <code>this</code> state — a snapshot of <code>this</code>
state’s current contents.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">express</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">clone</span> <span class="p">(</span> <span class="nx">obj</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">obj</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="p">(</span> <span class="nx">out</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">)[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span>
                <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">?</span>
                    <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">obj</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">)</span> <span class="o">:</span>
                    <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">cloneEvents</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">events</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span> <span class="nx">out</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">)[</span> <span class="nx">type</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">items</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">recurse</span> <span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">typed</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">substates</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">substate</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span> <span class="nx">out</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">)[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substate</span><span class="p">.</span><span class="nx">express</span><span class="p">(</span> <span class="nx">typed</span> <span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>By default the returned expression is returned as a plain <code>Object</code>; if
<code>typed</code> is truthy, the expression is a formally typed
<a href="#state-expression"><code>StateExpression</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*Function*/</span> <span class="nx">ExpressionConstructor</span><span class="p">,</span>
          <span class="cm">/*Number*/</span> <span class="nx">attributes</span><span class="p">,</span>
          <span class="cm">/*Object*/</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">transitions</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Boolean*/</span> <span class="nx">typed</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="nx">Z</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="nx">expression</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">attributes</span><span class="o">:</span>  <span class="nx">attributes</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span>        <span class="nx">clone</span><span class="p">(</span> <span class="nx">data</span> <span class="p">),</span>
                <span class="nx">methods</span><span class="o">:</span>     <span class="nx">clone</span><span class="p">(</span> <span class="nx">methods</span> <span class="p">),</span>
                <span class="nx">events</span><span class="o">:</span>      <span class="nx">cloneEvents</span><span class="p">(</span> <span class="nx">events</span> <span class="p">),</span>
                <span class="nx">guards</span><span class="o">:</span>      <span class="nx">clone</span><span class="p">(</span> <span class="nx">guards</span> <span class="p">),</span>
                <span class="nx">states</span><span class="o">:</span>      <span class="nx">recurse</span><span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">typed</span> <span class="p">),</span>
                <span class="nx">transitions</span><span class="o">:</span> <span class="nx">clone</span><span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span>
            <span class="p">});</span>

            <span class="k">return</span> <span class="nx">typed</span> <span class="o">?</span>
                <span class="k">new</span> <span class="nx">ExpressionConstructor</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="o">:</span>
                <span class="nx">expression</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}()</span> <span class="p">);</span>

<span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">express</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--mutation.js"
   href="#state--mutation.js"></a></p>

<h3><code>state/mutation.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--mutate"
   href="#state--privileged--mutate"></a></p>

<h4>mutate</h4>

<p>Transactionally mutates the state by adding, updating, or removing items
as specified by the expression provided in <code>expr</code>. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">mutate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span>
    <span class="cm">/*Function*/</span> <span class="nx">ExpressionConstructor</span><span class="p">,</span>
      <span class="cm">/*Number*/</span> <span class="nx">attributes</span><span class="p">,</span>
      <span class="cm">/*Object*/</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">transitions</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*&lt;expressionConstructor&gt; | Object*/</span> <span class="nx">expr</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">ExpressionConstructor</span> <span class="o">||</span>
            <span class="p">(</span> <span class="nx">expr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressionConstructor</span><span class="p">(</span> <span class="nx">expr</span> <span class="p">)</span> <span class="p">);</span>

        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">NIL</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">NIL</span><span class="p">,</span>
            <span class="nx">before</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">after</span><span class="p">,</span> <span class="nx">delta</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">addMethod</span><span class="p">,</span> <span class="nx">removeMethod</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>The privileged <code>init</code> method uses <code>mutate</code> for the state’s
initial build, but with the resultant <code>mutate</code> event suppressed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__initializing__</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>A snapshot of the <code>before</code> condition of this state is taken,
to be compared later with an <code>after</code> snapshot.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">before</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">express</span><span class="p">();</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>This invocation of <code>mutate</code> utilizes the set of privileged <code>add*</code>
methods, however, since they are being called as part of a single
operation, each must suppress its usual emission of its own
<code>mutate</code> event.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">__atomic__</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Data is already set up to handle differentials that contain <code>NIL</code>
values.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">data</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Methods are stored as a simple key mapping, and
<a href="#state--privileged--add-method"><code>addMethod</code></a> can be used both to
create an entry and to update an existing entry, without any
additional side-effects, so method expressions can simply be
compared against the <code>NIL</code> value.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">methods</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">methods</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">emitter</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">value</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
                <span class="nx">value</span> <span class="o">!==</span> <span class="nx">NIL</span> <span class="o">?</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">:</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">removeMethod</span><span class="p">(</span> <span class="nx">name</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Event listeners for a given event type might be expressed as a
simple <code>Array</code> of items to be added, as a plain <code>Object</code> that
maps items to specific keys in the internal event emitter that
should be updated or deleted, or as an <code>Array</code> that also includes
one or more such <code>Object</code>s.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">events</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span>
                    <span class="nx">eventCollection</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">eventCollection</span> <span class="o">&amp;&amp;</span> <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>If an event emitter object does not already exist for
this event type, then one will be created, so long as
<code>object</code> is expected to contain items to be added.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">eventCollection</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">eventCollection</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="o">=</span>
                        <span class="k">new</span> <span class="nx">StateEventEmitter</span><span class="p">(</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">type</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">items</span> <span class="o">=</span> <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>

                <span class="nx">edit</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
                            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="p">)</span> <span class="p">{</span>
                                <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">key</span> <span class="p">);</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="o">!==</span> <span class="nx">items</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
                                <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">};</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">object</span> <span class="p">);</span>
                    <span class="p">};</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                        <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">edit</span> <span class="o">:</span> <span class="nx">add</span> <span class="p">)(</span> <span class="nx">value</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">edit</span><span class="p">(</span> <span class="nx">object</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span>
                    <span class="nx">eventCollection</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">delete</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">type</span> <span class="p">];</span>
            <span class="p">});</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Guards are stored as simple objects, and altering them causes no
side-effects, so a deep <code>edit</code> is sufficient.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">guards</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">guards</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="s1">&#39;deep&#39;</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">guards</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Substates are instances of <a href="#State"><code>State</code></a>, which are either
created, destroyed, or recursively updated in place, as specified
by <code>expr.states</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">substates</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">states</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">emitter</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">value</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="o">?</span>
                    <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">destroy</span><span class="p">()</span> <span class="o">:</span>
                    <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">mutate</span><span class="p">(</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">addSubstate</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Transitions are instances of
<a href="#transition-expression"><code>TransitionExpression</code></a>, which are
either created, deleted, or replaced, as specified by
<code>expr.transitions</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">transitions</span> <span class="o">&amp;&amp;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">transitions</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">emitter</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">===</span> <span class="nx">NIL</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">delete</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">value</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">addTransition</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Allow <code>add*</code> methods to emit individual <code>mutate</code> events normally.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">__atomic__</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Finally the <code>before</code> snapshot is used to acquire the <code>delta</code> of the
mutation, which is emitted as part of a <code>mutate</code> event.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">before</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">after</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">express</span><span class="p">();</span>
            <span class="nx">delta</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">diff</span><span class="p">(</span> <span class="nx">before</span><span class="p">,</span> <span class="nx">after</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">delta</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;mutate&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">before</span><span class="p">,</span> <span class="nx">after</span> <span class="p">],</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--mutate"
   href="#state--prototype--mutate"></a></p>

<h4>mutate</h4>

<p>By default states are weakly immutable and their contents cannot be
changed. However, a weak-immutable superstate may contain a mutable
substate, to which the corresponding part of a mutation operation can be
forwarded.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mutate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">expr</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span>
        <span class="nx">NIL</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">NIL</span><span class="p">,</span>
        <span class="nx">substates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">substates</span><span class="p">(),</span>
        <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">states</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">emitter</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">!==</span> <span class="nx">NIL</span> <span class="o">&amp;&amp;</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">mutate</span><span class="p">(</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">addSubstate</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--attributes.js"
   href="#state--attributes.js"></a></p>

<h3><code>state/attributes.js</code></h3>

<p>Methods that inspect a state’s attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--attributes"
   href="#state--privileged--attributes"></a></p>

<h4>attributes</h4>

<p>Returns the bit-field representing the state’s attribute flags.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Number*/</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">attributes</span><span class="p">;</span> <span class="p">};</span>
<span class="p">};</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">attributes</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="nx">NORMAL</span> <span class="p">),</span>
    <span class="nx">isVirtual</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isMutable</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nb">isFinite</span><span class="o">:</span>     <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">FINITE</span>     <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isStatic</span><span class="o">:</span>     <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">STATIC</span>     <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isImmutable</span><span class="o">:</span>  <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">IMMUTABLE</span>  <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isInitial</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">INITIAL</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isConclusive</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">CONCLUSIVE</span> <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isFinal</span><span class="o">:</span>      <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">FINAL</span>      <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isAbstract</span><span class="o">:</span>   <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">ABSTRACT</span>   <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isDefault</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">DEFAULT</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isReflective</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">REFLECTIVE</span> <span class="p">);</span> <span class="p">},</span>
    <span class="nx">hasHistory</span><span class="o">:</span>   <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">HISTORY</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isRetained</span><span class="o">:</span>   <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">RETAINED</span>   <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isShallow</span><span class="o">:</span>    <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">SHALLOW</span>    <span class="p">);</span> <span class="p">},</span>
    <span class="nx">isConcurrent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nx">CONCURRENT</span> <span class="p">);</span> <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--model.js"
   href="#state--model.js"></a></p>

<h3><code>state/model.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--superstate"
   href="#state--privileged--superstate"></a></p>

<h4>superstate</h4>

<p>Returns the immediate superstate, or the nearest state in the superstate
chain with the provided <code>stateName</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">superstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State*/</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*String*/</span> <span class="nx">stateName</span> <span class="c1">// optional</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">stateName</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span>
                <span class="nx">superstate</span>
                <span class="o">:</span>
                <span class="nx">superstate</span> <span class="o">?</span>
                    <span class="nx">stateName</span> <span class="o">?</span>
                        <span class="nx">superstate</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="o">===</span> <span class="nx">stateName</span> <span class="o">?</span>
                            <span class="nx">superstate</span> <span class="o">:</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(</span> <span class="nx">stateName</span> <span class="p">)</span>
                        <span class="o">:</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">().</span><span class="nx">root</span><span class="p">()</span>
                    <span class="o">:</span>
                    <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--owner"
   href="#state--prototype--owner"></a></p>

<h4>owner</h4>

<p>Gets the owner object to which this state’s controller belongs.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">owner</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--controller"
   href="#state--prototype--controller"></a></p>

<h4>controller</h4>

<p>Gets the <a href="#state-controller"><code>StateController</code></a> to which this state
belongs.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">controller</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--root"
   href="#state--prototype--root"></a></p>

<h4>root</h4>

<p>Gets the root state, i.e. the top-level superstate of this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">root</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--superstate"
   href="#state--prototype--superstate"></a></p>

<h4>superstate</h4>

<p>The <code>superstate</code> method is overridden for non-root <code>State</code> instances
using <a href="#state--privileged--superstate"><code>State.privileged.superstate</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">superstate</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--derivation"
   href="#state--prototype--derivation"></a></p>

<h4>derivation</h4>

<p>Returns an object array of this state’s superstate chain, starting after
the root state and ending at <code>this</code>. If <code>byName</code> is set to <code>true</code>, a
string array of the states’ names is returned instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">derivation</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Boolean*/</span> <span class="nx">byName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">ss</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">ss</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">ss</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="nx">byName</span> <span class="o">?</span> <span class="nx">s</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">s</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--path"
   href="#state--prototype--path"></a></p>

<h4>path</h4>

<p>Returns this state’s fully qualified name.</p>

<p><em>Alias:</em> <strong>toString</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;path toString&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--depth"
   href="#state--prototype--depth"></a></p>

<h4>depth</h4>

<p>Returns the number of superstates this state has. The root state returns
<code>0</code>, its immediate substates return <code>1</code>, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">depth</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="nx">n</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--common"
   href="#state--prototype--common"></a></p>

<h4>common</h4>

<p>Returns the least common ancestor of <code>this</code> and <code>other</code>. If <code>this</code> is
itself an ancestor of <code>other</code>, or vice versa, that ancestor is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">common</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">other</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">state</span><span class="p">;</span>

        <span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">other</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">other</span> <span class="p">)</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">depth</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">depth</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">state</span> <span class="o">=</span> <span class="nx">other</span><span class="p">;</span> <span class="nx">other</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="nx">other</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">other</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--is"
   href="#state--prototype--is"></a></p>

<h4>is</h4>

<p>Determines whether <code>this</code> is <code>state</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">is</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nx">state</span> <span class="o">===</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--is-in"
   href="#state--prototype--is-in"></a></p>

<h4>isIn</h4>

<p>Determines whether <code>this</code> is or is a substate of <code>state</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">isIn</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nx">state</span> <span class="o">===</span> <span class="k">this</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--has"
   href="#state--prototype--has"></a></p>

<h4>has</h4>

<p>Determines whether <code>this</code> is or is a superstate of <code>state</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">has</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String */</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span> <span class="o">===</span> <span class="nx">state</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--is-superstate-of"
   href="#state--prototype--is-superstate-of"></a></p>

<h4>isSuperstateOf</h4>

<p>Determines whether <code>this</code> is a superstate of <code>state</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">isSuperstateOf</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">superstate</span><span class="p">;</span>
        <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">?</span>
            <span class="k">this</span> <span class="o">===</span> <span class="nx">superstate</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="o">:</span>
            <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--protostate"
   href="#state--prototype--protostate"></a></p>

<h4>protostate</h4>

<p>Returns the <strong>protostate</strong>, the state analogous to <code>this</code> found in the
next object in the owner’s prototype chain that has one. A state
inherits first from its protostates, then from its superstates.</p>

<p>If the owner does not share an analogous
<a href="#state-controller"><code>StateController</code></a> with its prototype, or if no
protostate can be found in the hierarchy of the prototype’s state
controller, then the search is iterated up the prototype chain.</p>

<p>A state and its protostate will always share an identical name and
identical derivation pattern, as will the respective superstates of
both, relative to one another.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">protostate</span><span class="o">:</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">memoize</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">memoizeProtostates</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">memoize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>If <code>destroyed</code> has been set, it means we’re hanging onto
an invalid reference. Removing this method from the
instance will clear the reference for GC. This
invocation can then be relayed back up to
<a href="#state--prototype--protostate"><code>State.prototype.protostate</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">destroyed</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">;</span>
                        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="k">return</span> <span class="nx">protostate</span><span class="p">;</span>
                <span class="p">};</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">derivation</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">),</span>
                <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">(),</span>
                <span class="nx">controllerName</span><span class="p">,</span> <span class="nx">prototype</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="nx">controllerName</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">name</span><span class="p">();</span>
            <span class="nx">prototype</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Returns the root state of the next <code>prototype</code> in the chain.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">s</span><span class="p">;</span>
                <span class="k">return</span> <span class="p">(</span> <span class="nx">prototype</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span> <span class="nx">prototype</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">prototype</span><span class="p">[</span> <span class="nx">controllerName</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">prototype</span> <span class="p">)</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">s</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>
            <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Walk up the prototype chain; starting at each prototype’s root
state, locate the protostate that corresponds to <code>this</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">while</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="nx">next</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">derivation</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">protostate</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="nx">derivation</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">protostate</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Before returning the located protostate, memoize
subsequent lookups with an instance method that closes
over it.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">memoize</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span> <span class="o">=</span> <span class="nx">memoize</span><span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">);</span>

                    <span class="k">return</span> <span class="nx">protostate</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}()</span> <span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--is-protostate-of"
   href="#state--prototype--is-protostate-of"></a></p>

<h4>isProtostateOf</h4>

<p>Determines whether <code>this</code> is a state analogous to <code>state</code> on any object
in the prototype chain of <code>state</code>’s owner.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">isProtostateOf</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*State | String*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">protostate</span><span class="p">;</span>
        <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">?</span>
            <span class="k">this</span> <span class="o">===</span> <span class="nx">protostate</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isProtostateOf</span><span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="o">:</span>
            <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--substates--default-substate"
   href="#state--substates--default-substate"></a></p>

<h4>defaultSubstate</h4>

<p>Returns the first substate marked <code>default</code>, or simply the first
substate. Recursion continues into the protostate only if no local
descendant states are marked <code>initial</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">defaultSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span><span class="p">,</span> <span class="c1">// = true</span>
                       <span class="nx">first</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">substates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">substates</span><span class="p">(),</span>
            <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">substates</span> <span class="o">&amp;&amp;</span> <span class="nx">substates</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
            <span class="nx">protostate</span><span class="p">;</span>

        <span class="nx">first</span> <span class="o">||</span> <span class="nx">l</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isDefault</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">||</span> <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">defaultSubstate</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">first</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">first</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--substates--initial-substate"
   href="#state--substates--initial-substate"></a></p>

<h4>initialSubstate</h4>

<p>Performs a “depth-within-breadth-first” recursive search to locate the
most deeply nested <code>initial</code> state by way of the greatest <code>initial</code>
descendant state. Recursion continues into the protostate only if no
local descendant states are marked <code>initial</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">initialSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span> <span class="c1">// = true</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="p">[</span> <span class="k">this</span> <span class="p">],</span>
            <span class="nx">subject</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">substates</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">.</span><span class="nx">substates</span><span class="p">(</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">state</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isInitial</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">initialSubstate</span><span class="p">(</span> <span class="kc">false</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">state</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">||</span> <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">initialSubstate</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--currency.js"
   href="#state--currency.js"></a></p>

<h3><code>state/currency.js</code></h3>

<p>Methods that inspect or change the owner’s current state.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--current"
   href="#state--prototype--current"></a></p>

<h4>current</h4>

<p>Gets the local controller’s current state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">current</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">().</span><span class="nx">current</span><span class="p">();</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--is-current"
   href="#state--prototype--is-current"></a></p>

<h4>isCurrent</h4>

<p>Returns a <code>Boolean</code> indicating whether <code>this</code> is the owner’s current
state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">isCurrent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--is-active"
   href="#state--prototype--is-active"></a></p>

<h4>isActive</h4>

<p>Returns a <code>Boolean</code> indicating whether <code>this</code> or one of its substates is
the owner’s current state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">isActive</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">current</span> <span class="o">===</span> <span class="k">this</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">current</span> <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--change"
   href="#state--prototype--change"></a></p>

<h4>change</h4>

<p>Forwards a <code>change</code> command to the state’s controller and returns its
result. Calling with no arguments directs the controller to change to
<code>this</code> state.</p>

<p><em>Aliases:</em> <strong>go</strong>, <strong>be</strong></p>

<p><em>See also:</em> <a href="#state-controller--privileged--change"><code>StateController.privileged.change</code></a></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;change go be&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*State | String*/</span> <span class="nx">target</span><span class="p">,</span>  <span class="c1">// optional</span>
                <span class="cm">/*Object*/</span> <span class="nx">options</span>  <span class="c1">// optional</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

        <span class="nx">Z</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">change</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">controller</span><span class="p">,</span>
            <span class="nx">target</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span>
                <span class="nx">arguments</span> <span class="o">:</span>
                <span class="p">[</span> <span class="k">this</span> <span class="p">].</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">arguments</span> <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--change-to"
   href="#state--prototype--change-to"></a></p>

<h4>changeTo</h4>

<p>Calls <code>change</code> without regard to a <code>target</code>’s retained internal state.</p>

<p><em>Alias:</em> <strong>goTo</strong></p>

<p><em>See also:</em> <a href="#state--prototype--change"><code>State.prototype.change</code></a></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;changeTo goTo&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*State | String*/</span> <span class="nx">target</span><span class="p">,</span>
                <span class="cm">/*Object*/</span> <span class="nx">options</span>  <span class="c1">// optional</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nx">target</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">this</span> <span class="p">);</span>
        <span class="nx">options</span> <span class="o">?</span> <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">direct</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">)</span> <span class="o">:</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">direct</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--query.js"
   href="#state--query.js"></a></p>

<h3><code>state/query.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--query"
   href="#state--prototype--query"></a></p>

<h4>query</h4>

<p>Matches a <code>selector</code> string with the state or states it represents,
evaluated first in the context of <code>this</code>, then its substates, and then
its superstates, until all locations in the state tree have been
searched for a match of <code>selector</code>.</p>

<p>Returns the matched <a href="#state"><code>State</code></a>, or an <code>Array</code> containing the set
of matched states. If a state to be tested <code>against</code> is provided, a
<code>Boolean</code> is returned, indicating whether <code>against</code> is the matched state
or is included in the matching set.</p>

<p>Setting <code>descend</code> to <code>false</code> disables recursion through the substates of
<code>this</code>, and likewise setting <code>ascend</code> to <code>false</code> disables the subsequent
recursion through its superstates.</p>

<p><em>Alias:</em> <strong>match</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;query match&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
         <span class="cm">/*String*/</span> <span class="nx">selector</span><span class="p">,</span>
          <span class="cm">/*State*/</span> <span class="nx">against</span><span class="p">,</span> <span class="c1">// optional</span>
        <span class="cm">/*Boolean*/</span> <span class="nx">descend</span><span class="p">,</span> <span class="c1">// = true</span>
        <span class="cm">/*Boolean*/</span> <span class="nx">ascend</span><span class="p">,</span>  <span class="c1">// = true</span>
        <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span> <span class="c1">// = true</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parts</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span>
            <span class="nx">queue</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">against</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">ascend</span> <span class="o">=</span> <span class="nx">descend</span><span class="p">;</span> <span class="nx">descend</span> <span class="o">=</span> <span class="nx">against</span><span class="p">;</span> <span class="nx">against</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">descend</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">descend</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
        <span class="nx">ascend</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">ascend</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
        <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>A few exceptional cases may be resolved early.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">selector</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">against</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">selector</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">against</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">against</span> <span class="o">===</span> <span class="k">this</span> <span class="o">:</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">selector</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">against</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">?</span>
                <span class="nx">against</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">:</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>Absolute wildcard expressions compared against the root state pass
immediately.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">against</span> <span class="o">&amp;&amp;</span> <span class="nx">against</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                <span class="nx">selector</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/^\*+$/</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Pure <code>.</code>/<code>*</code> expressions should not be recursed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">selector</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/^\.*\**$/</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">descend</span> <span class="o">=</span> <span class="nx">ascend</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>If <code>selector</code> is an absolute path, evaluate it from the root state
as a relative path.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;.&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">().</span><span class="nx">query</span><span class="p">(</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">descend</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>An all-<code>.</code> <code>selector</code> must have one <code>.</code> trimmed to parse correctly.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">selector</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="sr">/^(\.+)\.$/</span><span class="p">,</span> <span class="s1">&#39;$1&#39;</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Split <code>selector</code> into tokens, consume the leading empty-string
straight away, then parse the remaining tokens. A <code>cursor</code> reference
to a matching <a href="#state"><code>State</code></a> in the tree is kept, beginning with
the context state (<code>this</code>), and updated as each token is consumed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">parts</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="nx">cursor</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Upon reaching the end of the token stream, return the
<a href="#state"><code>State</code></a> currently referenced by <code>cursor</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">l</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">against</span> <span class="o">?</span> <span class="nx">against</span> <span class="o">===</span> <span class="nx">cursor</span> <span class="o">:</span> <span class="nx">cursor</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Consume a token.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">name</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>Interpret a <strong>single wildcard</strong> as any <em>immediate</em> substate of
the <code>cursor</code> state parsed thus far.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">against</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substates</span><span class="p">();</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">cursor</span> <span class="o">===</span> <span class="nx">against</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>Interpret a <strong>double wildcard</strong> as any descendant state of the
<code>cursor</code> state parsed thus far.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;**&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">against</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substates</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">against</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>Empty string, the product of leading/consecutive dots, implies
<code>cursor</code>’s superstate.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>Interpret any other token as an identifier that names a specific
substate of <code>cursor</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>If no matching substate exists, the query fails for this
context.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>If the query has failed, then recursively descend the tree,
breadth-first, and retry the query with a different context.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">descend</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">queue</span> <span class="o">=</span> <span class="p">[</span> <span class="k">this</span> <span class="p">];</span>
            <span class="k">while</span> <span class="p">(</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">substates</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">.</span><span class="nx">substates</span><span class="p">(</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">state</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>The <code>ascend</code> block uses <code>descend</code> to indicate a substate
that has already been searched.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="nx">descend</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

                    <span class="nx">result</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="kc">false</span> <span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>

                    <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>If the query still hasn’t succeeded, then recursively ascend the
tree and retry, but also passing <code>this</code> as a domain to be skipped
during the superstate’s subsequent descent.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">ascend</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">descend</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">,</span>
                <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>If the query still hasn’t succeeded, then retry the query on the
protostate.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">against</span><span class="p">,</span> <span class="nx">descend</span><span class="p">,</span> <span class="nx">ascend</span><span class="p">,</span>
                <span class="kc">true</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>All possibilities exhausted; no matches exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">against</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--$"
   href="#state--prototype--$"></a></p>

<h4>$</h4>

<p>Convenience method that either aliases to
<a href="#state--prototype--change"><code>change</code></a> if passed a function for the first
argument, or aliases to <a href="#state--prototype--query"><code>query</code></a> if passed a
string — thereby mimicking the behavior of the object’s accessor method.</p>

<p><em>See also:</em>
<a href="#state-controller--private--create-accessor"><code>StateController createAccessor</code></a></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">$</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">expr</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">method</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">expr</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">args</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">expr</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">expr</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">change</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">expr</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="nx">rxTransitionArrow</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">transitionArrowMethods</span><span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">[</span> <span class="nx">method</span> <span class="p">].</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">]</span>
                    <span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">return</span> <span class="k">this</span><span class="p">[</span> <span class="nx">method</span> <span class="p">](</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--data.js"
   href="#state--data.js"></a></p>

<h3><code>state/data.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--data"
   href="#state--privileged--data"></a></p>

<h4>data</h4>

<p>Either retrieves or edits a block of data associated with this state.</p>

<p><code>data( [Boolean viaSuper], [Boolean viaProto] )</code></p>

<p>Retrieves data attached to this state, including all data from inherited
states, unless specified otherwise by the inheritance flags <code>viaSuper</code>
and <code>viaProto</code>.</p>

<p><code>data( Object edit )</code></p>

<p>Edits data on this state. For keys in <code>edit</code> whose values are set to the
<code>NIL</code> directive, the matching keys in <code>data</code> are deleted. If the
operation results in a change to <code>data</code>, a <code>mutate</code> event is emitted for
this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">data</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*Number*/</span> <span class="nx">attributes</span><span class="p">,</span>
        <span class="cm">/*Object*/</span> <span class="nx">data</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Boolean*/</span> <span class="nx">viaSuper</span><span class="p">,</span> <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">viaSuper</span> <span class="o">!==</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">edit</span> <span class="o">=</span> <span class="nx">viaSuper</span><span class="p">;</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
                <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">edit</span> <span class="o">&amp;&amp;</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">edit</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">().</span><span class="nx">data</span><span class="p">(</span> <span class="nx">edit</span> <span class="p">);</span>
                <span class="p">}</span>
                
                <span class="nx">delta</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">delta</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">edit</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__atomic__</span> <span class="o">&amp;&amp;</span> <span class="nx">delta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">delta</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="s1">&#39;delta&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;mutate&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">edit</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">],</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span>
                    <span class="nx">viaSuper</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">superstate</span><span class="p">.</span><span class="nx">data</span><span class="p">(),</span>
                    <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">protostate</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="kc">false</span> <span class="p">),</span>
                    <span class="nx">data</span>
                <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <h4>reflect</h4>

<p>Copies this state’s <code>data</code> into the owner object, with the exception of
any properties that would collide with the owner’s accessor and
delegator methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">reflect</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">owner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">(),</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">(),</span>
            <span class="nx">key</span><span class="p">,</span> <span class="nx">fn</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">owner</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>Always retain the owner’s accessor method and delegator methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">owner</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">fn</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">fn</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">isDelegator</span> <span class="o">||</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">isAccessor</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">data</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="s1">&#39;absolute delta&#39;</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <h4>soak</h4>

<p>Copies owner properties into this state’s <code>data</code>. Conjugate of
<code>reflect</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">soak</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">copy</span><span class="p">,</span> <span class="nx">diff</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">fn</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isMutable</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="nx">owner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
        <span class="nx">copy</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>Exclude the owner’s accessor method and delegator methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">owner</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">fn</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">fn</span> <span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">fn</span><span class="p">.</span><span class="nx">isDelegator</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">fn</span><span class="p">.</span><span class="nx">isAccessor</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">copy</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>First get a comparison of the state’s existing <code>data</code> to the owner.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">diff</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">diff</span><span class="p">(</span> <span class="nx">copy</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">()</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p><code>soak</code> is non-destructive, so erase the <code>NIL</code>s from <code>diff</code> by
applying it to itself before applying it to the state’s <code>data</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Z</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="s1">&#39;deep&#39;</span><span class="p">,</span> <span class="nx">diff</span><span class="p">,</span> <span class="nx">diff</span> <span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="nx">diff</span> <span class="p">);</span>

        <span class="k">return</span> <span class="nx">diff</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--methods.js"
   href="#state--methods.js"></a></p>

<h3><code>state/methods.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">rootNoop</span> <span class="p">()</span> <span class="p">{}</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--method"
   href="#state--privileged--method"></a></p>

<h4>method</h4>

<p>Retrieves the named method held on this state. If no method is found,
step through this state’s protostate chain to find one. If no method is
found there, step up the superstate hierarchy and repeat the search.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">method</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
             <span class="cm">/*String*/</span> <span class="nx">methodName</span><span class="p">,</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaSuper</span><span class="p">,</span>    <span class="c1">// = true</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span><span class="p">,</span>    <span class="c1">// = true</span>
             <span class="cm">/*Object*/</span> <span class="nx">out</span>          <span class="c1">// optional</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">superstate</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">method</span><span class="p">;</span>

            <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>

            <span class="nx">methods</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">!==</span> <span class="nx">rootNoop</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">out</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">out</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="nx">out</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">method</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">out</span> <span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">out</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">out</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span> <span class="p">);</span>
                        <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">method</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">viaProto</span><span class="p">,</span>
                        <span class="nx">out</span> <span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">method</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">out</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">out</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">out</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--method-names"
   href="#state--privileged--method-names"></a></p>

<h4>methodNames</h4>

<p>Returns an <code>Array</code> of names of methods defined for this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">methodNames</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">methods</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--add-method"
   href="#state--privileged--add-method"></a></p>

<h4>addMethod</h4>

<p>Adds a method to this state, which will be callable directly from the
owner, but with its context bound to the state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">addMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <h5>createDelegator</h5>

<p>Creates a function that will serve as a <strong>delegator</strong> method on an
owner object. For each method defined in any of the owner’s states,
a delegator must be created and assigned on the owner itself, at
the <code>methodName</code> key. This delegator then forwards any calls to
<code>methodName</code> to the owner’s current state, which will locate the
appropriate implementation for the method, apply it, and return the
result.</p>

<p>If an owner already has an implementation for a delegated method,
it is copied into the owner’s root state, such that it remains
accessible as the owner’s “default behavior” if none of its active
states contains an implementation for that method.</p>

<p>Stateful methods are applied in the context of the <a href="#state"><code>State</code></a>
to which they belong, or, if a method is inherited from a
protostate, the context will be the corresponding virtual state
within the local <a href="#state-controller"><code>StateController</code></a>. However,
for any a priori methods relocated to the root state, the context
appropriately remains bound to the owner object.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">createDelegator</span> <span class="p">(</span> <span class="nx">accessorKey</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">original</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">function</span> <span class="nx">delegator</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">[</span> <span class="nx">accessorKey</span> <span class="p">]().</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">delegator</span><span class="p">.</span><span class="nx">isDelegator</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">delegator</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;[delegator]&quot;</span><span class="p">;</span> <span class="p">};</span>
            <span class="p">}</span>

            <span class="nx">original</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">delegator</span><span class="p">.</span><span class="nx">original</span> <span class="o">=</span> <span class="nx">original</span> <span class="p">);</span>

            <span class="k">return</span> <span class="nx">delegator</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span><span class="p">,</span> <span class="cm">/*Function*/</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">(),</span>
                <span class="nx">controllerName</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">name</span><span class="p">(),</span>
                <span class="nx">root</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">(),</span>
                <span class="nx">owner</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">owner</span><span class="p">(),</span>
                <span class="nx">ownerMethod</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>If there is not already a method called <code>methodName</code> in the
state hierarchy, then the owner and controller need to be set up
properly to accommodate calls to this method.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">this</span> <span class="o">!==</span> <span class="nx">root</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="nx">root</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">ownerMethod</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">ownerMethod</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">ownerMethod</span><span class="p">.</span><span class="nx">isDelegator</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">ownerMethod</span> <span class="o">=</span> <span class="nx">rootNoop</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">root</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">ownerMethod</span> <span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>A delegator function is instated on the owner, which will
direct subsequent calls to <code>owner[ methodName ]</code> to the
controller, and then on to the appropriate state’s
implementation.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span>
                    <span class="nx">createDelegator</span><span class="p">(</span> <span class="nx">controllerName</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">ownerMethod</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--remove-method"
   href="#state--privileged--remove-method"></a></p>

<h4>removeMethod</h4>

<p>Dissociates the named method from this state object and returns its
function.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">removeMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">methods</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
            <span class="k">delete</span> <span class="nx">methods</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
            <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">method</span><span class="o">:</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="kc">null</span> <span class="p">),</span>
    <span class="nx">methodNames</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">[];</span> <span class="p">},</span>
    <span class="s1">&#39;addMethod removeMethod&#39;</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--has-method"
   href="#state--prototype--has-method"></a></p>

<h4>hasMethod</h4>

<p>Determines whether <code>this</code> possesses or inherits a method named
<code>methodName</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">hasMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">!==</span> <span class="nx">rootNoop</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--has-own-method"
   href="#state--prototype--has-own-method"></a></p>

<h4>hasOwnMethod</h4>

<p>Determines whether <code>this</code> directly possesses a method named <code>methodName</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">hasOwnMethod</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--apply"
   href="#state--prototype--apply"></a></p>

<h4>apply</h4>

<p>Finds a state method and applies it in the appropriate context. If the
method was originally defined in the owner, the context will be the
owner. Otherwise, the context will either be the state in which the
method is defined, or if the implementation resides in a protostate, the
corresponding state belonging to the inheriting owner. If the named
method does not exist locally and cannot be inherited, a <code>noSuchMethod</code>
event is emitted and the call returns <code>undefined</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">apply</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
        <span class="cm">/*String*/</span> <span class="nx">methodName</span><span class="p">,</span>
         <span class="cm">/*Array*/</span> <span class="nx">args</span>         <span class="c1">// optional</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">ownerMethod</span><span class="p">;</span>

        <span class="nx">out</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">context</span><span class="o">:</span> <span class="kc">undefined</span> <span class="p">};</span>
        <span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">out</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">method</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>Observers may listen for either a general <code>noSuchMethod</code> event,
or one that is specific to a particular method.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;noSuchMethod&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span> <span class="p">]</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;noSuchMethod:&#39;</span> <span class="o">+</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">context</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
        <span class="nx">ownerMethod</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">methodName</span> <span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">ownerMethod</span> <span class="o">&amp;&amp;</span> <span class="nx">ownerMethod</span><span class="p">.</span><span class="nx">original</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">context</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--call"
   href="#state--prototype--call"></a></p>

<h4>call</h4>

<p>Variadic <a href="#state--prototype--apply"><code>apply</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">call</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">methodName</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--events.js"
   href="#state--events.js"></a></p>

<h3><code>state/events.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--event"
   href="#state--privileged--event"></a></p>

<h4>event</h4>

<p>Returns a registered event listener, or the number of listeners
registered, for a given event <code>type</code>.</p>

<p>If an <code>id</code> as returned by <a href="#state--privileged--add-event"><code>addEvent</code></a> is
provided, the event listener associated with that <code>id</code> is returned. If no
<code>id</code> is provided, the number of event listeners registered to <code>type</code> is
returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">event</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                    <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span>
         <span class="cm">/*String | Function*/</span> <span class="nx">id</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">emitter</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">id</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

            <span class="k">typeof</span> <span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">id</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--add-event"
   href="#state--privileged--add-event"></a></p>

<h4>addEvent</h4>

<p>Binds an event listener to the specified <code>eventType</code> and returns a unique
identifier for the listener. Built-in event types are listed at
<code>STATE_EVENT_TYPES</code>.</p>

<p><em>Aliases:</em> <strong>on</strong>, <strong>bind</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">addEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
              <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span>
            <span class="cm">/*Function*/</span> <span class="nx">fn</span><span class="p">,</span>
              <span class="cm">/*Object*/</span> <span class="nx">context</span>    <span class="c1">// = this</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">eventType</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateEventEmitter</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">eventType</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">].</span><span class="nx">add</span><span class="p">(</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--remove-event"
   href="#state--privileged--remove-event"></a></p>

<h4>removeEvent</h4>

<p>Unbinds the event listener with the specified <code>id</code> that was supplied by
<a href="#state--privileged--add-event"><code>addEvent</code></a>.</p>

<p><em>Aliases:</em> <strong>off</strong>, <strong>unbind</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">removeEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span> <span class="cm">/*String*/</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">].</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">id</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--emit"
   href="#state--privileged--emit"></a></p>

<h4>emit</h4>

<p>Invokes all listeners bound to the given event type.</p>

<p>Arguments for the listeners can be passed as an array to the <code>args</code>
parameter.</p>

<p>Callbacks are invoked in the context of <code>this</code>, or as specified by
<code>context</code>.</p>

<p>Callbacks bound to superstates and protostates are also invoked, unless
otherwise directed by setting <code>viaSuper</code> or <code>viaProto</code> to <code>false</code>.</p>

<p><em>Alias:</em> <strong>trigger</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">emit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
             <span class="cm">/*String*/</span> <span class="nx">eventType</span><span class="p">,</span>
              <span class="cm">/*Array*/</span> <span class="nx">args</span><span class="p">,</span>      <span class="c1">// = []</span>
              <span class="cm">/*State*/</span> <span class="nx">context</span><span class="p">,</span>   <span class="c1">// = this</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaSuper</span><span class="p">,</span>  <span class="c1">// = true</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span>   <span class="c1">// = true</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">eventType</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">args</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">viaProto</span> <span class="o">=</span> <span class="nx">viaSuper</span><span class="p">;</span>
                <span class="nx">viaSuper</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
                <span class="nx">context</span> <span class="o">=</span> <span class="nx">args</span><span class="p">;</span>
                <span class="nx">args</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">context</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">viaProto</span> <span class="o">=</span> <span class="nx">viaSuper</span><span class="p">;</span>
                <span class="nx">viaSuper</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
                <span class="nx">context</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="o">!</span><span class="nx">args</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">args</span> <span class="p">]</span> <span class="p">);</span>
            <span class="nx">viaSuper</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaSuper</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>
            <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span>

            <span class="p">(</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">eventType</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="k">this</span> <span class="p">);</span>

            <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="nx">protostate</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="k">this</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

            <span class="nx">viaSuper</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="nx">superstate</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="nx">eventType</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="nx">superstate</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;event addEvent removeEvent emit trigger&#39;</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--guards.js"
   href="#state--guards.js"></a></p>

<h3><code>state/guards.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--guard"
   href="#state--privileged--guard"></a></p>

<h4>guard</h4>

<p>Gets a <strong>guard</strong> entity for this state. A guard is a value or function
that will be evaluated, as either a boolean or predicate, respectively,
to provide a determination of whether a controller will be admitted into
or released from the state to which the guard is applied. Guards are
inherited from protostates, but not from superstates.</p>

<p><em>See also:</em> <a href="#state-controller--private--evaluate-guard"><code>StateController evaluateGuard</code></a></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">guard</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">guards</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">guardType</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

            <span class="k">return</span> <span class="p">(</span>
                <span class="p">(</span> <span class="nx">guard</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">guard</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">protostate</span><span class="p">.</span><span class="nx">guard</span><span class="p">(</span> <span class="nx">guardType</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="kc">undefined</span>
            <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--add-guard"
   href="#state--privileged--add-guard"></a></p>

<h4>addGuard</h4>

<p>Adds a guard to this state, or augments an existing guard with additional
entries.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">addGuard</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">guards</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">guardType</span><span class="p">,</span> <span class="cm">/*Object*/</span> <span class="nx">guard</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span>
                <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">),</span>
                <span class="nx">guard</span>
            <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--remove-guard"
   href="#state--privileged--remove-guard"></a></p>

<h4>removeGuard</h4>

<p>Removes a guard from this state, or removes specific entries from an
existing guard.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">removeGuard</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">guards</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                    <span class="cm">/*String*/</span> <span class="nx">guardType</span>
            <span class="cm">/*Array | String*/</span> <span class="cm">/* keys... */</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">entry</span><span class="p">;</span>

            <span class="nx">guard</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">guard</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span> <span class="k">delete</span> <span class="nx">guards</span><span class="p">[</span> <span class="nx">guardType</span> <span class="p">]</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">guard</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">keys</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">entry</span> <span class="o">=</span> <span class="nx">guard</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="k">delete</span> <span class="nx">guard</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">entry</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;guard addGuard removeGuard&#39;</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--substates.js"
   href="#state--substates.js"></a></p>

<h3><code>state/substates.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--substate"
   href="#state--privileged--substate"></a></p>

<h4>substate</h4>

<p>Retrieves the named substate of <code>this</code> state. If no such substate
exists in the local state, any identically named substate held on a
protostate will be returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">substate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
             <span class="cm">/*String*/</span> <span class="nx">stateName</span><span class="p">,</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">viaProto</span>    <span class="c1">// = true</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
                <span class="nx">ss</span><span class="p">,</span> <span class="nx">protostate</span><span class="p">;</span>

            <span class="nx">viaProto</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">viaProto</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <p>First scan for any virtual substates that are active on the
local controller.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="nx">s</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">ss</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">);</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">ss</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">ss</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">name</span><span class="p">()</span> <span class="o">===</span> <span class="nx">stateName</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">s</span><span class="p">;</span> 
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <p>Otherwise retrieve a real substate, either locally or from a
protostate.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="p">(</span>
                <span class="nx">substates</span> <span class="o">&amp;&amp;</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span>
                    <span class="o">||</span>
                <span class="nx">viaProto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">protostate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">protostate</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="nx">stateName</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="kc">undefined</span>
            <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--substates"
   href="#state--privileged--substates"></a></p>

<h4>substates</h4>

<p>Returns an <code>Array</code> of this state’s substates. If the boolean <code>deep</code>
argument is <code>true</code>, returns a depth-first flattened array containing all
of this state’s descendant states.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">substates</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">deep</span><span class="p">,</span>    <span class="c1">// = false</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">virtual</span>  <span class="c1">// = false</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">s</span><span class="p">,</span> <span class="nx">ss</span><span class="p">,</span> <span class="nx">key</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <p>Include virtual substates, if present.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">virtual</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">s</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">while</span> <span class="p">(</span> <span class="nx">s</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span> <span class="o">!==</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                           <span class="p">(</span> <span class="nx">ss</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span>
                    <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">deep</span> <span class="o">?</span>
                            <span class="nx">result</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="nx">s</span> <span class="p">)</span> <span class="o">:</span>
                            <span class="nx">ss</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="nx">s</span> <span class="p">);</span>
                        <span class="nx">s</span> <span class="o">=</span> <span class="nx">ss</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-176">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-176">&#182;</a>               </div>               <p>Include real substates.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">substates</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">substates</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">deep</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">key</span> <span class="p">].</span><span class="nx">substates</span><span class="p">(</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-177">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-177">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--add-substate"
   href="#state--privileged--add-substate"></a></p>

<h4>addSubstate</h4>

<p>Creates a state from the supplied <code>stateExpression</code> and adds it as a
substate of this state. If a substate with the same <code>stateName</code> already
exists, it is first destroyed and then replaced. If the new substate is
being added to the controller’s root state, a reference is added
directly on the controller itself as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">addSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                                      <span class="cm">/*String*/</span> <span class="nx">stateName</span><span class="p">,</span>
            <span class="cm">/*StateExpression | Object | State*/</span> <span class="nx">stateExpression</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">substate</span><span class="p">,</span> <span class="nx">controller</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">~</span><span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">MUTABLE</span> <span class="p">)</span> <span class="p">{</span>
                <span class="s2">&quot;catch!&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">stateExpression</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">&amp;&amp;</span>
                 <span class="nx">stateExpression</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                 <span class="nx">stateExpression</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span>
                 <span class="nx">stateExpression</span><span class="p">.</span><span class="nx">protostate</span><span class="p">().</span><span class="nx">superstate</span><span class="p">().</span><span class="nx">isProtostateOf</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="s2">&quot;catch!&quot;</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">VIRTUAL</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">realize</span><span class="p">().</span><span class="nx">addSubstate</span><span class="p">(</span> <span class="nx">stateName</span><span class="p">,</span> <span class="nx">stateExpression</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="p">(</span> <span class="nx">substate</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">substate</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>

            <span class="nx">substate</span> <span class="o">=</span> <span class="nx">stateExpression</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">?</span>
                <span class="nx">stateExpression</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">stateExpression</span><span class="p">.</span><span class="nx">realize</span><span class="p">()</span>
                <span class="o">:</span>
                <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">stateName</span><span class="p">,</span> <span class="nx">stateExpression</span> <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">substate</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

            <span class="k">this</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substate</span><span class="p">;</span>

            <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">controller</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">substate</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">substate</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-178">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-178">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--remove-substate"
   href="#state--privileged--remove-substate"></a></p>

<h4>removeSubstate</h4>

<p>Removes the named substate from the local state, if possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">removeSubstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">substates</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">stateName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">controller</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span>
                <span class="nx">substate</span> <span class="o">=</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">substate</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
            <span class="nx">current</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-179">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-179">&#182;</a>               </div>               <p>If a transition is underway involving <code>substate</code>, the removal
will fail.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">transition</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">transition</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
                    <span class="nx">substate</span><span class="p">.</span><span class="nx">isSuperstateOf</span><span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="o">||</span>
                    <span class="nx">substate</span> <span class="o">===</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span><span class="p">()</span> <span class="o">||</span>
                    <span class="nx">substate</span> <span class="o">===</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">target</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-180">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-180">&#182;</a>               </div>               <p>The controller must be forced to evacuate the state before it is
removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="nx">substate</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span> <span class="nx">forced</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="k">delete</span> <span class="nx">substates</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>
            <span class="nx">controller</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="k">delete</span> <span class="nx">controller</span><span class="p">[</span> <span class="nx">stateName</span> <span class="p">];</span>

            <span class="k">return</span> <span class="nx">substate</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;substate substates&#39;</span><span class="o">:</span> <span class="p">[</span> <span class="kc">null</span> <span class="p">]</span>
<span class="p">});</span>
<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;addSubstate removeSubstate&#39;</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-181">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-181">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--transitions.js"
   href="#state--transitions.js"></a></p>

<h3><code>state/transitions.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-182">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-182">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--transition"
   href="#state--privileged--transition"></a></p>

<h4>transition</h4>

<p>Returns the named transition expression held on this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">transition</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">transitionName</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">transitionName</span> <span class="p">];</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-183">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-183">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--transitions"
   href="#state--privileged--transitions"></a></p>

<h4>transitions</h4>

<p>Returns an object containing all of the transition expressions defined
on this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">transitions</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">transitions</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-184">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-184">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--add-transition"
   href="#state--privileged--add-transition"></a></p>

<h4>addTransition</h4>

<p>Registers a transition expression to this state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">addTransition</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                                   <span class="cm">/*String*/</span> <span class="nx">name</span><span class="p">,</span>
            <span class="cm">/*TransitionExpression | Object*/</span> <span class="nx">expression</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="nx">expression</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="o">||</span>
                <span class="p">(</span> <span class="nx">expression</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">);</span>

            <span class="k">return</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-185">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-185">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--remove-transition"
   href="#state--privileged--remove-transition"></a></p>

<h4>removeTransition</h4>

<p>(Not implemented)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">removeTransition</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span>
<span class="p">});</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;transition addTransition removeTransition&#39;</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span>
    <span class="nx">transitions</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{};</span> <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-186">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-186">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--history.js"
   href="#state--history.js"></a></p>

<h3><code>state/history.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-187">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-187">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--history"
   href="#state--privileged--history"></a></p>

<h4>history</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">history</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">history</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">indexDelta</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">indexDelta</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">history</span><span class="p">.</span><span class="nx">express</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">history</span><span class="p">[</span> <span class="nx">history</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">indexDelta</span> <span class="p">];</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-188">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-188">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--push"
   href="#state--privileged--push"></a></p>

<h4>push</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">push</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">history</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">mutation</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>

            <span class="nx">item</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">item</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">item</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">item</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">&amp;&amp;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">item</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">history</span><span class="p">.</span><span class="nx">pushMutation</span><span class="p">(</span> <span class="nx">mutation</span> <span class="o">=</span> <span class="nx">item</span> <span class="p">);</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-189">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-189">&#182;</a>               </div>               <p>While the history-keeping state is inactive, a state-<code>push</code>
should not be propagated to any history-keeping superstates,
whereas a mutation-<code>push</code> should be propagated whether active or
inactive.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isActive</span><span class="p">()</span> <span class="o">||</span> <span class="nx">mutation</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
                <span class="nx">superstate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">historian</span><span class="p">()</span> <span class="p">);</span>
                <span class="nx">superstate</span> <span class="o">&amp;&amp;</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">item</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">old_push</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">history</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">previous</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">flags</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">data</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">;</span>
                <span class="nx">transition</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
                <span class="nx">state</span> <span class="o">=</span> <span class="nx">flags</span><span class="p">;</span>
                <span class="nx">flags</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="nx">flags</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">flags</span> <span class="p">);</span>

            <span class="nx">i</span> <span class="o">=</span> <span class="nx">history</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
            <span class="nx">previous</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

            <span class="nx">i</span> <span class="o">=</span> <span class="nx">history</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">current</span> <span class="o">=</span> <span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">state</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
                <span class="nx">transition</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span> <span class="kc">undefined</span>
            <span class="p">};</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">relative</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">previous</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">current</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">previous</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
                    <span class="nx">previous</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">delta</span><span class="p">(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">current</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">current</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>
                <span class="nx">previous</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">previous</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">diff</span><span class="p">(</span> <span class="nx">previous</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">history</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span> <span class="o">++</span><span class="nx">i</span><span class="p">,</span> <span class="nx">history</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">i</span> <span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">isActive</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">historian</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="nx">superstate</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>

            <span class="mi">1</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isCurrent</span><span class="p">()</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">goTo</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>

            <span class="k">return</span> <span class="nx">history</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-190">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-190">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--privileged--replace"
   href="#state--privileged--replace"></a></p>

<h4>replace</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">replace</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">history</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">item</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">item</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">item</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">item</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">(</span> <span class="nx">item</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">history</span><span class="p">.</span><span class="nx">replaceMutation</span><span class="p">(</span> <span class="nx">item</span> <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">old_replace</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">history</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">previous</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span>
                <span class="nx">i</span> <span class="o">=</span> <span class="nx">history</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span>
                <span class="nx">l</span> <span class="o">=</span> <span class="nx">history</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">flags</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">data</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
                <span class="nx">state</span> <span class="o">=</span> <span class="nx">flags</span><span class="p">;</span>
                <span class="nx">flags</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="nx">flags</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">flags</span> <span class="p">);</span>

            <span class="nx">current</span> <span class="o">=</span> <span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">previous</span> <span class="o">=</span> <span class="nx">history</span><span class="p">[</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">);</span>
            <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">history</span><span class="p">[</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">);</span>

            <span class="nx">current</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
            <span class="nx">delta</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">relative</span> <span class="o">?</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">delta</span> <span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">diff</span> <span class="p">)(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">delta</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">previous</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">previous</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">);</span>
                <span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">next</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">current</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>

            <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">goTo</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>

            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">State</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-191">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-191">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--history"
   href="#state--prototype--history"></a></p>

<h4>history</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">history</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">historian</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">h</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">history</span><span class="p">();</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-192">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-192">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--prototype--historian"
   href="#state--prototype--historian"></a></p>

<h4>historian</h4>

<p>Returns <code>this</code> if it records a history, or else the nearest superstate
that records a deep history.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">historian</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">hasHistory</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span> <span class="nx">s</span><span class="p">;</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">hasHistory</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">isShallow</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">push</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">flags</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">;</span>
            <span class="nx">transition</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
            <span class="nx">state</span> <span class="o">=</span> <span class="nx">flags</span><span class="p">;</span>
            <span class="nx">flags</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">historian</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">historian</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">historian</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-193">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-193">&#182;</a>               </div>               <p>Before delegating to the historian, <code>state</code> must be resolved
locally.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">historian</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">replace</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">historian</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">historian</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">historian</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-194">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-194">&#182;</a>               </div>               <p>Before delegating to the historian, <code>state</code> must be resolved
locally.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">historian</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="cm">/** */</span>
    <span class="nx">pushHistory</span><span class="o">:</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span> <span class="o">&amp;&amp;</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span> <span class="o">?</span>
        <span class="kd">function</span> <span class="p">(</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">urlBase</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">title</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
                <span class="nx">urlBase</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span> <span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span>

    <span class="cm">/** */</span>
    <span class="nx">replaceHistory</span><span class="o">:</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span> <span class="o">&amp;&amp;</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span> <span class="o">?</span>
        <span class="kd">function</span> <span class="p">(</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">urlBase</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">global</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">title</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
                <span class="nx">urlBase</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span> <span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-195">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-195">&#182;</a>               </div>               <p><a class="icon-link"
   name="state--__post.js"
   href="#state--__post.js"></a></p>

<h3><code>state/__post.js</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">return</span> <span class="nx">State</span><span class="p">;</span>

<span class="p">}()</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-196">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-196">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-expression"
   href="#state-expression"></a></p>

<h2>StateExpression</h2>

<p>A <strong>state expression</strong> formalizes a definition of a state’s contents.
States are declared by calling the module’s exported <a href="#module"><code>state()</code></a>
function and passing it an object map containing the definition. This
input may be expressed in a shorthand format, which the
<a href="#state-expression"><code>StateExpression</code></a>
<a href="#state-expression--constructor">constructor</a> rewrites into unambiguous
long form, which can be used later to create <a href="#state"><code>State</code></a> instances.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">StateExpression</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">attributeMap</span> <span class="o">=</span>
            <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_ATTRIBUTE_MODIFIERS</span> <span class="p">),</span>
                <span class="kd">function</span> <span class="p">(</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
                <span class="p">}),</span>

        <span class="nx">attributeFlags</span> <span class="o">=</span>
            <span class="nx">Z</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span> <span class="nx">STATE_ATTRIBUTES</span> <span class="p">),</span>
                <span class="kd">function</span> <span class="p">(</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
                <span class="p">}),</span>

        <span class="nx">categoryMap</span>    <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_EXPRESSION_CATEGORIES</span> <span class="p">),</span>
        <span class="nx">eventTypes</span>     <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_EVENT_TYPES</span> <span class="p">),</span>
        <span class="nx">guardActions</span>   <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">GUARD_ACTIONS</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-197">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-197">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-expression--constructor"
   href="#state-expression--constructor"></a></p>

<h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">StateExpression</span> <span class="p">(</span>
        <span class="cm">/*String | Object*/</span> <span class="nx">attributes</span><span class="p">,</span> <span class="c1">// optional</span>
                 <span class="cm">/*Object*/</span> <span class="nx">map</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">map</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">map</span> <span class="p">)</span> <span class="p">{</span> <span class="nx">map</span> <span class="o">=</span> <span class="p">{};</span> <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">map</span> <span class="p">)</span> <span class="p">{</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">;</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">Z</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="s1">&#39;deep all&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">map</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="o">?</span> <span class="nx">map</span> <span class="o">:</span> <span class="nx">interpret</span><span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">attributes</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
            <span class="nx">map</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">)</span> <span class="o">:</span>
            <span class="nx">Z</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">encodeAttributes</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="nx">attributes</span> <span class="o">||</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-198">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-198">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-expression--class"
   href="#state-expression--class"></a></p>

<h3>Class functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-199">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-199">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-expression--class--encode-attributes"
   href="#state-expression--class--encode-attributes"></a></p>

<h4>encodeAttributes</h4>

<p>Returns the bit-field integer represented by the provided set of
attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">encodeAttributes</span> <span class="p">(</span> <span class="cm">/*Object | String*/</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">attributeMap</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span> <span class="o">|=</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">[</span> <span class="nx">attributeMap</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">StateExpression</span><span class="p">.</span><span class="nx">encodeAttributes</span> <span class="o">=</span> <span class="nx">encodeAttributes</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-200">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-200">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-expression--class--decode-attributes"
   href="#state-expression--class--decode-attributes"></a></p>

<h4>decodeAttributes</h4>

<p>Returns the space-delimited set of attribute names represented by the
provided bit-field integer.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">decodeAttributes</span> <span class="p">(</span> <span class="cm">/*Number*/</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">out</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">attributeFlags</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">attributes</span> <span class="o">&amp;</span> <span class="nx">key</span> <span class="o">&amp;&amp;</span> <span class="nx">out</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">attributeFlags</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">out</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">StateExpression</span><span class="p">.</span><span class="nx">decodeAttributes</span> <span class="o">=</span> <span class="nx">decodeAttributes</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-201">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-201">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-expression--private"
   href="#state-expression--private"></a></p>

<h3>Class-private functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-202">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-202">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-expression--private--interpret"
   href="#state-expression--private--interpret"></a></p>

<h4>interpret</h4>

<p>Transforms a plain object map into a well-formed
<a href="#state-expression"><code>StateExpression</code></a>, making the appropriate
inferences for any shorthand notation encountered.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">interpret</span> <span class="p">(</span> <span class="cm">/*Object*/</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">STATE_EXPRESSION_CATEGORIES</span><span class="p">,</span> <span class="kc">null</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-203">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-203">&#182;</a>               </div>               <p>Interpret and categorize the elements of the provided <code>map</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">map</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-204">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-204">&#182;</a>               </div>               <p>If <code>value</code> is just a reference to the exported <code>state</code> function,
interpret this as an empty state.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">value</span> <span class="o">===</span> <span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-205">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-205">&#182;</a>               </div>               <p><strong>Priority 1:</strong> Do a nominative type match for explicit
expression instances.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">category</span> <span class="o">=</span>
                <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;states&#39;</span> <span class="o">||</span>
                <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;transitions&#39;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">category</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">];</span>
                <span class="nx">item</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
                <span class="nx">item</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-206">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-206">&#182;</a>               </div>               <p><strong>Priority 2:</strong> Recognize an explicitly named category object.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">],</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-207">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-207">&#182;</a>               </div>               <p><strong>Priority 3:</strong> Use keys and value types to infer implicit
categorization.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">category</span> <span class="o">=</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">eventTypes</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span>
                        <span class="s1">&#39;events&#39;</span> <span class="o">:</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">guardActions</span> <span class="o">?</span>
                        <span class="s1">&#39;guards&#39;</span> <span class="o">:</span>
                    <span class="nx">Z</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">?</span>
                        <span class="s1">&#39;states&#39;</span> <span class="o">:</span>
                    <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">?</span>
                        <span class="s1">&#39;methods&#39;</span> <span class="o">:</span>
                    <span class="kc">undefined</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">category</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">];</span>
                    <span class="nx">item</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
                    <span class="nx">item</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-208">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-208">&#182;</a>               </div>               <p>Coerce the extracted values as necessary:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-209">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-209">&#182;</a>               </div>               <p>Event values are coerced into an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">events</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">value</span> <span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-210">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-210">&#182;</a>               </div>               <p>Guards are represented as a hashmap keyed by selector, so non-object
values are coerced into a single-element object with the value keyed
to the wildcard selector.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">guards</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="nx">value</span> <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-211">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-211">&#182;</a>               </div>               <p>Transition values must be a
<a href="#transition-expression"><code>TransitionExpression</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">transitions</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-212">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-212">&#182;</a>               </div>               <p>State values must be a <a href="#state-expression"><code>StateExpression</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">object</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">states</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">object</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">StateExpression</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-213">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-213">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller"
   href="#state-controller"></a></p>

<h2>StateController</h2>

<p>A <strong>state controller</strong> maintains the identity of the owner’s <strong>current
state</strong>, and facilitates transitions from one state to another. It provides
the behavior-modeling aspect of the owner’s state by forwarding method calls
made on the owner to any associated stateful implementations of those
methods that are valid given the current state.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">StateController</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-214">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-214">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--constructor"
   href="#state-controller--constructor"></a></p>

<h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">StateController</span> <span class="p">(</span>
                          <span class="cm">/*Object*/</span> <span class="nx">owner</span><span class="p">,</span>      <span class="c1">// = {}</span>
        <span class="cm">/*StateExpression | Object*/</span> <span class="nx">expression</span><span class="p">,</span> <span class="c1">// optional</span>
                          <span class="cm">/*Object*/</span> <span class="nx">options</span>     <span class="c1">// optional</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">StateController</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">StateController</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">name</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">defaultSubstate</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">setCurrent</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}</span>
        <span class="kd">function</span> <span class="nx">setTransition</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">transition</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-215">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-215">&#182;</a>               </div>               <p>Validate arguments.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">owner</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">owner</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
        <span class="nx">expression</span> <span class="k">instanceof</span> <span class="nx">StateExpression</span> <span class="o">||</span>
            <span class="p">(</span> <span class="nx">expression</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StateExpression</span><span class="p">(</span> <span class="nx">expression</span> <span class="p">)</span> <span class="p">);</span>
        <span class="nx">options</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="o">||</span>
            <span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">initialState</span><span class="o">:</span> <span class="nx">options</span> <span class="p">}</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-216">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-216">&#182;</a>               </div>               <p>Assign to <code>owner</code> an
<a href="#state-controller--private--create-accessor">accessor method</a>
that will serve as the owner’s interface into its state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;state&#39;</span><span class="p">;</span>
        <span class="nx">owner</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">createAccessor</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>

        <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-217">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-217">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--constructor--owner"
   href="#state-controller--constructor--owner"></a></p>

<h4>owner</h4>

<p>Returns the owner object on whose behalf this controller acts.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">owner</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">thunk</span><span class="p">(</span> <span class="nx">owner</span> <span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-218">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-218">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--constructor--name"
   href="#state-controller--constructor--name"></a></p>

<h4>name</h4>

<p>Returns the name assigned to this controller. This is also the
key in <code>owner</code> that holds the <code>accessor</code> function associated
with this controller.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">name</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">stringFunction</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">name</span><span class="p">;</span> <span class="p">}</span> <span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-219">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-219">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--constructor--current"
   href="#state-controller--constructor--current"></a></p>

<h4>current</h4>

<p>Returns the controller’s current state, or currently active
transition.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">current</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">current</span><span class="p">;</span> <span class="p">},</span> <span class="p">{</span>
                <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">current</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">current</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}),</span></pre></div>             </td>           </tr>                               <tr id="section-220">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-220">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--constructor--change"
   href="#state-controller--constructor--change"></a></p>

<h4>change</h4>

<p><em>See</em> <a href="#state-controller--privileged--change"><code>StateController.privileged.change</code></a></p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">change</span><span class="o">:</span> <span class="nx">StateController</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span>
                <span class="nx">setCurrent</span><span class="p">,</span> <span class="nx">setTransition</span> <span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-221">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-221">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--constructor--transition"
   href="#state-controller--constructor--transition"></a></p>

<h4>transition</h4>

<p>Returns the currently active transition, or <code>undefined</code> if the
controller is not presently engaged in a transition.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">transition</span><span class="o">:</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">transition</span><span class="p">;</span> <span class="p">},</span> <span class="p">{</span>
                <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}),</span></pre></div>             </td>           </tr>                               <tr id="section-222">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-222">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--constructor--destroy"
   href="#state-controller--constructor--destroy"></a></p>

<h4>destroy</h4>

<p>Destroys this controller and all of its states, and returns the
owner to its original condition.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
                <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">;</span>
                <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
                <span class="nx">root</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="nx">result</span> <span class="o">=</span> <span class="k">delete</span> <span class="nx">owner</span><span class="p">[</span> <span class="nx">name</span> <span class="p">];</span>
                <span class="nx">owner</span> <span class="o">=</span> <span class="nx">self</span> <span class="o">=</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-223">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-223">&#182;</a>               </div>               <p>Instantiate the root state, adding a redefinition of the
<code>controller</code> method that points directly to this controller, along
with all of the members and substates outlined in <code>expression</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">root</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-224">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-224">&#182;</a>               </div>               <p>Establish which state should be the initial state and set the
current state to that.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">current</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">initialSubstate</span><span class="p">()</span> <span class="o">||</span> <span class="nx">root</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">initialState</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">current</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">initialState</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">isAbstract</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">defaultSubstate</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">defaultSubstate</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">defaultSubstate</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">current</span> <span class="o">=</span> <span class="nx">defaultSubstate</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">controller</span><span class="p">()</span> <span class="o">!==</span> <span class="k">this</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">current</span> <span class="o">=</span> <span class="nx">virtualize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">current</span> <span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-225">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-225">&#182;</a>               </div>               <p>(Exposed for debugging.)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">__private__</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{</span>
            <span class="nx">root</span><span class="o">:</span> <span class="nx">root</span><span class="p">,</span>
            <span class="nx">owner</span><span class="o">:</span> <span class="nx">owner</span><span class="p">,</span>
            <span class="nx">options</span><span class="o">:</span> <span class="nx">options</span>
        <span class="p">});</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-226">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-226">&#182;</a>               </div>               <h3>Class-private functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-227">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-227">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--private--create-accessor"
   href="#state-controller--private--create-accessor"></a></p>

<h4>createAccessor</h4>

<p>Returns an <code>accessor</code> function, which will serve as an owner object’s
interface to the implementation of its state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">createAccessor</span> <span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">self</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">accessor</span> <span class="p">(</span> <span class="nx">input</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">method</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="k">this</span> <span class="o">===</span> <span class="nx">owner</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">current</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">current</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">input</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">current</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="nx">input</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">input</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="nx">rxTransitionArrow</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">transitionArrowMethods</span><span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">current</span><span class="p">[</span> <span class="nx">method</span> <span class="p">].</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">current</span><span class="p">,</span> <span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">]</span>
                            <span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">return</span> <span class="nx">current</span><span class="p">[</span> <span class="nx">method</span> <span class="p">](</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">current</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-228">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-228">&#182;</a>               </div>               <p>Calling the accessor of a prototype means that <code>this</code> requires
its own accessor and <a href="#state-controller"><code>StateController</code></a>.
Creating a new <code>StateController</code> has the desired side-effect of
also creating the object’s new accessor, to which the call is
then forwarded.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
                <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isPrototypeOf</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="k">this</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="k">new</span> <span class="nx">StateController</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
                    <span class="nx">initialState</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span>
                <span class="p">});</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">[</span> <span class="nx">name</span> <span class="p">].</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">accessor</span><span class="p">.</span><span class="nx">isAccessor</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">accessor</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s2">&quot;[accessor] -&gt; &quot;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">accessor</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-229">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-229">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--private--virtualize"
   href="#state-controller--private--virtualize"></a></p>

<h4>virtualize</h4>

<p>Creates a transient virtual state within the local state hierarchy to
represent <code>protostate</code>, along with as many virtual superstates as are
necessary to reach a real <a href="#state"><code>State</code></a> in the local hierarchy.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">virtualize</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">derivation</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">name</span><span class="p">;</span>
        <span class="kd">function</span> <span class="nx">iterate</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">next</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">substate</span><span class="p">(</span> <span class="p">(</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">derivation</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">),</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">next</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">protostate</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">&amp;&amp;</span>
            <span class="nx">protostate</span><span class="p">.</span><span class="nx">owner</span><span class="p">().</span><span class="nx">isPrototypeOf</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span> <span class="nx">derivation</span> <span class="o">=</span> <span class="nx">protostate</span><span class="p">.</span><span class="nx">derivation</span><span class="p">(</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">).</span><span class="nx">length</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">();</span>
            <span class="nx">iterate</span><span class="p">();</span>
            <span class="k">while</span> <span class="p">(</span> <span class="nx">next</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">state</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
                <span class="nx">iterate</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">while</span> <span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">state</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">attributes</span><span class="o">:</span> <span class="nx">STATE_ATTRIBUTES</span><span class="p">.</span><span class="nx">VIRTUAL</span>
                <span class="p">});</span>
                <span class="nx">name</span> <span class="o">=</span> <span class="nx">derivation</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-230">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-230">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--private--evaluate-guard"
   href="#state-controller--private--evaluate-guard"></a></p>

<h4>evaluateGuard</h4>

<p>Returns the <code>Boolean</code> result of the guard function at <code>guardName</code>
defined on this state, as evaluated against <code>testState</code>, or <code>true</code> if no
guard exists.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">evaluateGuard</span> <span class="p">(</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">against</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">valueIsFn</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">selectors</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">typeof</span> <span class="nx">guard</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">guard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">guard</span><span class="p">(</span> <span class="nx">guard</span> <span class="p">)</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">guard</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">guard</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">guard</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">guard</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="nx">valueIsFn</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">;</span>

            <span class="nx">valueIsFn</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
            <span class="nx">selectors</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span> <span class="nx">key</span> <span class="p">).</span><span class="nx">split</span><span class="p">(</span> <span class="sr">/\s*,+\s*/</span> <span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">selectors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selectors</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">against</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">result</span> <span class="o">=</span> <span class="nx">valueIsFn</span> <span class="o">?</span> <span class="o">!!</span><span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="p">)</span> <span class="o">:</span> <span class="o">!!</span><span class="nx">value</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">result</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-231">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-231">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--privileged"
   href="#state-controller--privileged"></a></p>

<h3>External privileged methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">StateController</span><span class="p">.</span><span class="nx">privileged</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-232">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-232">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--privileged--change"
   href="#state-controller--privileged--change"></a></p>

<h4>change</h4>

<p>Attempts to execute a state transition. Handles asynchronous
transitions, generation of appropriate events, and construction of
any necessary temporary virtual states. Respects guards supplied in
both the origin and <code>target</code> states.</p>

<p>The <code>target</code> parameter may be either a <a href="#state"><code>State</code></a> object
within the purview of this controller, or a string that resolves to
a likewise targetable <code>State</code> when evaluated from the context of the
most recently current state.</p>

<p>The <code>options</code> parameter is an optional map that may include:</p>

<ul>
<li><p><code>args</code> : <code>Array</code> — arguments to be passed to a transition’s
<code>action</code> function.</p></li>
<li><p><code>success</code> : <code>Function</code> — callback to be executed upon successful
completion of the transition.</p></li>
<li><p><code>failure</code> : <code>Function</code> — callback to be executed if the transition
attempt is blocked by a guard.</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">change</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">setCurrent</span><span class="p">,</span> <span class="nx">setTransition</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">defaultOptions</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span>
                <span class="cm">/*State | String*/</span> <span class="nx">target</span><span class="p">,</span>
                        <span class="cm">/*Object*/</span> <span class="nx">options</span> <span class="c1">// optional</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">targetOwner</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">domain</span><span class="p">,</span>
                    <span class="nx">state</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">transitionExpression</span><span class="p">,</span>
                    <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

                <span class="nx">owner</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
                <span class="nx">transition</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transition</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-233">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-233">&#182;</a>               </div>               <p>The <code>origin</code> is defined as the controller’s most recently
current state that is not a <code>Transition</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">origin</span> <span class="o">=</span> <span class="nx">transition</span> <span class="o">?</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">origin</span><span class="p">()</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-234">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-234">&#182;</a>               </div>               <p>Departures are not allowed from a state that is <code>final</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">isFinal</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-235">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-235">&#182;</a>               </div>               <p>Ensure that <code>target</code> is a valid <a href="#state"><code>State</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">target</span><span class="p">;</span> <span class="c1">// TODO: Interpret number as history traversal</span>
                <span class="p">}</span>
                <span class="nx">target</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span>
                    <span class="p">(</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span> <span class="o">?</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">target</span> <span class="o">||</span>
                        <span class="p">(</span> <span class="nx">targetOwner</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span> <span class="p">)</span> <span class="o">!==</span> <span class="nx">owner</span> <span class="o">&amp;&amp;</span>
                        <span class="o">!</span><span class="nx">targetOwner</span><span class="p">.</span><span class="nx">isPrototypeOf</span><span class="p">(</span> <span class="nx">owner</span> <span class="p">)</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-236">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-236">&#182;</a>               </div>               <p>Resolve <code>options</code> to an object if necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">options</span> <span class="o">=</span> <span class="nx">defaultOptions</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">args</span><span class="o">:</span> <span class="nx">options</span> <span class="p">};</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-237">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-237">&#182;</a>               </div>               <p>An ingressing transition that targets a retained state must
be redirected to whichever of that state’s internal states
was most recently current.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">direct</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">.</span><span class="nx">isRetained</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                        <span class="o">!</span><span class="nx">target</span><span class="p">.</span><span class="nx">isActive</span><span class="p">()</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">state</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">history</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
                    <span class="nx">target</span> <span class="o">=</span> <span class="nx">state</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">target</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-238">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-238">&#182;</a>               </div>               <p>A transition cannot target an abstract state directly, so
<code>target</code> must be reassigned to the appropriate concrete
substate.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">while</span> <span class="p">(</span> <span class="nx">target</span><span class="p">.</span><span class="nx">isAbstract</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">defaultSubstate</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">target</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-239">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-239">&#182;</a>               </div>               <p>If any guards are in place for the given <code>origin</code> and
<code>target</code> states, they must consent to the transition.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">forced</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
                        <span class="o">!</span><span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">origin</span><span class="p">,</span> <span class="s1">&#39;release&#39;</span><span class="p">,</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">||</span>
                        <span class="o">!</span><span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;admit&#39;</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span>
                <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">failure</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">options</span><span class="p">.</span><span class="nx">failure</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-240">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-240">&#182;</a>               </div>               <p>If <code>target</code> is a protostate, i.e. a state from a prototype
of <code>owner</code>, then it must be represented within <code>owner</code> as a
transient virtual state that inherits from the protostate.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">.</span><span class="nx">controller</span><span class="p">()</span> <span class="o">!==</span> <span class="k">this</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">virtualize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">target</span> <span class="p">)</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-241">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-241">&#182;</a>               </div>               <p>The <code>source</code> variable will reference the previously current
state (or abortive transition).</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">source</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-242">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-242">&#182;</a>               </div>               <p>The upcoming transition will start from its <code>source</code> and
proceed within the <code>domain</code> of the least common ancestor
between that state and the specified target.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">domain</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">common</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-243">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-243">&#182;</a>               </div>               <p>Conclusivity is enforced by checking each state that will be
exited against the <code>conclusive</code> attribute.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">state</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">!==</span> <span class="nx">domain</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isConclusive</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                    <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-244">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-244">&#182;</a>               </div>               <p>If a previously initiated transition is still underway, it
needs to be notified that it won’t finish.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-245">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-245">&#182;</a>               </div>               <p>Retrieve the appropriate transition expression for this
origin/target pairing; if none is defined, then an
actionless default transition will be created and applied,
causing the callback to return immediately.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">transitionExpression</span> <span class="o">=</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">getTransitionExpressionFor</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">);</span>
                <span class="nx">transition</span> <span class="o">=</span>
                    <span class="k">new</span> <span class="nx">Transition</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">transitionExpression</span> <span class="p">);</span>
                <span class="nx">setTransition</span><span class="p">(</span> <span class="nx">transition</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-246">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-246">&#182;</a>               </div>               <p>Preparation for the transition begins by emitting a <code>depart</code>
event on the <code>source</code> state.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">source</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;depart&#39;</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-247">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-247">&#182;</a>               </div>               <p>Enter into the transition state.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">setCurrent</span><span class="p">(</span> <span class="nx">transition</span> <span class="p">);</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;enter&#39;</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-248">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-248">&#182;</a>               </div>               <p>Walk up to the top of the domain, emitting <code>exit</code> events for
each state along the way.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span> <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span> <span class="o">!==</span> <span class="nx">domain</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">state</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">attachTo</span><span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="p">);</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-249">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-249">&#182;</a>               </div>               <p>A scoped callback will be called from <code>transition.end()</code> to
conclude the transition.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">setCallback</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">pathToState</span><span class="p">,</span> <span class="nx">substate</span><span class="p">,</span> <span class="nx">superstate</span><span class="p">;</span>

                    <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-250">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-250">&#182;</a>               </div>               <p>Trace a path from <code>target</code> up to <code>domain</code>, then walk
down it, emitting <code>enter</code> events for each state along
the way.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">pathToState</span> <span class="o">=</span> <span class="p">[];</span>
                              <span class="nx">state</span> <span class="o">!==</span> <span class="nx">domain</span><span class="p">;</span>
                              <span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span>
                        <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">pathToState</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">state</span> <span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">;</span>
                        <span class="nx">transition</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">substate</span> <span class="o">=</span> <span class="nx">pathToState</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="p">);</span>
                        <span class="nx">state</span> <span class="o">=</span> <span class="nx">substate</span>
                    <span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isShallow</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">hasHistory</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">substate</span> <span class="p">);</span>
                        <span class="p">}</span>
                        <span class="nx">transition</span><span class="p">.</span><span class="nx">attachTo</span><span class="p">(</span> <span class="nx">substate</span> <span class="p">);</span>
                        <span class="nx">substate</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;enter&#39;</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                        <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-251">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-251">&#182;</a>               </div>               <p>Exit from the transition state.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">transition</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                        <span class="nx">transition</span><span class="p">.</span><span class="nx">wasAborted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">transition</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">);</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-252">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-252">&#182;</a>               </div>               <p>Terminate the transition with an <code>arrive</code> event on the
targeted state.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">transition</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">setCurrent</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span>
                        <span class="nx">target</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;arrive&#39;</span><span class="p">,</span> <span class="nx">transition</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-253">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-253">&#182;</a>               </div>               <p>For each state from <code>target</code> to <code>root</code> that records
a deep history, push a new element that points to
<code>target</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span> <span class="nx">state</span><span class="p">;</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
                            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">isShallow</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">hasHistory</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                                <span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-254">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-254">&#182;</a>               </div>               <p>Any virtual states that were previously active are
no longer needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">for</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">;</span>
                              <span class="nx">state</span><span class="p">.</span><span class="nx">isVirtual</span><span class="p">();</span>
                              <span class="nx">state</span> <span class="o">=</span> <span class="nx">superstate</span>
                        <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">superstate</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
                            <span class="nx">state</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-255">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-255">&#182;</a>               </div>               <p>Now complete, the <a href="#transition"><code>Transition</code></a>
instance can be discarded.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">transition</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                        <span class="nx">transition</span> <span class="o">=</span> <span class="nx">setTransition</span><span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
                        <span class="p">}</span>

                        <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-256">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-256">&#182;</a>               </div>               <p>At this point the transition is attached to the <code>domain</code>
state and is ready to proceed.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">return</span> <span class="nx">transition</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">transition</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">transition</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">args</span> <span class="p">)</span> <span class="o">||</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-257">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-257">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--prototype"
   href="#state-controller--prototype"></a></p>

<h3>Prototype methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">StateController</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-258">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-258">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--prototype--to-string"
   href="#state-controller--prototype--to-string"></a></p>

<h4>toString</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-259">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-259">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-controller--prototype--get-transition-expression-for"
   href="#state-controller--prototype--get-transition-expression-for"></a></p>

<h4>getTransitionExpressionFor</h4>

<p>Finds the appropriate transition expression for the given origin and
target states. If no matching transitions are defined in any of the
states, returns a generic actionless transition expression for the
origin/target pair.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">getTransitionExpressionFor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">origin</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">origin</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">()</span> <span class="p">);</span>

            <span class="kd">function</span> <span class="nx">search</span> <span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">until</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">transitions</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">guards</span><span class="p">,</span> <span class="nx">admit</span><span class="p">,</span> <span class="nx">release</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span> <span class="p">;</span>
                     <span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span> <span class="o">!==</span> <span class="nx">until</span><span class="p">;</span>
                     <span class="nx">state</span> <span class="o">=</span> <span class="nx">until</span> <span class="o">?</span> <span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">transitions</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">transitions</span><span class="p">();</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">transitions</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">transitions</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nx">expr</span> <span class="o">=</span> <span class="nx">transitions</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">guards</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">guards</span> <span class="p">)</span> <span class="o">||</span>
                                    <span class="p">(</span>
                                        <span class="o">!</span><span class="p">(</span> <span class="nx">admit</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">.</span><span class="nx">admit</span> <span class="p">)</span> <span class="o">||</span>
                                            <span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">admit</span> <span class="p">)</span> <span class="o">||</span>
                                            <span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">admit</span><span class="p">,</span>
                                                <span class="nx">target</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span>
                                    <span class="p">)</span>
                                        <span class="o">&amp;&amp;</span>
                                    <span class="p">(</span>
                                        <span class="o">!</span><span class="p">(</span> <span class="nx">release</span> <span class="o">=</span> <span class="nx">guards</span><span class="p">.</span><span class="nx">release</span> <span class="p">)</span> <span class="o">||</span>
                                            <span class="nx">Z</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">release</span> <span class="p">)</span> <span class="o">||</span>
                                            <span class="nx">evaluateGuard</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">target</span><span class="p">,</span>
                                                <span class="nx">release</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">target</span> <span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                                    <span class="o">&amp;&amp;</span>
                                <span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">target</span> <span class="o">?</span>
                                        <span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="nx">target</span> <span class="p">)</span> <span class="o">:</span>
                                        <span class="nx">state</span> <span class="o">===</span> <span class="nx">target</span>
                                <span class="p">)</span>
                                    <span class="o">&amp;&amp;</span>
                                <span class="p">(</span> <span class="o">!</span><span class="nx">expr</span><span class="p">.</span><span class="nx">origin</span> <span class="o">||</span>
                                    <span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">origin</span><span class="p">,</span> <span class="nx">origin</span> <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="nx">expr</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-260">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-260">&#182;</a>               </div>               <p>Search order:
1. <code>target</code>,
2. <code>origin</code>,
3. superstates of <code>target</code>,
4. superstates of <code>origin</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="p">(</span>
                <span class="nx">search</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="nx">origin</span> <span class="o">!==</span> <span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="nx">search</span><span class="p">(</span> <span class="nx">origin</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="nx">search</span><span class="p">(</span> <span class="nx">target</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">)</span> <span class="o">||</span>
                        <span class="nx">search</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="o">!</span><span class="nx">target</span><span class="p">.</span><span class="nx">isIn</span><span class="p">(</span> <span class="nx">origin</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">search</span><span class="p">(</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">superstate</span><span class="p">(),</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">common</span><span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="o">||</span>
                <span class="k">new</span> <span class="nx">TransitionExpression</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">StateController</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-261">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-261">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter"
   href="#state-event-emitter"></a></p>

<h2>StateEventEmitter</h2>

<p>A state holds event listeners for a given event type in a <code>StateEventEmitter</code>
instance.</p>

<p>An event listener is usually a function, but may also be held as a string,
which, when the client state <a href="#state--privileged--emit"><code>emit</code></a>s
the event type associated with this emitter, will be interpreted as an
implicit order for the emitting state to <a href="#state--prototype--change"><code>change</code></a>
to the target state named by the string.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">StateEventEmitter</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">guid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-262">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-262">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter"
   href="#state-event-emitter"></a></p>

<h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">StateEventEmitter</span> <span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-263">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-263">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype"
   href="#state-event-emitter--prototype"></a></p>

<h3>Prototype methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">StateEventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-264">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-264">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--guid"
   href="#state-event-emitter--prototype--guid"></a></p>

<h4>guid</h4>

<p>Produces a unique numeric string, to be used as a key for bound
event listeners.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">guid</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span> <span class="nx">guid</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-265">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-265">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--get"
   href="#state-event-emitter--prototype--get"></a></p>

<h4>get</h4>

<p>Retrieves a bound listener associated with the provided <code>id</code> string
as returned by the prior call to
<a href="#state-event-emitter--prototype--add"><code>add</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*String*/</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span> <span class="nx">id</span> <span class="p">];</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-266">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-266">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--get-all"
   href="#state-event-emitter--prototype--get-all"></a></p>

<h4>getAll</h4>

<p>Returns an array of all bound listeners.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">getAll</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-267">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-267">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--set"
   href="#state-event-emitter--prototype--set"></a></p>

<h4>set</h4>

<p>Adds or replaces a handler bound to a specific key.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
                       <span class="cm">/*String*/</span> <span class="nx">id</span><span class="p">,</span>
            <span class="cm">/*Function | String*/</span> <span class="nx">handler</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
            <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">id</span> <span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">items</span><span class="p">[</span> <span class="nx">id</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-268">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-268">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--key"
   href="#state-event-emitter--prototype--key"></a></p>

<h4>key</h4>

<p>Retrieves the <code>id</code> string associated with the provided listener.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">key</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Function*/</span> <span class="nx">listener</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">listener</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-269">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-269">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--keys"
   href="#state-event-emitter--prototype--keys"></a></p>

<h4>keys</h4>

<p>Returns the set of <code>id</code> strings associated with all bound listeners.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">keys</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="nx">result</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">join</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-270">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-270">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--add"
   href="#state-event-emitter--prototype--add"></a></p>

<h4>add</h4>

<p>Binds a listener, along with an optional context object, to be
called when the the emitter
<a href="#state-event-emitter--prototype--emit"><code>emit</code></a>s an event.
Returns a unique key that can be used later to
<a href="#state-event-emitter--prototype--remove"><code>remove</code></a> the listener.</p>

<p><em>Aliases:</em> <strong>on bind</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="s1">&#39;add on bind&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*Function*/</span> <span class="nx">fn</span><span class="p">,</span>
              <span class="cm">/*Object*/</span> <span class="nx">context</span>  <span class="c1">// optional</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">guid</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span> <span class="nx">id</span> <span class="p">]</span> <span class="o">=</span>
                <span class="k">typeof</span> <span class="nx">context</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">?</span> <span class="p">[</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span> <span class="p">]</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="o">++</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-271">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-271">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--remove"
   href="#state-event-emitter--prototype--remove"></a></p>

<h4>remove</h4>

<p>Unbinds a listener. Accepts either the numeric string returned by
<a href="#state-event-emitter--prototype--add"><code>add</code></a> or a reference to
the function itself.</p>

<p><em>Aliases:</em> <strong>off unbind</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="s1">&#39;remove off unbind&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Function | String*/</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span>
                <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>

            <span class="nx">fn</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span> <span class="k">typeof</span> <span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span> <span class="nx">id</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">id</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">fn</span> <span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">delete</span> <span class="nx">items</span><span class="p">[</span> <span class="nx">id</span> <span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="o">--</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-272">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-272">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--empty"
   href="#state-event-emitter--prototype--empty"></a></p>

<h4>empty</h4>

<p>Removes all listeners, and returns the number of listeners removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">empty</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">n</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

            <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="k">delete</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-273">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-273">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--emit"
   href="#state-event-emitter--prototype--emit"></a></p>

<h4>emit</h4>

<p>Invokes all bound listeners, with the provided array of <code>args</code>, and
in the context of the bound or provided <code>state</code>.</p>

<p><em>Alias:</em> <strong>trigger</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="s1">&#39;emit trigger&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
            <span class="cm">/*Array*/</span> <span class="nx">args</span><span class="p">,</span>  <span class="c1">// optional</span>
            <span class="cm">/*State*/</span> <span class="nx">state</span>  <span class="c1">// = this</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">itemType</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span>
                <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>

            <span class="nx">state</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">item</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="nx">itemType</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span> <span class="nx">item</span> <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">itemType</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">fn</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">itemType</span> <span class="o">===</span> <span class="s1">&#39;array&#39;</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">fn</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-274">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-274">&#182;</a>               </div>               <p>If <code>item</code> is a string or <a href="#state"><code>State</code></a>, interpret this
as an implied transition to be instigated from the client
<code>State</code> after all the callbacks have been invoked.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">itemType</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="nx">item</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">target</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
                <span class="nx">fn</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-275">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-275">&#182;</a>               </div>               <p><a class="icon-link"
   name="state-event-emitter--prototype--destroy"
   href="#state-event-emitter--prototype--destroy"></a></p>

<h4>destroy</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span> <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">StateEventEmitter</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-276">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-276">&#182;</a>               </div>               <h2>StateHistory</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    ### How `mutationOffset` works</span>

<span class="cm">    &#39; * &#39; : the precise location within the `history` array that describes the</span>
<span class="cm">            present condition and composition of `this.state`</span>
<span class="cm">    &#39;Sta&#39; : any string that names a state</span>
<span class="cm">    &#39;Mut&#39; : any delta object that describes a mutation</span>
<span class="cm">    &#39;NIL&#39; : the value `Z.NIL`, representing a stored `delete` operation</span>
<span class="cm">    &#39;~==&#39; : &quot;is essentially deep-equal to&quot;</span>
<span class="cm">    &#39;&lt;ƒ&gt;&#39; : an arbitrary function</span>
<span class="cm">    </span>
<span class="cm">                                                        7         *    11</span>
<span class="cm">    indices            : [ Sta Sta Mut Sta Mut Mut Sta Sta Mut Mut Mut Sta Mut Sta ]</span>
<span class="cm">    index              : 7</span>
<span class="cm">    stateIndices       : [ 0  1  3  6  7  11  12  14 ]</span>
<span class="cm">    stateIndicesIndex  : 4</span>
<span class="cm">    mutationOffset     : 2</span>
<span class="cm">              7                                           *                   11</span>
<span class="cm">    [ ... &#39;StateA&#39;, { data:{a:NIL} }, { methods:{b:NIL} }, { data:{c:3} }, &#39;StateB&#39; ... ]</span>
<span class="cm">    </span>
<span class="cm">    this.state.express() ~== state( &#39;mutable history&#39;, {</span>
<span class="cm">                                 data: { a:1 },</span>
<span class="cm">                                 methods: { b:&lt;ƒ&gt; },</span>
<span class="cm">                                 states: {</span>
<span class="cm">                                     StateA: {},</span>
<span class="cm">                                     StateB: {}</span>
<span class="cm">                                 }</span>
<span class="cm">                             })</span>
<span class="cm">    </span>
<span class="cm">    </span>
<span class="cm">    &gt; this.mutate( 1 );</span>
<span class="cm">    mutationOffset     : 3</span>
<span class="cm">    </span>
<span class="cm">              7                                                             *   11</span>
<span class="cm">    [ ... &#39;StateA&#39;, { data:{a:NIL} }, { methods:{b:NIL} }, { data:{c:NIL} }, &#39;StateB&#39; ... ]</span>
<span class="cm">    </span>
<span class="cm">    this.state.express() ~== state( ...</span>
<span class="cm">                                 data: { a:1, c:3 },</span>
<span class="cm">                                 methods: { b:&lt;ƒ&gt; }</span>
<span class="cm">                             ... )</span>
<span class="cm">    </span>
<span class="cm">    </span>
<span class="cm">    &gt; this.mutate( -2 );</span>
<span class="cm">    mutationOffset     : 1</span>
<span class="cm">    </span>
<span class="cm">              7                      *                                        11</span>
<span class="cm">    [ ... &#39;StateA&#39;, { data:{a:NIL} }, { methods:{b:&lt;ƒ&gt;} }, { data:{c:3} }, &#39;StateB&#39; ... ]</span>
<span class="cm">    </span>
<span class="cm">    this.state.express() ~== state( ...</span>
<span class="cm">                                 data: { a:1 },</span>
<span class="cm">                                 methods: {}</span>
<span class="cm">                             ... )</span>
<span class="cm">*/</span>

<span class="kd">var</span> <span class="nx">StateHistory</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">guid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">binarySearch</span> <span class="p">(</span> <span class="nx">sortedArray</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">min</span><span class="p">,</span> <span class="nx">max</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">k</span><span class="p">;</span>
        <span class="nx">min</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">min</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">);</span>
        <span class="nx">max</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">max</span> <span class="o">=</span> <span class="nx">sortedArray</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span> <span class="nx">min</span> <span class="o">&lt;=</span> <span class="nx">max</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">i</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">min</span> <span class="o">+</span> <span class="nx">max</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
            <span class="nx">k</span> <span class="o">=</span> <span class="nx">sortedArray</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span>      <span class="p">(</span> <span class="nx">key</span> <span class="o">&lt;</span> <span class="nx">k</span> <span class="p">)</span> <span class="nx">max</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="o">&gt;</span> <span class="nx">k</span> <span class="p">)</span> <span class="nx">min</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">else</span>    <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">StateHistory</span> <span class="p">(</span> <span class="cm">/*State*/</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-277">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-277">&#182;</a>               </div>               <p>The state to which this history belongs.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-278">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-278">&#182;</a>               </div>               <p>The content of a history is stored as a “heap” of <code>elements</code>, whose
keys are unique decimal integers supplied by the up-scope <code>guid</code>,
which map to values that are either:</p>

<ul>
<li><p>a <code>String</code> that uniquely identifies a previously or subsequently
current <code>State</code> within the domain of <code>this.state</code>;</p></li>
<li><p>an <code>Object</code> that represents a <strong>mutation delta</strong>, which contains
the key-value changes between adjacent mutations of <code>this.state</code>;</p></li>
<li><p>a <code>Number</code> that is an <strong>element reference</strong> pointing to a
superhistory element, within which is contained the information
relevant to this element;</p></li>
<li><p>or <code>null</code>, indicating a period of inactivity. Anytime the owner
object <code>exit</code>s a <code>history</code> state, a <code>null</code> entry is recorded.</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">elements</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-279">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-279">&#182;</a>               </div>               <p>The element references of <code>this.elements</code> are indexed in an ordered
list.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">indices</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-280">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-280">&#182;</a>               </div>               <p><code>this.index</code> indirectly references, via <code>this.indices</code>, a state
(string) element within <code>this.elements</code> that names the specific
<code>State</code> that is presently <strong>current</strong> within the history.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-281">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-281">&#182;</a>               </div>               <p>By default a history is “deep”, in that it records a view into the
timeline of its client <code>state</code>, which includes the active condition
of and mutations to itself and all of its descendants. This is
contrasted with a <code>shallow</code> history, which only records the active
condition of the <code>state</code>’s immediate substates, and mutations to its
own content.</p>

<p>As such the shallow history does not hold reference elements, and
does not propagate traversals or <code>push</code>es.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">isShallow</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isShallow</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-282">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-282">&#182;</a>               </div>               <p>A host state that bears the <code>immutable</code> attribute asserts that all
of its descendant states will also be immutable; consequently the
history does not need to record mutations or implement the
structures and logic required to traverse the recorded mutations.</p>

<p>Absent that guarantee of absolute immutability, mutations will be
stored within <code>this.indices</code> as deltas relative to the present
expression of <code>this.state</code>. Traversal operations will update these
deltas as necessary to reflect the movement of the <code>index</code> pointer.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIsImmutable</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isImmutable</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-283">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-283">&#182;</a>               </div>               <p>For faster traversals amidst mutations, <code>this.stateIndices</code>
holds an array containing the specific indices within
<code>this.indices</code> that point to states. A <code>stateIndex</code> property is
added as well, such that, for <code>this.indices.length &gt; 0</code>,
<code>this.stateIndices[ this.stateIndex ]</code> is equal to <code>this.index</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">stateIndices</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stateIndex</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-284">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-284">&#182;</a>               </div>               <p>A sequence of mutations is stored as a subarray of interstitial
deltas between adjacent state elements. The history’s current
state, including mutations undergone since the transition into
that state, is precisely defined in relation to <code>this.index</code> by
<code>this.mutationOffset</code>, which is a non-negative number of deltas
ahead of <code>this.index</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">mutationOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">StateHistory</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-285">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-285">&#182;</a>               </div>               <h4>superhistory</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">superhistory</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">superstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">superstate</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">superstate</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">superstate</span><span class="p">.</span><span class="nx">historian</span><span class="p">();</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-286">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-286">&#182;</a>               </div>               <h4>root</h4>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">root</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">sh</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superhistory</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">sh</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">sh</span><span class="p">.</span><span class="nx">root</span><span class="p">()</span> <span class="o">||</span> <span class="nx">sh</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-287">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-287">&#182;</a>               </div>               <h4>createElement</h4>

<p>type inferences of <code>item</code>:</p>

<ul>
<li><code>Number</code> : pointer to a superhistory element</li>
<li><code>String</code> : state path</li>
<li><code>Object</code> : mutation delta</li>
<li><code>null</code>   : state is inactive</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">createElement</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span> <span class="nx">guid</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
        <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-288">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-288">&#182;</a>               </div>               <h4>indexOf</h4>

<p>Returns the index of the item within <code>this.indices</code> that holds the
<code>key</code> for a particular member of <code>this.elements</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">indexOf</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">binarySearch</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">indices</span><span class="p">,</span> <span class="nx">key</span> <span class="p">);</span>
            <span class="p">};</span>
        <span class="p">},</span>

        <span class="nx">traverseToElement</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="cm">/*Number*/</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">targetIndex</span> <span class="o">=</span> <span class="nx">binarySearch</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">indices</span><span class="p">,</span> <span class="nx">key</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">targetIndex</span> <span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">traverseToIndex</span><span class="p">(</span> <span class="nx">targetIndex</span> <span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">traverseToIndex</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
             <span class="cm">/*Number*/</span> <span class="nx">targetIndex</span><span class="p">,</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">directly</span>      <span class="c1">// = true</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">indices</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indices</span><span class="p">,</span>
                <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span>
                <span class="nx">step</span> <span class="o">=</span> <span class="nx">targetIndex</span> <span class="o">&lt;</span> <span class="nx">index</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nx">stateIndices</span><span class="p">,</span> <span class="nx">stateIndex</span><span class="p">,</span> <span class="nx">targetStateIndex</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">nMutations</span><span class="p">,</span>
                <span class="nx">blockLength</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">compoundDelta</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-289">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-289">&#182;</a>               </div>               <p>If the host state and all of its descendants are immutable, then
it is guaranteed that no mutations will be stored in <code>indices</code>.
This means all of its elements will refer to states, so
traversal operations can simply proceed per-element.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIsImmutable</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-290">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-290">&#182;</a>               </div>               <p><code>directly</code> causes the traversal to jump straight to the
targeted state and instigate a single transition; otherwise
the traversal transitions through each state in order.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">directly</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">targetIndex</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span> <span class="nx">indices</span><span class="p">[</span> <span class="nx">targetIndex</span> <span class="p">]</span> <span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">while</span> <span class="p">(</span> <span class="nx">index</span> <span class="o">!==</span> <span class="nx">targetIndex</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">+=</span> <span class="nx">step</span><span class="p">;</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span> <span class="nx">indices</span><span class="p">[</span> <span class="nx">index</span> <span class="p">]</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-291">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-291">&#182;</a>               </div>               <p>Otherwise, since the host state or any of its descendants could
be mutable, the possibility exists of mutations being stored in
this history, in which case the traversal will involve applying
these mutations to the host state and transforming the mutation
deltas appropriately.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">stateIndices</span>      <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIndices</span><span class="p">;</span>
                <span class="nx">stateIndex</span>        <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIndex</span><span class="p">;</span>
                <span class="nx">targetStateIndex</span><span class="p">;</span> <span class="c1">// = `stateIndex` that is or is to the left of `targetIndex`</span>
                <span class="nx">offset</span>            <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mutationOffset</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-292">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-292">&#182;</a>               </div>               <p>Get a plain-object expression of this history’s state to
apply deltas against.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">expr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">express</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-293">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-293">&#182;</a>               </div>               <p>Process the elements of <code>indices</code> in blocks, each consisting
of one state element at the tail, followed by a contiguous
sequence of zero or more mutations.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">while</span> <span class="p">(</span> <span class="nx">index</span> <span class="o">!==</span> <span class="nx">targetIndex</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-294">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-294">&#182;</a>               </div>               <p><code>blockLength</code> refers to the number of mutations in this
block; it does not account for the trailing state
element (thus its range is <code>[0..]</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">blockLength</span> <span class="o">=</span> <span class="nx">stateIndices</span><span class="p">[</span> <span class="nx">stateIndex</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="nx">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-295">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-295">&#182;</a>               </div>               <p><code>offset</code> (which on the first run of the outer loop will
already have been initialized to <code>this.mutationOffset</code>)
iterates either backward or forward through the
mutations in this block, accreting an aggregate delta,
which, immediately prior to the next state change, will
be applied to the state in a single mutation operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">step</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">offset</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">blockLength</span> <span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">offset</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">while</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nx">offset</span> <span class="o">&amp;&amp;</span> <span class="nx">offset</span> <span class="o">&lt;=</span> <span class="nx">blockLength</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">index</span> <span class="o">===</span> <span class="nx">targetIndex</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span> <span class="nx">nMutations</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
                            <span class="k">else</span> <span class="nx">nMutations</span><span class="o">--</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nx">i</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">;</span>
                        <span class="nx">delta</span> <span class="o">=</span> <span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">delta</span><span class="p">(</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">);</span>
                        <span class="nx">compoundDelta</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">compoundDelta</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">);</span>
                        <span class="nx">offset</span> <span class="o">+=</span> <span class="nx">step</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                    <span class="nx">index</span> <span class="o">=</span> <span class="nx">stateIndices</span><span class="p">[</span> <span class="nx">stateIndex</span> <span class="o">+=</span> <span class="nx">step</span> <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-296">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-296">&#182;</a>               </div>               <p>If instigating transitions on each iteration, then the
transition for the next iteration’s block is made at the
end of this iteration.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">directly</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">compoundDelta</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">mutateState</span><span class="p">(</span> <span class="nx">compoundDelta</span> <span class="p">);</span>
                            <span class="nx">compoundDelta</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span> <span class="nx">indices</span><span class="p">[</span> <span class="nx">index</span> <span class="p">]</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">directly</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">compoundDelta</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mutateState</span><span class="p">(</span> <span class="nx">compoundDelta</span> <span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span> <span class="nx">indices</span><span class="p">[</span> <span class="nx">targetIndex</span> <span class="p">]</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">mutationOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-297">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-297">&#182;</a>               </div>               <h4>traverse</h4>

<p>Traverses the history by a given number of states, applying any
interstitial mutations along the way, and by a given number of
additional mutations upon arrival at the targeted state.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">traverseBy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span>
             <span class="cm">/*Number*/</span> <span class="nx">nStates</span><span class="p">,</span>
             <span class="cm">/*Number*/</span> <span class="nx">nMutations</span><span class="p">,</span> <span class="c1">// = 0</span>
            <span class="cm">/*Boolean*/</span> <span class="nx">directly</span>    <span class="c1">// = true</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">elements</span><span class="p">,</span> <span class="nx">indices</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">length</span><span class="p">,</span>
                <span class="nx">stateIndices</span><span class="p">,</span> <span class="nx">stateIndicesLength</span><span class="p">,</span> <span class="nx">stateIndex</span><span class="p">,</span> <span class="nx">mutationOffset</span><span class="p">,</span>
                <span class="nx">targetIndex</span><span class="p">,</span> <span class="nx">targetStateIndex</span><span class="p">,</span>
                <span class="nx">step</span><span class="p">,</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">blockLength</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">compoundDelta</span><span class="p">;</span>

            <span class="k">typeof</span> <span class="nx">nStates</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">nMutations</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">directly</span> <span class="o">=</span> <span class="nx">nMutations</span><span class="p">;</span>
                <span class="nx">nMutations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">nMutations</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">nMutations</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">);</span>

            <span class="nx">elements</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">elements</span><span class="p">;</span>
            <span class="nx">indices</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indices</span><span class="p">;</span>
            <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">index</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="nx">length</span> <span class="o">=</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

            <span class="nx">directly</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">directly</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-298">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-298">&#182;</a>               </div>               <p>If the host state and all of its descendants are immutable, then
it is guaranteed that no mutations will be stored in <code>indices</code>.
This means all of its elements will refer to states, so
traversal operations can simply proceed per-element.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIsImmutable</span> <span class="p">)</span> <span class="p">{</span>
                </pre></div>             </td>           </tr>                               <tr id="section-299">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-299">&#182;</a>               </div>               <p>Clamp <code>nStates</code> and acquire a <code>targetIndex</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">targetIndex</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">+</span> <span class="nx">nStates</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">targetIndex</span> <span class="o">&gt;=</span> <span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">targetIndex</span> <span class="o">=</span> <span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">targetIndex</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">targetIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="nx">nStates</span> <span class="o">=</span> <span class="nx">targetIndex</span> <span class="o">-</span> <span class="nx">index</span><span class="p">;</span>
                <span class="nx">step</span> <span class="o">=</span> <span class="nx">nStates</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
                </pre></div>             </td>           </tr>                               <tr id="section-300">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-300">&#182;</a>               </div>               <p><code>directly</code> causes the traversal to jump straight to the
targeted state and instigate a single transition; otherwise
the traversal transitions through each state in order.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="nx">directly</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">targetIndex</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span> <span class="nx">indices</span><span class="p">[</span> <span class="nx">targetIndex</span> <span class="p">]</span> <span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">while</span> <span class="p">(</span> <span class="nx">index</span> <span class="o">!==</span> <span class="nx">targetIndex</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">+=</span> <span class="nx">step</span><span class="p">;</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span> <span class="nx">indices</span><span class="p">[</span> <span class="nx">index</span> <span class="p">]</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            </pre></div>             </td>           </tr>                               <tr id="section-301">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-301">&#182;</a>               </div>               <p>Otherwise, since the host state or any of its descendants could
be mutable, the possibility exists of mutations being stored in
this history, in which case the traversal will involve applying
these mutations to the host state and transforming the mutation
deltas appropriately.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-302">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-302">&#182;</a>               </div>               <p>Clamp <code>nStates</code> and acquire a <code>targetIndex</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">stateIndices</span>         <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIndices</span><span class="p">;</span>
                <span class="nx">stateIndicesLength</span>   <span class="o">=</span> <span class="nx">stateIndices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                <span class="nx">stateIndex</span>           <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIndex</span><span class="p">;</span>
                <span class="nx">mutationOffset</span>       <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mutationOffset</span><span class="p">;</span>
                <span class="nx">targetStateIndex</span>     <span class="o">=</span> <span class="nx">stateIndex</span> <span class="o">+</span> <span class="nx">nStates</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nx">targetStateIndex</span> <span class="o">&gt;=</span> <span class="nx">stateIndicesLength</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">targetStateIndex</span> <span class="o">=</span> <span class="nx">stateIndicesLength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">targetStateIndex</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">targetStateIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="nx">targetIndex</span>          <span class="o">=</span> <span class="nx">stateIndices</span><span class="p">[</span> <span class="nx">targetStateIndex</span> <span class="p">];</span>
                <span class="nx">nStates</span>              <span class="o">=</span> <span class="nx">targetStateIndex</span> <span class="o">-</span> <span class="nx">stateIndex</span><span class="p">;</span>
                <span class="nx">step</span>                 <span class="o">=</span> <span class="nx">nStates</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-303">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-303">&#182;</a>               </div>               <p>Get a plain-object expression of this history’s state to
apply deltas against.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">expr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">express</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-304">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-304">&#182;</a>               </div>               <p>Process the elements of <code>indices</code> in blocks, each consisting
of one state element at the tail, followed by a contiguous
sequence of zero or more mutations.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">while</span> <span class="p">(</span> <span class="nx">index</span> <span class="o">!==</span> <span class="nx">targetIndex</span> <span class="o">||</span> <span class="nx">nMutations</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-305">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-305">&#182;</a>               </div>               <p><code>blockLength</code> refers to the number of mutations in this
block; it does not account for the trailing state
element (thus its range is <code>[0..]</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">blockLength</span> <span class="o">=</span> <span class="nx">stateIndices</span><span class="p">[</span> <span class="nx">stateIndex</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="nx">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-306">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-306">&#182;</a>               </div>               <p><code>mutationOffset</code> (which on the first run of the outer
loop will already have been initialized to
<code>this.mutationOffset</code>) iterates either backward or
forward through the mutations in this block, accreting
an aggregate delta, which, immediately prior to the next
state change, will be applied to the state in a single
mutation operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">step</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">mutationOffset</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">mutationOffset</span> <span class="o">=</span> <span class="nx">blockLength</span> <span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">mutationOffset</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">while</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nx">mutationOffset</span> <span class="o">&amp;&amp;</span> <span class="nx">mutationOffset</span> <span class="o">&lt;=</span> <span class="nx">blockLength</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">index</span> <span class="o">===</span> <span class="nx">targetIndex</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span> <span class="nx">nMutations</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
                            <span class="k">else</span> <span class="nx">nMutations</span><span class="o">--</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nx">i</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">+</span> <span class="nx">mutationOffset</span><span class="p">;</span>
                        <span class="nx">delta</span> <span class="o">=</span> <span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">delta</span><span class="p">(</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">);</span>
                        <span class="nx">compoundDelta</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">compoundDelta</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">);</span>
                        <span class="nx">mutationOffset</span> <span class="o">+=</span> <span class="nx">step</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">mutationOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                    <span class="nx">index</span> <span class="o">=</span> <span class="nx">stateIndices</span><span class="p">[</span> <span class="nx">stateIndex</span> <span class="o">+=</span> <span class="nx">step</span> <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-307">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-307">&#182;</a>               </div>               <p>If instigating transitions on each iteration, then the
transition for the next iteration’s block is made at the
end of this iteration.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">directly</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span> <span class="nx">compoundDelta</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">mutateState</span><span class="p">(</span> <span class="nx">compoundDelta</span> <span class="p">);</span>
                            <span class="nx">compoundDelta</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span> <span class="nx">indices</span><span class="p">[</span> <span class="nx">index</span> <span class="p">]</span> <span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">directly</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">compoundDelta</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mutateState</span><span class="p">(</span> <span class="nx">compoundDelta</span> <span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">changeState</span><span class="p">(</span> <span class="nx">indices</span><span class="p">[</span> <span class="nx">targetIndex</span> <span class="p">]</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">mutationOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span>

        <span class="nx">changeState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">target</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">traverse</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">change</span><span class="p">(</span> <span class="nx">target</span> <span class="p">);</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">traverse</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">mutateState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">expr</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">mutate</span><span class="p">(</span> <span class="nx">expr</span> <span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">pushState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">elements</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">elements</span><span class="p">,</span>
                <span class="nx">indices</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indices</span><span class="p">,</span>
                <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">mutationOffset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-308">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-308">&#182;</a>               </div>               <p>Splice off the forward elements.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">indices</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">index</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-309">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-309">&#182;</a>               </div>               <p>Add <code>state</code> to the new end of <code>indices</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">mutationOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="nx">state</span> <span class="k">instanceof</span> <span class="nx">State</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">);</span>
            <span class="nx">indices</span><span class="p">[</span> <span class="nx">index</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">},</span>

        <span class="nx">replaceState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">indices</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indices</span><span class="p">,</span>
                <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-310">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-310">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">},</span>

        <span class="nx">pushMutation</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">mutation</span> <span class="p">)</span> <span class="p">{</span>

        <span class="p">},</span>

        <span class="nx">replaceMutation</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">mutation</span> <span class="p">)</span> <span class="p">{</span>

        <span class="p">},</span>

        <span class="nx">previousStateIndex</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIndices</span> <span class="o">?</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">stateIndices</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIndex</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">:</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">nextStateIndex</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIndices</span> <span class="o">?</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">stateIndices</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateIndex</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">:</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">currentState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">selector</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="p">];</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selector</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">selector</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">previousState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">selector</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">previousStateIndex</span><span class="p">()</span> <span class="p">];</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selector</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">selector</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">nextState</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">selector</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">nextStateIndex</span><span class="p">()</span> <span class="p">];</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="nx">selector</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">selector</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indices</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">StateHistory</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-311">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-311">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition"
   href="#transition"></a></p>

<h2>Transition</h2>

<p>A <code>Transition</code> is a transient <code>State</code> adopted by a controller as it changes
from one of its proper <code>State</code>s to another.</p>

<p>A transition acts within the <strong>domain</strong> of the <em>least common ancestor</em>
between its <strong>origin</strong> and <strong>target</strong> states. During this time it behaves as
if it were a substate of that domain state, inheriting method calls and
propagating events in the familiar fashion.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Transition</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">Z</span><span class="p">.</span><span class="nx">inherit</span><span class="p">(</span> <span class="nx">Transition</span><span class="p">,</span> <span class="nx">State</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-312">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-312">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor"
   href="#transition--constructor"></a></p>

<h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">Transition</span> <span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">TransitionExpression</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">methods</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">events</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">guards</span> <span class="o">=</span> <span class="p">{},</span></pre></div>             </td>           </tr>                               <tr id="section-313">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-313">&#182;</a>               </div>               <p>The <strong>action</strong> of a transition is a function that will be called
after the transition has been <code>start</code>ed. This function, if
provided, is responsible for calling <code>end()</code> on the transition
at some point in the future.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">action</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">action</span><span class="p">,</span>

            <span class="nx">attachment</span> <span class="o">=</span> <span class="nx">source</span><span class="p">,</span>
            <span class="nx">controller</span><span class="p">,</span> <span class="nx">aborted</span><span class="p">;</span>

        <span class="nx">controller</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">controller</span> <span class="o">!==</span> <span class="nx">target</span><span class="p">.</span><span class="nx">controller</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">controller</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-314">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-314">&#182;</a>               </div>               <p>(Exposed for debugging.)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Z</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">__private__</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{</span>
            <span class="nx">methods</span><span class="o">:</span> <span class="nx">methods</span><span class="p">,</span>
            <span class="nx">events</span><span class="o">:</span> <span class="nx">events</span><span class="p">,</span>
            <span class="nx">guards</span><span class="o">:</span> <span class="nx">guards</span><span class="p">,</span>
            <span class="nx">action</span><span class="o">:</span> <span class="nx">action</span>
        <span class="p">});</span>

        <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-315">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-315">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--superstate"
   href="#transition--constructor--superstate"></a></p>

<h4>superstate</h4>

<p>A <a href="#transition"><code>Transition</code></a> instance uses <code>superstate</code> to
track its position as it traverses the <a href="#state"><code>State</code></a> subtree
that defines its domain.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">superstate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">attachment</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-316">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-316">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--attach-to"
   href="#transition--constructor--attach-to"></a></p>

<h4>attachTo</h4>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">attachTo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">state</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">attachment</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-317">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-317">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--controller"
   href="#transition--constructor--controller"></a></p>

<h4>controller</h4>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">controller</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-318">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-318">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--origin"
   href="#transition--constructor--origin"></a></p>

<h4>origin</h4>

<p>A transition’s <strong>origin</strong> is the controller’s most recently
active <a href="#state"><code>State</code></a> that is not itself a
<a href="#transition"><code>Transition</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">origin</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">source</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="o">?</span> <span class="nx">source</span><span class="p">.</span><span class="nx">origin</span><span class="p">()</span> <span class="o">:</span> <span class="nx">source</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-319">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-319">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--source"
   href="#transition--constructor--source"></a></p>

<h4>source</h4>

<p>A transition’s <strong>source</strong> is the <a href="#state"><code>State</code></a> or
<a href="#transition"><code>Transition</code></a> that immediately preceded <code>this</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">source</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">source</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-320">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-320">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--target"
   href="#transition--constructor--target"></a></p>

<h4>target</h4>

<p>The intended destination <a href="#state"><code>State</code></a> for this transition.
If a target is invalidated by a controller that
<a href="#state-controller--privileged--change"><code>change</code></a>s state again
before this transition completes, then this transition is
aborted and the <code>change</code> call will create a new transition with
<code>this</code> as its <code>source</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">target</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">target</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-321">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-321">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--set-callback"
   href="#transition--constructor--set-callback"></a></p>

<h4>setCallback</h4>

<p>Allows the callback function to be set or changed prior to the
transition’s completion.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">setCallback</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-322">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-322">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--was-aborted"
   href="#transition--constructor--was-aborted"></a></p>

<h4>wasAborted</h4>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">wasAborted</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">aborted</span><span class="p">;</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-323">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-323">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--start"
   href="#transition--constructor--start"></a></p>

<h4>start</h4>

<p>Starts the transition; if an <code>action</code> is defined, that function
is responsible for declaring an end to the transition by calling
<a href="#transitions--constructor--end"><code>end()</code></a>. Otherwise, the
transition is necessarily synchronous and is concluded
immediately.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">aborted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">action</span> <span class="o">&amp;&amp;</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">action</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">action</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-324">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-324">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--abort"
   href="#transition--constructor--abort"></a></p>

<h4>abort</h4>

<p>Indicates that a transition won’t directly reach its target
state; for example, if a new transition is initiated while an
asynchronous transition is already underway, that previous
transition is aborted. The previous transition is retained as
the <code>source</code> for the new transition.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">abort</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">aborted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">callback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;abort&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-325">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-325">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--end"
   href="#transition--constructor--end"></a></p>

<h4>end</h4>

<p>Indicates that a transition has completed and has reached its
intended target. The transition is subsequently retired, along
with any preceding aborted transitions.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">end</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">aborted</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
                    <span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">controller</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-326">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-326">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--constructor--destroy"
   href="#transition--constructor--destroy"></a></p>

<h4>destroy</h4>

<p>Destroys this transition and clears its held references, and
does the same for any aborted <code>source</code> transitions that preceded
it.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">source</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="o">&amp;&amp;</span> <span class="nx">source</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="nx">target</span> <span class="o">=</span> <span class="nx">attachment</span> <span class="o">=</span> <span class="nx">controller</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-327">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-327">&#182;</a>               </div>               <p><a href="#transition"><code>Transition</code></a> also inherits certain privileged methods
from <a href="#state"><code>State</code></a>, which it obtains by partially applying the
corresponding members of <a href="#state--privileged"><code>State.privileged</code></a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Z</span><span class="p">.</span><span class="nx">privilege</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;express mutate&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">TransitionExpression</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nx">methods</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">guards</span> <span class="p">],</span>
            <span class="s1">&#39;method methodNames addMethod removeMethod&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">methods</span> <span class="p">],</span>
            <span class="s1">&#39;event addEvent removeEvent emit&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">events</span> <span class="p">],</span>
            <span class="s1">&#39;guard addGuard removeGuard&#39;</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">guards</span> <span class="p">]</span>
        <span class="p">});</span>
        <span class="nx">Z</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">addEvent</span><span class="o">:</span> <span class="s1">&#39;on bind&#39;</span><span class="p">,</span>
            <span class="nx">removeEvent</span><span class="o">:</span> <span class="s1">&#39;off unbind&#39;</span><span class="p">,</span>
            <span class="nx">emit</span><span class="o">:</span> <span class="s1">&#39;trigger&#39;</span>
        <span class="p">});</span>

        <span class="nx">State</span><span class="p">.</span><span class="nx">privileged</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span> <span class="nx">TransitionExpression</span> <span class="p">).</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">expression</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-328">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-328">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition--prototype--depth"
   href="#transition--prototype--depth"></a></p>

<h4>depth</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Transition</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">source</span><span class="p">(),</span>
            <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        
        <span class="k">while</span> <span class="p">(</span> <span class="nx">s</span> <span class="k">instanceof</span> <span class="nx">Transition</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">source</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">count</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Transition</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-329">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-329">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition-expression"
   href="#transition-expression"></a></p>

<h2>TransitionExpression</h2>

<p>A <a href="#state"><code>State</code></a> may hold <strong>transition expressions</strong> that describe the
transition that will take place between any two given <strong>origin</strong> and
<strong>target</strong> states.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">TransitionExpression</span> <span class="o">=</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">properties</span>   <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">TRANSITION_PROPERTIES</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span>
        <span class="nx">categories</span>   <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">TRANSITION_EXPRESSION_CATEGORIES</span><span class="p">,</span> <span class="kc">null</span> <span class="p">),</span>
        <span class="nx">eventTypes</span>   <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">TRANSITION_EVENT_TYPES</span> <span class="p">),</span>
        <span class="nx">guardActions</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">GUARD_ACTIONS</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-330">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-330">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition-expression--constructor"
   href="#transition-expression--constructor"></a></p>

<h3>Constructor</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">TransitionExpression</span> <span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">TransitionExpression</span><span class="p">(</span> <span class="nx">map</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">Z</span><span class="p">.</span><span class="nx">edit</span><span class="p">(</span> <span class="s1">&#39;deep all&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">map</span> <span class="k">instanceof</span> <span class="nx">TransitionExpression</span> <span class="o">?</span> <span class="nx">map</span> <span class="o">:</span> <span class="nx">interpret</span><span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-331">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-331">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition-expression--private"
   href="#transition-expression--private"></a></p>

<h3>Class-private functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-332">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-332">&#182;</a>               </div>               <p><a class="icon-link"
   name="transition-expression--private--interpret"
   href="#transition-expression--private--interpret"></a></p>

<h4>interpret</h4>

<p>Rewrites a plain object map as a well-formed
<a href="#transition-expression"><code>TransitionExpression</code></a>, making the appropriate
inferences for any shorthand notation encountered.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">interpret</span> <span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="p">{},</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">categories</span> <span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">map</span> <span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">hasOwn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">properties</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">categories</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">key</span> <span class="p">],</span> <span class="nx">value</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">category</span> <span class="o">=</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">eventTypes</span> <span class="o">?</span>
                        <span class="s1">&#39;events&#39;</span> <span class="o">:</span>
                    <span class="nx">key</span> <span class="k">in</span> <span class="nx">guardActions</span> <span class="o">?</span>
                        <span class="s1">&#39;guards&#39;</span> <span class="o">:</span>
                    <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">?</span>
                        <span class="s1">&#39;methods&#39;</span> <span class="o">:</span>
                    <span class="kc">undefined</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nx">category</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">];</span>
                    <span class="nx">item</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span> <span class="nx">category</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
                    <span class="nx">item</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="p">(</span> <span class="nx">events</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">events</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">Z</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">events</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">value</span> <span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">TransitionExpression</span><span class="p">;</span>
<span class="p">}()</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-333">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-333">&#182;</a>               </div>               <p>Classes are made available as members of the exported module.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Z</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">State</span><span class="o">:</span> <span class="nx">State</span><span class="p">,</span>
    <span class="nx">StateExpression</span><span class="o">:</span> <span class="nx">StateExpression</span><span class="p">,</span>
    <span class="nx">StateController</span><span class="o">:</span> <span class="nx">StateController</span><span class="p">,</span>
    <span class="nx">StateEventEmitter</span><span class="o">:</span> <span class="nx">StateEventEmitter</span><span class="p">,</span>
    <span class="nx">Transition</span><span class="o">:</span> <span class="nx">Transition</span><span class="p">,</span>
    <span class="nx">TransitionExpression</span><span class="o">:</span> <span class="nx">TransitionExpression</span>
<span class="p">});</span>

<span class="p">}.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 